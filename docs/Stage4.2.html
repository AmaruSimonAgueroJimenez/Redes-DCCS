<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Amaru Simón Agüero Jiménez">

<title>Análisis Comparativo de Redes de Policonsumo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Stage4.2_files/libs/clipboard/clipboard.min.js"></script>
<script src="Stage4.2_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Stage4.2_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Stage4.2_files/libs/quarto-html/popper.min.js"></script>
<script src="Stage4.2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Stage4.2_files/libs/quarto-html/anchor.min.js"></script>
<link href="Stage4.2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Stage4.2_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Stage4.2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Stage4.2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Stage4.2_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>html{ scroll-behavior: smooth; }</style>
<script src="Stage4.2_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="Stage4.2_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">



</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#introducción" id="toc-introducción" class="nav-link active" data-scroll-target="#introducción"><span class="header-section-number">1</span> Introducción</a></li>
  <li><a href="#metodología" id="toc-metodología" class="nav-link" data-scroll-target="#metodología"><span class="header-section-number">2</span> Metodología</a>
  <ul>
  <li><a href="#descripción-de-los-datos" id="toc-descripción-de-los-datos" class="nav-link" data-scroll-target="#descripción-de-los-datos"><span class="header-section-number">2.1</span> Descripción de los datos</a></li>
  </ul></li>
  <li><a href="#introducción-y-objetivos" id="toc-introducción-y-objetivos" class="nav-link" data-scroll-target="#introducción-y-objetivos"><span class="header-section-number">3</span> 1. Introducción y Objetivos</a>
  <ul>
  <li><a href="#hipótesis-de-investigación" id="toc-hipótesis-de-investigación" class="nav-link" data-scroll-target="#hipótesis-de-investigación"><span class="header-section-number">3.1</span> 1.1 Hipótesis de Investigación</a></li>
  </ul></li>
  <li><a href="#preparación-de-datos" id="toc-preparación-de-datos" class="nav-link" data-scroll-target="#preparación-de-datos"><span class="header-section-number">4</span> 2. Preparación de Datos</a></li>
  <li><a href="#análisis-de-redes-transversales-por-etapa" id="toc-análisis-de-redes-transversales-por-etapa" class="nav-link" data-scroll-target="#análisis-de-redes-transversales-por-etapa"><span class="header-section-number">5</span> 3. Análisis de Redes Transversales por Etapa</a>
  <ul>
  <li><a href="#estimación-de-redes" id="toc-estimación-de-redes" class="nav-link" data-scroll-target="#estimación-de-redes"><span class="header-section-number">5.1</span> 3.1 Estimación de Redes</a></li>
  <li><a href="#visualización-de-redes---inicio" id="toc-visualización-de-redes---inicio" class="nav-link" data-scroll-target="#visualización-de-redes---inicio"><span class="header-section-number">5.2</span> 3.2 Visualización de Redes - Inicio</a></li>
  <li><a href="#visualización-de-redes---3-meses" id="toc-visualización-de-redes---3-meses" class="nav-link" data-scroll-target="#visualización-de-redes---3-meses"><span class="header-section-number">5.3</span> 3.3 Visualización de Redes - 3 meses</a></li>
  <li><a href="#visualización-de-redes---6-meses" id="toc-visualización-de-redes---6-meses" class="nav-link" data-scroll-target="#visualización-de-redes---6-meses"><span class="header-section-number">5.4</span> 3.4 Visualización de Redes - 6 meses</a></li>
  <li><a href="#visualización-de-redes---9-meses" id="toc-visualización-de-redes---9-meses" class="nav-link" data-scroll-target="#visualización-de-redes---9-meses"><span class="header-section-number">5.5</span> 3.5 Visualización de Redes - 9 meses</a></li>
  <li><a href="#visualización-de-redes---12-meses" id="toc-visualización-de-redes---12-meses" class="nav-link" data-scroll-target="#visualización-de-redes---12-meses"><span class="header-section-number">5.6</span> 3.6 Visualización de Redes - 12 meses</a></li>
  </ul></li>
  <li><a href="#métricas-de-red" id="toc-métricas-de-red" class="nav-link" data-scroll-target="#métricas-de-red"><span class="header-section-number">6</span> 4. Métricas de Red</a>
  <ul>
  <li><a href="#evolución-de-métricas" id="toc-evolución-de-métricas" class="nav-link" data-scroll-target="#evolución-de-métricas"><span class="header-section-number">6.1</span> 4.1 Evolución de Métricas</a></li>
  </ul></li>
  <li><a href="#análisis-de-nodos-puente" id="toc-análisis-de-nodos-puente" class="nav-link" data-scroll-target="#análisis-de-nodos-puente"><span class="header-section-number">7</span> 5. Análisis de Nodos Puente</a></li>
  <li><a href="#comparación-de-redes-nct" id="toc-comparación-de-redes-nct" class="nav-link" data-scroll-target="#comparación-de-redes-nct"><span class="header-section-number">8</span> 6. Comparación de Redes (NCT)</a></li>
  <li><a href="#redes-de-cambio" id="toc-redes-de-cambio" class="nav-link" data-scroll-target="#redes-de-cambio"><span class="header-section-number">9</span> 7. Redes de Cambio</a>
  <ul>
  <li><a href="#visualización-red-de-cambios-inicio-3-meses" id="toc-visualización-red-de-cambios-inicio-3-meses" class="nav-link" data-scroll-target="#visualización-red-de-cambios-inicio-3-meses"><span class="header-section-number">9.1</span> 7.1 Visualización Red de Cambios: Inicio → 3 meses</a></li>
  <li><a href="#visualización-red-de-cambios-3-6-meses" id="toc-visualización-red-de-cambios-3-6-meses" class="nav-link" data-scroll-target="#visualización-red-de-cambios-3-6-meses"><span class="header-section-number">9.2</span> 7.2 Visualización Red de Cambios: 3 → 6 meses</a></li>
  <li><a href="#visualización-red-de-cambios-6-12-meses" id="toc-visualización-red-de-cambios-6-12-meses" class="nav-link" data-scroll-target="#visualización-red-de-cambios-6-12-meses"><span class="header-section-number">9.3</span> 7.3 Visualización Red de Cambios: 6 → 12 meses</a></li>
  </ul></li>
  <li><a href="#modelos-mixtos-lineales" id="toc-modelos-mixtos-lineales" class="nav-link" data-scroll-target="#modelos-mixtos-lineales"><span class="header-section-number">10</span> 8. Modelos Mixtos Lineales</a>
  <ul>
  <li><a href="#trayectorias-predichas" id="toc-trayectorias-predichas" class="nav-link" data-scroll-target="#trayectorias-predichas"><span class="header-section-number">10.1</span> 8.1 Trayectorias Predichas</a></li>
  </ul></li>
  <li><a href="#análisis-cross-lagged" id="toc-análisis-cross-lagged" class="nav-link" data-scroll-target="#análisis-cross-lagged"><span class="header-section-number">11</span> 9. Análisis Cross-Lagged</a></li>
  <li><a href="#contraste-de-hipótesis" id="toc-contraste-de-hipótesis" class="nav-link" data-scroll-target="#contraste-de-hipótesis"><span class="header-section-number">12</span> 10. Contraste de Hipótesis</a></li>
  <li><a href="#tabla-resumen-final" id="toc-tabla-resumen-final" class="nav-link" data-scroll-target="#tabla-resumen-final"><span class="header-section-number">13</span> 11. Tabla Resumen Final</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Análisis Comparativo de Redes de Policonsumo</h1>
<p class="subtitle lead">Red de Co-ocurrencia vs Red Bipartita</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Autor/a</div>
    <div class="quarto-title-meta-contents">
             <p>Amaru Simón Agüero Jiménez <a href="mailto:aaguero@miaundes.cl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0001-7336-1833" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Fecha de publicación</div>
    <div class="quarto-title-meta-contents">
      <p class="date">28 de septiembre de 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introducción" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introducción</h1>
<p>Los trastornos por uso de sustancias (TUS) constituyen una de las principales causas de carga de enfermedad y mortalidad evitable a escala global. En 2016 se calculó que más de 100 millones de personas sufrían trastorno por consumo de alcohol y decenas de millones presentaban dependencia de opioides, cannabis o cocaína<span class="citation" data-cites="Volkow2023"><sup><a href="#ref-Volkow2023" role="doc-biblioref">1</a></sup></span>. La frecuente comorbilidad psiquiátrica, depresión, trastornos de ansiedad, psicosis o trastornos de personalidad multiplica la severidad clínica y los costes sociosanitarios<span class="citation" data-cites="Connery2020"><sup><a href="#ref-Connery2020" role="doc-biblioref">2</a></sup></span>. Estudios hospitalarios europeos y norteamericanos muestran que alrededor del 20 % de las admisiones psiquiátricas corresponden a pacientes de sexo femenino con diagnóstico dual, fenómeno que favorece re-ingresos y estancias prolongadas<span class="citation" data-cites="GomezSanchezLafuente2022"><sup><a href="#ref-GomezSanchezLafuente2022" role="doc-biblioref">3</a></sup></span>.</p>
<p>En Chile, las encuestas nacionales sitúan la prevalencia de abuso o dependencia de sustancias entre el 11 % y el 20 %, una de las más elevadas de Latinoamérica. Los registros hospitalarios concuerdan con las cifras internacionales: alrededor de una quinta parte de los internados en psiquiatría presenta un TCS como diagnóstico primario o secundario. Esta convergencia evidencia que la hospitalización psiquiátrica es un desenlace clínico crítico en la trayectoria de las adicciones, razón por la cual identificar sus factores determinantes resulta esencial para planificar intervenciones preventivas, asignar recursos y reducir la carga asistencial<span class="citation" data-cites="Connery2020 Saxena2011 GomezSanchezLafuente2016 Rojas2002"><sup><a href="#ref-Connery2020" role="doc-biblioref">2</a>,<a href="#ref-Saxena2011" role="doc-biblioref">4</a>–<a href="#ref-Rojas2002" role="doc-biblioref">6</a></sup></span>.</p>
</section>
<section id="metodología" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Metodología</h1>
<section id="descripción-de-los-datos" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="descripción-de-los-datos"><span class="header-section-number">2.1</span> Descripción de los datos</h2>
<p>Este es un estudio de cohorte retrospectiva de pacientes adultos en tratamiento por consumo de sustancias, con datos otorgados por el Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol de Chile (SENDA) en convenio con el núcleo milenio de ánalisis de políticas públicas de drogas (nDP). La cohorte se construyó vinculando los registros administrativos de los pacientes (n = 223,061 episodios de tratamiento entre 97,698 personas en las 16 regiones del país).</p>
<p>Estos datos incluyen múltiples variables relacionadas al consumo y tratamiento rehabilitador de drogas. Entre estas variables esta la <em>sustancia principal</em> por la cual se trató al paciente y sustancias secundarias (alcohol, pasta base de cocaína, cocaína, marihuana, depresores del SNC u otras sustancias. Tambien está presente el número de reingresos a tratamiento (retratamientos, categorizados en 0, 1, 2, 3 o más reingresos), el <em>tipo de plan de tratamiento</em> (ambulatorio vs.&nbsp;residencial) y el historial clínico de salud mental de los pacientes.</p>
<p>El registro de pacientes en tratamiento se realizó en una plataforma electrónica denominada SISTRAT, que contenía información sociodemográfica, datos sobre el estado de salud y patrones de consumo de sustancias, entre otras variables, además de información sobre el propio tratamiento (p.&nbsp;ej., fecha de ingreso, egreso, tipo de tratamiento). Las base de datos se vincularon de forma determinista mediante un hash de 64 caracteres resultante del cifrado (con un algoritmo SHA-256) del número de identificación único de cada persona.</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># TOP 2015–2022: Carga robusta + Limpieza + Renombrado</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup unificado (paquetes + opciones + tema + seed)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Función robusta para instalar/cargar paquetes ----</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>ensure_packages <span class="ot">&lt;-</span> <span class="cf">function</span>(pkgs, <span class="at">repos =</span> <span class="fu">getOption</span>(<span class="st">"repos"</span>)) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(pkgs), <span class="fu">length</span>(pkgs) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Repos por defecto si no están definidos</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(repos) <span class="sc">||</span> <span class="fu">is.na</span>(repos[<span class="st">"CRAN"</span>]) <span class="sc">||</span> repos[<span class="st">"CRAN"</span>] <span class="sc">==</span> <span class="st">"@CRAN@"</span>) {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN =</span> <span class="st">"https://cloud.r-project.org"</span>))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detectar faltantes</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  missing_pkgs <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span><span class="fu">vapply</span>(pkgs, requireNamespace, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="at">quietly =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Instalar faltantes (con dependencias y en paralelo cuando sea posible)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_pkgs)) {</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    ncpus <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"parallel"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      ncpus <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>L)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(missing_pkgs, <span class="at">dependencies =</span> <span class="cn">TRUE</span>, <span class="at">Ncpus =</span> ncpus)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cargar todos (incluye los que ya estaban)</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, <span class="cf">function</span>(p) {</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressPackageStartupMessages</span>(</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">library</span>(p, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">TRUE</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Declaración única de paquetes ----</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># utilidades / data wrangling</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table"</span>, <span class="st">"stringr"</span>, <span class="st">"stringi"</span>, <span class="st">"janitor"</span>, <span class="st">"lubridate"</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dplyr"</span>, <span class="st">"purrr"</span>, <span class="st">"tibble"</span>, <span class="st">"openxlsx"</span>, <span class="st">"tidyverse"</span>,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># redes y psicometría</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"igraph"</span>, <span class="st">"qgraph"</span>, <span class="st">"bootnet"</span>, <span class="st">"NetworkComparisonTest"</span>, <span class="st">"networktools"</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># modelos mixtos</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>, <span class="st">"lmerTest"</span>, <span class="st">"broom.mixed"</span>,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># grafos/visualización</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggraph"</span>, <span class="st">"tidygraph"</span>, <span class="st">"corrplot"</span>, <span class="st">"patchwork"</span>, <span class="st">"kableExtra"</span>, <span class="st">"plotly"</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Carga de paquetes (instala si faltan) ----</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="fu">ensure_packages</span>(pkgs)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Configuración global knitr/figuras ----</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">message   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">10</span>,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">8</span>,</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">dpi =</span> <span class="dv">300</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Temas y opciones de visualización ----</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>))</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Semilla global para reproducibilidad ----</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Paths y configuración ----------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>root <span class="ot">&lt;-</span> <span class="fu">normalizePath</span>(<span class="fu">gsub</span>(<span class="st">"/docs$"</span>, <span class="st">""</span>, <span class="fu">getwd</span>()), <span class="at">mustWork =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>base_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>output_rds <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022_FINAL.rds"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>output_excel <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022_FINAL.xlsx"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Archivos esperados --------------------------------------------------</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>archivos <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2015_oct_dup_enc.csv"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2016_oct_dup1_enc.csv"</span>, <span class="st">"2016_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2017_oct_dup1_enc.csv"</span>, <span class="st">"2017_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2018_oct_dup1_enc.csv"</span>, <span class="st">"2018_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2019_oct_dup1_enc.csv"</span>, <span class="st">"2019_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2019oct_oct_dup_enc.csv"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2020_oct_dup1_enc.csv"</span>, <span class="st">"2020_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2021_oct_dup1_enc.csv"</span>, <span class="st">"2021_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2022_oct_dup1_enc.csv"</span>, <span class="st">"2022_oct_dup2_enc.csv"</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Funciones de utilidad -----------------------------------------------</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Extrae año del nombre del archivo</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>extract_year <span class="ot">&lt;-</span> <span class="cf">function</span>(filename) {</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(filename, <span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2}"</span>))</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpia nombres de columnas</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>clean_colnames <span class="ot">&lt;-</span> <span class="cf">function</span>(nms) {</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(nms, <span class="st">"Latin-ASCII"</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"[^A-Za-z0-9]+"</span>, <span class="st">"_"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"_{2,}"</span>, <span class="st">"_"</span>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"^_|_$"</span>, <span class="st">""</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">make_clean_names</span>(nms)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Mojibake safe (no explota con NA)</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>fix_mojibake <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">enc2utf8</span>(x)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  bad <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"(Ã.|Â|Aƒ)"</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(bad)) {</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    cand <span class="ot">&lt;-</span> <span class="fu">iconv</span>(x[bad], <span class="at">from =</span> <span class="st">"latin1"</span>, <span class="at">to =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    scount <span class="ot">&lt;-</span> <span class="cf">function</span>(v, pat) { </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>      out <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_count</span>(v, pat)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      out[<span class="fu">is.na</span>(out)] <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>      out </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    keep <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scount</span>(cand, <span class="st">"Ã|Â|Aƒ"</span>) <span class="sc">&lt;</span> <span class="fu">scount</span>(x[bad], <span class="st">"Ã|Â|Aƒ"</span>), </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>      cand, </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>      x[bad]</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    x[bad] <span class="ot">&lt;-</span> keep</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Parser de fechas mixtas</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>parse_mixed_dates <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_trim</span>(x)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  x[x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">"NULL"</span>, <span class="st">"0000-00-00"</span>, <span class="st">"00/00/0000"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(x, <span class="st">"[./]"</span>, <span class="st">"-"</span>)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">as.Date</span>(<span class="cn">NA</span>), <span class="fu">length</span>(x))</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yyyy-mm-dd</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  ymd_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[12][0-9]{3}-[0-9]{1,2}-[0-9]{1,2}$"</span>)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(ymd_mask)) res[ymd_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(x[ymd_mask]))</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dd-mm-yyyy (preferencia Chile)</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  dmy_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span>ymd_mask <span class="sc">&amp;</span> </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{1,2}-[0-9]{1,2}-[12][0-9]{3}$"</span>)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(dmy_mask)) res[dmy_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">dmy</span>(x[dmy_mask]))</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mdy como fallback</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>  mdy_mask <span class="ot">&lt;-</span> <span class="fu">is.na</span>(res) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> </span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{1,2}-[0-9]{1,2}-[12][0-9]{3}$"</span>)</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(mdy_mask)) res[mdy_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">mdy</span>(x[mdy_mask]))</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># YYYYMMDD</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>  yfirst8_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^(19|20)</span><span class="sc">\\</span><span class="st">d{6}$"</span>)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(yfirst8_mask)) res[yfirst8_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(x[yfirst8_mask]))</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># DDMMAAAA</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>  dmy8_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{8}$"</span>) <span class="sc">&amp;</span> <span class="sc">!</span>yfirst8_mask</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(dmy8_mask)) res[dmy8_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">dmy</span>(x[dmy8_mask]))</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fechas Excel</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>  excel_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{5,6}$"</span>)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(excel_mask)) {</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">which</span>(excel_mask)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    num <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(x[idx]))</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(num) <span class="sc">&amp;</span> num <span class="sc">&gt;</span> <span class="dv">20000</span> <span class="sc">&amp;</span> num <span class="sc">&lt;</span> <span class="dv">60000</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(ok)) res[idx[ok]] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(num[ok], <span class="at">origin =</span> <span class="st">"1899-12-30"</span>)</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Último recurso</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  fallback_mask <span class="ot">&lt;-</span> <span class="fu">is.na</span>(res) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(fallback_mask)) {</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>      x[fallback_mask],</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">orders =</span> <span class="fu">c</span>(<span class="st">"Ymd"</span>,<span class="st">"Y-m-d"</span>,<span class="st">"dmY"</span>,<span class="st">"d-m-Y"</span>,<span class="st">"mdY"</span>,<span class="st">"m-d-Y"</span>,<span class="st">"Ymd HMS"</span>,<span class="st">"dmY HMS"</span>,<span class="st">"mdY HMS"</span>)</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    res[fallback_mask] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(tmp)</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta columnas de fecha por nombre</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>normalize_name <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  n <span class="sc">%&gt;%</span> </span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(<span class="st">"Latin-ASCII"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tolower</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">"[^a-z0-9]+"</span>, <span class="st">""</span>)</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>is_date_like <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>  n_norm <span class="ot">&lt;-</span> <span class="fu">normalize_name</span>(n)</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    n_norm,</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"^fecha"</span>,<span class="st">"fechanacimiento"</span>,<span class="st">"fechadeingreso"</span>,<span class="st">"fechaingreso"</span>,</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fechaegreso"</span>,<span class="st">"fechaalta"</span>,<span class="st">"fecharegistro"</span>,<span class="st">"fechaconsulta"</span>,</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fechacita"</span>,<span class="st">"fechadiagnostico"</span>)</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Lector robusto de archivos</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>read_top_file <span class="ot">&lt;-</span> <span class="cf">function</span>(filename) {</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(base_path, filename)</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>      data.table<span class="sc">::</span><span class="fu">fread</span>(</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>        file_path,</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">";"</span>,</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>        <span class="at">encoding =</span> <span class="st">"Latin-1"</span>,</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>        <span class="at">na.strings =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">"NULL"</span>),</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>        <span class="at">showProgress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>        <span class="at">colClasses =</span> <span class="st">"character"</span></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(dt)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setDT</span>(dt)</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(dt)) dt[, HASHKEY <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(HASHKEY)]</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(dt, <span class="fu">clean_colnames</span>(<span class="fu">names</span>(dt)))</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>  dt[, year <span class="sc">:</span><span class="er">=</span> <span class="fu">extract_year</span>(filename)]</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>  dt[, source_file <span class="sc">:</span><span class="er">=</span> filename]</span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>  dt[]</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Renombrado dinámico de columnas de dosis</span></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>rename_dosis_cols <span class="ot">&lt;-</span> <span class="cf">function</span>(dt) {</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> <span class="fu">names</span>(dt)</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>  dose_mask <span class="ot">&lt;-</span> <span class="fu">startsWith</span>(nms, <span class="st">"d_af_a_sis_"</span>)</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(dose_mask)) <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>  sufijos <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^d_af_a_sis_"</span>, <span class="st">""</span>, nms[dose_mask])</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>  sub_map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oh"</span> <span class="ot">=</span> <span class="st">"alcohol"</span>,</span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>    <span class="st">"thc"</span> <span class="ot">=</span> <span class="st">"cannabis"</span>,</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pbc"</span> <span class="ot">=</span> <span class="st">"pasta_base"</span>,</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>    <span class="st">"coc"</span> <span class="ot">=</span> <span class="st">"cocaina"</span>,</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bzd"</span> <span class="ot">=</span> <span class="st">"benzodiacepinas"</span>,</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    <span class="st">"otra"</span> <span class="ot">=</span> <span class="st">"otra_sustancia"</span></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>  suf_ok <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sufijos <span class="sc">%in%</span> <span class="fu">names</span>(sub_map), sub_map[sufijos], sufijos)</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>  nuevos <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"dosis_"</span>, suf_ok)</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(dt, nms[dose_mask], nuevos)</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Funciones de limpieza de texto</span></span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================</span></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: forzar a character cuando venga factor</span></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>.as_char <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(x))    <span class="fu">return</span>(<span class="fu">as.character</span>(x))</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta "mojibake" típico</span></span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>.has_mojibake <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"(Ã|Â|â|�)"</span>, x), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Normaliza texto: espacios invisibles, comillas/guiones, trim</span></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>normalize_text <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u00A0"</span>, <span class="st">" "</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)                 <span class="co"># NBSP</span></span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u200B\u200C\u200D\uFEFF]"</span>, <span class="st">""</span>, x)            <span class="co"># zero-width</span></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u201C\u201D]"</span>, <span class="st">"</span><span class="sc">\"</span><span class="st">"</span>, x)                      <span class="co"># " "</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u2019"</span>, <span class="st">"'"</span>, x)                               <span class="co"># '</span></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u2013\u2014]"</span>, <span class="st">"-"</span>, x)                       <span class="co"># – —</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">'""'</span>, <span class="st">'"'</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" +"</span>, <span class="st">" "</span>, x)</span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trimws</span>(x)</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback de reemplazos comunes de mojibake</span></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback de reemplazos comunes de mojibake (incluye variantes con "f"/"ƒ")</span></span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>.fix_mojibake_pairs <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Variantes básicas (una sola pasada UTF-8 interpretada como latin1)</span></span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>  basics_from <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Ã¡"</span>,<span class="st">"Ã©"</span>,<span class="st">"Ã­"</span>,<span class="st">"Ã³"</span>,<span class="st">"Ãº"</span>,<span class="st">"Ãñ"</span>,<span class="st">"ÃÑ"</span>,<span class="st">"Ãœ"</span>,<span class="st">"Ã¼"</span>,<span class="st">"Ã‰"</span>,<span class="st">"Ã“"</span>,<span class="st">"Ãš"</span>,<span class="st">"Ã"</span>,<span class="st">"Ã"</span>)</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>  basics_to   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"á"</span>,<span class="st">"é"</span>,<span class="st">"í"</span>,<span class="st">"ó"</span>,<span class="st">"ú"</span>,<span class="st">"ñ"</span>,<span class="st">"Ñ"</span>,<span class="st">"Ü"</span>,<span class="st">"ü"</span>,<span class="st">"É"</span>,<span class="st">"Ó"</span>,<span class="st">"Ú"</span>,<span class="st">"Á"</span>,<span class="st">"Í"</span>)</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(basics_from)) x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(basics_from[i], basics_to[i], x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Doble codificación muy común (ÃƒÂ*)</span></span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>  dbl_from <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ÃƒÂ¡"</span>,<span class="st">"ÃƒÂ©"</span>,<span class="st">"ÃƒÂ­"</span>,<span class="st">"ÃƒÂ³"</span>,<span class="st">"ÃƒÂº"</span>,<span class="st">"ÃƒÂ±"</span>,<span class="st">"Ãƒâ€˜"</span>,<span class="st">"ÃƒÂœ"</span>,<span class="st">"ÃƒÂº"</span>,<span class="st">"ÃƒÂ"</span></span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>  dbl_to   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"á"</span>,<span class="st">"é"</span>,<span class="st">"í"</span>,<span class="st">"ó"</span>,<span class="st">"ú"</span>,<span class="st">"ñ"</span>,<span class="st">"Ñ"</span>,<span class="st">"Ü"</span>,<span class="st">"ú"</span>,<span class="st">"Ã"</span>) <span class="co"># "ÃƒÂ" suelto → "Ã" (luego cae en basics)</span></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(dbl_from)) x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(dbl_from[i], dbl_to[i], x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Misma doble codificación vista como "ÃfÂ*" (cuando ƒ se ve como f)</span></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Usamos regex para cubrir "f" o "ƒ"</span></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â¡"</span>, <span class="st">"á"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â©"</span>, <span class="st">"é"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â­"</span>, <span class="st">"í"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â³"</span>, <span class="st">"ó"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Âº"</span>, <span class="st">"ú"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â±"</span>, <span class="st">"ñ"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]â€˜"</span>, <span class="st">"Ñ"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otros restos comunes</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Âº"</span>,<span class="st">"º"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Âª"</span>,<span class="st">"ª"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Â°"</span>,<span class="st">"°"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚"</span>,<span class="st">""</span>,  x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)     <span class="co"># Â sobrante</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Comillas/guiones mojibake de cp1252 → UTF-8 mal decodificado</span></span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â€œ"</span>, <span class="st">"–"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â€"</span>, <span class="st">"—"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Ëœ"</span>, <span class="st">"‘"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â„¢"</span>, <span class="st">"’"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Å“"</span>, <span class="st">"“"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Â"</span>, <span class="st">"”"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Reparador principal de mojibake</span></span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>.repair_mojibake_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>  safe_iconv <span class="ot">&lt;-</span> <span class="cf">function</span>(z, from, to) {</span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(<span class="fu">iconv</span>(z, <span class="at">from =</span> from, <span class="at">to =</span> to, <span class="at">sub =</span> <span class="cn">NA</span>))</span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a>  cand <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>    <span class="at">raw            =</span> x,</span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">enc2utf8       =</span> <span class="fu">enc2utf8</span>(x),</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">latin1_to_utf8 =</span> <span class="fu">safe_iconv</span>(x, <span class="st">"latin1"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">cp1252_to_utf8 =</span> <span class="fu">safe_iconv</span>(x, <span class="st">"CP1252"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">rt_latin1      =</span> <span class="fu">safe_iconv</span>(<span class="fu">safe_iconv</span>(x, <span class="st">"UTF-8"</span>, <span class="st">"latin1"</span>),  <span class="st">"latin1"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">rt_cp1252      =</span> <span class="fu">safe_iconv</span>(<span class="fu">safe_iconv</span>(x, <span class="st">"UTF-8"</span>, <span class="st">"CP1252"</span>),  <span class="st">"CP1252"</span>,  <span class="st">"UTF-8"</span>)</span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Elige el candidato con menos rastros</span></span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="cf">function</span>(v) {</span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>    v2 <span class="ot">&lt;-</span> v</span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>    v2[<span class="fu">is.na</span>(v2)] <span class="ot">&lt;-</span> x[<span class="fu">is.na</span>(v2)]</span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">grepl</span>(<span class="st">"Ã|Â|â|�"</span>, v2))</span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> <span class="fu">sapply</span>(cand, score)</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> cand[[<span class="fu">names</span>(<span class="fu">which.min</span>(scores))[<span class="dv">1</span>]]]</span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>  out[<span class="fu">is.na</span>(out)] <span class="ot">&lt;-</span> x[<span class="fu">is.na</span>(out)]</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\uFEFF"</span>, <span class="st">""</span>, out, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u00A0"</span>, <span class="st">" "</span>, out, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aplica fallback explícito</span></span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">.fix_mojibake_pairs</span>(out)</span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">.fix_mojibake_pairs</span>(out)  <span class="co"># Segunda pasada</span></span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta si columna es mayormente numérica</span></span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>is_mostly_numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">threshold =</span> <span class="fl">0.90</span>) {</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(x)</span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">"."</span>, y, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">trimws</span>(y)</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[<span class="sc">!</span><span class="fu">is.na</span>(y) <span class="sc">&amp;</span> y <span class="sc">!=</span> <span class="st">""</span>]</span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(y)) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>  ok <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^[-+]?</span><span class="sc">\\</span><span class="st">d*(?:</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">d+)?$"</span>, y)</span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(ok) <span class="sc">&gt;=</span> threshold</span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Conversión segura a numérico</span></span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>to_numeric_safely <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(x))</span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(x)</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">"."</span>, y, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"NaN"</span>, <span class="st">"null"</span>, <span class="st">"NULL"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(y))</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a><span class="co"># Función principal de casteo</span></span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>clean_cast_dataset <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">id_cols =</span> <span class="st">"HASHKEY"</span>, <span class="at">numeric_threshold =</span> <span class="fl">0.90</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(df)) <span class="fu">stop</span>(<span class="st">"df debe ser un data.frame/tibble."</span>)</span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> df</span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>  id_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(id_cols, <span class="fu">names</span>(out))</span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Limpiar columnas character excepto IDs</span></span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>  char_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(out)[<span class="fu">vapply</span>(out, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>  char_cols_to_clean <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(char_cols, id_cols)</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(char_cols_to_clean)) {</span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (nm <span class="cf">in</span> char_cols_to_clean) {</span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(<span class="fu">.repair_mojibake_vec</span>(out[[nm]]))</span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Castear a numeric si corresponde</span></span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>  converted_to_numeric <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(out), id_cols)) {</span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(out[[nm]]) <span class="sc">&amp;&amp;</span> <span class="fu">is_mostly_numeric</span>(out[[nm]], numeric_threshold)) {</span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">to_numeric_safely</span>(out[[nm]])</span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>      converted_to_numeric <span class="ot">&lt;-</span> <span class="fu">c</span>(converted_to_numeric, nm)</span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Castear resto a factor</span></span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>  converted_to_factor <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(out), id_cols)) {</span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(out[[nm]])) {</span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">normalize_text</span>(out[[nm]]))</span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a>      converted_to_factor <span class="ot">&lt;-</span> <span class="fu">c</span>(converted_to_factor, nm)</span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mantener IDs como character</span></span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> id_cols) {</span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(out[[nm]])) {</span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(df[[nm]])</span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-355"><a href="#cb2-355" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================</span></span>
<span id="cb2-356"><a href="#cb2-356" aria-hidden="true" tabindex="-1"></a><span class="co"># Funciones de recodificación</span></span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================</span></span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a>.squish <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>, <span class="st">" "</span>, <span class="fu">trimws</span>(<span class="fu">.as_char</span>(x)))</span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a>.recode_si_no <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">yes_label =</span> <span class="st">"Sí"</span>, <span class="at">no_label =</span> <span class="st">"No"</span>) {</span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a>  yu <span class="ot">&lt;-</span> <span class="fu">toupper</span>(y)</span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>  is_yes <span class="ot">&lt;-</span> yu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"SI"</span>,<span class="st">"SÍ"</span>,<span class="st">"SÍ"</span>)</span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a>  is_no  <span class="ot">&lt;-</span> yu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"N"</span>,<span class="st">"NO"</span>)</span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a>  y[is_yes] <span class="ot">&lt;-</span> yes_label</span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a>  y[is_no]  <span class="ot">&lt;-</span> no_label</span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a><span class="co"># Unifica categorías de sustancias</span></span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a>.recode_sustancia <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a>  lx <span class="ot">&lt;-</span> <span class="fu">tolower</span>(y)</span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a>  canon <span class="ot">&lt;-</span> y</span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a>  set <span class="ot">&lt;-</span> <span class="cf">function</span>(idx, val) { canon[idx] <span class="ot">&lt;&lt;-</span> val }</span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^inhalables"</span>,                         lx), <span class="st">"Inhalables"</span>)</span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sedantes"</span>,                           lx), <span class="st">"Sedantes"</span>)</span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hipn[oó]ticos"</span>,                      lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Hipnóticos"</span>)</span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"otros</span><span class="sc">\\</span><span class="st">s+opioides</span><span class="sc">\\</span><span class="st">s+analg"</span>,         lx), <span class="st">"Otros Opioides Analgésicos"</span>)</span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros</span><span class="sc">\\</span><span class="st">s+alucin[oó]genos"</span>,          lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Otros Alucinógenos"</span>)</span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros</span><span class="sc">\\</span><span class="st">s+estimulantes"</span>,             lx), <span class="st">"Otros Estimulantes"</span>)</span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^pasta</span><span class="sc">\\</span><span class="st">s+base"</span>,                     lx), <span class="st">"Pasta Base"</span>)</span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^coca[ií]na"</span>,                        lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Cocaína"</span>)</span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^(?:e|é)xtasis"</span>,                     lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Éxtasis"</span>)</span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hero[ií]na"</span>,                        lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Heroína"</span>)</span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^marihuana"</span>,                         lx), <span class="st">"Marihuana"</span>)</span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^metanfetaminas?"</span>,                   lx), <span class="st">"Metanfetaminas y otros derivados"</span>)</span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^anfetaminas?"</span>,                      lx), <span class="st">"Anfetaminas"</span>)</span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^metadona"</span>,                          lx), <span class="st">"Metadona"</span>)</span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hongos$"</span>,                           lx), <span class="st">"Hongos"</span>)</span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^lsd$"</span>,                              lx), <span class="st">"LSD"</span>)</span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^crack$"</span>,                            lx), <span class="st">"Crack"</span>)</span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^alcohol$"</span>,                          lx), <span class="st">"Alcohol"</span>)</span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^tranquilizantes"</span>,                   lx), <span class="st">"Tranquilizantes"</span>)</span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^fenilciclidina"</span>,                    lx), <span class="st">"Fenilciclidina"</span>)</span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+consumo$"</span>,                   lx), <span class="st">"Sin consumo"</span>)</span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+especificar$"</span>,              lx), <span class="st">"Sin especificar"</span>)</span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+sustancia</span><span class="sc">\\</span><span class="st">s+principal"</span>,     lx), <span class="st">"Sin sustancia principal"</span>)</span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros$"</span>,                            lx), <span class="st">"Otros"</span>)</span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a>  canon</span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajustes puntuales</span></span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>.recode_tipo_centro <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(<span class="fu">tolower</span>(y))</span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">==</span> <span class="st">"publico"</span>] <span class="ot">&lt;-</span> <span class="st">"Público"</span></span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">==</span> <span class="st">"privado"</span>] <span class="ot">&lt;-</span> <span class="st">"Privado"</span></span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a>.recode_motivo_egreso <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"Admnistrativa"</span>, <span class="st">"Administrativa"</span>, y, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a>.recode_eval_proceso <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(?i)minimo"</span>, <span class="st">"Mínimo"</span>, y, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Función principal de recodificación</span></span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>limpiar_caracteres_y_recodificar <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.data.frame</span>(df))</span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a>  is_chr <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb2-439"><a href="#cb2-439" aria-hidden="true" tabindex="-1"></a>  is_fac <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df, is.factor, <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb2-440"><a href="#cb2-440" aria-hidden="true" tabindex="-1"></a>  cols_cf <span class="ot">&lt;-</span> <span class="fu">names</span>(df)[is_chr <span class="sc">|</span> is_fac]</span>
<span id="cb2-441"><a href="#cb2-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-442"><a href="#cb2-442" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reparar encoding + espacios</span></span>
<span id="cb2-443"><a href="#cb2-443" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> cols_cf) {</span>
<span id="cb2-444"><a href="#cb2-444" aria-hidden="true" tabindex="-1"></a>    was_factor <span class="ot">&lt;-</span> <span class="fu">is.factor</span>(df[[nm]])</span>
<span id="cb2-445"><a href="#cb2-445" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">.squish</span>(<span class="fu">.repair_mojibake_vec</span>(df[[nm]]))</span>
<span id="cb2-446"><a href="#cb2-446" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="cf">if</span> (was_factor) <span class="fu">factor</span>(tmp) <span class="cf">else</span> tmp</span>
<span id="cb2-447"><a href="#cb2-447" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-448"><a href="#cb2-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-449"><a href="#cb2-449" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detectar y recodificar S/N</span></span>
<span id="cb2-450"><a href="#cb2-450" aria-hidden="true" tabindex="-1"></a>  sn_cols <span class="ot">&lt;-</span> cols_cf[<span class="fu">sapply</span>(cols_cf, <span class="cf">function</span>(nm) {</span>
<span id="cb2-451"><a href="#cb2-451" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">toupper</span>(<span class="fu">trimws</span>(<span class="fu">.as_char</span>(df[[nm]]))))</span>
<span id="cb2-452"><a href="#cb2-452" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> u[<span class="sc">!</span><span class="fu">is.na</span>(u)]</span>
<span id="cb2-453"><a href="#cb2-453" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(u) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(u <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"N"</span>,<span class="st">"SI"</span>,<span class="st">"SÍ"</span>,<span class="st">"SÍ"</span>,<span class="st">"NO"</span>))</span>
<span id="cb2-454"><a href="#cb2-454" aria-hidden="true" tabindex="-1"></a>  })]</span>
<span id="cb2-455"><a href="#cb2-455" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-456"><a href="#cb2-456" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> sn_cols) {</span>
<span id="cb2-457"><a href="#cb2-457" aria-hidden="true" tabindex="-1"></a>    lab <span class="ot">&lt;-</span> <span class="fu">.recode_si_no</span>(df[[nm]])</span>
<span id="cb2-458"><a href="#cb2-458" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(lab, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"No"</span>,<span class="st">"Sí"</span>))</span>
<span id="cb2-459"><a href="#cb2-459" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-460"><a href="#cb2-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-461"><a href="#cb2-461" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unificar sustancias</span></span>
<span id="cb2-462"><a href="#cb2-462" aria-hidden="true" tabindex="-1"></a>  sust_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(</span>
<span id="cb2-463"><a href="#cb2-463" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal_1"</span>,<span class="st">"sustancia_principal_2"</span>,<span class="st">"sustancia_principal_3"</span>,</span>
<span id="cb2-464"><a href="#cb2-464" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal1"</span>,<span class="st">"sustancia_principal2"</span>,<span class="st">"sustancia_principal3"</span></span>
<span id="cb2-465"><a href="#cb2-465" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb2-466"><a href="#cb2-466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-467"><a href="#cb2-467" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> sust_cols) {</span>
<span id="cb2-468"><a href="#cb2-468" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">.recode_sustancia</span>(df[[nm]])</span>
<span id="cb2-469"><a href="#cb2-469" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(tmp)</span>
<span id="cb2-470"><a href="#cb2-470" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-471"><a href="#cb2-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-472"><a href="#cb2-472" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ajustes puntuales</span></span>
<span id="cb2-473"><a href="#cb2-473" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"tipo_centro"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb2-474"><a href="#cb2-474" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>tipo_centro <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_tipo_centro</span>(df<span class="sc">$</span>tipo_centro))</span>
<span id="cb2-475"><a href="#cb2-475" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-476"><a href="#cb2-476" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"motivo_egreso"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb2-477"><a href="#cb2-477" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>motivo_egreso <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_motivo_egreso</span>(df<span class="sc">$</span>motivo_egreso))</span>
<span id="cb2-478"><a href="#cb2-478" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-479"><a href="#cb2-479" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"evaluacion_proceso_terapeutico"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb2-480"><a href="#cb2-480" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>evaluacion_proceso_terapeutico <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_eval_proceso</span>(df<span class="sc">$</span>evaluacion_proceso_terapeutico))</span>
<span id="cb2-481"><a href="#cb2-481" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-482"><a href="#cb2-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-483"><a href="#cb2-483" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb2-484"><a href="#cb2-484" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-485"><a href="#cb2-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-486"><a href="#cb2-486" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Pipeline principal ==================================================</span></span>
<span id="cb2-487"><a href="#cb2-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-488"><a href="#cb2-488" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar si existe el archivo RDS final</span></span>
<span id="cb2-489"><a href="#cb2-489" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(output_rds)) {</span>
<span id="cb2-490"><a href="#cb2-490" aria-hidden="true" tabindex="-1"></a>  datos_final <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(output_rds)</span>
<span id="cb2-491"><a href="#cb2-491" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-492"><a href="#cb2-492" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-493"><a href="#cb2-493" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span><span class="al">TODO</span><span class="co"> EL PROCESAMIENTO OCURRE AQUÍ SI NO EXISTE EL ARCHIVO FINAL</span></span>
<span id="cb2-494"><a href="#cb2-494" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-495"><a href="#cb2-495" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Primera etapa: verificar caché intermedio</span></span>
<span id="cb2-496"><a href="#cb2-496" aria-hidden="true" tabindex="-1"></a>  output_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022.rds"</span>)</span>
<span id="cb2-497"><a href="#cb2-497" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-498"><a href="#cb2-498" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(output_path)) {</span>
<span id="cb2-499"><a href="#cb2-499" aria-hidden="true" tabindex="-1"></a>    datos_completos <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(output_path)</span>
<span id="cb2-500"><a href="#cb2-500" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-501"><a href="#cb2-501" aria-hidden="true" tabindex="-1"></a>    lista <span class="ot">&lt;-</span> <span class="fu">lapply</span>(archivos, read_top_file)</span>
<span id="cb2-502"><a href="#cb2-502" aria-hidden="true" tabindex="-1"></a>    lista <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="fu">Negate</span>(is.null), lista)</span>
<span id="cb2-503"><a href="#cb2-503" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(lista) <span class="sc">==</span> <span class="dv">0</span>L) <span class="fu">stop</span>(<span class="st">"No se encontró ningún archivo en: "</span>, base_path)</span>
<span id="cb2-504"><a href="#cb2-504" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-505"><a href="#cb2-505" aria-hidden="true" tabindex="-1"></a>    datos_completos <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">rbindlist</span>(lista, <span class="at">fill =</span> <span class="cn">TRUE</span>, <span class="at">use.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-506"><a href="#cb2-506" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-507"><a href="#cb2-507" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Repara mojibake en TODAS las columnas de texto (excepto hashkey)</span></span>
<span id="cb2-508"><a href="#cb2-508" aria-hidden="true" tabindex="-1"></a>    char_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_completos)[<span class="fu">vapply</span>(datos_completos, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb2-509"><a href="#cb2-509" aria-hidden="true" tabindex="-1"></a>    char_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(char_cols, <span class="st">"hashkey"</span>)</span>
<span id="cb2-510"><a href="#cb2-510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(char_cols)) {</span>
<span id="cb2-511"><a href="#cb2-511" aria-hidden="true" tabindex="-1"></a>      datos_completos[, (char_cols) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, fix_mojibake), .SDcols <span class="ot">=</span> char_cols]</span>
<span id="cb2-512"><a href="#cb2-512" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-513"><a href="#cb2-513" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-514"><a href="#cb2-514" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Candidatas por nombre y parseo de fechas</span></span>
<span id="cb2-515"><a href="#cb2-515" aria-hidden="true" tabindex="-1"></a>    posibles_fechas <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_completos)[<span class="fu">vapply</span>(<span class="fu">names</span>(datos_completos), is_date_like, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb2-516"><a href="#cb2-516" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> <span class="fu">intersect</span>(posibles_fechas, <span class="fu">names</span>(datos_completos))) {</span>
<span id="cb2-517"><a href="#cb2-517" aria-hidden="true" tabindex="-1"></a>      datos_completos[[col]] <span class="ot">&lt;-</span> <span class="fu">parse_mixed_dates</span>(datos_completos[[col]])</span>
<span id="cb2-518"><a href="#cb2-518" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-519"><a href="#cb2-519" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-520"><a href="#cb2-520" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Guarda cache crudo-limpio (antes de renombrados semánticos)</span></span>
<span id="cb2-521"><a href="#cb2-521" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(datos_completos, output_path)</span>
<span id="cb2-522"><a href="#cb2-522" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-523"><a href="#cb2-523" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-524"><a href="#cb2-524" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5) Renombrado semántico TOP (incluye dosis) ----------------------------</span></span>
<span id="cb2-525"><a href="#cb2-525" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-526"><a href="#cb2-526" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.1 HASHKEY mayúsculas, eliminar id</span></span>
<span id="cb2-527"><a href="#cb2-527" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"hashkey"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) {</span>
<span id="cb2-528"><a href="#cb2-528" aria-hidden="true" tabindex="-1"></a>    data.table<span class="sc">::</span><span class="fu">setnames</span>(datos_completos, <span class="st">"hashkey"</span>, <span class="st">"HASHKEY"</span>)</span>
<span id="cb2-529"><a href="#cb2-529" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="st">"hashkey"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos) <span class="sc">&amp;&amp;</span> <span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) {</span>
<span id="cb2-530"><a href="#cb2-530" aria-hidden="true" tabindex="-1"></a>    datos_completos[, HASHKEY <span class="sc">:</span><span class="er">=</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">as.character</span>(HASHKEY), <span class="fu">as.character</span>(hashkey))]</span>
<span id="cb2-531"><a href="#cb2-531" aria-hidden="true" tabindex="-1"></a>    datos_completos[, hashkey <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb2-532"><a href="#cb2-532" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-533"><a href="#cb2-533" aria-hidden="true" tabindex="-1"></a>  datos_completos[, HASHKEY <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(HASHKEY)]</span>
<span id="cb2-534"><a href="#cb2-534" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"id"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) datos_completos[, id <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb2-535"><a href="#cb2-535" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-536"><a href="#cb2-536" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.2 Mapeo estático (fechas, centros, sustancias totales, dominios sociales)</span></span>
<span id="cb2-537"><a href="#cb2-537" aria-hidden="true" tabindex="-1"></a>  rename_map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-538"><a href="#cb2-538" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fechas y cabecera TOP</span></span>
<span id="cb2-539"><a href="#cb2-539" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_aplicaci_af_a_n_top"</span>    <span class="ot">=</span> <span class="st">"fecha_aplicacion_top"</span>,</span>
<span id="cb2-540"><a href="#cb2-540" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nombre_apliacadordel_top"</span>     <span class="ot">=</span> <span class="st">"nombre_aplicador_top"</span>,</span>
<span id="cb2-541"><a href="#cb2-541" aria-hidden="true" tabindex="-1"></a>    <span class="st">"etapadel_tratamiento"</span>         <span class="ot">=</span> <span class="st">"etapa_tratamiento"</span>,</span>
<span id="cb2-542"><a href="#cb2-542" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fechade_ingresoa_tratamiento"</span> <span class="ot">=</span> <span class="st">"fecha_ingreso_tratamiento"</span>,</span>
<span id="cb2-543"><a href="#cb2-543" aria-hidden="true" tabindex="-1"></a>    <span class="st">"plande_tratamiento"</span>           <span class="ot">=</span> <span class="st">"plan_tratamiento"</span>,</span>
<span id="cb2-544"><a href="#cb2-544" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nombredel_centro"</span>             <span class="ot">=</span> <span class="st">"nombre_centro"</span>,</span>
<span id="cb2-545"><a href="#cb2-545" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tipo_centro"</span>                  <span class="ot">=</span> <span class="st">"tipo_centro"</span>,</span>
<span id="cb2-546"><a href="#cb2-546" aria-hidden="true" tabindex="-1"></a>    <span class="st">"regi_af_a_n_centro"</span>           <span class="ot">=</span> <span class="st">"region_centro"</span>,</span>
<span id="cb2-547"><a href="#cb2-547" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_nacimiento"</span>             <span class="ot">=</span> <span class="st">"fecha_nacimiento"</span>,</span>
<span id="cb2-548"><a href="#cb2-548" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_egreso"</span>                 <span class="ot">=</span> <span class="st">"fecha_egreso"</span>,</span>
<span id="cb2-549"><a href="#cb2-549" aria-hidden="true" tabindex="-1"></a>    <span class="st">"motivo_egreso"</span>                <span class="ot">=</span> <span class="st">"motivo_egreso"</span>,</span>
<span id="cb2-550"><a href="#cb2-550" aria-hidden="true" tabindex="-1"></a>    <span class="st">"evaluacion_proceso_terapeutico"</span> <span class="ot">=</span> <span class="st">"evaluacion_proceso_terapeutico"</span>,</span>
<span id="cb2-551"><a href="#cb2-551" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-552"><a href="#cb2-552" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sustancias (totales)</span></span>
<span id="cb2-553"><a href="#cb2-553" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_oh"</span>    <span class="ot">=</span> <span class="st">"total_alcohol"</span>,</span>
<span id="cb2-554"><a href="#cb2-554" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_thc"</span>   <span class="ot">=</span> <span class="st">"total_cannabis"</span>,</span>
<span id="cb2-555"><a href="#cb2-555" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_pbc"</span>   <span class="ot">=</span> <span class="st">"total_pasta_base"</span>,</span>
<span id="cb2-556"><a href="#cb2-556" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_coc"</span>   <span class="ot">=</span> <span class="st">"total_cocaina"</span>,</span>
<span id="cb2-557"><a href="#cb2-557" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_bzd"</span>   <span class="ot">=</span> <span class="st">"total_benzodiacepinas"</span>,</span>
<span id="cb2-558"><a href="#cb2-558" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_otra"</span>  <span class="ot">=</span> <span class="st">"total_otra_sustancia"</span>,</span>
<span id="cb2-559"><a href="#cb2-559" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-560"><a href="#cb2-560" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sustancia(s) principal(es)</span></span>
<span id="cb2-561"><a href="#cb2-561" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal1"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_1"</span>,</span>
<span id="cb2-562"><a href="#cb2-562" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal2"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_2"</span>,</span>
<span id="cb2-563"><a href="#cb2-563" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal3"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_3"</span>,</span>
<span id="cb2-564"><a href="#cb2-564" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-565"><a href="#cb2-565" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delitos / Transgresión</span></span>
<span id="cb2-566"><a href="#cb2-566" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hurto"</span>                   <span class="ot">=</span> <span class="st">"hurto"</span>,</span>
<span id="cb2-567"><a href="#cb2-567" aria-hidden="true" tabindex="-1"></a>    <span class="st">"robo"</span>                    <span class="ot">=</span> <span class="st">"robo"</span>,</span>
<span id="cb2-568"><a href="#cb2-568" aria-hidden="true" tabindex="-1"></a>    <span class="st">"venta_drogas"</span>            <span class="ot">=</span> <span class="st">"venta_de_drogas"</span>,</span>
<span id="cb2-569"><a href="#cb2-569" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ri_af_a_a"</span>               <span class="ot">=</span> <span class="st">"rina"</span>,</span>
<span id="cb2-570"><a href="#cb2-570" aria-hidden="true" tabindex="-1"></a>    <span class="st">"otro"</span>                    <span class="ot">=</span> <span class="st">"otro_delito"</span>,</span>
<span id="cb2-571"><a href="#cb2-571" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_vif"</span>               <span class="ot">=</span> <span class="st">"total_violencia_intrafamiliar"</span>,</span>
<span id="cb2-572"><a href="#cb2-572" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_transgresi_af_a_n"</span> <span class="ot">=</span> <span class="st">"total_transgresion"</span>,</span>
<span id="cb2-573"><a href="#cb2-573" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-574"><a href="#cb2-574" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Salud y funcionamiento social</span></span>
<span id="cb2-575"><a href="#cb2-575" aria-hidden="true" tabindex="-1"></a>    <span class="st">"salud_psicol_af_a_gica"</span>  <span class="ot">=</span> <span class="st">"salud_psicologica"</span>,</span>
<span id="cb2-576"><a href="#cb2-576" aria-hidden="true" tabindex="-1"></a>    <span class="st">"salud_f_af_a_sica"</span>       <span class="ot">=</span> <span class="st">"salud_fisica"</span>,</span>
<span id="cb2-577"><a href="#cb2-577" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_trabajo"</span>           <span class="ot">=</span> <span class="st">"total_trabajo"</span>,</span>
<span id="cb2-578"><a href="#cb2-578" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_educaci_af_a_n"</span>    <span class="ot">=</span> <span class="st">"total_educacion"</span>,</span>
<span id="cb2-579"><a href="#cb2-579" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-580"><a href="#cb2-580" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vivienda / Calidad de vida</span></span>
<span id="cb2-581"><a href="#cb2-581" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lugar_vivir"</span>             <span class="ot">=</span> <span class="st">"lugar_donde_vive"</span>,</span>
<span id="cb2-582"><a href="#cb2-582" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vivienda"</span>                <span class="ot">=</span> <span class="st">"tipo_vivienda"</span>,</span>
<span id="cb2-583"><a href="#cb2-583" aria-hidden="true" tabindex="-1"></a>    <span class="st">"calidad_vida"</span>            <span class="ot">=</span> <span class="st">"calidad_de_vida"</span></span>
<span id="cb2-584"><a href="#cb2-584" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-585"><a href="#cb2-585" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-586"><a href="#cb2-586" aria-hidden="true" tabindex="-1"></a>  existentes <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(rename_map), <span class="fu">names</span>(datos_completos))</span>
<span id="cb2-587"><a href="#cb2-587" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(existentes)) data.table<span class="sc">::</span><span class="fu">setnames</span>(datos_completos, existentes, <span class="fu">unname</span>(rename_map[existentes]))</span>
<span id="cb2-588"><a href="#cb2-588" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-589"><a href="#cb2-589" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.3 Renombrado dinámico de dosis (todas las d_af_a_sis_*)</span></span>
<span id="cb2-590"><a href="#cb2-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_dosis_cols</span>(datos_completos)</span>
<span id="cb2-591"><a href="#cb2-591" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-592"><a href="#cb2-592" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.4 Reordenar: HASHKEY y year primero</span></span>
<span id="cb2-593"><a href="#cb2-593" aria-hidden="true" tabindex="-1"></a>  primero <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"HASHKEY"</span>, <span class="st">"year"</span>)</span>
<span id="cb2-594"><a href="#cb2-594" aria-hidden="true" tabindex="-1"></a>  primero <span class="ot">&lt;-</span> primero[primero <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)]</span>
<span id="cb2-595"><a href="#cb2-595" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setcolorder</span>(datos_completos, <span class="fu">c</span>(primero, <span class="fu">setdiff</span>(<span class="fu">names</span>(datos_completos), primero)))</span>
<span id="cb2-596"><a href="#cb2-596" aria-hidden="true" tabindex="-1"></a>  datos_completos <span class="ot">&lt;-</span> datos_completos <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>nombre_aplicador_top, <span class="sc">-</span>source_file)</span>
<span id="cb2-597"><a href="#cb2-597" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-598"><a href="#cb2-598" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-599"><a href="#cb2-599" aria-hidden="true" tabindex="-1"></a>  <span class="co"># USO (fase 1: casteo)</span></span>
<span id="cb2-600"><a href="#cb2-600" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-601"><a href="#cb2-601" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> <span class="fu">clean_cast_dataset</span>(</span>
<span id="cb2-602"><a href="#cb2-602" aria-hidden="true" tabindex="-1"></a>    datos_completos,</span>
<span id="cb2-603"><a href="#cb2-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="st">"HASHKEY"</span>,</span>
<span id="cb2-604"><a href="#cb2-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">numeric_threshold =</span> <span class="fl">0.90</span>,</span>
<span id="cb2-605"><a href="#cb2-605" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb2-606"><a href="#cb2-606" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-607"><a href="#cb2-607" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-608"><a href="#cb2-608" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-609"><a href="#cb2-609" aria-hidden="true" tabindex="-1"></a>  <span class="co"># USO (fase 2: recodificación)</span></span>
<span id="cb2-610"><a href="#cb2-610" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-611"><a href="#cb2-611" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> <span class="fu">limpiar_caracteres_y_recodificar</span>(datos_limpios)</span>
<span id="cb2-612"><a href="#cb2-612" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-613"><a href="#cb2-613" aria-hidden="true" tabindex="-1"></a>  targets <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sustancia_principal_2"</span>,<span class="st">"sustancia_principal_3"</span>)</span>
<span id="cb2-614"><a href="#cb2-614" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-615"><a href="#cb2-615" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> datos_limpios <span class="sc">%&gt;%</span></span>
<span id="cb2-616"><a href="#cb2-616" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(targets), \(x) {</span>
<span id="cb2-617"><a href="#cb2-617" aria-hidden="true" tabindex="-1"></a>      x_chr <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb2-618"><a href="#cb2-618" aria-hidden="true" tabindex="-1"></a>      to_na <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^(?i)</span><span class="sc">\\</span><span class="st">s*sin</span><span class="sc">\\</span><span class="st">s+consumo</span><span class="sc">\\</span><span class="st">s*$"</span>, x_chr, <span class="at">perl =</span> <span class="cn">TRUE</span>) <span class="sc">|</span></span>
<span id="cb2-619"><a href="#cb2-619" aria-hidden="true" tabindex="-1"></a>               <span class="fu">grepl</span>(<span class="st">"^(?i)</span><span class="sc">\\</span><span class="st">s*sin</span><span class="sc">\\</span><span class="st">s+sustancia</span><span class="sc">\\</span><span class="st">s+principal(</span><span class="sc">\\</span><span class="st">s*</span><span class="sc">\\</span><span class="st">)?</span><span class="sc">\\</span><span class="st">s*)?$"</span>, x_chr, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-620"><a href="#cb2-620" aria-hidden="true" tabindex="-1"></a>      x_chr[to_na] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb2-621"><a href="#cb2-621" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(x_chr)</span>
<span id="cb2-622"><a href="#cb2-622" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb2-623"><a href="#cb2-623" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-624"><a href="#cb2-624" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asignar resultado final</span></span>
<span id="cb2-625"><a href="#cb2-625" aria-hidden="true" tabindex="-1"></a>  datos_final <span class="ot">&lt;-</span> datos_limpios</span>
<span id="cb2-626"><a href="#cb2-626" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-627"><a href="#cb2-627" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar RDS final</span></span>
<span id="cb2-628"><a href="#cb2-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(datos_final, output_rds)</span>
<span id="cb2-629"><a href="#cb2-629" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-630"><a href="#cb2-630" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar Excel</span></span>
<span id="cb2-631"><a href="#cb2-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb2-632"><a href="#cb2-632" aria-hidden="true" tabindex="-1"></a>    datos_excel <span class="ot">&lt;-</span> datos_final</span>
<span id="cb2-633"><a href="#cb2-633" aria-hidden="true" tabindex="-1"></a>    factor_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_excel)[<span class="fu">sapply</span>(datos_excel, is.factor)]</span>
<span id="cb2-634"><a href="#cb2-634" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> factor_cols) {</span>
<span id="cb2-635"><a href="#cb2-635" aria-hidden="true" tabindex="-1"></a>      datos_excel[[col]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(datos_excel[[col]])</span>
<span id="cb2-636"><a href="#cb2-636" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-637"><a href="#cb2-637" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-638"><a href="#cb2-638" aria-hidden="true" tabindex="-1"></a>    wb <span class="ot">&lt;-</span> openxlsx<span class="sc">::</span><span class="fu">createWorkbook</span>()</span>
<span id="cb2-639"><a href="#cb2-639" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">addWorksheet</span>(wb, <span class="st">"Datos_TOP_2015_2022"</span>)</span>
<span id="cb2-640"><a href="#cb2-640" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">writeDataTable</span>(wb, <span class="at">sheet =</span> <span class="dv">1</span>, <span class="at">x =</span> datos_excel, <span class="at">tableStyle =</span> <span class="st">"TableStyleLight1"</span>)</span>
<span id="cb2-641"><a href="#cb2-641" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">setColWidths</span>(wb, <span class="at">sheet =</span> <span class="dv">1</span>, <span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(datos_excel), <span class="at">widths =</span> <span class="st">"auto"</span>)</span>
<span id="cb2-642"><a href="#cb2-642" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">saveWorkbook</span>(wb, output_excel, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-643"><a href="#cb2-643" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb2-644"><a href="#cb2-644" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(datos_final, <span class="fu">gsub</span>(<span class="st">".xlsx$"</span>, <span class="st">".csv"</span>, output_excel), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-645"><a href="#cb2-645" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-646"><a href="#cb2-646" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-647"><a href="#cb2-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-648"><a href="#cb2-648" aria-hidden="true" tabindex="-1"></a><span class="co"># Datos finales disponibles en el objeto: datos_final</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="introducción-y-objetivos" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> 1. Introducción y Objetivos</h1>
<p>Este análisis examina las redes psicométricas del Treatment Outcome Profile (TOP) en contexto longitudinal, evaluando la evolución de las relaciones entre consumo de sustancias, salud, inclusión social y riesgo durante el tratamiento de rehabilitación.</p>
<section id="hipótesis-de-investigación" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="hipótesis-de-investigación"><span class="header-section-number">3.1</span> 1.1 Hipótesis de Investigación</h2>
<p><strong>H1</strong>: La densidad de la red (fuerza global) disminuye significativamente entre el ingreso y los 6-12 meses de tratamiento, reflejando una desacoplación de síntomas.</p>
<p><strong>H2</strong>: Las variables de salud (psicológica/física) aumentan su centralidad de puente entre dominios al avanzar el tratamiento.</p>
<p><strong>H3</strong>: Los cambios en consumo de sustancias entre etapas predicen cambios en salud y calidad de vida (análisis de transiciones).</p>
<p><strong>H4</strong>: Existen trayectorias heterogéneas de cambio identificables mediante modelos mixtos lineales.</p>
</section>
</section>
<section id="preparación-de-datos" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> 2. Preparación de Datos</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir nodos por dominio temático siguiendo el TOP completo</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sección 1: Uso de sustancias (días de consumo en últimas 4 semanas)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>vars_uso <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Alcohol"</span>, <span class="st">"Cannabis"</span>, <span class="st">"Pasta Base"</span>, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Cocaína"</span>, <span class="st">"Benzodiacepinas"</span>, <span class="st">"Otra Sustancia"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Sección 2: Transgresión de normas sociales</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>vars_transgresion <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Hurto"</span>, <span class="st">"Robo"</span>, <span class="st">"Venta de Drogas"</span>, </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Riña"</span>, <span class="st">"Violencia Intrafamiliar"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Sección 3: Salud y funcionamiento social  </span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>vars_salud <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Salud Psicológica"</span>, <span class="st">"Salud Física"</span>, <span class="st">"Calidad de Vida"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>vars_funcionamiento <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Días Trabajo"</span>, <span class="st">"Días Educación"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Vector con todos los nodos del TOP</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>nodes_all <span class="ot">&lt;-</span> <span class="fu">c</span>(vars_uso, vars_transgresion, vars_salud, vars_funcionamiento)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos con etapas estandarizadas y conversión de variables categóricas</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># NOTA: Ajustar nombres de columnas en datos_final para que coincidan con el formato TOP</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>dat_analysis <span class="ot">&lt;-</span> datos_final <span class="sc">%&gt;%</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Renombrar columnas para coincidir con formato TOP</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alcohol"</span> <span class="ot">=</span> total_alcohol,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cannabis"</span> <span class="ot">=</span> total_cannabis,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pasta Base"</span> <span class="ot">=</span> total_pasta_base,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cocaína"</span> <span class="ot">=</span> total_cocaina,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Benzodiacepinas"</span> <span class="ot">=</span> total_benzodiacepinas,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Otra Sustancia"</span> <span class="ot">=</span> total_otra_sustancia,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hurto"</span> <span class="ot">=</span> hurto,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Robo"</span> <span class="ot">=</span> robo,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Venta de Drogas"</span> <span class="ot">=</span> venta_de_drogas,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Riña"</span> <span class="ot">=</span> rina,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Violencia Intrafamiliar"</span> <span class="ot">=</span> total_violencia_intrafamiliar,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Salud Psicológica"</span> <span class="ot">=</span> salud_psicologica,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Salud Física"</span> <span class="ot">=</span> salud_fisica,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calidad de Vida"</span> <span class="ot">=</span> calidad_de_vida,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Días Trabajo"</span> <span class="ot">=</span> total_trabajo,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Días Educación"</span> <span class="ot">=</span> total_educacion</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convertir variables categóricas Sí/No a numéricas (1/0)</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hurto =</span> <span class="fu">ifelse</span>(Hurto <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">Robo =</span> <span class="fu">ifelse</span>(Robo <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Venta de Drogas</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">Venta de Drogas</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    Riña <span class="ot">=</span> <span class="fu">ifelse</span>(Riña <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estandarizar nombres de etapas</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">etapa_std =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"(?i)inicio"</span>) <span class="sc">~</span> <span class="st">"Inicio"</span>,</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"3"</span>) <span class="sc">~</span> <span class="st">"3m"</span>,</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"6"</span>) <span class="sc">~</span> <span class="st">"6m"</span>,</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"9"</span>) <span class="sc">~</span> <span class="st">"9m"</span>,</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"12"</span>) <span class="sc">~</span> <span class="st">"12m"</span>,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convertir etapas a tiempo numérico (meses)</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">tiempo_num =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"Inicio"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"3m"</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"6m"</span> <span class="sc">~</span> <span class="dv">6</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"9m"</span> <span class="sc">~</span> <span class="dv">9</span>,</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"12m"</span> <span class="sc">~</span> <span class="dv">12</span>,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(etapa_std)) <span class="sc">%&gt;%</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(HASHKEY, etapa_std, tiempo_num, <span class="fu">all_of</span>(nodes_all)) <span class="sc">%&gt;%</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(<span class="fu">any_of</span>(vars_salud))</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla resumen de datos</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>resumen_datos <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Métrica</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Total observaciones"</span>, <span class="st">"Pacientes únicos"</span>),</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Valor</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(dat_analysis), <span class="fu">n_distinct</span>(dat_analysis<span class="sc">$</span>HASHKEY)),</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>resumen_datos <span class="sc">%&gt;%</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Dimensiones del dataset"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Dimensiones del dataset</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Métrica</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Valor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total observaciones</td>
<td style="text-align: right;">167404</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pacientes únicos</td>
<td style="text-align: right;">56998</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribución por etapa</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>distribucion_etapas <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">table</span>(dat_analysis<span class="sc">$</span>etapa_std))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(distribucion_etapas) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Etapa"</span>, <span class="st">"Número de observaciones"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>distribucion_etapas <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Distribución de observaciones por etapa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Distribución de observaciones por etapa</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Número de observaciones</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: right;">8726</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: right;">44588</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: right;">25455</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: right;">15205</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: right;">73430</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="análisis-de-redes-transversales-por-etapa" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> 3. Análisis de Redes Transversales por Etapa</h1>
<section id="estimación-de-redes" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="estimación-de-redes"><span class="header-section-number">5.1</span> 3.1 Estimación de Redes</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para estimar red por etapa</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>estimate_stage_network <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage, nodes) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filtrar datos de la etapa específica</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  stage_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>])) <span class="co"># Estandarizar variables</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar tamaño mínimo de muestra</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stage_data) <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimar red con EBIC-glasso</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimateNetwork</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    stage_data,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"EBICglasso"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">corMethod =</span> <span class="st">"cor_auto"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuning =</span> <span class="fl">0.5</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="cn">TRUE</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimar redes para cada etapa temporal</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>stages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>networks_by_stage <span class="ot">&lt;-</span> <span class="fu">map</span>(stages, <span class="sc">~</span><span class="fu">estimate_stage_network</span>(dat_analysis, .x, nodes_all))</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(networks_by_stage) <span class="ot">&lt;-</span> stages</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar redes NULL</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>networks_by_stage <span class="ot">&lt;-</span> networks_by_stage[<span class="sc">!</span><span class="fu">sapply</span>(networks_by_stage, is.null)]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar resumen de redes estimadas</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>resumen_redes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">names</span>(networks_by_stage),</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Red estimada</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Sí"</span>,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="visualización-de-redes---inicio" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="visualización-de-redes---inicio"><span class="header-section-number">5.2</span> 3.2 Visualización de Redes - Inicio</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Red al inicio del tratamiento</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"Inicio"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"Inicio"</span>]]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular strength (fuerza) de cada nodo</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear grafo con valores absolutos para el layout</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Grafo real con pesos originales</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular coordenadas del layout</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aplicar coordenadas al grafo</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear visualización con leyenda mejorada</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red al INICIO del tratamiento"</span>,</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"Inicio"</span>)))) <span class="sc">+</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/visualize-network-inicio-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-redes---3-meses" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="visualización-de-redes---3-meses"><span class="header-section-number">5.3</span> 3.3 Visualización de Redes - 3 meses</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Red a los 3 meses de tratamiento</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"3m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"3m"</span>]]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 3 MESES de tratamiento"</span>,</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"3m"</span>)))) <span class="sc">+</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/visualize-network-3m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-redes---6-meses" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="visualización-de-redes---6-meses"><span class="header-section-number">5.4</span> 3.4 Visualización de Redes - 6 meses</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Red a los 6 meses de tratamiento</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"6m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"6m"</span>]]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 6 MESES de tratamiento"</span>,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"6m"</span>)))) <span class="sc">+</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/visualize-network-6m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-redes---9-meses" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="visualización-de-redes---9-meses"><span class="header-section-number">5.5</span> 3.5 Visualización de Redes - 9 meses</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Red a los 9 meses de tratamiento</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"9m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"9m"</span>]]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 9 MESES de tratamiento"</span>,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"9m"</span>)))) <span class="sc">+</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/visualize-network-9m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-redes---12-meses" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="visualización-de-redes---12-meses"><span class="header-section-number">5.6</span> 3.6 Visualización de Redes - 12 meses</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Red a los 12 meses de tratamiento</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"12m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"12m"</span>]]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 12 MESES de tratamiento"</span>,</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"12m"</span>)))) <span class="sc">+</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/visualize-network-12m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="métricas-de-red" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> 4. Métricas de Red</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular métricas de red</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>calculate_network_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(net, stage_name) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(net)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear grafos con pesos absolutos y sin pesos</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  g_weighted <span class="ot">&lt;-</span> <span class="fu">graph_from_adjacency_matrix</span>(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(<span class="fu">as.matrix</span>(net<span class="sc">$</span>graph)),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">"undirected"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted =</span> <span class="cn">TRUE</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  g_unweighted <span class="ot">&lt;-</span> <span class="fu">graph_from_adjacency_matrix</span>(</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>(net<span class="sc">$</span>graph <span class="sc">!=</span> <span class="dv">0</span>),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">"undirected"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted =</span> <span class="cn">NULL</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas globales de la red</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  global_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodos</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">vcount</span>(g_weighted),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Aristas</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ecount</span>(g_weighted),</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Densidad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">edge_density</span>(g_unweighted),</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph)),</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Longitud promedio</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean_distance</span>(g_unweighted),</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Coeficiente agrupamiento</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">transitivity</span>(g_unweighted, <span class="at">type =</span> <span class="st">"global"</span>),</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Modularidad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">modularity</span>(<span class="fu">cluster_louvain</span>(g_weighted)),</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA_real_</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas por nodo</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  node_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">degree</span>(g_unweighted),</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph)),</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Intermediación</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">betweenness</span>(g_unweighted, <span class="at">normalized =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Cercanía</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">closeness</span>(g_unweighted, <span class="at">normalized =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Centralidad eigenvector</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">eigen_centrality</span>(g_weighted)<span class="sc">$</span>vector,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="fu">vcount</span>(g_weighted))</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">global =</span> global_metrics, <span class="at">nodes =</span> node_metrics)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular métricas para todas las etapas</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>all_metrics <span class="ot">&lt;-</span> <span class="fu">map2</span>(networks_by_stage, <span class="fu">names</span>(networks_by_stage), </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                    calculate_network_metrics)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Combinar métricas globales</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>global_metrics_df <span class="ot">&lt;-</span> <span class="fu">map_df</span>(all_metrics, <span class="st">"global"</span>)</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar tabla de métricas globales</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>global_metrics_df <span class="sc">%&gt;%</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Propiedades globales de red por etapa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Propiedades globales de red por etapa</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Nodos</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Aristas</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Densidad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Fuerza global</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Longitud promedio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Coeficiente agrupamiento</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Modularidad</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">0.575</td>
<td style="text-align: right;">10.187</td>
<td style="text-align: right;">1.442</td>
<td style="text-align: right;">0.669</td>
<td style="text-align: right;">0.313</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">0.442</td>
<td style="text-align: right;">9.052</td>
<td style="text-align: right;">1.642</td>
<td style="text-align: right;">0.581</td>
<td style="text-align: right;">0.380</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">0.383</td>
<td style="text-align: right;">8.552</td>
<td style="text-align: right;">1.800</td>
<td style="text-align: right;">0.571</td>
<td style="text-align: right;">0.415</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">0.325</td>
<td style="text-align: right;">8.068</td>
<td style="text-align: right;">2.050</td>
<td style="text-align: right;">0.538</td>
<td style="text-align: right;">0.441</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">0.267</td>
<td style="text-align: right;">8.298</td>
<td style="text-align: right;">2.065</td>
<td style="text-align: right;">0.550</td>
<td style="text-align: right;">0.479</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="evolución-de-métricas" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="evolución-de-métricas"><span class="header-section-number">6.1</span> 4.1 Evolución de Métricas</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos para visualización</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>metrics_long <span class="ot">&lt;-</span> global_metrics_df <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>, <span class="st">`</span><span class="at">Fuerza global</span><span class="st">`</span>, <span class="st">`</span><span class="at">Densidad</span><span class="st">`</span>, <span class="st">`</span><span class="at">Coeficiente agrupamiento</span><span class="st">`</span>, <span class="st">`</span><span class="at">Longitud promedio</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>, <span class="at">names_to =</span> <span class="st">"Métrica"</span>, <span class="at">values_to =</span> <span class="st">"Valor"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Etapa =</span> <span class="fu">factor</span>(Etapa, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráfico de evolución de métricas</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(metrics_long, <span class="fu">aes</span>(<span class="at">x =</span> Etapa, <span class="at">y =</span> Valor, <span class="at">group =</span> Métrica, <span class="at">color =</span> Métrica)) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Métrica, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Evolución de métricas de red durante el tratamiento"</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Etapa de tratamiento"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Valor"</span>) <span class="sc">+</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/metrics-evolution-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="análisis-de-nodos-puente" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> 5. Análisis de Nodos Puente</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular bridge expected influence</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>calculate_bridges <span class="ot">&lt;-</span> <span class="cf">function</span>(net, stage_name) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(net)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Definir comunidades por dominio</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  node_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  comm_vector <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular métricas de puente</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  bridge_result <span class="ot">&lt;-</span> <span class="fu">bridge</span>(net<span class="sc">$</span>graph, <span class="at">communities =</span> comm_vector)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodo</span><span class="st">`</span> <span class="ot">=</span> node_names,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comunidad</span><span class="st">`</span> <span class="ot">=</span> comm_vector,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza puente</span><span class="st">`</span> <span class="ot">=</span> bridge_result<span class="sc">$</span><span class="st">`</span><span class="at">Bridge Strength</span><span class="st">`</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span> <span class="ot">=</span> bridge_result<span class="sc">$</span><span class="st">`</span><span class="at">Bridge Expected Influence (1-step)</span><span class="st">`</span>,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular para todas las etapas</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>bridge_metrics <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(networks_by_stage, <span class="fu">names</span>(networks_by_stage), </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                          calculate_bridges)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Top 3 nodos puente por etapa</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>bridge_metrics <span class="sc">%&gt;%</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">3</span>, <span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>, <span class="fu">desc</span>(<span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Top 3 nodos puente por etapa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Top 3 nodos puente por etapa</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Nodo</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Comunidad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Fuerza puente</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Influencia puente esperada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.169</td>
<td style="text-align: right;">0.169</td>
</tr>
<tr class="even">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Hurto</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.115</td>
<td style="text-align: right;">0.115</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Benzodiacepinas</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.080</td>
<td style="text-align: right;">0.080</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: left;">Funcionamiento</td>
<td style="text-align: right;">0.308</td>
<td style="text-align: right;">0.164</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Cannabis</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.207</td>
<td style="text-align: right;">0.136</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.455</td>
<td style="text-align: right;">0.124</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Cannabis</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.189</td>
<td style="text-align: right;">0.116</td>
</tr>
<tr class="even">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: left;">Funcionamiento</td>
<td style="text-align: right;">0.239</td>
<td style="text-align: right;">0.106</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.173</td>
<td style="text-align: right;">0.080</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.378</td>
<td style="text-align: right;">0.157</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Hurto</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.130</td>
<td style="text-align: right;">0.130</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: left;">Funcionamiento</td>
<td style="text-align: right;">0.114</td>
<td style="text-align: right;">0.114</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Venta de Drogas</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.198</td>
<td style="text-align: right;">0.198</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Cannabis</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.250</td>
<td style="text-align: right;">0.184</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.260</td>
<td style="text-align: right;">0.168</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="comparación-de-redes-nct" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> 6. Comparación de Redes (NCT)</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para Network Comparison Test entre etapas</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>perform_nct <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes, <span class="at">iterations =</span> <span class="dv">1000</span>) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Preparar datos de cada etapa</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  data1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  data2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar tamaño mínimo</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(data1) <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">||</span> <span class="fu">nrow</span>(data2) <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ejecutar NCT sin barra de progreso</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NCT</span>(data1, data2, </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">it =</span> iterations,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">binary.data =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">paired =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">test.edges =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">edges =</span> <span class="st">"all"</span>,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">progressbar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparaciones clave con manejo de errores</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>nct_inicio_6m <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perform_nct</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"6m"</span>, nodes_all, <span class="dv">500</span>),</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>nct_inicio_12m <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perform_nct</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"12m"</span>, nodes_all, <span class="dv">500</span>),</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla de resultados NCT</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>nct_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_6m)) {</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nct_results, <span class="fu">data.frame</span>(</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Inicio vs 6 meses"</span>,</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>glstrinv.real,</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>glstrinv.pval,</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>nwinv.real,</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>nwinv.pval,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_12m)) {</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nct_results, <span class="fu">data.frame</span>(</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Inicio vs 12 meses"</span>,</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>glstrinv.real,</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>glstrinv.pval,</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>nwinv.real,</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>nwinv.pval,</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar resultados NCT</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(nct_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="sc">%&gt;%</span></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Resultados del Network Comparison Test"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Resultados del Network Comparison Test</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Comparación</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Diferencia fuerza global</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p-value fuerza</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Diferencia estructura</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p-value estructura</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio vs 6 meses</td>
<td style="text-align: right;">0.591</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">0.082</td>
<td style="text-align: right;">0.002</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio vs 12 meses</td>
<td style="text-align: right;">0.829</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">0.262</td>
<td style="text-align: right;">0.002</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="redes-de-cambio" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> 7. Redes de Cambio</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular cambios entre etapas</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>calculate_changes <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identificar pacientes con datos en ambas etapas</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  has_stage1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  has_stage2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solo pacientes presentes en ambas etapas</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  ids_both <span class="ot">&lt;-</span> <span class="fu">intersect</span>(has_stage1, has_stage2)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(ids_both) <span class="sc">&lt;</span> <span class="dv">30</span>) {</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Datos pareados - un registro por paciente por etapa</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificaciones de consistencia</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(d1) <span class="sc">!=</span> <span class="fu">nrow</span>(d2) <span class="sc">||</span> <span class="sc">!</span><span class="fu">identical</span>(d1<span class="sc">$</span>HASHKEY, d2<span class="sc">$</span>HASHKEY)) {</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular cambios</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  changes <span class="ot">&lt;-</span> d2[, <span class="sc">-</span><span class="dv">1</span>] <span class="sc">-</span> d1[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimar red de cambios</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  change_net <span class="ot">&lt;-</span> <span class="fu">estimateNetwork</span>(</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    changes <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>])),</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"EBICglasso"</span>,</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuning =</span> <span class="fl">0.5</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">network =</span> change_net, <span class="at">n =</span> <span class="fu">nrow</span>(d1), <span class="at">data =</span> changes)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular para transiciones clave</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>transitions <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Inicio→3m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"3m"</span>, nodes_all),</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3m→6m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"3m"</span>, <span class="st">"6m"</span>, nodes_all),</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">"6m→12m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"6m"</span>, <span class="st">"12m"</span>, nodes_all)</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar resumen de redes de cambio</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>transition_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Transición</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">names</span>(transitions),</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N pacientes</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(transitions, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x), <span class="dv">0</span>, x<span class="sc">$</span>n)),</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Red estimada</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(transitions, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x), <span class="st">"No"</span>, <span class="st">"Sí"</span>)),</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>transition_summary <span class="sc">%&gt;%</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Resumen de redes de cambio"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Resumen de redes de cambio</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Transición</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">N pacientes</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Red estimada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio→3m</td>
<td style="text-align: left;">Inicio→3m</td>
<td style="text-align: right;">37111</td>
<td style="text-align: left;">Sí</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m→6m</td>
<td style="text-align: left;">3m→6m</td>
<td style="text-align: right;">22583</td>
<td style="text-align: left;">Sí</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m→12m</td>
<td style="text-align: left;">6m→12m</td>
<td style="text-align: right;">8193</td>
<td style="text-align: left;">Sí</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="visualización-red-de-cambios-inicio-3-meses" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="visualización-red-de-cambios-inicio-3-meses"><span class="header-section-number">9.1</span> 7.1 Visualización Red de Cambios: Inicio → 3 meses</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizar red de cambio Inicio → 3m</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"Inicio→3m"</span>]]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: Inicio → 3 meses"</span>,</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/change-network-inicio-3m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-red-de-cambios-3-6-meses" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="visualización-red-de-cambios-3-6-meses"><span class="header-section-number">9.2</span> 7.2 Visualización Red de Cambios: 3 → 6 meses</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizar red de cambio 3m → 6m</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"3m→6m"</span>]]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: 3 → 6 meses"</span>,</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/change-network-3m-6m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-red-de-cambios-6-12-meses" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="visualización-red-de-cambios-6-12-meses"><span class="header-section-number">9.3</span> 7.3 Visualización Red de Cambios: 6 → 12 meses</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizar red de cambio 6m → 12m</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"6m→12m"</span>]]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: 6 → 12 meses"</span>,</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"left"</span>,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/change-network-6m-12m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="modelos-mixtos-lineales" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> 8. Modelos Mixtos Lineales</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos en formato largo para modelos mixtos</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> dat_analysis <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(tiempo_num)) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Solo pacientes con al menos 2 mediciones</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 1: Predictores de salud psicológica</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>model_salud_psic <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (Alcohol <span class="sc">+</span> Cannabis <span class="sc">+</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>                                      Cocaína <span class="sc">+</span> <span class="st">`</span><span class="at">Pasta Base</span><span class="st">`</span> <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>                                      Riña <span class="sc">+</span> <span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>                        (<span class="dv">1</span> <span class="sc">+</span> tiempo_num <span class="sc">|</span> HASHKEY),</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_long,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">REML =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>, <span class="at">optCtrl =</span> <span class="fu">list</span>(<span class="at">maxfun =</span> <span class="fl">2e5</span>))</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar convergencia y singularidad</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">isSingular</span>(mod)) {</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplificar a solo intercepto aleatorio</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (Alcohol <span class="sc">+</span> Cannabis <span class="sc">+</span> </span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>                                        Cocaína <span class="sc">+</span> <span class="st">`</span><span class="at">Pasta Base</span><span class="st">`</span> <span class="sc">+</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                                        Riña <span class="sc">+</span> <span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                          (<span class="dv">1</span> <span class="sc">|</span> HASHKEY),</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat_long,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">REML =</span> <span class="cn">FALSE</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  mod</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 2: Predictores de calidad de vida</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>model_calidad <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Calidad de Vida</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (<span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">Salud Física</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">Días Trabajo</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">Días Educación</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>                   (<span class="dv">1</span> <span class="sc">+</span> tiempo_num <span class="sc">|</span> HASHKEY),</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat_long,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">REML =</span> <span class="cn">FALSE</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados Modelo 1</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic)) {</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Procesar resultados y traducir nombres</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>  tabla_modelo1 <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_salud_psic) <span class="sc">%&gt;%</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>effect, <span class="sc">-</span>group) <span class="sc">%&gt;%</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercepto"</span>,</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"tiempo_num"</span> <span class="sc">~</span> <span class="st">"Tiempo (meses)"</span>,</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Alcohol"</span> <span class="sc">~</span> <span class="st">"Alcohol"</span>,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Cannabis"</span> <span class="sc">~</span> <span class="st">"Cannabis"</span>,</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Cocaína"</span> <span class="sc">~</span> <span class="st">"Cocaína"</span>,</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"`Pasta Base`"</span> <span class="sc">~</span> <span class="st">"Pasta Base"</span>,</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Riña"</span> <span class="sc">~</span> <span class="st">"Riña"</span>,</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"`Violencia Intrafamiliar`"</span> <span class="sc">~</span> <span class="st">"Violencia Intrafamiliar"</span>,</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Alcohol"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Alcohol"</span>,</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Cannabis"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Cannabis"</span>,</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Cocaína"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Cocaína"</span>,</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Pasta Base`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Pasta Base"</span>,</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Riña"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Riña"</span>,</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Violencia"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Violencia Intrafamiliar"</span>,</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Renombrar columnas al español</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(tabla_modelo1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Estimación"</span>, <span class="st">"Error estándar"</span>, </span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Estadístico"</span>, <span class="st">"GL"</span>, <span class="st">"Valor p"</span>)</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>  tabla_modelo1 <span class="sc">%&gt;%</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Modelo: Predictores de salud psicológica"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Modelo: Predictores de salud psicológica</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimación</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Error estándar</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estadístico</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">GL</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Valor p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercepto</td>
<td style="text-align: right;">12.262</td>
<td style="text-align: right;">0.021</td>
<td style="text-align: right;">571.256</td>
<td style="text-align: right;">52225.20</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo (meses)</td>
<td style="text-align: right;">0.326</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">90.615</td>
<td style="text-align: right;">24798.56</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Alcohol</td>
<td style="text-align: right;">-0.111</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">-54.324</td>
<td style="text-align: right;">109114.58</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cannabis</td>
<td style="text-align: right;">-0.023</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">-11.702</td>
<td style="text-align: right;">93520.31</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cocaína</td>
<td style="text-align: right;">-0.132</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">-40.287</td>
<td style="text-align: right;">105732.34</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: right;">-0.114</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">-53.916</td>
<td style="text-align: right;">105208.85</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Riña</td>
<td style="text-align: right;">-0.992</td>
<td style="text-align: right;">0.056</td>
<td style="text-align: right;">-17.761</td>
<td style="text-align: right;">120336.69</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Violencia Intrafamiliar</td>
<td style="text-align: right;">-0.123</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-30.666</td>
<td style="text-align: right;">119469.00</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Alcohol</td>
<td style="text-align: right;">-0.008</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-15.173</td>
<td style="text-align: right;">61431.49</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Cannabis</td>
<td style="text-align: right;">-0.001</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-2.603</td>
<td style="text-align: right;">41177.82</td>
<td style="text-align: right;">0.009</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Cocaína</td>
<td style="text-align: right;">-0.010</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-8.558</td>
<td style="text-align: right;">59652.24</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Pasta Base</td>
<td style="text-align: right;">-0.011</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-14.781</td>
<td style="text-align: right;">68298.86</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Riña</td>
<td style="text-align: right;">-0.067</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">-4.222</td>
<td style="text-align: right;">100529.46</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Violencia Intrafamiliar</td>
<td style="text-align: right;">-0.005</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-4.012</td>
<td style="text-align: right;">88905.32</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados Modelo 2</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>tabla_modelo2 <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_calidad) <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>effect, <span class="sc">-</span>group) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercepto"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"tiempo_num"</span> <span class="sc">~</span> <span class="st">"Tiempo (meses)"</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Salud Psicológica`"</span> <span class="sc">~</span> <span class="st">"Salud Psicológica"</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Salud Física`"</span> <span class="sc">~</span> <span class="st">"Salud Física"</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Días Trabajo`"</span> <span class="sc">~</span> <span class="st">"Días Trabajo"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Días Educación`"</span> <span class="sc">~</span> <span class="st">"Días Educación"</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Salud Psicológica`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Salud Psicológica"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Salud Física`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Salud Física"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Días Trabajo`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Días Trabajo"</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Días Educación`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Días Educación"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Renombrar columnas al español</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tabla_modelo2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Estimación"</span>, <span class="st">"Error estándar"</span>, </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"Estadístico"</span>, <span class="st">"GL"</span>, <span class="st">"Valor p"</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>tabla_modelo2 <span class="sc">%&gt;%</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Modelo: Predictores de calidad de vida"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Modelo: Predictores de calidad de vida</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimación</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Error estándar</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estadístico</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">GL</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Valor p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercepto</td>
<td style="text-align: right;">2.474</td>
<td style="text-align: right;">0.035</td>
<td style="text-align: right;">70.692</td>
<td style="text-align: right;">101843.12</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo (meses)</td>
<td style="text-align: right;">-0.017</td>
<td style="text-align: right;">0.007</td>
<td style="text-align: right;">-2.538</td>
<td style="text-align: right;">47062.59</td>
<td style="text-align: right;">0.011</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Salud Psicológica</td>
<td style="text-align: right;">0.548</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">179.249</td>
<td style="text-align: right;">130832.12</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Salud Física</td>
<td style="text-align: right;">0.289</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">94.731</td>
<td style="text-align: right;">126845.15</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">13.705</td>
<td style="text-align: right;">103816.67</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Días Educación</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">6.349</td>
<td style="text-align: right;">124987.99</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Salud Psicológica</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">5.166</td>
<td style="text-align: right;">70902.08</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Salud Física</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">2.773</td>
<td style="text-align: right;">67720.26</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Días Trabajo</td>
<td style="text-align: right;">-0.001</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-4.874</td>
<td style="text-align: right;">44100.27</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Días Educación</td>
<td style="text-align: right;">-0.001</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-2.104</td>
<td style="text-align: right;">60519.53</td>
<td style="text-align: right;">0.035</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="trayectorias-predichas" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="trayectorias-predichas"><span class="header-section-number">10.1</span> 8.1 Trayectorias Predichas</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generar predicciones para diferentes combinaciones</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>time_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="at">by =</span> <span class="dv">3</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tiempo_num =</span> time_seq,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Alcohol =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>),  <span class="co"># Sin consumo vs 15 días/mes</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cannabis =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  Cocaína <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Pasta Base</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  Riña <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),  <span class="co"># Sin/con violencia</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(dat_long<span class="sc">$</span><span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Salud Física</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(dat_long<span class="sc">$</span><span class="st">`</span><span class="at">Salud Física</span><span class="st">`</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Días Trabajo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(dat_long<span class="sc">$</span><span class="st">`</span><span class="at">Días Trabajo</span><span class="st">`</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Días Educación</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(dat_long<span class="sc">$</span><span class="st">`</span><span class="at">Días Educación</span><span class="st">`</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicciones para salud psicológica</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic)) {</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  new_data<span class="sc">$</span>pred_salud <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_salud_psic, </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">newdata =</span> new_data, </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">re.form =</span> <span class="cn">NA</span>) <span class="co"># Sin efectos aleatorios</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gráfico de trayectorias predichas</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(new_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span> <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>         <span class="fu">aes</span>(<span class="at">x =</span> tiempo_num, <span class="at">y =</span> pred_salud, </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">factor</span>(Alcohol))) <span class="sc">+</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">paste</span>(<span class="st">"Cannabis días:"</span>, Cannabis)) <span class="sc">+</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, <span class="st">"15"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sin alcohol"</span>, <span class="st">"15 días alcohol"</span>)) <span class="sc">+</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Trayectorias predichas de salud psicológica (sin violencia intrafamiliar)"</span>,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Tiempo (meses)"</span>,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Salud psicológica predicha"</span>,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Consumo alcohol"</span>) <span class="sc">+</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/trajectories-viz-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="análisis-cross-lagged" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> 9. Análisis Cross-Lagged</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para correlaciones cross-lagged</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>calculate_crosslag <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identificar pacientes con datos en ambas etapas</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  has_stage1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  has_stage2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solo pacientes en ambas etapas</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  ids_both <span class="ot">&lt;-</span> <span class="fu">intersect</span>(has_stage1, has_stage2)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(ids_both) <span class="sc">&lt;</span> <span class="dv">30</span>) {</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener datos ordenados y alineados</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar alineación</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(d1<span class="sc">$</span>HASHKEY, d2<span class="sc">$</span>HASHKEY)) {</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matriz de correlaciones cruzadas</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  cross_cor <span class="ot">&lt;-</span> <span class="fu">cor</span>(d1[,<span class="sc">-</span><span class="dv">1</span>], d2[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualizar como heatmap</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corrplot</span>(cross_cor, </span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>           <span class="at">method =</span> <span class="st">"color"</span>,</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="st">"full"</span>,</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>           <span class="at">tl.cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>           <span class="at">tl.col =</span> <span class="st">"black"</span>,</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"#e74c3c"</span>, <span class="st">"white"</span>, <span class="st">"#2ecc71"</span>))(<span class="dv">100</span>),</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Cross-lagged: Inicio → 6m (n ="</span>, <span class="fu">nrow</span>(d1), <span class="st">")"</span>))</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cross_cor)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular para transición Inicio → 6m</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>crosslag_inicio_6m <span class="ot">&lt;-</span> <span class="fu">calculate_crosslag</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"6m"</span>, nodes_all)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4.2_files/figure-html/cross-lagged-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="contraste-de-hipótesis" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> 10. Contraste de Hipótesis</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># H1: Test de disminución de densidad</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>h1_test <span class="ot">&lt;-</span> global_metrics_df <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"6m"</span>, <span class="st">"12m"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>, <span class="st">`</span><span class="at">Fuerza global</span><span class="st">`</span>, <span class="st">`</span><span class="at">Densidad</span><span class="st">`</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>h1_test <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"H1 - Cambio en densidad de red"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>H1 - Cambio en densidad de red</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Fuerza global</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Densidad</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: right;">10.187</td>
<td style="text-align: right;">0.575</td>
</tr>
<tr class="even">
<td style="text-align: left;">6m</td>
<td style="text-align: right;">8.552</td>
<td style="text-align: right;">0.383</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: right;">8.298</td>
<td style="text-align: right;">0.267</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># H2: Evolución de centralidad de puente en salud</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>h2_test <span class="ot">&lt;-</span> bridge_metrics <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="st">`</span><span class="at">Nodo</span><span class="st">`</span> <span class="sc">%in%</span> vars_salud) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Media influencia puente</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(<span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>h2_test <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"H2 - Evolución de bridge influence (variables salud)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>H2 - Evolución de bridge influence (variables salud)</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Media influencia puente</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: right;">-0.157</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: right;">-0.169</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: right;">-0.168</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: right;">-0.144</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: right;">-0.204</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># H4: Componentes de varianza - heterogeneidad de trayectorias</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">isSingular</span>(model_salud_psic)) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  var_comp <span class="ot">&lt;-</span> <span class="fu">VarCorr</span>(model_salud_psic)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  variance_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Componente</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Varianza interceptos aleatorios"</span>, </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Varianza pendientes aleatorias"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Varianza residual"</span>),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Valor</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(<span class="fu">as.numeric</span>(var_comp<span class="sc">$</span>HASHKEY[<span class="dv">1</span>]), <span class="dv">3</span>),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">ncol</span>(var_comp<span class="sc">$</span>HASHKEY) <span class="sc">&gt;</span> <span class="dv">1</span>, </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>             <span class="fu">round</span>(<span class="fu">as.numeric</span>(var_comp<span class="sc">$</span>HASHKEY[<span class="dv">4</span>]), <span class="dv">3</span>), </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>             <span class="cn">NA</span>),</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(<span class="fu">attr</span>(var_comp, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  variance_table <span class="sc">%&gt;%</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"H4 - Componentes de varianza (heterogeneidad)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>H4 - Componentes de varianza (heterogeneidad)</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Componente</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Valor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Varianza interceptos aleatorios</td>
<td style="text-align: right;">6.779</td>
</tr>
<tr class="even">
<td style="text-align: left;">Varianza pendientes aleatorias</td>
<td style="text-align: right;">0.059</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Varianza residual</td>
<td style="text-align: right;">10.679</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="tabla-resumen-final" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> 11. Tabla Resumen Final</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar resultados de hipótesis</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>h1_result <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_6m)) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  nct_inicio_6m<span class="sc">$</span>glstrinv.pval <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>h2_result <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">nrow</span>(h2_test) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  any_12m <span class="ot">&lt;-</span> h2_test<span class="sc">$</span><span class="st">`</span><span class="at">Media influencia puente</span><span class="st">`</span>[h2_test<span class="sc">$</span><span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"12m"</span>]</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  any_inicio <span class="ot">&lt;-</span> h2_test<span class="sc">$</span><span class="st">`</span><span class="at">Media influencia puente</span><span class="st">`</span>[h2_test<span class="sc">$</span><span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Inicio"</span>]</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(any_12m) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(any_inicio) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    any_12m <span class="sc">&gt;</span> any_inicio</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla resumen de hipótesis</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>summary_findings <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Hipótesis</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"H1"</span>, <span class="st">"H2"</span>, <span class="st">"H3"</span>, <span class="st">"H4"</span>),</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Descripción</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Disminución de densidad con tratamiento"</span>,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Aumento de puente en variables salud"</span>,</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Consumo predice cambios en salud"</span>,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Heterogeneidad en trayectorias"</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Resultado</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(h1_result) <span class="sc">&amp;&amp;</span> h1_result, <span class="st">"Soportada"</span>, </span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(<span class="fu">is.na</span>(h1_result), <span class="st">"No evaluable"</span>, <span class="st">"No soportada"</span>)),</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(h2_result) <span class="sc">&amp;&amp;</span> h2_result, <span class="st">"Soportada"</span>, </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(<span class="fu">is.na</span>(h2_result), <span class="st">"No evaluable"</span>, <span class="st">"No soportada"</span>)),</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic), <span class="st">"Parcialmente soportada"</span>, <span class="st">"No evaluable"</span>),</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">isSingular</span>(model_salud_psic), </span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>           <span class="st">"Soportada"</span>, <span class="st">"No evaluable"</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Evidencia</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_6m), </span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>           <span class="fu">paste</span>(<span class="st">"p ="</span>, <span class="fu">round</span>(nct_inicio_6m<span class="sc">$</span>glstrinv.pval, <span class="dv">3</span>)), </span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>           <span class="st">"NCT no ejecutado"</span>),</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(h2_result), <span class="st">"Cambio en bridge EI evaluado"</span>, <span class="st">"No evaluado"</span>),</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ver tabla de modelos mixtos"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic), <span class="st">"Varianza en efectos aleatorios"</span>, <span class="st">"No evaluado"</span>)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar tabla resumen final</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>summary_findings <span class="sc">%&gt;%</span></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Resumen de contraste de hipótesis"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">color =</span> <span class="fu">ifelse</span>(summary_findings<span class="sc">$</span>Resultado <span class="sc">==</span> <span class="st">"Soportada"</span>, </span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"green"</span>, </span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">ifelse</span>(summary_findings<span class="sc">$</span>Resultado <span class="sc">==</span> <span class="st">"No soportada"</span>,</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"red"</span>, <span class="st">"orange"</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Resumen de contraste de hipótesis</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Hipótesis</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Descripción</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Resultado</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Evidencia</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">H1</td>
<td style="text-align: left;">Disminución de densidad con tratamiento</td>
<td style="text-align: left; color: green !important;">Soportada</td>
<td style="text-align: left;">p = 0.002</td>
</tr>
<tr class="even">
<td style="text-align: left;">H2</td>
<td style="text-align: left;">Aumento de puente en variables salud</td>
<td style="text-align: left; color: green !important;">Soportada</td>
<td style="text-align: left;">Cambio en bridge EI evaluado</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H3</td>
<td style="text-align: left;">Consumo predice cambios en salud</td>
<td style="text-align: left; color: orange !important;">Parcialmente soportada</td>
<td style="text-align: left;">Ver tabla de modelos mixtos</td>
</tr>
<tr class="even">
<td style="text-align: left;">H4</td>
<td style="text-align: left;">Heterogeneidad en trayectorias</td>
<td style="text-align: left; color: green !important;">Soportada</td>
<td style="text-align: left;">Varianza en efectos aleatorios</td>
</tr>
</tbody>
</table>
</div>
</div>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">Referencias</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-Volkow2023" class="csl-entry" role="listitem">
1. Volkow, N. D., &amp; Blanco, C. (2023). Substance use disorders: a comprehensive update of classification, epidemiology, neurobiology, clinical aspects, treatment and prevention. <em>World Psychiatry</em>, <em>22</em>(2), 203-229. <a href="https://doi.org/10.1002/wps.21073">https://doi.org/10.1002/wps.21073</a>
</div>
<div id="ref-Connery2020" class="csl-entry" role="listitem">
2. Connery, H. S., McHugh, R. K., Reilly, M., Shin, S., &amp; Greenfield, S. F. (2020). Substance Use Disorders in Global Mental Health Delivery: Epidemiology, Treatment Gap, and Implementation of Evidence-Based Treatments. <em>Harvard Review of Psychiatry</em>, <em>28</em>(5), 316-327. <a href="https://doi.org/10.1097/HRP.0000000000000271">https://doi.org/10.1097/HRP.0000000000000271</a>
</div>
<div id="ref-GomezSanchezLafuente2022" class="csl-entry" role="listitem">
3. Gómez-Sánchez-Lafuente, C., Guzman-Parra, J., Suarez-Perez, J., Bordallo-Aragon, A., Rodriguez-de-Fonseca, F., &amp; Mayoral-Cleries, F. (2022). Trends in Psychiatric Hospitalizations of Patients With Dual Diagnosis in Spain. <em>Journal of Dual Diagnosis</em>, <em>18</em>(2), 92-100. <a href="https://doi.org/10.1080/15504263.2022.2053770">https://doi.org/10.1080/15504263.2022.2053770</a>
</div>
<div id="ref-Saxena2011" class="csl-entry" role="listitem">
4. Saxena, S., Thornicroft, G., Knapp, J., &amp; Whiteford, M. (2007). Resources for mental health: scarcity, inequity, and inefficiency. <em>World Psychiatry</em>, <em>6</em>(1), 1-10. <a href="https://doi.org/10.1002/wps.21073">https://doi.org/10.1002/wps.21073</a>
</div>
<div id="ref-GomezSanchezLafuente2016" class="csl-entry" role="listitem">
5. Gómez-Sánchez-Lafuente, C., Guzman-Parra, J., Suarez-Perez, J., Mayoral-Cleries, F., &amp; Rodriguez-de-Fonseca, F. (2016). Dual Diagnosis in Spain: Prevalence, Sociodemographic Profile, and Psychiatric Comorbidity in a Sample of Patients Admitted to Psychiatric Inpatient Units. <em>Journal of Dual Diagnosis</em>, <em>12</em>(3-4), 249-258. <a href="https://doi.org/10.1080/15504263.2016.1220207">https://doi.org/10.1080/15504263.2016.1220207</a>
</div>
<div id="ref-Rojas2002" class="csl-entry" role="listitem">
6. Rojas, G., Gaete, M., Guajardo, M., Martínez, M., Martínez, M., Fritsch, R., &amp; Araya, R. (2002). Prevalencia de trastornos psiquiátricos en pacientes hospitalizados en un hospital general. <em>Revista M<span>é</span>dica de Chile</em>, <em>130</em>(6), 689-696. <a href="https://doi.org/10.4067/S0034-98872002000600008">https://doi.org/10.4067/S0034-98872002000600008</a>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiado");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiado");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<script src="Stage4.2_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>