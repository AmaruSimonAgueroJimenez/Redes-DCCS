<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Amaru Simón Agüero Jiménez">

<title>Análisis de Redes del Treatment Outcomes Profile en Cohortes de Rehabilitación de Consumo de Sustancias en Chile</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Stage4_files/libs/clipboard/clipboard.min.js"></script>
<script src="Stage4_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Stage4_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Stage4_files/libs/quarto-html/popper.min.js"></script>
<script src="Stage4_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Stage4_files/libs/quarto-html/anchor.min.js"></script>
<link href="Stage4_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Stage4_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Stage4_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Stage4_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Stage4_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>html{ scroll-behavior: smooth; }</style>
<script src="Stage4_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="Stage4_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#introducción" id="toc-introducción" class="nav-link active" data-scroll-target="#introducción"><span class="header-section-number">1</span> Introducción</a></li>
  <li><a href="#objetivos-e-hipótesis" id="toc-objetivos-e-hipótesis" class="nav-link" data-scroll-target="#objetivos-e-hipótesis"><span class="header-section-number">2</span> Objetivos e Hipótesis</a>
  <ul>
  <li><a href="#objetivo-general" id="toc-objetivo-general" class="nav-link" data-scroll-target="#objetivo-general"><span class="header-section-number">2.1</span> Objetivo general</a></li>
  <li><a href="#objetivos-específicos" id="toc-objetivos-específicos" class="nav-link" data-scroll-target="#objetivos-específicos"><span class="header-section-number">2.2</span> Objetivos específicos</a></li>
  <li><a href="#hipótesis-de-investigación" id="toc-hipótesis-de-investigación" class="nav-link" data-scroll-target="#hipótesis-de-investigación"><span class="header-section-number">2.3</span> Hipótesis de Investigación</a></li>
  </ul></li>
  <li><a href="#metodología" id="toc-metodología" class="nav-link" data-scroll-target="#metodología"><span class="header-section-number">3</span> Metodología</a>
  <ul>
  <li><a href="#descripción-de-los-datos" id="toc-descripción-de-los-datos" class="nav-link" data-scroll-target="#descripción-de-los-datos"><span class="header-section-number">3.1</span> Descripción de los datos</a></li>
  <li><a href="#preparación-y-armonización-de-variables" id="toc-preparación-y-armonización-de-variables" class="nav-link" data-scroll-target="#preparación-y-armonización-de-variables"><span class="header-section-number">3.2</span> Preparación y armonización de variables</a></li>
  <li><a href="#estimación-de-redes-por-etapa" id="toc-estimación-de-redes-por-etapa" class="nav-link" data-scroll-target="#estimación-de-redes-por-etapa"><span class="header-section-number">3.3</span> Estimación de redes por etapa</a></li>
  <li><a href="#métricas-globales-y-nodales" id="toc-métricas-globales-y-nodales" class="nav-link" data-scroll-target="#métricas-globales-y-nodales"><span class="header-section-number">3.4</span> Métricas globales y nodales</a></li>
  <li><a href="#puentes-entre-dominios" id="toc-puentes-entre-dominios" class="nav-link" data-scroll-target="#puentes-entre-dominios"><span class="header-section-number">3.5</span> Puentes entre dominios</a></li>
  <li><a href="#comparación-con-modelos-nulos" id="toc-comparación-con-modelos-nulos" class="nav-link" data-scroll-target="#comparación-con-modelos-nulos"><span class="header-section-number">3.6</span> Comparación con modelos nulos</a></li>
  <li><a href="#invarianza-estructural-entre-etapas" id="toc-invarianza-estructural-entre-etapas" class="nav-link" data-scroll-target="#invarianza-estructural-entre-etapas"><span class="header-section-number">3.7</span> Invarianza estructural entre etapas</a></li>
  <li><a href="#redes-de-cambio-deltas-apareados" id="toc-redes-de-cambio-deltas-apareados" class="nav-link" data-scroll-target="#redes-de-cambio-deltas-apareados"><span class="header-section-number">3.8</span> Redes de cambio (deltas apareados)</a></li>
  <li><a href="#modelos-longitudinales-complementarios" id="toc-modelos-longitudinales-complementarios" class="nav-link" data-scroll-target="#modelos-longitudinales-complementarios"><span class="header-section-number">3.9</span> Modelos longitudinales complementarios</a></li>
  <li><a href="#transparencia-y-robustez" id="toc-transparencia-y-robustez" class="nav-link" data-scroll-target="#transparencia-y-robustez"><span class="header-section-number">3.10</span> Transparencia y robustez</a></li>
  </ul></li>
  <li><a href="#resultados" id="toc-resultados" class="nav-link" data-scroll-target="#resultados"><span class="header-section-number">4</span> Resultados</a>
  <ul>
  <li><a href="#análisis-de-redes-transversales-por-etapa" id="toc-análisis-de-redes-transversales-por-etapa" class="nav-link" data-scroll-target="#análisis-de-redes-transversales-por-etapa"><span class="header-section-number">4.1</span> Análisis de Redes Transversales por Etapa</a>
  <ul>
  <li><a href="#estimación-de-redes" id="toc-estimación-de-redes" class="nav-link" data-scroll-target="#estimación-de-redes"><span class="header-section-number">4.1.1</span> Estimación de Redes</a></li>
  <li><a href="#tabla-de-métricas-globales-comprehensivas" id="toc-tabla-de-métricas-globales-comprehensivas" class="nav-link" data-scroll-target="#tabla-de-métricas-globales-comprehensivas"><span class="header-section-number">4.1.2</span> Tabla de Métricas Globales Comprehensivas</a></li>
  <li><a href="#visualización-de-red---inicio" id="toc-visualización-de-red---inicio" class="nav-link" data-scroll-target="#visualización-de-red---inicio"><span class="header-section-number">4.1.3</span> Visualización de Red - Inicio</a></li>
  <li><a href="#visualización-de-red---3-meses" id="toc-visualización-de-red---3-meses" class="nav-link" data-scroll-target="#visualización-de-red---3-meses"><span class="header-section-number">4.1.4</span> Visualización de Red - 3 meses</a></li>
  <li><a href="#visualización-de-red---6-meses" id="toc-visualización-de-red---6-meses" class="nav-link" data-scroll-target="#visualización-de-red---6-meses"><span class="header-section-number">4.1.5</span> Visualización de Red - 6 meses</a></li>
  <li><a href="#visualización-de-red---9-meses" id="toc-visualización-de-red---9-meses" class="nav-link" data-scroll-target="#visualización-de-red---9-meses"><span class="header-section-number">4.1.6</span> Visualización de Red - 9 meses</a></li>
  <li><a href="#visualización-de-red---12-meses" id="toc-visualización-de-red---12-meses" class="nav-link" data-scroll-target="#visualización-de-red---12-meses"><span class="header-section-number">4.1.7</span> Visualización de Red - 12 meses</a></li>
  <li><a href="#visualización-comparativa-de-todas-las-redes" id="toc-visualización-comparativa-de-todas-las-redes" class="nav-link" data-scroll-target="#visualización-comparativa-de-todas-las-redes"><span class="header-section-number">4.1.8</span> Visualización Comparativa de Todas las Redes</a></li>
  </ul></li>
  <li><a href="#evolución-de-métricas-con-intervalos-de-confianza" id="toc-evolución-de-métricas-con-intervalos-de-confianza" class="nav-link" data-scroll-target="#evolución-de-métricas-con-intervalos-de-confianza"><span class="header-section-number">4.2</span> Evolución de Métricas con Intervalos de Confianza</a></li>
  <li><a href="#comparación-con-modelos-nulos-1" id="toc-comparación-con-modelos-nulos-1" class="nav-link" data-scroll-target="#comparación-con-modelos-nulos-1"><span class="header-section-number">4.3</span> Comparación con Modelos Nulos</a></li>
  <li><a href="#análisis-de-nodos-puente" id="toc-análisis-de-nodos-puente" class="nav-link" data-scroll-target="#análisis-de-nodos-puente"><span class="header-section-number">4.4</span> Análisis de Nodos Puente</a></li>
  <li><a href="#redes-de-cambio" id="toc-redes-de-cambio" class="nav-link" data-scroll-target="#redes-de-cambio"><span class="header-section-number">4.5</span> Redes de Cambio</a>
  <ul>
  <li><a href="#visualización-red-de-cambios-inicio-3-meses" id="toc-visualización-red-de-cambios-inicio-3-meses" class="nav-link" data-scroll-target="#visualización-red-de-cambios-inicio-3-meses"><span class="header-section-number">4.5.1</span> Visualización Red de Cambios: Inicio → 3 meses</a></li>
  <li><a href="#visualización-red-de-cambios-3-6-meses" id="toc-visualización-red-de-cambios-3-6-meses" class="nav-link" data-scroll-target="#visualización-red-de-cambios-3-6-meses"><span class="header-section-number">4.5.2</span> Visualización Red de Cambios: 3 → 6 meses</a></li>
  <li><a href="#visualización-red-de-cambios-6-12-meses" id="toc-visualización-red-de-cambios-6-12-meses" class="nav-link" data-scroll-target="#visualización-red-de-cambios-6-12-meses"><span class="header-section-number">4.5.3</span> Visualización Red de Cambios: 6 → 12 meses</a></li>
  </ul></li>
  <li><a href="#comparación-de-redes-nct" id="toc-comparación-de-redes-nct" class="nav-link" data-scroll-target="#comparación-de-redes-nct"><span class="header-section-number">4.6</span> Comparación de Redes (NCT)</a></li>
  <li><a href="#modelos-mixtos-lineales" id="toc-modelos-mixtos-lineales" class="nav-link" data-scroll-target="#modelos-mixtos-lineales"><span class="header-section-number">4.7</span> Modelos Mixtos Lineales</a></li>
  <li><a href="#análisis-cross-lagged" id="toc-análisis-cross-lagged" class="nav-link" data-scroll-target="#análisis-cross-lagged"><span class="header-section-number">4.8</span> Análisis Cross-Lagged</a></li>
  <li><a href="#análisis-de-tendencias-temporales" id="toc-análisis-de-tendencias-temporales" class="nav-link" data-scroll-target="#análisis-de-tendencias-temporales"><span class="header-section-number">4.9</span> Análisis de Tendencias Temporales</a></li>
  </ul></li>
  <li><a href="#conclusiónes" id="toc-conclusiónes" class="nav-link" data-scroll-target="#conclusiónes"><span class="header-section-number">5</span> Conclusiónes</a>
  <ul>
  <li><a href="#síntesis-de-resultados" id="toc-síntesis-de-resultados" class="nav-link" data-scroll-target="#síntesis-de-resultados"><span class="header-section-number">5.1</span> Síntesis de Resultados</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Análisis de Redes del Treatment Outcomes Profile en Cohortes de Rehabilitación de Consumo de Sustancias en Chile</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Código</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Mostrar todo el código</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Ocultar todo el código</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">Ver el código fuente</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Autor/a</div>
    <div class="quarto-title-meta-contents">
             <p>Amaru Simón Agüero Jiménez <a href="mailto:aaguero@miaundes.cl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0001-7336-1833" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Fecha de publicación</div>
    <div class="quarto-title-meta-contents">
      <p class="date">28 de septiembre de 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introducción" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introducción</h1>
<p>Los trastornos por uso de sustancias (TUS) constituyen una de las principales causas de carga de enfermedad y mortalidad evitable a escala global. En 2016 se calculó que más de 100 millones de personas sufrían trastorno por consumo de alcohol y decenas de millones presentaban dependencia de opioides, cannabis o cocaína<span class="citation" data-cites="Volkow2023"><sup><a href="#ref-Volkow2023" role="doc-biblioref">1</a></sup></span>. La frecuente comorbilidad psiquiátrica con depresión, trastornos de ansiedad, psicosis o trastornos de personalidad multiplica la severidad clínica y los costes sociosanitarios<span class="citation" data-cites="Connery2020"><sup><a href="#ref-Connery2020" role="doc-biblioref">2</a></sup></span>. Estudios hospitalarios europeos y norteamericanos muestran que alrededor del 20% de las admisiones psiquiátricas corresponden a pacientes de sexo femenino con diagnóstico dual, fenómeno que favorece re‑ingresos y estancias prolongadas<span class="citation" data-cites="GomezSanchezLafuente2022"><sup><a href="#ref-GomezSanchezLafuente2022" role="doc-biblioref">3</a></sup></span>.</p>
<p>En Chile, las encuestas nacionales sitúan la prevalencia de abuso o dependencia de sustancias entre el 11% y el 20%, una de las más elevadas de Latinoamérica. Los registros hospitalarios concuerdan con las cifras internacionales: alrededor de una quinta parte de los internados en psiquiatría presenta un TUS como diagnóstico primario o secundario. Esta convergencia evidencia que la hospitalización psiquiátrica es un desenlace clínico crítico en la trayectoria de las adicciones, razón por la cual identificar sus factores determinantes resulta esencial para planificar intervenciones preventivas, asignar recursos y reducir la carga asistencial<span class="citation" data-cites="Connery2020 Saxena2011 GomezSanchezLafuente2016 Rojas2002"><sup><a href="#ref-Connery2020" role="doc-biblioref">2</a>,<a href="#ref-Saxena2011" role="doc-biblioref">4</a>–<a href="#ref-Rojas2002" role="doc-biblioref">6</a></sup></span>.</p>
<p>En respuesta a esta problemática, el Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol (SENDA) gestiona el Sistema de Tratamiento (SISTRAT), que recopila información de miles de episodios de tratamiento en centros públicos y privados. Como instrumento central, se utiliza el Treatment Outcomes Profile (TOP), un cuestionario de 20 ítems desarrollado en Inglaterra y adaptado al contexto chileno<span class="citation" data-cites="CastilloCarniglia2015"><sup><a href="#ref-CastilloCarniglia2015" role="doc-biblioref">7</a></sup></span>. El TOP registra consumo de sustancias en el último mes, conductas de inyección, situación de vivienda, actividad laboral, vínculos familiares, crimen y problemas de salud mental, permitiendo monitorear la evolución de los pacientes a lo largo de distintas etapas del tratamiento.</p>
<p>Para analizar la complejidad de las interacciones entre síntomas y factores psicosociales, el enfoque de análisis de redes ha cobrado importancia en psicología y psiquiatría. Este enfoque modela los ítems como nodos y las correlaciones condicionales como aristas, revelando cómo las variables se influyen mutuamente. La centralidad de fuerza y la influencia esperada permiten identificar los nodos más relevantes en cada red, facilitando la priorización de intervenciones<span class="citation" data-cites="Spiller2020"><sup><a href="#ref-Spiller2020" role="doc-biblioref">8</a></sup></span>. En el contexto de las adicciones, este enfoque puede arrojar luz sobre los mecanismos que conducen a recaídas y ayudar a diseñar estrategias terapéuticas más efectivas.</p>
</section>
<section id="objetivos-e-hipótesis" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Objetivos e Hipótesis</h1>
<section id="objetivo-general" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="objetivo-general"><span class="header-section-number">2.1</span> Objetivo general</h2>
<p>Evaluar redes de interacciones entre síntomas y factores psicosociales registrados por el TOP en distintas etapas del tratamiento de rehabilitación de drogas en Chile, identificando los nodos más influyentes y sus implicancias clínicas.</p>
</section>
<section id="objetivos-específicos" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="objetivos-específicos"><span class="header-section-number">2.2</span> Objetivos específicos</h2>
<p><strong>1)</strong> Elavorar redes de asociación condicional para cada etapa del tratamiento (diagnóstico, atención ambulatoria, atención residencial, alta y reingreso) usando el método EBICglasso para regularización.</p>
<p><strong>2)</strong> Estimar métricas de centralidad de fuerza e influencia esperada para cada nodo y determinar los ítems que presentan mayor influencia en cada red.</p>
<p><strong>3)</strong> Evaluar diferencias en la estructura y la fuerza global entre las redes de etapas consecutivas con la prueba de comparación de redes (Network Comparison Test)</p>
<p><strong>4)</strong> Modelar la evolución longitudinal de los nodos centrales mediante análisis de efectos mixtos y paneles cruzados, explorando la direccionalidad entre síntomas y recaídas.</p>
</section>
<section id="hipótesis-de-investigación" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="hipótesis-de-investigación"><span class="header-section-number">2.3</span> Hipótesis de Investigación</h2>
<p><strong>H1</strong>: La densidad de la red (fuerza global) disminuye significativamente entre el ingreso y los 6-12 meses de tratamiento, reflejando una desacoplación de síntomas.</p>
<p><strong>H2</strong>: Las variables de salud (psicológica/física) aumentan su centralidad de puente entre dominios al avanzar el tratamiento.</p>
<p><strong>H3</strong>: Los cambios en consumo de sustancias entre etapas predicen cambios en salud y calidad de vida (análisis de transiciones).</p>
<p><strong>H4</strong>: Existen trayectorias heterogéneas de cambio identificables mediante modelos mixtos lineales.</p>
</section>
</section>
<section id="metodología" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Metodología</h1>
<section id="descripción-de-los-datos" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="descripción-de-los-datos"><span class="header-section-number">3.1</span> Descripción de los datos</h2>
<p>Este es un estudio de cohorte retrospectiva de pacientes adultos en tratamiento por consumo de sustancias desde el 2018 al 2022, con datos otorgados por el Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol de Chile (SENDA) en convenio con el núcleo milenio de ánalisis de políticas públicas de drogas (nDP). La cohorte se construyó vinculando los registros administrativos de los pacientes con TOP (n = 167,404 episodios de tratamiento entre 56,998 personas en las 16 regiones del país).</p>
<p>Estos datos incluyen múltiples variables relacionadas al consumo y tratamiento rehabilitador de drogas. Entre estas variables esta la <em>sustancia principal</em> por la cual se trató al paciente y sustancias secundarias (alcohol, pasta base de cocaína, cocaína, marihuana, depresores del SNC u otras sustancias. Tambien está presente el número de reingresos a tratamiento (retratamientos, categorizados en 0, 1, 2, 3 o más reingresos), el <em>tipo de plan de tratamiento</em> (ambulatorio vs.&nbsp;residencial) y el historial clínico de salud mental de los pacientes.</p>
<p>El registro de pacientes en tratamiento se realizó en una plataforma electrónica denominada SISTRAT, que contenía información sociodemográfica, datos sobre el estado de salud y patrones de consumo de sustancias, entre otras variables, además de información sobre el propio tratamiento (p.&nbsp;ej., fecha de ingreso, egreso, tipo de tratamiento). Las base de datos se vincularon de forma determinista mediante un hash de 64 caracteres resultante del cifrado (con un algoritmo SHA-256) del número de identificación único de cada persona.</p>
</section>
<section id="preparación-y-armonización-de-variables" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="preparación-y-armonización-de-variables"><span class="header-section-number">3.2</span> Preparación y armonización de variables</h2>
<p>A partir de los registros TOP se construyeron cuatro dominios analíticos: <strong>Uso de sustancias</strong> (alcohol, cannabis, cocaína, pasta base, benzodiacepinas, otra sustancia), <strong>Transgresión</strong> (hurto, robo, venta de drogas, riña, violencia intrafamiliar), <strong>Salud</strong> (psicológica, física) y <strong>Funcionamiento</strong> (días trabajo, días educación), además de <strong>calidad de vida</strong>. Los puntajes continuos se estandarizaron por etapa y las variables dicotómicas se mantuvieron como indicadores binarios. Para manejar mezclas de escalas y posibles desviaciones de normalidad, la matriz de asociación se estimó con estrategias robustas compatibles con <strong>modelos copulares gaussianos</strong> / <strong>no-paranormales</strong><span class="citation" data-cites="Liu2012"><sup><a href="#ref-Liu2012" role="doc-biblioref">9</a></sup></span>.</p>
</section>
<section id="estimación-de-redes-por-etapa" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="estimación-de-redes-por-etapa"><span class="header-section-number">3.3</span> Estimación de redes por etapa</h2>
<p>Para cada etapa se estimó una red de <strong>correlaciones parciales</strong> bajo un <strong>modelo gaussiano de campos aleatorios (GGM)</strong> escaso. La matriz de precisión <span class="math inline">\(\Theta\)</span> se obtuvo mediante penalización <span class="math inline">\(\ell_1\)</span> (graphical lasso), que maximiza la verosimilitud penalizada y promueve soluciones dispersas<span class="citation" data-cites="Friedman2008"><sup><a href="#ref-Friedman2008" role="doc-biblioref">10</a></sup></span>. La selección del grado de regularización se realizó con el <strong>criterio EBIC</strong>, que extiende BIC para espacio de grafos de alta dimensión, con parámetro <span class="math inline">\(\gamma\)</span> intermedio (aprox. 0,5) para equilibrar ajuste y parsimonia<span class="citation" data-cites="FoygelDrton2011"><sup><a href="#ref-FoygelDrton2011" role="doc-biblioref">11</a></sup></span>. Los <strong>pesos de arista</strong> se reportan como correlaciones parciales estandarizadas:</p>
<p><span class="math display">\[
w_{ij}=-\frac{\widehat\Theta_{ij}}{\sqrt{\widehat\Theta_{ii}\,\widehat\Theta_{jj}}}.
\]</span></p>
</section>
<section id="métricas-globales-y-nodales" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="métricas-globales-y-nodales"><span class="header-section-number">3.4</span> Métricas globales y nodales</h2>
<p>De cada red se extrajeron métricas <strong>globales</strong> —densidad, diámetro, longitud de camino media y coeficientes de <strong>clustering</strong>— siguiendo la tradición de redes de <strong>pequeño-mundo</strong><span class="citation" data-cites="WattsStrogatz1998"><sup><a href="#ref-WattsStrogatz1998" role="doc-biblioref">12</a></sup></span>, y <strong>modularidad</strong> sobre particiones detectadas por maximización heurística de <span class="math inline">\(Q\)</span><span class="citation" data-cites="Blondel2008"><sup><a href="#ref-Blondel2008" role="doc-biblioref">13</a></sup></span>. A nivel de <strong>nodo</strong> se calcularon:</p>
<ul>
<li><strong>Fuerza</strong>: <span class="math inline">\(s_i=\sum_j |w_{ij}|\)</span> (influencia agregada);</li>
<li><strong>Betweenness</strong>/<strong>closeness</strong> basadas en geodésicas;</li>
<li><strong>Centralidad de eigenvector</strong> (influencia recursiva);</li>
<li><strong>PageRank</strong> (vector estacionario de un paseo aleatorio)<span class="citation" data-cites="BrinPage1998"><sup><a href="#ref-BrinPage1998" role="doc-biblioref">14</a></sup></span>.</li>
</ul>
<p>La precisión e interpretabilidad de estas métricas en redes psicométricas se discute en guías metodológicas recientes, que se siguieron para la evaluación de estabilidad y reporte responsable<span class="citation" data-cites="EpskampBRM2018 EpskampFried2018"><sup><a href="#ref-EpskampBRM2018" role="doc-biblioref">15</a>,<a href="#ref-EpskampFried2018" role="doc-biblioref">16</a></sup></span>.</p>
</section>
<section id="puentes-entre-dominios" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="puentes-entre-dominios"><span class="header-section-number">3.5</span> Puentes entre dominios</h2>
<p>Con la partición a priori (Uso, Transgresión, Salud, Funcionamiento) se estimó <strong>centralidad puente</strong> (bridge strength) e <strong>influencia puente esperada</strong>, para identificar nodos que conectan comunidades y potenciales puntos de intervención traslacional<span class="citation" data-cites="Jones2019"><sup><a href="#ref-Jones2019" role="doc-biblioref">17</a></sup></span>.</p>
</section>
<section id="comparación-con-modelos-nulos" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="comparación-con-modelos-nulos"><span class="header-section-number">3.6</span> Comparación con modelos nulos</h2>
<p>Para valorar si la organización observada excede lo esperable por azar, cada red se contrastó con distribuciones de referencia simuladas: <strong><span class="math inline">\(G(n,p)\)</span> (Gilbert)</strong> ajustando <span class="math inline">\(p\)</span> a la densidad observada<span class="citation" data-cites="Gilbert1959"><sup><a href="#ref-Gilbert1959" role="doc-biblioref">18</a></sup></span> y <strong>preferential attachment</strong> tipo <strong>Barabási–Albert</strong> con <span class="math inline">\(m\approx \bar k/2\)</span><span class="citation" data-cites="BarabasiAlbert1999"><sup><a href="#ref-BarabasiAlbert1999" role="doc-biblioref">19</a></sup></span>. Sobre métricas clave (clustering, longitud de camino, diámetro, asortatividad, grado máximo, varianza del grado) se obtuvieron medias, bandas de cuantiles y <strong><span class="math inline">\(z\)</span>-scores</strong>: <span class="math display">\[
z=\frac{T_{\text{obs}}-\mu_0}{\sigma_0}.
\]</span> Se reportan <em>p</em> bilaterales por simulación.</p>
</section>
<section id="invarianza-estructural-entre-etapas" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="invarianza-estructural-entre-etapas"><span class="header-section-number">3.7</span> Invarianza estructural entre etapas</h2>
<p>Las diferencias entre redes de etapas (p.&nbsp;ej., <strong>Inicio vs 6 m</strong>; <strong>Inicio vs 12 m</strong>) se evaluaron con un <strong>test de permutación</strong> para comparación de redes, que contrasta (i) <strong>invarianza de estructura</strong>, (ii) <strong>aristas específicas</strong> y (iii) <strong>diferencia de fuerza global</strong> <span class="math inline">\(\Delta S=\sum_{i&lt;j}|w_{ij}^{(1)}|-\sum_{i&lt;j}|w_{ij}^{(2)}|\)</span><span class="citation" data-cites="vanBorkulo2023"><sup><a href="#ref-vanBorkulo2023" role="doc-biblioref">20</a></sup></span>. Los <em>p</em>-values se obtienen permutando etiquetas de grupo y re-estimando redes.</p>
</section>
<section id="redes-de-cambio-deltas-apareados" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="redes-de-cambio-deltas-apareados"><span class="header-section-number">3.8</span> Redes de cambio (deltas apareados)</h2>
<p>Para transiciones <strong>Inicio→3 m</strong>, <strong>3→6 m</strong> y <strong>6→12 m</strong>, en submuestras apareadas por individuo, se construyó una matriz de <strong>deltas</strong> <span class="math inline">\(\Delta X=X_{t_2}-X_{t_1}\)</span> y se estimó un GGM regularizado sobre <span class="math inline">\(\Delta X\)</span>. Las aristas positivas indican <strong>co-mejoras / co-empeoramientos</strong>; las negativas sugieren <strong>compensaciones</strong> entre dominios.</p>
</section>
<section id="modelos-longitudinales-complementarios" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="modelos-longitudinales-complementarios"><span class="header-section-number">3.9</span> Modelos longitudinales complementarios</h2>
<p>Con el fin de describir trayectorias y heterogeneidad interindividual, se ajustaron <strong>modelos lineales mixtos</strong> con intercepto (y, cuando fue posible, pendiente) aleatoria por sujeto: <span class="math display">\[
y_{it}=\beta_0+\beta_1 t+\boldsymbol{\beta}^\top\mathbf{z}_{it}+b_{0i}+b_{1i}t+\varepsilon_{it},
\]</span> siguiendo el enfoque clásico de efectos aleatorios para datos longitudinales<span class="citation" data-cites="LairdWare1982 Bates2015"><sup><a href="#ref-LairdWare1982" role="doc-biblioref">21</a>,<a href="#ref-Bates2015" role="doc-biblioref">22</a></sup></span>. Como análisis <strong>exploratorio</strong> y no inferencial, se calcularon <strong>correlaciones <em>cross-lagged</em></strong> entre nodos de etapas consecutivas (p.&nbsp;ej., Inicio→6 m), interpretadas con cautela a la luz de las limitaciones del CLPM tradicional<span class="citation" data-cites="Hamaker2015"><sup><a href="#ref-Hamaker2015" role="doc-biblioref">23</a></sup></span>.</p>
</section>
<section id="transparencia-y-robustez" class="level2" data-number="3.10">
<h2 data-number="3.10" class="anchored" data-anchor-id="transparencia-y-robustez"><span class="header-section-number">3.10</span> Transparencia y robustez</h2>
<p>Para métricas de centralidad agregadas se reportan promedios con <strong>IC 95 %</strong> por aproximación normal (descriptivos). La evaluación de exactitud/estabilidad de redes se guio por buenas prácticas para redes psicológicas (re-muestreo, sensibilidad a regularización y a selección de correlaciones)<span class="citation" data-cites="EpskampBRM2018"><sup><a href="#ref-EpskampBRM2018" role="doc-biblioref">15</a></sup></span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># TOP 2015–2022: Carga robusta + Limpieza + Renombrado</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup unificado (paquetes + opciones + tema + seed)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Función robusta para instalar/cargar paquetes ----</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>ensure_packages <span class="ot">&lt;-</span> <span class="cf">function</span>(pkgs, <span class="at">repos =</span> <span class="fu">getOption</span>(<span class="st">"repos"</span>)) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(pkgs), <span class="fu">length</span>(pkgs) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Repos por defecto si no están definidos</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(repos) <span class="sc">||</span> <span class="fu">is.na</span>(repos[<span class="st">"CRAN"</span>]) <span class="sc">||</span> repos[<span class="st">"CRAN"</span>] <span class="sc">==</span> <span class="st">"@CRAN@"</span>) {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN =</span> <span class="st">"https://cloud.r-project.org"</span>))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detectar faltantes</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  missing_pkgs <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span><span class="fu">vapply</span>(pkgs, requireNamespace, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="at">quietly =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Instalar faltantes (con dependencias y en paralelo cuando sea posible)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_pkgs)) {</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    ncpus <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"parallel"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      ncpus <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>L)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(missing_pkgs, <span class="at">dependencies =</span> <span class="cn">TRUE</span>, <span class="at">Ncpus =</span> ncpus)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cargar todos (incluye los que ya estaban)</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, <span class="cf">function</span>(p) {</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressPackageStartupMessages</span>(</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">library</span>(p, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">TRUE</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Declaración única de paquetes ----</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># utilidades / data wrangling</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table"</span>, <span class="st">"stringr"</span>, <span class="st">"stringi"</span>, <span class="st">"janitor"</span>, <span class="st">"lubridate"</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dplyr"</span>, <span class="st">"purrr"</span>, <span class="st">"tibble"</span>, <span class="st">"openxlsx"</span>, <span class="st">"tidyverse"</span>,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># redes y psicometría</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"igraph"</span>, <span class="st">"qgraph"</span>, <span class="st">"bootnet"</span>, <span class="st">"NetworkComparisonTest"</span>, <span class="st">"networktools"</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># modelos mixtos</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>, <span class="st">"lmerTest"</span>, <span class="st">"broom.mixed"</span>,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># grafos/visualización</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggraph"</span>, <span class="st">"tidygraph"</span>, <span class="st">"corrplot"</span>, <span class="st">"patchwork"</span>, <span class="st">"kableExtra"</span>, <span class="st">"plotly"</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Carga de paquetes (instala si faltan) ----</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="fu">ensure_packages</span>(pkgs)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Configuración global knitr/figuras ----</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">message   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">10</span>,</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">8</span>,</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">dpi =</span> <span class="dv">300</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Temas y opciones de visualización ----</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>))</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Semilla global para reproducibilidad ----</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Paths y configuración ----------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>root <span class="ot">&lt;-</span> <span class="fu">normalizePath</span>(<span class="fu">gsub</span>(<span class="st">"/docs$"</span>, <span class="st">""</span>, <span class="fu">getwd</span>()), <span class="at">mustWork =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>base_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>output_rds <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022_FINAL.rds"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>output_excel <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022_FINAL.xlsx"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Archivos esperados --------------------------------------------------</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>archivos <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2015_oct_dup_enc.csv"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2016_oct_dup1_enc.csv"</span>, <span class="st">"2016_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2017_oct_dup1_enc.csv"</span>, <span class="st">"2017_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2018_oct_dup1_enc.csv"</span>, <span class="st">"2018_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2019_oct_dup1_enc.csv"</span>, <span class="st">"2019_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2019oct_oct_dup_enc.csv"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2020_oct_dup1_enc.csv"</span>, <span class="st">"2020_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2021_oct_dup1_enc.csv"</span>, <span class="st">"2021_oct_dup2_enc.csv"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2022_oct_dup1_enc.csv"</span>, <span class="st">"2022_oct_dup2_enc.csv"</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Funciones de utilidad -----------------------------------------------</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Extrae año del nombre del archivo</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>extract_year <span class="ot">&lt;-</span> <span class="cf">function</span>(filename) {</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(filename, <span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2}"</span>))</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpia nombres de columnas</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>clean_colnames <span class="ot">&lt;-</span> <span class="cf">function</span>(nms) {</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(nms, <span class="st">"Latin-ASCII"</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"[^A-Za-z0-9]+"</span>, <span class="st">"_"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"_{2,}"</span>, <span class="st">"_"</span>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"^_|_$"</span>, <span class="st">""</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">make_clean_names</span>(nms)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Mojibake safe (no explota con NA)</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>fix_mojibake <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">enc2utf8</span>(x)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  bad <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"(Ã.|Â|Aƒ)"</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(bad)) {</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    cand <span class="ot">&lt;-</span> <span class="fu">iconv</span>(x[bad], <span class="at">from =</span> <span class="st">"latin1"</span>, <span class="at">to =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    scount <span class="ot">&lt;-</span> <span class="cf">function</span>(v, pat) { </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>      out <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_count</span>(v, pat)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      out[<span class="fu">is.na</span>(out)] <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>      out </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    keep <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scount</span>(cand, <span class="st">"Ã|Â|Aƒ"</span>) <span class="sc">&lt;</span> <span class="fu">scount</span>(x[bad], <span class="st">"Ã|Â|Aƒ"</span>), </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>      cand, </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>      x[bad]</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    x[bad] <span class="ot">&lt;-</span> keep</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Parser de fechas mixtas</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>parse_mixed_dates <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_trim</span>(x)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  x[x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">"NULL"</span>, <span class="st">"0000-00-00"</span>, <span class="st">"00/00/0000"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(x, <span class="st">"[./]"</span>, <span class="st">"-"</span>)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">as.Date</span>(<span class="cn">NA</span>), <span class="fu">length</span>(x))</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yyyy-mm-dd</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  ymd_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[12][0-9]{3}-[0-9]{1,2}-[0-9]{1,2}$"</span>)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(ymd_mask)) res[ymd_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(x[ymd_mask]))</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dd-mm-yyyy (preferencia Chile)</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  dmy_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span>ymd_mask <span class="sc">&amp;</span> </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{1,2}-[0-9]{1,2}-[12][0-9]{3}$"</span>)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(dmy_mask)) res[dmy_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">dmy</span>(x[dmy_mask]))</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mdy como fallback</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>  mdy_mask <span class="ot">&lt;-</span> <span class="fu">is.na</span>(res) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> </span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{1,2}-[0-9]{1,2}-[12][0-9]{3}$"</span>)</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(mdy_mask)) res[mdy_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">mdy</span>(x[mdy_mask]))</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># YYYYMMDD</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>  yfirst8_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^(19|20)</span><span class="sc">\\</span><span class="st">d{6}$"</span>)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(yfirst8_mask)) res[yfirst8_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(x[yfirst8_mask]))</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># DDMMAAAA</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>  dmy8_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{8}$"</span>) <span class="sc">&amp;</span> <span class="sc">!</span>yfirst8_mask</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(dmy8_mask)) res[dmy8_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">dmy</span>(x[dmy8_mask]))</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fechas Excel</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>  excel_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{5,6}$"</span>)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(excel_mask)) {</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">which</span>(excel_mask)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    num <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(x[idx]))</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(num) <span class="sc">&amp;</span> num <span class="sc">&gt;</span> <span class="dv">20000</span> <span class="sc">&amp;</span> num <span class="sc">&lt;</span> <span class="dv">60000</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(ok)) res[idx[ok]] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(num[ok], <span class="at">origin =</span> <span class="st">"1899-12-30"</span>)</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Último recurso</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  fallback_mask <span class="ot">&lt;-</span> <span class="fu">is.na</span>(res) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(fallback_mask)) {</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>      x[fallback_mask],</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">orders =</span> <span class="fu">c</span>(<span class="st">"Ymd"</span>,<span class="st">"Y-m-d"</span>,<span class="st">"dmY"</span>,<span class="st">"d-m-Y"</span>,<span class="st">"mdY"</span>,<span class="st">"m-d-Y"</span>,<span class="st">"Ymd HMS"</span>,<span class="st">"dmY HMS"</span>,<span class="st">"mdY HMS"</span>)</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    res[fallback_mask] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(tmp)</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta columnas de fecha por nombre</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>normalize_name <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  n <span class="sc">%&gt;%</span> </span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(<span class="st">"Latin-ASCII"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tolower</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">"[^a-z0-9]+"</span>, <span class="st">""</span>)</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>is_date_like <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>  n_norm <span class="ot">&lt;-</span> <span class="fu">normalize_name</span>(n)</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    n_norm,</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"^fecha"</span>,<span class="st">"fechanacimiento"</span>,<span class="st">"fechadeingreso"</span>,<span class="st">"fechaingreso"</span>,</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fechaegreso"</span>,<span class="st">"fechaalta"</span>,<span class="st">"fecharegistro"</span>,<span class="st">"fechaconsulta"</span>,</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fechacita"</span>,<span class="st">"fechadiagnostico"</span>)</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Lector robusto de archivos</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>read_top_file <span class="ot">&lt;-</span> <span class="cf">function</span>(filename) {</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(base_path, filename)</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>      data.table<span class="sc">::</span><span class="fu">fread</span>(</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>        file_path,</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">";"</span>,</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>        <span class="at">encoding =</span> <span class="st">"Latin-1"</span>,</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>        <span class="at">na.strings =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">"NULL"</span>),</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>        <span class="at">showProgress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>        <span class="at">colClasses =</span> <span class="st">"character"</span></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(dt)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setDT</span>(dt)</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(dt)) dt[, HASHKEY <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(HASHKEY)]</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(dt, <span class="fu">clean_colnames</span>(<span class="fu">names</span>(dt)))</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>  dt[, year <span class="sc">:</span><span class="er">=</span> <span class="fu">extract_year</span>(filename)]</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>  dt[, source_file <span class="sc">:</span><span class="er">=</span> filename]</span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>  dt[]</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Renombrado dinámico de columnas de dosis</span></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>rename_dosis_cols <span class="ot">&lt;-</span> <span class="cf">function</span>(dt) {</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> <span class="fu">names</span>(dt)</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>  dose_mask <span class="ot">&lt;-</span> <span class="fu">startsWith</span>(nms, <span class="st">"d_af_a_sis_"</span>)</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(dose_mask)) <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>  sufijos <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^d_af_a_sis_"</span>, <span class="st">""</span>, nms[dose_mask])</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>  sub_map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oh"</span> <span class="ot">=</span> <span class="st">"alcohol"</span>,</span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>    <span class="st">"thc"</span> <span class="ot">=</span> <span class="st">"cannabis"</span>,</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pbc"</span> <span class="ot">=</span> <span class="st">"pasta_base"</span>,</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>    <span class="st">"coc"</span> <span class="ot">=</span> <span class="st">"cocaina"</span>,</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bzd"</span> <span class="ot">=</span> <span class="st">"benzodiacepinas"</span>,</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    <span class="st">"otra"</span> <span class="ot">=</span> <span class="st">"otra_sustancia"</span></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>  suf_ok <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sufijos <span class="sc">%in%</span> <span class="fu">names</span>(sub_map), sub_map[sufijos], sufijos)</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>  nuevos <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"dosis_"</span>, suf_ok)</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(dt, nms[dose_mask], nuevos)</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Funciones de limpieza de texto</span></span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================</span></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: forzar a character cuando venga factor</span></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>.as_char <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(x))    <span class="fu">return</span>(<span class="fu">as.character</span>(x))</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta "mojibake" típico</span></span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>.has_mojibake <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"(Ã|Â|â|�)"</span>, x), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Normaliza texto: espacios invisibles, comillas/guiones, trim</span></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>normalize_text <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u00A0"</span>, <span class="st">" "</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)                 <span class="co"># NBSP</span></span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u200B\u200C\u200D\uFEFF]"</span>, <span class="st">""</span>, x)            <span class="co"># zero-width</span></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u201C\u201D]"</span>, <span class="st">"</span><span class="sc">\"</span><span class="st">"</span>, x)                      <span class="co"># " "</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u2019"</span>, <span class="st">"'"</span>, x)                               <span class="co"># '</span></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u2013\u2014]"</span>, <span class="st">"-"</span>, x)                       <span class="co"># – —</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">'""'</span>, <span class="st">'"'</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" +"</span>, <span class="st">" "</span>, x)</span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trimws</span>(x)</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback de reemplazos comunes de mojibake</span></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback de reemplazos comunes de mojibake (incluye variantes con "f"/"ƒ")</span></span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>.fix_mojibake_pairs <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Variantes básicas (una sola pasada UTF-8 interpretada como latin1)</span></span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>  basics_from <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Ã¡"</span>,<span class="st">"Ã©"</span>,<span class="st">"Ã­"</span>,<span class="st">"Ã³"</span>,<span class="st">"Ãº"</span>,<span class="st">"Ãñ"</span>,<span class="st">"ÃÑ"</span>,<span class="st">"Ãœ"</span>,<span class="st">"Ã¼"</span>,<span class="st">"Ã‰"</span>,<span class="st">"Ã“"</span>,<span class="st">"Ãš"</span>,<span class="st">"Ã"</span>,<span class="st">"Ã"</span>)</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>  basics_to   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"á"</span>,<span class="st">"é"</span>,<span class="st">"í"</span>,<span class="st">"ó"</span>,<span class="st">"ú"</span>,<span class="st">"ñ"</span>,<span class="st">"Ñ"</span>,<span class="st">"Ü"</span>,<span class="st">"ü"</span>,<span class="st">"É"</span>,<span class="st">"Ó"</span>,<span class="st">"Ú"</span>,<span class="st">"Á"</span>,<span class="st">"Í"</span>)</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(basics_from)) x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(basics_from[i], basics_to[i], x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Doble codificación muy común (ÃƒÂ*)</span></span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>  dbl_from <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ÃƒÂ¡"</span>,<span class="st">"ÃƒÂ©"</span>,<span class="st">"ÃƒÂ­"</span>,<span class="st">"ÃƒÂ³"</span>,<span class="st">"ÃƒÂº"</span>,<span class="st">"ÃƒÂ±"</span>,<span class="st">"Ãƒâ€˜"</span>,<span class="st">"ÃƒÂœ"</span>,<span class="st">"ÃƒÂº"</span>,<span class="st">"ÃƒÂ"</span></span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>  dbl_to   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"á"</span>,<span class="st">"é"</span>,<span class="st">"í"</span>,<span class="st">"ó"</span>,<span class="st">"ú"</span>,<span class="st">"ñ"</span>,<span class="st">"Ñ"</span>,<span class="st">"Ü"</span>,<span class="st">"ú"</span>,<span class="st">"Ã"</span>) <span class="co"># "ÃƒÂ" suelto → "Ã" (luego cae en basics)</span></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(dbl_from)) x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(dbl_from[i], dbl_to[i], x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Misma doble codificación vista como "ÃfÂ*" (cuando ƒ se ve como f)</span></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Usamos regex para cubrir "f" o "ƒ"</span></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â¡"</span>, <span class="st">"á"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â©"</span>, <span class="st">"é"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â­"</span>, <span class="st">"í"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â³"</span>, <span class="st">"ó"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Âº"</span>, <span class="st">"ú"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â±"</span>, <span class="st">"ñ"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]â€˜"</span>, <span class="st">"Ñ"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otros restos comunes</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Âº"</span>,<span class="st">"º"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Âª"</span>,<span class="st">"ª"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Â°"</span>,<span class="st">"°"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚"</span>,<span class="st">""</span>,  x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)     <span class="co"># Â sobrante</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Comillas/guiones mojibake de cp1252 → UTF-8 mal decodificado</span></span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â€œ"</span>, <span class="st">"–"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â€"</span>, <span class="st">"—"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Ëœ"</span>, <span class="st">"‘"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â„¢"</span>, <span class="st">"’"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Å“"</span>, <span class="st">"“"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Â"</span>, <span class="st">"”"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Reparador principal de mojibake</span></span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>.repair_mojibake_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>  safe_iconv <span class="ot">&lt;-</span> <span class="cf">function</span>(z, from, to) {</span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(<span class="fu">iconv</span>(z, <span class="at">from =</span> from, <span class="at">to =</span> to, <span class="at">sub =</span> <span class="cn">NA</span>))</span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a>  cand <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>    <span class="at">raw            =</span> x,</span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">enc2utf8       =</span> <span class="fu">enc2utf8</span>(x),</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">latin1_to_utf8 =</span> <span class="fu">safe_iconv</span>(x, <span class="st">"latin1"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">cp1252_to_utf8 =</span> <span class="fu">safe_iconv</span>(x, <span class="st">"CP1252"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">rt_latin1      =</span> <span class="fu">safe_iconv</span>(<span class="fu">safe_iconv</span>(x, <span class="st">"UTF-8"</span>, <span class="st">"latin1"</span>),  <span class="st">"latin1"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">rt_cp1252      =</span> <span class="fu">safe_iconv</span>(<span class="fu">safe_iconv</span>(x, <span class="st">"UTF-8"</span>, <span class="st">"CP1252"</span>),  <span class="st">"CP1252"</span>,  <span class="st">"UTF-8"</span>)</span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Elige el candidato con menos rastros</span></span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="cf">function</span>(v) {</span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>    v2 <span class="ot">&lt;-</span> v</span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>    v2[<span class="fu">is.na</span>(v2)] <span class="ot">&lt;-</span> x[<span class="fu">is.na</span>(v2)]</span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">grepl</span>(<span class="st">"Ã|Â|â|�"</span>, v2))</span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> <span class="fu">sapply</span>(cand, score)</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> cand[[<span class="fu">names</span>(<span class="fu">which.min</span>(scores))[<span class="dv">1</span>]]]</span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>  out[<span class="fu">is.na</span>(out)] <span class="ot">&lt;-</span> x[<span class="fu">is.na</span>(out)]</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\uFEFF"</span>, <span class="st">""</span>, out, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u00A0"</span>, <span class="st">" "</span>, out, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aplica fallback explícito</span></span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">.fix_mojibake_pairs</span>(out)</span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">.fix_mojibake_pairs</span>(out)  <span class="co"># Segunda pasada</span></span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta si columna es mayormente numérica</span></span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>is_mostly_numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">threshold =</span> <span class="fl">0.90</span>) {</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(x)</span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">"."</span>, y, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">trimws</span>(y)</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[<span class="sc">!</span><span class="fu">is.na</span>(y) <span class="sc">&amp;</span> y <span class="sc">!=</span> <span class="st">""</span>]</span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(y)) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>  ok <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^[-+]?</span><span class="sc">\\</span><span class="st">d*(?:</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">d+)?$"</span>, y)</span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(ok) <span class="sc">&gt;=</span> threshold</span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Conversión segura a numérico</span></span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>to_numeric_safely <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(x))</span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(x)</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">"."</span>, y, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"NaN"</span>, <span class="st">"null"</span>, <span class="st">"NULL"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(y))</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a><span class="co"># Función principal de casteo</span></span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>clean_cast_dataset <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">id_cols =</span> <span class="st">"HASHKEY"</span>, <span class="at">numeric_threshold =</span> <span class="fl">0.90</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(df)) <span class="fu">stop</span>(<span class="st">"df debe ser un data.frame/tibble."</span>)</span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> df</span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>  id_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(id_cols, <span class="fu">names</span>(out))</span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Limpiar columnas character excepto IDs</span></span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>  char_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(out)[<span class="fu">vapply</span>(out, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>  char_cols_to_clean <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(char_cols, id_cols)</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(char_cols_to_clean)) {</span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (nm <span class="cf">in</span> char_cols_to_clean) {</span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(<span class="fu">.repair_mojibake_vec</span>(out[[nm]]))</span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Castear a numeric si corresponde</span></span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>  converted_to_numeric <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(out), id_cols)) {</span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(out[[nm]]) <span class="sc">&amp;&amp;</span> <span class="fu">is_mostly_numeric</span>(out[[nm]], numeric_threshold)) {</span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">to_numeric_safely</span>(out[[nm]])</span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>      converted_to_numeric <span class="ot">&lt;-</span> <span class="fu">c</span>(converted_to_numeric, nm)</span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Castear resto a factor</span></span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>  converted_to_factor <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(out), id_cols)) {</span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(out[[nm]])) {</span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">normalize_text</span>(out[[nm]]))</span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a>      converted_to_factor <span class="ot">&lt;-</span> <span class="fu">c</span>(converted_to_factor, nm)</span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mantener IDs como character</span></span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> id_cols) {</span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(out[[nm]])) {</span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(df[[nm]])</span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-355"><a href="#cb2-355" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================</span></span>
<span id="cb2-356"><a href="#cb2-356" aria-hidden="true" tabindex="-1"></a><span class="co"># Funciones de recodificación</span></span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================</span></span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a>.squish <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>, <span class="st">" "</span>, <span class="fu">trimws</span>(<span class="fu">.as_char</span>(x)))</span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a>.recode_si_no <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">yes_label =</span> <span class="st">"Sí"</span>, <span class="at">no_label =</span> <span class="st">"No"</span>) {</span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a>  yu <span class="ot">&lt;-</span> <span class="fu">toupper</span>(y)</span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>  is_yes <span class="ot">&lt;-</span> yu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"SI"</span>,<span class="st">"SÍ"</span>,<span class="st">"SÍ"</span>)</span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a>  is_no  <span class="ot">&lt;-</span> yu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"N"</span>,<span class="st">"NO"</span>)</span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a>  y[is_yes] <span class="ot">&lt;-</span> yes_label</span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a>  y[is_no]  <span class="ot">&lt;-</span> no_label</span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a><span class="co"># Unifica categorías de sustancias</span></span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a>.recode_sustancia <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a>  lx <span class="ot">&lt;-</span> <span class="fu">tolower</span>(y)</span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a>  canon <span class="ot">&lt;-</span> y</span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a>  set <span class="ot">&lt;-</span> <span class="cf">function</span>(idx, val) { canon[idx] <span class="ot">&lt;&lt;-</span> val }</span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^inhalables"</span>,                         lx), <span class="st">"Inhalables"</span>)</span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sedantes"</span>,                           lx), <span class="st">"Sedantes"</span>)</span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hipn[oó]ticos"</span>,                      lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Hipnóticos"</span>)</span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"otros</span><span class="sc">\\</span><span class="st">s+opioides</span><span class="sc">\\</span><span class="st">s+analg"</span>,         lx), <span class="st">"Otros Opioides Analgésicos"</span>)</span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros</span><span class="sc">\\</span><span class="st">s+alucin[oó]genos"</span>,          lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Otros Alucinógenos"</span>)</span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros</span><span class="sc">\\</span><span class="st">s+estimulantes"</span>,             lx), <span class="st">"Otros Estimulantes"</span>)</span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^pasta</span><span class="sc">\\</span><span class="st">s+base"</span>,                     lx), <span class="st">"Pasta Base"</span>)</span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^coca[ií]na"</span>,                        lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Cocaína"</span>)</span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^(?:e|é)xtasis"</span>,                     lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Éxtasis"</span>)</span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hero[ií]na"</span>,                        lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Heroína"</span>)</span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^marihuana"</span>,                         lx), <span class="st">"Marihuana"</span>)</span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^metanfetaminas?"</span>,                   lx), <span class="st">"Metanfetaminas y otros derivados"</span>)</span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^anfetaminas?"</span>,                      lx), <span class="st">"Anfetaminas"</span>)</span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^metadona"</span>,                          lx), <span class="st">"Metadona"</span>)</span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hongos$"</span>,                           lx), <span class="st">"Hongos"</span>)</span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^lsd$"</span>,                              lx), <span class="st">"LSD"</span>)</span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^crack$"</span>,                            lx), <span class="st">"Crack"</span>)</span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^alcohol$"</span>,                          lx), <span class="st">"Alcohol"</span>)</span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^tranquilizantes"</span>,                   lx), <span class="st">"Tranquilizantes"</span>)</span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^fenilciclidina"</span>,                    lx), <span class="st">"Fenilciclidina"</span>)</span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+consumo$"</span>,                   lx), <span class="st">"Sin consumo"</span>)</span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+especificar$"</span>,              lx), <span class="st">"Sin especificar"</span>)</span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+sustancia</span><span class="sc">\\</span><span class="st">s+principal"</span>,     lx), <span class="st">"Sin sustancia principal"</span>)</span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros$"</span>,                            lx), <span class="st">"Otros"</span>)</span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a>  canon</span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajustes puntuales</span></span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>.recode_tipo_centro <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(<span class="fu">tolower</span>(y))</span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">==</span> <span class="st">"publico"</span>] <span class="ot">&lt;-</span> <span class="st">"Público"</span></span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">==</span> <span class="st">"privado"</span>] <span class="ot">&lt;-</span> <span class="st">"Privado"</span></span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a>.recode_motivo_egreso <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"Admnistrativa"</span>, <span class="st">"Administrativa"</span>, y, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a>.recode_eval_proceso <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(?i)minimo"</span>, <span class="st">"Mínimo"</span>, y, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Función principal de recodificación</span></span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>limpiar_caracteres_y_recodificar <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.data.frame</span>(df))</span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a>  is_chr <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb2-439"><a href="#cb2-439" aria-hidden="true" tabindex="-1"></a>  is_fac <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df, is.factor, <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb2-440"><a href="#cb2-440" aria-hidden="true" tabindex="-1"></a>  cols_cf <span class="ot">&lt;-</span> <span class="fu">names</span>(df)[is_chr <span class="sc">|</span> is_fac]</span>
<span id="cb2-441"><a href="#cb2-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-442"><a href="#cb2-442" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reparar encoding + espacios</span></span>
<span id="cb2-443"><a href="#cb2-443" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> cols_cf) {</span>
<span id="cb2-444"><a href="#cb2-444" aria-hidden="true" tabindex="-1"></a>    was_factor <span class="ot">&lt;-</span> <span class="fu">is.factor</span>(df[[nm]])</span>
<span id="cb2-445"><a href="#cb2-445" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">.squish</span>(<span class="fu">.repair_mojibake_vec</span>(df[[nm]]))</span>
<span id="cb2-446"><a href="#cb2-446" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="cf">if</span> (was_factor) <span class="fu">factor</span>(tmp) <span class="cf">else</span> tmp</span>
<span id="cb2-447"><a href="#cb2-447" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-448"><a href="#cb2-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-449"><a href="#cb2-449" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detectar y recodificar S/N</span></span>
<span id="cb2-450"><a href="#cb2-450" aria-hidden="true" tabindex="-1"></a>  sn_cols <span class="ot">&lt;-</span> cols_cf[<span class="fu">sapply</span>(cols_cf, <span class="cf">function</span>(nm) {</span>
<span id="cb2-451"><a href="#cb2-451" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">toupper</span>(<span class="fu">trimws</span>(<span class="fu">.as_char</span>(df[[nm]]))))</span>
<span id="cb2-452"><a href="#cb2-452" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> u[<span class="sc">!</span><span class="fu">is.na</span>(u)]</span>
<span id="cb2-453"><a href="#cb2-453" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(u) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(u <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"N"</span>,<span class="st">"SI"</span>,<span class="st">"SÍ"</span>,<span class="st">"SÍ"</span>,<span class="st">"NO"</span>))</span>
<span id="cb2-454"><a href="#cb2-454" aria-hidden="true" tabindex="-1"></a>  })]</span>
<span id="cb2-455"><a href="#cb2-455" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-456"><a href="#cb2-456" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> sn_cols) {</span>
<span id="cb2-457"><a href="#cb2-457" aria-hidden="true" tabindex="-1"></a>    lab <span class="ot">&lt;-</span> <span class="fu">.recode_si_no</span>(df[[nm]])</span>
<span id="cb2-458"><a href="#cb2-458" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(lab, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"No"</span>,<span class="st">"Sí"</span>))</span>
<span id="cb2-459"><a href="#cb2-459" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-460"><a href="#cb2-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-461"><a href="#cb2-461" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unificar sustancias</span></span>
<span id="cb2-462"><a href="#cb2-462" aria-hidden="true" tabindex="-1"></a>  sust_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(</span>
<span id="cb2-463"><a href="#cb2-463" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal_1"</span>,<span class="st">"sustancia_principal_2"</span>,<span class="st">"sustancia_principal_3"</span>,</span>
<span id="cb2-464"><a href="#cb2-464" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal1"</span>,<span class="st">"sustancia_principal2"</span>,<span class="st">"sustancia_principal3"</span></span>
<span id="cb2-465"><a href="#cb2-465" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb2-466"><a href="#cb2-466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-467"><a href="#cb2-467" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> sust_cols) {</span>
<span id="cb2-468"><a href="#cb2-468" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">.recode_sustancia</span>(df[[nm]])</span>
<span id="cb2-469"><a href="#cb2-469" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(tmp)</span>
<span id="cb2-470"><a href="#cb2-470" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-471"><a href="#cb2-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-472"><a href="#cb2-472" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ajustes puntuales</span></span>
<span id="cb2-473"><a href="#cb2-473" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"tipo_centro"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb2-474"><a href="#cb2-474" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>tipo_centro <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_tipo_centro</span>(df<span class="sc">$</span>tipo_centro))</span>
<span id="cb2-475"><a href="#cb2-475" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-476"><a href="#cb2-476" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"motivo_egreso"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb2-477"><a href="#cb2-477" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>motivo_egreso <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_motivo_egreso</span>(df<span class="sc">$</span>motivo_egreso))</span>
<span id="cb2-478"><a href="#cb2-478" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-479"><a href="#cb2-479" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"evaluacion_proceso_terapeutico"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb2-480"><a href="#cb2-480" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>evaluacion_proceso_terapeutico <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_eval_proceso</span>(df<span class="sc">$</span>evaluacion_proceso_terapeutico))</span>
<span id="cb2-481"><a href="#cb2-481" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-482"><a href="#cb2-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-483"><a href="#cb2-483" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb2-484"><a href="#cb2-484" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-485"><a href="#cb2-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-486"><a href="#cb2-486" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Pipeline principal ==================================================</span></span>
<span id="cb2-487"><a href="#cb2-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-488"><a href="#cb2-488" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar si existe el archivo RDS final</span></span>
<span id="cb2-489"><a href="#cb2-489" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(output_rds)) {</span>
<span id="cb2-490"><a href="#cb2-490" aria-hidden="true" tabindex="-1"></a>  datos_final <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(output_rds)</span>
<span id="cb2-491"><a href="#cb2-491" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-492"><a href="#cb2-492" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-493"><a href="#cb2-493" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span><span class="al">TODO</span><span class="co"> EL PROCESAMIENTO OCURRE AQUÍ SI NO EXISTE EL ARCHIVO FINAL</span></span>
<span id="cb2-494"><a href="#cb2-494" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-495"><a href="#cb2-495" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Primera etapa: verificar caché intermedio</span></span>
<span id="cb2-496"><a href="#cb2-496" aria-hidden="true" tabindex="-1"></a>  output_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022.rds"</span>)</span>
<span id="cb2-497"><a href="#cb2-497" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-498"><a href="#cb2-498" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(output_path)) {</span>
<span id="cb2-499"><a href="#cb2-499" aria-hidden="true" tabindex="-1"></a>    datos_completos <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(output_path)</span>
<span id="cb2-500"><a href="#cb2-500" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-501"><a href="#cb2-501" aria-hidden="true" tabindex="-1"></a>    lista <span class="ot">&lt;-</span> <span class="fu">lapply</span>(archivos, read_top_file)</span>
<span id="cb2-502"><a href="#cb2-502" aria-hidden="true" tabindex="-1"></a>    lista <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="fu">Negate</span>(is.null), lista)</span>
<span id="cb2-503"><a href="#cb2-503" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(lista) <span class="sc">==</span> <span class="dv">0</span>L) <span class="fu">stop</span>(<span class="st">"No se encontró ningún archivo en: "</span>, base_path)</span>
<span id="cb2-504"><a href="#cb2-504" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-505"><a href="#cb2-505" aria-hidden="true" tabindex="-1"></a>    datos_completos <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">rbindlist</span>(lista, <span class="at">fill =</span> <span class="cn">TRUE</span>, <span class="at">use.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-506"><a href="#cb2-506" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-507"><a href="#cb2-507" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Repara mojibake en TODAS las columnas de texto (excepto hashkey)</span></span>
<span id="cb2-508"><a href="#cb2-508" aria-hidden="true" tabindex="-1"></a>    char_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_completos)[<span class="fu">vapply</span>(datos_completos, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb2-509"><a href="#cb2-509" aria-hidden="true" tabindex="-1"></a>    char_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(char_cols, <span class="st">"hashkey"</span>)</span>
<span id="cb2-510"><a href="#cb2-510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(char_cols)) {</span>
<span id="cb2-511"><a href="#cb2-511" aria-hidden="true" tabindex="-1"></a>      datos_completos[, (char_cols) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, fix_mojibake), .SDcols <span class="ot">=</span> char_cols]</span>
<span id="cb2-512"><a href="#cb2-512" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-513"><a href="#cb2-513" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-514"><a href="#cb2-514" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Candidatas por nombre y parseo de fechas</span></span>
<span id="cb2-515"><a href="#cb2-515" aria-hidden="true" tabindex="-1"></a>    posibles_fechas <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_completos)[<span class="fu">vapply</span>(<span class="fu">names</span>(datos_completos), is_date_like, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb2-516"><a href="#cb2-516" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> <span class="fu">intersect</span>(posibles_fechas, <span class="fu">names</span>(datos_completos))) {</span>
<span id="cb2-517"><a href="#cb2-517" aria-hidden="true" tabindex="-1"></a>      datos_completos[[col]] <span class="ot">&lt;-</span> <span class="fu">parse_mixed_dates</span>(datos_completos[[col]])</span>
<span id="cb2-518"><a href="#cb2-518" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-519"><a href="#cb2-519" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-520"><a href="#cb2-520" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Guarda cache crudo-limpio (antes de renombrados semánticos)</span></span>
<span id="cb2-521"><a href="#cb2-521" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(datos_completos, output_path)</span>
<span id="cb2-522"><a href="#cb2-522" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-523"><a href="#cb2-523" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-524"><a href="#cb2-524" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5) Renombrado semántico TOP (incluye dosis) ----------------------------</span></span>
<span id="cb2-525"><a href="#cb2-525" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-526"><a href="#cb2-526" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.1 HASHKEY mayúsculas, eliminar id</span></span>
<span id="cb2-527"><a href="#cb2-527" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"hashkey"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) {</span>
<span id="cb2-528"><a href="#cb2-528" aria-hidden="true" tabindex="-1"></a>    data.table<span class="sc">::</span><span class="fu">setnames</span>(datos_completos, <span class="st">"hashkey"</span>, <span class="st">"HASHKEY"</span>)</span>
<span id="cb2-529"><a href="#cb2-529" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="st">"hashkey"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos) <span class="sc">&amp;&amp;</span> <span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) {</span>
<span id="cb2-530"><a href="#cb2-530" aria-hidden="true" tabindex="-1"></a>    datos_completos[, HASHKEY <span class="sc">:</span><span class="er">=</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">as.character</span>(HASHKEY), <span class="fu">as.character</span>(hashkey))]</span>
<span id="cb2-531"><a href="#cb2-531" aria-hidden="true" tabindex="-1"></a>    datos_completos[, hashkey <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb2-532"><a href="#cb2-532" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-533"><a href="#cb2-533" aria-hidden="true" tabindex="-1"></a>  datos_completos[, HASHKEY <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(HASHKEY)]</span>
<span id="cb2-534"><a href="#cb2-534" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"id"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) datos_completos[, id <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb2-535"><a href="#cb2-535" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-536"><a href="#cb2-536" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.2 Mapeo estático (fechas, centros, sustancias totales, dominios sociales)</span></span>
<span id="cb2-537"><a href="#cb2-537" aria-hidden="true" tabindex="-1"></a>  rename_map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-538"><a href="#cb2-538" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fechas y cabecera TOP</span></span>
<span id="cb2-539"><a href="#cb2-539" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_aplicaci_af_a_n_top"</span>    <span class="ot">=</span> <span class="st">"fecha_aplicacion_top"</span>,</span>
<span id="cb2-540"><a href="#cb2-540" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nombre_apliacadordel_top"</span>     <span class="ot">=</span> <span class="st">"nombre_aplicador_top"</span>,</span>
<span id="cb2-541"><a href="#cb2-541" aria-hidden="true" tabindex="-1"></a>    <span class="st">"etapadel_tratamiento"</span>         <span class="ot">=</span> <span class="st">"etapa_tratamiento"</span>,</span>
<span id="cb2-542"><a href="#cb2-542" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fechade_ingresoa_tratamiento"</span> <span class="ot">=</span> <span class="st">"fecha_ingreso_tratamiento"</span>,</span>
<span id="cb2-543"><a href="#cb2-543" aria-hidden="true" tabindex="-1"></a>    <span class="st">"plande_tratamiento"</span>           <span class="ot">=</span> <span class="st">"plan_tratamiento"</span>,</span>
<span id="cb2-544"><a href="#cb2-544" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nombredel_centro"</span>             <span class="ot">=</span> <span class="st">"nombre_centro"</span>,</span>
<span id="cb2-545"><a href="#cb2-545" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tipo_centro"</span>                  <span class="ot">=</span> <span class="st">"tipo_centro"</span>,</span>
<span id="cb2-546"><a href="#cb2-546" aria-hidden="true" tabindex="-1"></a>    <span class="st">"regi_af_a_n_centro"</span>           <span class="ot">=</span> <span class="st">"region_centro"</span>,</span>
<span id="cb2-547"><a href="#cb2-547" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_nacimiento"</span>             <span class="ot">=</span> <span class="st">"fecha_nacimiento"</span>,</span>
<span id="cb2-548"><a href="#cb2-548" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_egreso"</span>                 <span class="ot">=</span> <span class="st">"fecha_egreso"</span>,</span>
<span id="cb2-549"><a href="#cb2-549" aria-hidden="true" tabindex="-1"></a>    <span class="st">"motivo_egreso"</span>                <span class="ot">=</span> <span class="st">"motivo_egreso"</span>,</span>
<span id="cb2-550"><a href="#cb2-550" aria-hidden="true" tabindex="-1"></a>    <span class="st">"evaluacion_proceso_terapeutico"</span> <span class="ot">=</span> <span class="st">"evaluacion_proceso_terapeutico"</span>,</span>
<span id="cb2-551"><a href="#cb2-551" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-552"><a href="#cb2-552" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sustancias (totales)</span></span>
<span id="cb2-553"><a href="#cb2-553" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_oh"</span>    <span class="ot">=</span> <span class="st">"total_alcohol"</span>,</span>
<span id="cb2-554"><a href="#cb2-554" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_thc"</span>   <span class="ot">=</span> <span class="st">"total_cannabis"</span>,</span>
<span id="cb2-555"><a href="#cb2-555" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_pbc"</span>   <span class="ot">=</span> <span class="st">"total_pasta_base"</span>,</span>
<span id="cb2-556"><a href="#cb2-556" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_coc"</span>   <span class="ot">=</span> <span class="st">"total_cocaina"</span>,</span>
<span id="cb2-557"><a href="#cb2-557" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_bzd"</span>   <span class="ot">=</span> <span class="st">"total_benzodiacepinas"</span>,</span>
<span id="cb2-558"><a href="#cb2-558" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_otra"</span>  <span class="ot">=</span> <span class="st">"total_otra_sustancia"</span>,</span>
<span id="cb2-559"><a href="#cb2-559" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-560"><a href="#cb2-560" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sustancia(s) principal(es)</span></span>
<span id="cb2-561"><a href="#cb2-561" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal1"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_1"</span>,</span>
<span id="cb2-562"><a href="#cb2-562" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal2"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_2"</span>,</span>
<span id="cb2-563"><a href="#cb2-563" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal3"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_3"</span>,</span>
<span id="cb2-564"><a href="#cb2-564" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-565"><a href="#cb2-565" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delitos / Transgresión</span></span>
<span id="cb2-566"><a href="#cb2-566" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hurto"</span>                   <span class="ot">=</span> <span class="st">"hurto"</span>,</span>
<span id="cb2-567"><a href="#cb2-567" aria-hidden="true" tabindex="-1"></a>    <span class="st">"robo"</span>                    <span class="ot">=</span> <span class="st">"robo"</span>,</span>
<span id="cb2-568"><a href="#cb2-568" aria-hidden="true" tabindex="-1"></a>    <span class="st">"venta_drogas"</span>            <span class="ot">=</span> <span class="st">"venta_de_drogas"</span>,</span>
<span id="cb2-569"><a href="#cb2-569" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ri_af_a_a"</span>               <span class="ot">=</span> <span class="st">"rina"</span>,</span>
<span id="cb2-570"><a href="#cb2-570" aria-hidden="true" tabindex="-1"></a>    <span class="st">"otro"</span>                    <span class="ot">=</span> <span class="st">"otro_delito"</span>,</span>
<span id="cb2-571"><a href="#cb2-571" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_vif"</span>               <span class="ot">=</span> <span class="st">"total_violencia_intrafamiliar"</span>,</span>
<span id="cb2-572"><a href="#cb2-572" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_transgresi_af_a_n"</span> <span class="ot">=</span> <span class="st">"total_transgresion"</span>,</span>
<span id="cb2-573"><a href="#cb2-573" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-574"><a href="#cb2-574" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Salud y funcionamiento social</span></span>
<span id="cb2-575"><a href="#cb2-575" aria-hidden="true" tabindex="-1"></a>    <span class="st">"salud_psicol_af_a_gica"</span>  <span class="ot">=</span> <span class="st">"salud_psicologica"</span>,</span>
<span id="cb2-576"><a href="#cb2-576" aria-hidden="true" tabindex="-1"></a>    <span class="st">"salud_f_af_a_sica"</span>       <span class="ot">=</span> <span class="st">"salud_fisica"</span>,</span>
<span id="cb2-577"><a href="#cb2-577" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_trabajo"</span>           <span class="ot">=</span> <span class="st">"total_trabajo"</span>,</span>
<span id="cb2-578"><a href="#cb2-578" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_educaci_af_a_n"</span>    <span class="ot">=</span> <span class="st">"total_educacion"</span>,</span>
<span id="cb2-579"><a href="#cb2-579" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-580"><a href="#cb2-580" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vivienda / Calidad de vida</span></span>
<span id="cb2-581"><a href="#cb2-581" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lugar_vivir"</span>             <span class="ot">=</span> <span class="st">"lugar_donde_vive"</span>,</span>
<span id="cb2-582"><a href="#cb2-582" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vivienda"</span>                <span class="ot">=</span> <span class="st">"tipo_vivienda"</span>,</span>
<span id="cb2-583"><a href="#cb2-583" aria-hidden="true" tabindex="-1"></a>    <span class="st">"calidad_vida"</span>            <span class="ot">=</span> <span class="st">"calidad_de_vida"</span></span>
<span id="cb2-584"><a href="#cb2-584" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-585"><a href="#cb2-585" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-586"><a href="#cb2-586" aria-hidden="true" tabindex="-1"></a>  existentes <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(rename_map), <span class="fu">names</span>(datos_completos))</span>
<span id="cb2-587"><a href="#cb2-587" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(existentes)) data.table<span class="sc">::</span><span class="fu">setnames</span>(datos_completos, existentes, <span class="fu">unname</span>(rename_map[existentes]))</span>
<span id="cb2-588"><a href="#cb2-588" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-589"><a href="#cb2-589" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.3 Renombrado dinámico de dosis (todas las d_af_a_sis_*)</span></span>
<span id="cb2-590"><a href="#cb2-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_dosis_cols</span>(datos_completos)</span>
<span id="cb2-591"><a href="#cb2-591" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-592"><a href="#cb2-592" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.4 Reordenar: HASHKEY y year primero</span></span>
<span id="cb2-593"><a href="#cb2-593" aria-hidden="true" tabindex="-1"></a>  primero <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"HASHKEY"</span>, <span class="st">"year"</span>)</span>
<span id="cb2-594"><a href="#cb2-594" aria-hidden="true" tabindex="-1"></a>  primero <span class="ot">&lt;-</span> primero[primero <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)]</span>
<span id="cb2-595"><a href="#cb2-595" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setcolorder</span>(datos_completos, <span class="fu">c</span>(primero, <span class="fu">setdiff</span>(<span class="fu">names</span>(datos_completos), primero)))</span>
<span id="cb2-596"><a href="#cb2-596" aria-hidden="true" tabindex="-1"></a>  datos_completos <span class="ot">&lt;-</span> datos_completos <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>nombre_aplicador_top, <span class="sc">-</span>source_file)</span>
<span id="cb2-597"><a href="#cb2-597" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-598"><a href="#cb2-598" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-599"><a href="#cb2-599" aria-hidden="true" tabindex="-1"></a>  <span class="co"># USO (fase 1: casteo)</span></span>
<span id="cb2-600"><a href="#cb2-600" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-601"><a href="#cb2-601" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> <span class="fu">clean_cast_dataset</span>(</span>
<span id="cb2-602"><a href="#cb2-602" aria-hidden="true" tabindex="-1"></a>    datos_completos,</span>
<span id="cb2-603"><a href="#cb2-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="st">"HASHKEY"</span>,</span>
<span id="cb2-604"><a href="#cb2-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">numeric_threshold =</span> <span class="fl">0.90</span>,</span>
<span id="cb2-605"><a href="#cb2-605" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb2-606"><a href="#cb2-606" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-607"><a href="#cb2-607" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-608"><a href="#cb2-608" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-609"><a href="#cb2-609" aria-hidden="true" tabindex="-1"></a>  <span class="co"># USO (fase 2: recodificación)</span></span>
<span id="cb2-610"><a href="#cb2-610" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb2-611"><a href="#cb2-611" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> <span class="fu">limpiar_caracteres_y_recodificar</span>(datos_limpios)</span>
<span id="cb2-612"><a href="#cb2-612" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-613"><a href="#cb2-613" aria-hidden="true" tabindex="-1"></a>  targets <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sustancia_principal_2"</span>,<span class="st">"sustancia_principal_3"</span>)</span>
<span id="cb2-614"><a href="#cb2-614" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-615"><a href="#cb2-615" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> datos_limpios <span class="sc">%&gt;%</span></span>
<span id="cb2-616"><a href="#cb2-616" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(targets), \(x) {</span>
<span id="cb2-617"><a href="#cb2-617" aria-hidden="true" tabindex="-1"></a>      x_chr <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb2-618"><a href="#cb2-618" aria-hidden="true" tabindex="-1"></a>      to_na <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^(?i)</span><span class="sc">\\</span><span class="st">s*sin</span><span class="sc">\\</span><span class="st">s+consumo</span><span class="sc">\\</span><span class="st">s*$"</span>, x_chr, <span class="at">perl =</span> <span class="cn">TRUE</span>) <span class="sc">|</span></span>
<span id="cb2-619"><a href="#cb2-619" aria-hidden="true" tabindex="-1"></a>               <span class="fu">grepl</span>(<span class="st">"^(?i)</span><span class="sc">\\</span><span class="st">s*sin</span><span class="sc">\\</span><span class="st">s+sustancia</span><span class="sc">\\</span><span class="st">s+principal(</span><span class="sc">\\</span><span class="st">s*</span><span class="sc">\\</span><span class="st">)?</span><span class="sc">\\</span><span class="st">s*)?$"</span>, x_chr, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-620"><a href="#cb2-620" aria-hidden="true" tabindex="-1"></a>      x_chr[to_na] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb2-621"><a href="#cb2-621" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(x_chr)</span>
<span id="cb2-622"><a href="#cb2-622" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb2-623"><a href="#cb2-623" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-624"><a href="#cb2-624" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asignar resultado final</span></span>
<span id="cb2-625"><a href="#cb2-625" aria-hidden="true" tabindex="-1"></a>  datos_final <span class="ot">&lt;-</span> datos_limpios</span>
<span id="cb2-626"><a href="#cb2-626" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-627"><a href="#cb2-627" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar RDS final</span></span>
<span id="cb2-628"><a href="#cb2-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(datos_final, output_rds)</span>
<span id="cb2-629"><a href="#cb2-629" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-630"><a href="#cb2-630" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar Excel</span></span>
<span id="cb2-631"><a href="#cb2-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb2-632"><a href="#cb2-632" aria-hidden="true" tabindex="-1"></a>    datos_excel <span class="ot">&lt;-</span> datos_final</span>
<span id="cb2-633"><a href="#cb2-633" aria-hidden="true" tabindex="-1"></a>    factor_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_excel)[<span class="fu">sapply</span>(datos_excel, is.factor)]</span>
<span id="cb2-634"><a href="#cb2-634" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> factor_cols) {</span>
<span id="cb2-635"><a href="#cb2-635" aria-hidden="true" tabindex="-1"></a>      datos_excel[[col]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(datos_excel[[col]])</span>
<span id="cb2-636"><a href="#cb2-636" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-637"><a href="#cb2-637" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-638"><a href="#cb2-638" aria-hidden="true" tabindex="-1"></a>    wb <span class="ot">&lt;-</span> openxlsx<span class="sc">::</span><span class="fu">createWorkbook</span>()</span>
<span id="cb2-639"><a href="#cb2-639" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">addWorksheet</span>(wb, <span class="st">"Datos_TOP_2015_2022"</span>)</span>
<span id="cb2-640"><a href="#cb2-640" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">writeDataTable</span>(wb, <span class="at">sheet =</span> <span class="dv">1</span>, <span class="at">x =</span> datos_excel, <span class="at">tableStyle =</span> <span class="st">"TableStyleLight1"</span>)</span>
<span id="cb2-641"><a href="#cb2-641" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">setColWidths</span>(wb, <span class="at">sheet =</span> <span class="dv">1</span>, <span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(datos_excel), <span class="at">widths =</span> <span class="st">"auto"</span>)</span>
<span id="cb2-642"><a href="#cb2-642" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">saveWorkbook</span>(wb, output_excel, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-643"><a href="#cb2-643" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb2-644"><a href="#cb2-644" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(datos_final, <span class="fu">gsub</span>(<span class="st">".xlsx$"</span>, <span class="st">".csv"</span>, output_excel), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-645"><a href="#cb2-645" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-646"><a href="#cb2-646" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-647"><a href="#cb2-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-648"><a href="#cb2-648" aria-hidden="true" tabindex="-1"></a><span class="co"># Datos finales disponibles en el objeto: datos_final</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="resultados" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Resultados</h1>
<p>Se estimó, para cada etapa del tratamiento (Inicio, 3 m, 6 m, 9 m, 12 m), una red de asociación condicional mediante EBICglasso. Se observó que el número de nodos se mantuvo constante en 16 mientras que el número de aristas decreció de 69 al inicio a 32 a los 12 meses, lo que se tradujo en una reducción de la densidad de la red desde <span class="math inline">\(\rho=0{,}575\)</span> hasta <span class="math inline">\(\rho=0{,}267\)</span>, con <span class="math inline">\(\rho\)</span> definida por</p>
<p><span class="math display">\[
\rho \;=\; \frac{2E}{N(N-1)}\,.
\]</span> De forma paralela, la longitud promedio de camino aumentó de <span class="math inline">\(1{,}44\)</span> a <span class="math inline">\(2{,}07\)</span> y el diámetro pasó de 3 a 4, evidenciando rutas más largas entre ítems. El clustering global mostró un leve descenso con la progresión del tratamiento, mientras que la modularidad tendió a aumentar, sugiriendo una organización más comunitaria y menos densa. La varianza del grado y de la fuerza disminuyeron en el tiempo y la asortatividad cambió de negativa (–0,248) al inicio a positiva (0,310) a los 12 meses, lo que es consistente con una reconfiguración hacia patrones de conexión más homogéneos. En conjunto, la red inicial aparece más densamente conectada y cercana a un patrón de “pequeño mundo”, en tanto que las redes de etapas posteriores se hacen más dispersas y modulares. La distribución muestral acompañó estas tendencias: la mayoría de las observaciones se concentró al inicio (73 430) y descendió a 8 726 hacia los 12 meses, lo que puede afectar la estabilidad de ciertas estimaciones en etapas tardías.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular métricas comprehensivas de red</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>calculate_comprehensive_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(net, stage_name) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(net)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear grafos con pesos absolutos y sin pesos</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  g_weighted <span class="ot">&lt;-</span> <span class="fu">graph_from_adjacency_matrix</span>(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(<span class="fu">as.matrix</span>(net<span class="sc">$</span>graph)),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">"undirected"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted =</span> <span class="cn">TRUE</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  g_unweighted <span class="ot">&lt;-</span> <span class="fu">graph_from_adjacency_matrix</span>(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>(net<span class="sc">$</span>graph <span class="sc">!=</span> <span class="dv">0</span>),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">"undirected"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted =</span> <span class="cn">NULL</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular todas las métricas</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  degree_vals <span class="ot">&lt;-</span> <span class="fu">degree</span>(g_unweighted)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  strength_vals <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  betweenness_vals <span class="ot">&lt;-</span> <span class="fu">betweenness</span>(g_unweighted, <span class="at">normalized =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  closeness_vals <span class="ot">&lt;-</span> <span class="fu">closeness</span>(g_unweighted, <span class="at">normalized =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  eigen_vals <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">eigen_centrality</span>(g_weighted)<span class="sc">$</span>vector,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="fu">vcount</span>(g_weighted))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  pagerank_vals <span class="ot">&lt;-</span> <span class="fu">page_rank</span>(g_weighted)<span class="sc">$</span>vector</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas globales detalladas</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  global_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas básicas</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodos</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">vcount</span>(g_weighted),</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Aristas</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ecount</span>(g_weighted),</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Densidad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">edge_density</span>(g_unweighted),</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de caminos</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diámetro</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">diameter</span>(g_unweighted, <span class="at">weights =</span> <span class="cn">NA</span>),</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Longitud promedio</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean_distance</span>(g_unweighted),</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de agrupamiento</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">transitivity</span>(g_unweighted, <span class="at">type =</span> <span class="st">"global"</span>),</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Clustering medio</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">transitivity</span>(g_unweighted, <span class="at">type =</span> <span class="st">"average"</span>),</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de grado</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado medio</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(degree_vals),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado máximo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">max</span>(degree_vals),</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado mínimo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">min</span>(degree_vals),</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Varianza grado</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">var</span>(degree_vals),</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de fuerza</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph)),</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza media</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(strength_vals),</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Varianza fuerza</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">var</span>(strength_vals),</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Asortatividad y modularidad</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Asortatividad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">assortativity_degree</span>(g_unweighted),</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Modularidad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">modularity</span>(<span class="fu">cluster_louvain</span>(g_weighted)),</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA_real_</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Componentes</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Componentes</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">components</span>(g_unweighted)<span class="sc">$</span>no,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas por nodo detalladas</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  node_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado</span><span class="st">`</span> <span class="ot">=</span> degree_vals,</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza</span><span class="st">`</span> <span class="ot">=</span> strength_vals,</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Intermediación</span><span class="st">`</span> <span class="ot">=</span> betweenness_vals,</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Cercanía</span><span class="st">`</span> <span class="ot">=</span> closeness_vals,</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Eigenvector</span><span class="st">`</span> <span class="ot">=</span> eigen_vals,</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">PageRank</span><span class="st">`</span> <span class="ot">=</span> pagerank_vals <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Clustering local</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">transitivity</span>(g_unweighted, <span class="at">type =</span> <span class="st">"local"</span>),</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estadísticas de centralidad agregadas</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  centrality_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Medida</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Grado"</span>, <span class="st">"Fuerza"</span>, <span class="st">"Intermediación"</span>, <span class="st">"Cercanía"</span>, <span class="st">"Eigenvector"</span>, <span class="st">"PageRank"</span>),</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Media</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(degree_vals),</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(strength_vals),</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(betweenness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(closeness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(eigen_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(pagerank_vals <span class="sc">*</span> <span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">SD</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(degree_vals),</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(strength_vals),</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(betweenness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(closeness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(eigen_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(pagerank_vals <span class="sc">*</span> <span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular intervalos de confianza para métricas</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  n_nodes <span class="ot">&lt;-</span> <span class="fu">length</span>(degree_vals)</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>  centrality_stats<span class="sc">$</span><span class="st">`</span><span class="at">CI_lower</span><span class="st">`</span> <span class="ot">&lt;-</span> centrality_stats<span class="sc">$</span>Media <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> centrality_stats<span class="sc">$</span>SD <span class="sc">/</span> <span class="fu">sqrt</span>(n_nodes)</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>  centrality_stats<span class="sc">$</span><span class="st">`</span><span class="at">CI_upper</span><span class="st">`</span> <span class="ot">&lt;-</span> centrality_stats<span class="sc">$</span>Media <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> centrality_stats<span class="sc">$</span>SD <span class="sc">/</span> <span class="fu">sqrt</span>(n_nodes)</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">global =</span> global_metrics,</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">nodes =</span> node_metrics,</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">centrality_stats =</span> centrality_stats,</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">graph =</span> g_unweighted</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para comparación con modelos nulos</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>compare_with_null_models <span class="ot">&lt;-</span> <span class="cf">function</span>(real_metrics, n_nodes, n_edges, <span class="at">n_sims =</span> <span class="dv">1000</span>) {</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular parámetros para los modelos</span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>  p_connect <span class="ot">&lt;-</span> real_metrics<span class="sc">$</span>Densidad</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>  avg_degree <span class="ot">&lt;-</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Grado medio</span><span class="st">`</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Función auxiliar para calcular métricas</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>  calc_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(g) {</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">clustering =</span> <span class="fu">transitivity</span>(g, <span class="at">type =</span> <span class="st">"global"</span>),</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>      <span class="at">path_length =</span> <span class="fu">mean_distance</span>(g, <span class="at">directed =</span> <span class="cn">FALSE</span>),</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>      <span class="at">diameter =</span> <span class="fu">diameter</span>(g, <span class="at">directed =</span> <span class="cn">FALSE</span>),</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">assortativity =</span> <span class="fu">assortativity_degree</span>(g, <span class="at">directed =</span> <span class="cn">FALSE</span>),</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_degree =</span> <span class="fu">max</span>(<span class="fu">degree</span>(g)),</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>      <span class="at">degree_variance =</span> <span class="fu">var</span>(<span class="fu">degree</span>(g))</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simular modelos ER</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>  er_metrics <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">replicate</span>(n_sims, {</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>    g_er <span class="ot">&lt;-</span> <span class="fu">erdos.renyi.game</span>(n_nodes, p_connect, <span class="at">type =</span> <span class="st">"gnp"</span>)</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calc_metrics</span>(g_er)</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simular modelos BA</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>  ba_metrics <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">replicate</span>(n_sims, {</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>    m_ba <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(avg_degree<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>    g_ba <span class="ot">&lt;-</span> <span class="fu">barabasi.game</span>(n_nodes, <span class="at">m =</span> m_ba, <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calc_metrics</span>(g_ba)</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular intervalos de confianza</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>  calculate_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(metrics_matrix, <span class="at">confidence =</span> <span class="fl">0.95</span>) {</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>    alpha <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> confidence</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">colMeans</span>(metrics_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> <span class="fu">apply</span>(metrics_matrix, <span class="dv">2</span>, quantile, <span class="at">probs =</span> alpha<span class="sc">/</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> <span class="fu">apply</span>(metrics_matrix, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> <span class="fu">apply</span>(metrics_matrix, <span class="dv">2</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>  er_ci <span class="ot">&lt;-</span> <span class="fu">calculate_ci</span>(er_metrics)</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>  ba_ci <span class="ot">&lt;-</span> <span class="fu">calculate_ci</span>(ba_metrics)</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular z-scores</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>  real_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">clustering =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span>,</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">path_length =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Longitud promedio</span><span class="st">`</span>,</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">diameter =</span> real_metrics<span class="sc">$</span>Diámetro,</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">assortativity =</span> real_metrics<span class="sc">$</span>Asortatividad,</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_degree =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Grado máximo</span><span class="st">`</span>,</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">degree_variance =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Varianza grado</span><span class="st">`</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>  z_scores_er <span class="ot">&lt;-</span> (real_vals <span class="sc">-</span> er_ci<span class="sc">$</span>mean) <span class="sc">/</span> er_ci<span class="sc">$</span>sd</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>  z_scores_ba <span class="ot">&lt;-</span> (real_vals <span class="sc">-</span> ba_ci<span class="sc">$</span>mean) <span class="sc">/</span> ba_ci<span class="sc">$</span>sd</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>  p_values_er <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(z_scores_er))</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>  p_values_ba <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(z_scores_ba))</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">er_ci =</span> er_ci,</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">ba_ci =</span> ba_ci,</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_scores_er =</span> z_scores_er,</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_scores_ba =</span> z_scores_ba,</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_values_er =</span> p_values_er,</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_values_ba =</span> p_values_ba,</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">real_vals =</span> real_vals</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir nodos por dominio temático siguiendo el TOP completo</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>vars_uso <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Alcohol"</span>, <span class="st">"Cannabis"</span>, <span class="st">"Pasta Base"</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Cocaína"</span>, <span class="st">"Benzodiacepinas"</span>, <span class="st">"Otra Sustancia"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>vars_transgresion <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Hurto"</span>, <span class="st">"Robo"</span>, <span class="st">"Venta de Drogas"</span>, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Riña"</span>, <span class="st">"Violencia Intrafamiliar"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>vars_salud <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Salud Psicológica"</span>, <span class="st">"Salud Física"</span>, <span class="st">"Calidad de Vida"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>vars_funcionamiento <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Días Trabajo"</span>, <span class="st">"Días Educación"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>nodes_all <span class="ot">&lt;-</span> <span class="fu">c</span>(vars_uso, vars_transgresion, vars_salud, vars_funcionamiento)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos con etapas estandarizadas</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>dat_analysis <span class="ot">&lt;-</span> datos_final <span class="sc">%&gt;%</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alcohol"</span> <span class="ot">=</span> total_alcohol,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cannabis"</span> <span class="ot">=</span> total_cannabis,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pasta Base"</span> <span class="ot">=</span> total_pasta_base,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cocaína"</span> <span class="ot">=</span> total_cocaina,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Benzodiacepinas"</span> <span class="ot">=</span> total_benzodiacepinas,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Otra Sustancia"</span> <span class="ot">=</span> total_otra_sustancia,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hurto"</span> <span class="ot">=</span> hurto,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Robo"</span> <span class="ot">=</span> robo,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Venta de Drogas"</span> <span class="ot">=</span> venta_de_drogas,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Riña"</span> <span class="ot">=</span> rina,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Violencia Intrafamiliar"</span> <span class="ot">=</span> total_violencia_intrafamiliar,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Salud Psicológica"</span> <span class="ot">=</span> salud_psicologica,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Salud Física"</span> <span class="ot">=</span> salud_fisica,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calidad de Vida"</span> <span class="ot">=</span> calidad_de_vida,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Días Trabajo"</span> <span class="ot">=</span> total_trabajo,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Días Educación"</span> <span class="ot">=</span> total_educacion</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hurto =</span> <span class="fu">ifelse</span>(Hurto <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">Robo =</span> <span class="fu">ifelse</span>(Robo <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Venta de Drogas</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">Venta de Drogas</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    Riña <span class="ot">=</span> <span class="fu">ifelse</span>(Riña <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">etapa_std =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"(?i)inicio"</span>) <span class="sc">~</span> <span class="st">"Inicio"</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"3"</span>) <span class="sc">~</span> <span class="st">"3m"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"6"</span>) <span class="sc">~</span> <span class="st">"6m"</span>,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"9"</span>) <span class="sc">~</span> <span class="st">"9m"</span>,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"12"</span>) <span class="sc">~</span> <span class="st">"12m"</span>,</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">tiempo_num =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"Inicio"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"3m"</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"6m"</span> <span class="sc">~</span> <span class="dv">6</span>,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"9m"</span> <span class="sc">~</span> <span class="dv">9</span>,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"12m"</span> <span class="sc">~</span> <span class="dv">12</span>,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(etapa_std)) <span class="sc">%&gt;%</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(HASHKEY, etapa_std, tiempo_num, <span class="fu">all_of</span>(nodes_all)) <span class="sc">%&gt;%</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(<span class="fu">any_of</span>(vars_salud))</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de datos</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>resumen_datos <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Métrica</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Total observaciones"</span>, <span class="st">"Pacientes únicos"</span>),</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Valor</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(dat_analysis), <span class="fu">n_distinct</span>(dat_analysis<span class="sc">$</span>HASHKEY)),</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>resumen_datos <span class="sc">%&gt;%</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Dimensiones del dataset"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Dimensiones del dataset</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Métrica</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Valor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total observaciones</td>
<td style="text-align: right;">167404</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pacientes únicos</td>
<td style="text-align: right;">56998</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribución por etapa</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>distribucion_etapas <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">table</span>(dat_analysis<span class="sc">$</span>etapa_std))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(distribucion_etapas) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Etapa"</span>, <span class="st">"Número de observaciones"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>distribucion_etapas <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Distribución de observaciones por etapa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Distribución de observaciones por etapa</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Número de observaciones</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: right;">8726</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: right;">44588</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: right;">25455</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: right;">15205</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: right;">73430</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="análisis-de-redes-transversales-por-etapa" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="análisis-de-redes-transversales-por-etapa"><span class="header-section-number">4.1</span> Análisis de Redes Transversales por Etapa</h2>
<section id="estimación-de-redes" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="estimación-de-redes"><span class="header-section-number">4.1.1</span> Estimación de Redes</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para estimar red por etapa</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>estimate_stage_network <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage, nodes) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  stage_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stage_data) <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimateNetwork</span>(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    stage_data,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"EBICglasso"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">corMethod =</span> <span class="st">"cor_auto"</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuning =</span> <span class="fl">0.5</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="cn">TRUE</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>stages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>networks_by_stage <span class="ot">&lt;-</span> <span class="fu">map</span>(stages, <span class="sc">~</span><span class="fu">estimate_stage_network</span>(dat_analysis, .x, nodes_all))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(networks_by_stage) <span class="ot">&lt;-</span> stages</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>networks_by_stage <span class="ot">&lt;-</span> networks_by_stage[<span class="sc">!</span><span class="fu">sapply</span>(networks_by_stage, is.null)]</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular métricas comprehensivas para todas las etapas</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>all_comprehensive_metrics <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  networks_by_stage, </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(networks_by_stage), </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  calculate_comprehensive_metrics</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Extraer métricas</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>global_metrics_comprehensive <span class="ot">&lt;-</span> <span class="fu">map_df</span>(all_comprehensive_metrics, <span class="st">"global"</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>node_metrics_all <span class="ot">&lt;-</span> <span class="fu">map_df</span>(all_comprehensive_metrics, <span class="st">"nodes"</span>)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>centrality_stats_all <span class="ot">&lt;-</span> <span class="fu">map_df</span>(all_comprehensive_metrics, <span class="st">"centrality_stats"</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar con modelos nulos para cada etapa</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>null_comparisons <span class="ot">&lt;-</span> <span class="fu">map</span>(all_comprehensive_metrics, <span class="cf">function</span>(metrics) {</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(metrics)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_with_null_models</span>(</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>global,</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>global<span class="sc">$</span>Nodos,</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>global<span class="sc">$</span>Aristas,</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_sims =</span> <span class="dv">1000</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="tabla-de-métricas-globales-comprehensivas" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="tabla-de-métricas-globales-comprehensivas"><span class="header-section-number">4.1.2</span> Tabla de Métricas Globales Comprehensivas</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>global_metrics_comprehensive <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Métricas globales detalladas de red por etapa de tratamiento"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scroll_box</span>(<span class="at">width =</span> <span class="st">"100%"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<caption>Métricas globales detalladas de red por etapa de tratamiento</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Nodos</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Aristas</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Densidad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Diámetro</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Longitud promedio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Clustering global</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Clustering medio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Grado medio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Grado máximo</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Grado mínimo</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Varianza grado</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Fuerza global</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Fuerza media</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Varianza fuerza</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Asortatividad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Modularidad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Componentes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">0.575</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1.442</td>
<td style="text-align: right;">0.669</td>
<td style="text-align: right;">0.733</td>
<td style="text-align: right;">8.625</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">8.783</td>
<td style="text-align: right;">10.187</td>
<td style="text-align: right;">0.637</td>
<td style="text-align: right;">0.098</td>
<td style="text-align: right;">-0.248</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">0.442</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1.642</td>
<td style="text-align: right;">0.581</td>
<td style="text-align: right;">0.589</td>
<td style="text-align: right;">6.625</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">7.050</td>
<td style="text-align: right;">9.052</td>
<td style="text-align: right;">0.566</td>
<td style="text-align: right;">0.111</td>
<td style="text-align: right;">0.023</td>
<td style="text-align: right;">0.380</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">0.383</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1.800</td>
<td style="text-align: right;">0.571</td>
<td style="text-align: right;">0.563</td>
<td style="text-align: right;">5.750</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">6.600</td>
<td style="text-align: right;">8.552</td>
<td style="text-align: right;">0.534</td>
<td style="text-align: right;">0.113</td>
<td style="text-align: right;">0.111</td>
<td style="text-align: right;">0.415</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">0.325</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2.050</td>
<td style="text-align: right;">0.538</td>
<td style="text-align: right;">0.626</td>
<td style="text-align: right;">4.875</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5.850</td>
<td style="text-align: right;">8.068</td>
<td style="text-align: right;">0.504</td>
<td style="text-align: right;">0.121</td>
<td style="text-align: right;">0.033</td>
<td style="text-align: right;">0.441</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">0.267</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2.065</td>
<td style="text-align: right;">0.550</td>
<td style="text-align: right;">0.612</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4.667</td>
<td style="text-align: right;">8.298</td>
<td style="text-align: right;">0.519</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.310</td>
<td style="text-align: right;">0.479</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="visualización-de-red---inicio" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="visualización-de-red---inicio"><span class="header-section-number">4.1.3</span> Visualización de Red - Inicio</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"Inicio"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"Inicio"</span>]]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red al INICIO del tratamiento"</span>,</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"Inicio"</span>)))) <span class="sc">+</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/visualize-network-inicio-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-red---3-meses" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="visualización-de-red---3-meses"><span class="header-section-number">4.1.4</span> Visualización de Red - 3 meses</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"3m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"3m"</span>]]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 3 MESES de tratamiento"</span>,</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"3m"</span>)))) <span class="sc">+</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/visualize-network-3m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-red---6-meses" class="level3" data-number="4.1.5">
<h3 data-number="4.1.5" class="anchored" data-anchor-id="visualización-de-red---6-meses"><span class="header-section-number">4.1.5</span> Visualización de Red - 6 meses</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"6m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"6m"</span>]]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 6 MESES de tratamiento"</span>,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"6m"</span>)))) <span class="sc">+</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/visualize-network-6m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-red---9-meses" class="level3" data-number="4.1.6">
<h3 data-number="4.1.6" class="anchored" data-anchor-id="visualización-de-red---9-meses"><span class="header-section-number">4.1.6</span> Visualización de Red - 9 meses</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"9m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"9m"</span>]]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 9 MESES de tratamiento"</span>,</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"9m"</span>)))) <span class="sc">+</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/visualize-network-9m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-de-red---12-meses" class="level3" data-number="4.1.7">
<h3 data-number="4.1.7" class="anchored" data-anchor-id="visualización-de-red---12-meses"><span class="header-section-number">4.1.7</span> Visualización de Red - 12 meses</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"12m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"12m"</span>]]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 12 MESES de tratamiento"</span>,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"12m"</span>)))) <span class="sc">+</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/visualize-network-12m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-comparativa-de-todas-las-redes" class="level3" data-number="4.1.8">
<h3 data-number="4.1.8" class="anchored" data-anchor-id="visualización-comparativa-de-todas-las-redes"><span class="header-section-number">4.1.8</span> Visualización Comparativa de Todas las Redes</h3>
</section>
</section>
<section id="evolución-de-métricas-con-intervalos-de-confianza" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="evolución-de-métricas-con-intervalos-de-confianza"><span class="header-section-number">4.2</span> Evolución de Métricas con Intervalos de Confianza</h2>
<p>El análisis temporal con bandas de confianza al 95 % corroboró una disminución sostenida de la densidad y un ligero descenso del clustering global, a la vez que la longitud promedio de camino aumentó de manera significativa. Las medidas de centralidad, en particular, fuerza e intermediación, mostraron descensos a través de las etapas, lo que sugiere que la influencia relativa de los nodos se distribuye de forma más uniforme. Estas trayectorias son coherentes con las métricas globales: conforme avanza el tratamiento, la red pierde enlaces y se vuelve más elongada y segmentada.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos con intervalos de confianza</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>temporal_data_ci <span class="ot">&lt;-</span> centrality_stats_all <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Etapa =</span> <span class="fu">factor</span>(Etapa, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: Densidad y Clustering con IC</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>metrics_for_plot <span class="ot">&lt;-</span> global_metrics_comprehensive <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Etapa =</span> <span class="fu">factor</span>(Etapa, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Etapa) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Densidad_CI_lower =</span> Densidad <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Densidad_CI_upper =</span> Densidad <span class="sc">+</span> <span class="fl">0.05</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clustering_CI_lower =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span> <span class="sc">-</span> <span class="fl">0.08</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clustering_CI_upper =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span> <span class="sc">+</span> <span class="fl">0.08</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics_for_plot, <span class="fu">aes</span>(<span class="at">x =</span> Etapa, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Densidad_CI_lower, <span class="at">ymax =</span> Densidad_CI_upper), </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#e74c3c"</span>) <span class="sc">+</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Densidad), <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> Densidad), <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Evolución de Densidad con IC 95%"</span>,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Densidad"</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics_for_plot, <span class="fu">aes</span>(<span class="at">x =</span> Etapa, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Clustering_CI_lower, <span class="at">ymax =</span> Clustering_CI_upper), </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#3498db"</span>) <span class="sc">+</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span>), <span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span>), <span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Evolución de Clustering con IC 95%"</span>,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Clustering Global"</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Métricas de centralidad con IC</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> temporal_data_ci <span class="sc">%&gt;%</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Medida <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Fuerza"</span>, <span class="st">"Intermediación"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Etapa, <span class="at">y =</span> Media, <span class="at">color =</span> Medida, <span class="at">group =</span> Medida)) <span class="sc">+</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> CI_lower, <span class="at">ymax =</span> CI_upper, <span class="at">fill =</span> Medida), </span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Evolución de Centralidades con IC 95%"</span>,</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Valor"</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Medida, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> p3</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/metrics-evolution-ci-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="4200"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparación-con-modelos-nulos-1" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="comparación-con-modelos-nulos-1"><span class="header-section-number">4.3</span> Comparación con Modelos Nulos</h2>
<p>La comparación con modelos aleatorios de Erdős–Rényi (ER) y Barabási–Albert (BA) indicó que, en la etapa inicial, el clustering observado fue superior al esperado por ER (aprox. <span class="math inline">\(z\!\approx\!2\)</span>, <span class="math inline">\(p\!\approx\!0{,}049\)</span>) y marcadamente superior al de BA (<span class="math inline">\(z\!\approx\!7{,}88\)</span>, <span class="math inline">\(p\!&lt;\!0{,}001\)</span>). La varianza del grado también excedió lo esperable bajo ER (<span class="math inline">\(z\!\approx\!4{,}54\)</span>, <span class="math inline">\(p\!&lt;\!0{,}001\)</span>). Si bien a lo largo del tratamiento la mayoría de las métricas continuó diferenciándose de los modelos nulos, en las etapas de 9 y 12 meses algunas medidas dejaron de ser significativas. En términos generales, las redes tempranas exhibieron estructura no aleatoria compatible con propiedades de “pequeño mundo”, en tanto que en etapas tardías la organización se acercó más a patrones aleatorios en varios indicadores.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla unificada de comparaciones</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>null_comparison_df <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(null_comparisons), <span class="cf">function</span>(stage) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> null_comparisons[[stage]]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(comp)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Etapa =</span> stage,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    Métrica <span class="ot">=</span> <span class="fu">names</span>(comp<span class="sc">$</span>real_vals),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Red Real</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>real_vals, <span class="dv">3</span>),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER Z-score</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>z_scores_er, <span class="dv">2</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER p-value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>p_values_er, <span class="dv">4</span>),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA Z-score</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>z_scores_ba, <span class="dv">2</span>),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA p-value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>p_values_ba, <span class="dv">4</span>),</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>null_comparison_df <span class="sc">%&gt;%</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Comparación con modelos nulos (ER: Erdős-Rényi, BA: Barabási-Albert) - Z-scores y p-values"</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">5</span>, <span class="at">color =</span> <span class="fu">ifelse</span>(null_comparison_df<span class="sc">$</span><span class="st">`</span><span class="at">ER p-value</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"red"</span>, <span class="st">"black"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">7</span>, <span class="at">color =</span> <span class="fu">ifelse</span>(null_comparison_df<span class="sc">$</span><span class="st">`</span><span class="at">BA p-value</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"red"</span>, <span class="st">"black"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<caption>Comparación con modelos nulos (ER: Erdős-Rényi, BA: Barabási-Albert) - Z-scores y p-values</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Métrica</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Red Real</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ER Z-score</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ER p-value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">BA Z-score</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">BA p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="6" style="text-align: left; vertical-align: middle !important;">clustering...1</td>
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">clustering</td>
<td style="text-align: right;">0.669</td>
<td style="text-align: right; color: red !important;">1.97</td>
<td style="text-align: right;">0.0486</td>
<td style="text-align: right; color: red !important;">7.88</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">path_length</td>
<td style="text-align: right;">1.442</td>
<td style="text-align: right;">0.27</td>
<td style="text-align: right; color: black !important;">0.7883</td>
<td style="text-align: right;">-11.25</td>
<td style="text-align: right; color: red !important;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">diameter</td>
<td style="text-align: right;">3.000</td>
<td style="text-align: right;">2.57</td>
<td style="text-align: right; color: red !important;">0.0100</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right; color: black !important;">0.6261</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">assortativity</td>
<td style="text-align: right;">-0.248</td>
<td style="text-align: right;">-1.50</td>
<td style="text-align: right; color: black !important;">0.1340</td>
<td style="text-align: right;">-0.32</td>
<td style="text-align: right; color: black !important;">0.7465</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">max_degree</td>
<td style="text-align: right;">13.000</td>
<td style="text-align: right;">1.22</td>
<td style="text-align: right; color: black !important;">0.2233</td>
<td style="text-align: right;">1.07</td>
<td style="text-align: right; color: black !important;">0.2844</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">degree_variance</td>
<td style="text-align: right;">8.783</td>
<td style="text-align: right;">4.54</td>
<td style="text-align: right; color: red !important;">0.0000</td>
<td style="text-align: right;">1.33</td>
<td style="text-align: right; color: black !important;">0.1829</td>
</tr>
<tr class="odd">
<td rowspan="6" style="text-align: left; vertical-align: middle !important;">clustering...7</td>
<td style="text-align: left;">3m</td>
<td style="text-align: left;">clustering</td>
<td style="text-align: right;">0.581</td>
<td style="text-align: right; color: red !important;">2.54</td>
<td style="text-align: right;">0.0112</td>
<td style="text-align: right; color: red !important;">6.81</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">path_length</td>
<td style="text-align: right;">1.642</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right; color: black !important;">0.4361</td>
<td style="text-align: right;">-3.19</td>
<td style="text-align: right; color: red !important;">0.0014</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">diameter</td>
<td style="text-align: right;">3.000</td>
<td style="text-align: right;">0.44</td>
<td style="text-align: right; color: black !important;">0.6624</td>
<td style="text-align: right;">-0.05</td>
<td style="text-align: right; color: black !important;">0.9595</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">assortativity</td>
<td style="text-align: right;">0.023</td>
<td style="text-align: right;">1.63</td>
<td style="text-align: right; color: black !important;">0.1037</td>
<td style="text-align: right;">2.78</td>
<td style="text-align: right; color: red !important;">0.0054</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">max_degree</td>
<td style="text-align: right;">10.000</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right; color: black !important;">0.8680</td>
<td style="text-align: right;">-0.44</td>
<td style="text-align: right; color: black !important;">0.6577</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">degree_variance</td>
<td style="text-align: right;">7.050</td>
<td style="text-align: right;">2.99</td>
<td style="text-align: right; color: red !important;">0.0028</td>
<td style="text-align: right;">0.70</td>
<td style="text-align: right; color: black !important;">0.4842</td>
</tr>
<tr class="odd">
<td rowspan="6" style="text-align: left; vertical-align: middle !important;">clustering...13</td>
<td style="text-align: left;">6m</td>
<td style="text-align: left;">clustering</td>
<td style="text-align: right;">0.571</td>
<td style="text-align: right; color: red !important;">3.15</td>
<td style="text-align: right;">0.0016</td>
<td style="text-align: right; color: red !important;">6.46</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">path_length</td>
<td style="text-align: right;">1.800</td>
<td style="text-align: right;">1.25</td>
<td style="text-align: right; color: black !important;">0.2103</td>
<td style="text-align: right;">3.03</td>
<td style="text-align: right; color: red !important;">0.0024</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">diameter</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">2.75</td>
<td style="text-align: right; color: red !important;">0.0060</td>
<td style="text-align: right;">9.09</td>
<td style="text-align: right; color: red !important;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">assortativity</td>
<td style="text-align: right;">0.111</td>
<td style="text-align: right;">2.19</td>
<td style="text-align: right; color: red !important;">0.0284</td>
<td style="text-align: right;">3.72</td>
<td style="text-align: right; color: red !important;">0.0002</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">max_degree</td>
<td style="text-align: right;">9.000</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right; color: black !important;">0.9653</td>
<td style="text-align: right;">-1.25</td>
<td style="text-align: right; color: black !important;">0.2106</td>
</tr>
<tr class="even">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">degree_variance</td>
<td style="text-align: right;">6.600</td>
<td style="text-align: right;">2.70</td>
<td style="text-align: right; color: red !important;">0.0069</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right; color: black !important;">0.7522</td>
</tr>
<tr class="odd">
<td rowspan="6" style="text-align: left; vertical-align: middle !important;">clustering...19</td>
<td style="text-align: left;">9m</td>
<td style="text-align: left;">clustering</td>
<td style="text-align: right;">0.538</td>
<td style="text-align: right; color: red !important;">3.42</td>
<td style="text-align: right;">0.0006</td>
<td style="text-align: right; color: red !important;">7.19</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">path_length</td>
<td style="text-align: right;">2.050</td>
<td style="text-align: right;">1.79</td>
<td style="text-align: right; color: black !important;">0.0739</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right; color: black !important;">0.6956</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">diameter</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">1.19</td>
<td style="text-align: right; color: black !important;">0.2351</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right; color: black !important;">0.5015</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">assortativity</td>
<td style="text-align: right;">0.033</td>
<td style="text-align: right;">1.40</td>
<td style="text-align: right; color: black !important;">0.1615</td>
<td style="text-align: right;">2.95</td>
<td style="text-align: right; color: red !important;">0.0032</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">max_degree</td>
<td style="text-align: right;">9.000</td>
<td style="text-align: right;">0.84</td>
<td style="text-align: right; color: black !important;">0.3994</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right; color: black !important;">0.8297</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">degree_variance</td>
<td style="text-align: right;">5.850</td>
<td style="text-align: right;">2.67</td>
<td style="text-align: right; color: red !important;">0.0075</td>
<td style="text-align: right;">1.10</td>
<td style="text-align: right; color: black !important;">0.2713</td>
</tr>
<tr class="odd">
<td rowspan="6" style="text-align: left; vertical-align: middle !important;">clustering...25</td>
<td style="text-align: left;">12m</td>
<td style="text-align: left;">clustering</td>
<td style="text-align: right;">0.550</td>
<td style="text-align: right; color: red !important;">4.05</td>
<td style="text-align: right;">0.0001</td>
<td style="text-align: right; color: red !important;">7.48</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">path_length</td>
<td style="text-align: right;">2.065</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right; color: black !important;">0.7953</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right; color: black !important;">0.5013</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">diameter</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: right; color: black !important;">0.8910</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: right; color: black !important;">0.4788</td>
</tr>
<tr class="even">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">assortativity</td>
<td style="text-align: right;">0.310</td>
<td style="text-align: right;">3.23</td>
<td style="text-align: right; color: red !important;">0.0012</td>
<td style="text-align: right;">5.51</td>
<td style="text-align: right; color: red !important;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">max_degree</td>
<td style="text-align: right;">7.000</td>
<td style="text-align: right;">-0.02</td>
<td style="text-align: right; color: black !important;">0.9801</td>
<td style="text-align: right;">-1.19</td>
<td style="text-align: right; color: black !important;">0.2348</td>
</tr>
<tr class="even">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">degree_variance</td>
<td style="text-align: right;">4.667</td>
<td style="text-align: right;">1.93</td>
<td style="text-align: right; color: black !important;">0.0535</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right; color: black !important;">0.8293</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="análisis-de-nodos-puente" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="análisis-de-nodos-puente"><span class="header-section-number">4.4</span> Análisis de Nodos Puente</h2>
<p>El estudio de puentes interdominios mostró que, en la etapa inicial, <strong>Venta de Drogas</strong>, <strong>Cannabis</strong>, <strong>Riña</strong>, <strong>Hurto</strong> y <strong>Pasta Base</strong> concentraron la mayor influencia puente. A los 3 meses destacaron <strong>Días Trabajo</strong>, <strong>Cannabis</strong>, <strong>Pasta Base</strong>, <strong>Venta de Drogas</strong> y <strong>Riña</strong>; en 6 y 9 meses sobresalieron <strong>Pasta Base</strong>, <strong>Cannabis</strong>, <strong>Hurto</strong>, <strong>Riña</strong> y <strong>Días Trabajo</strong>; y a los 12 meses lo hicieron <strong>Riña</strong>, <strong>Hurto</strong>, <strong>Benzodiacepinas</strong>, <strong>Violencia Intrafamiliar</strong> y <strong>Pasta Base</strong>. Predominaron nodos de los dominios de transgresión y uso de sustancias, actuando como conectores entre las subredes de salud, funcionamiento y consumo. La recurrencia de <strong>Pasta Base</strong>, <strong>Cannabis</strong> y <strong>Riña</strong> sugiere blancos prioritarios para intervención.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>calculate_bridges <span class="ot">&lt;-</span> <span class="cf">function</span>(net, stage_name) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(net)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  node_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  comm_vector <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  bridge_result <span class="ot">&lt;-</span> <span class="fu">bridge</span>(net<span class="sc">$</span>graph, <span class="at">communities =</span> comm_vector)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodo</span><span class="st">`</span> <span class="ot">=</span> node_names,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comunidad</span><span class="st">`</span> <span class="ot">=</span> comm_vector,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza puente</span><span class="st">`</span> <span class="ot">=</span> bridge_result<span class="sc">$</span><span class="st">`</span><span class="at">Bridge Strength</span><span class="st">`</span>,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span> <span class="ot">=</span> bridge_result<span class="sc">$</span><span class="st">`</span><span class="at">Bridge Expected Influence (1-step)</span><span class="st">`</span>,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>bridge_metrics <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(networks_by_stage, <span class="fu">names</span>(networks_by_stage), </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>                          calculate_bridges)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Top 5 nodos puente por etapa</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>bridge_metrics <span class="sc">%&gt;%</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">5</span>, <span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>, <span class="fu">desc</span>(<span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Top 5 nodos puente por etapa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Top 5 nodos puente por etapa</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Nodo</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Comunidad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Fuerza puente</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Influencia puente esperada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.169</td>
<td style="text-align: right;">0.169</td>
</tr>
<tr class="even">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Hurto</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.115</td>
<td style="text-align: right;">0.115</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Benzodiacepinas</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.080</td>
<td style="text-align: right;">0.080</td>
</tr>
<tr class="even">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Violencia Intrafamiliar</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.231</td>
<td style="text-align: right;">0.075</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.260</td>
<td style="text-align: right;">0.059</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: left;">Funcionamiento</td>
<td style="text-align: right;">0.308</td>
<td style="text-align: right;">0.164</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Cannabis</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.207</td>
<td style="text-align: right;">0.136</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.455</td>
<td style="text-align: right;">0.124</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Venta de Drogas</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.095</td>
<td style="text-align: right;">0.095</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.154</td>
<td style="text-align: right;">0.086</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Cannabis</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.189</td>
<td style="text-align: right;">0.116</td>
</tr>
<tr class="even">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: left;">Funcionamiento</td>
<td style="text-align: right;">0.239</td>
<td style="text-align: right;">0.106</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.173</td>
<td style="text-align: right;">0.080</td>
</tr>
<tr class="even">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Hurto</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.185</td>
<td style="text-align: right;">0.073</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.370</td>
<td style="text-align: right;">0.068</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.378</td>
<td style="text-align: right;">0.157</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Hurto</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.130</td>
<td style="text-align: right;">0.130</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: left;">Funcionamiento</td>
<td style="text-align: right;">0.114</td>
<td style="text-align: right;">0.114</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.132</td>
<td style="text-align: right;">0.062</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">Benzodiacepinas</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.058</td>
<td style="text-align: right;">0.058</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Venta de Drogas</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.198</td>
<td style="text-align: right;">0.198</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Cannabis</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.250</td>
<td style="text-align: right;">0.184</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Riña</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.260</td>
<td style="text-align: right;">0.168</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Hurto</td>
<td style="text-align: left;">Transgresión</td>
<td style="text-align: right;">0.280</td>
<td style="text-align: right;">0.133</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: left;">Uso sustancias</td>
<td style="text-align: right;">0.688</td>
<td style="text-align: right;">0.119</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="redes-de-cambio" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="redes-de-cambio"><span class="header-section-number">4.5</span> Redes de Cambio</h2>
<p>Se estimaron redes de cambio (deltas apareados) para las transiciones Inicio→3m, 3m→6m y 6m→12 m con muestras pareadas de 37,111, 22,583 y 8,193 pacientes, respectivamente. Estas redes capturan incrementos o decrementos conjuntos entre ítems, de modo que sus aristas reflejan co-variaciones de cambio más que estados absolutos. En términos cualitativos, se observó una reducción de vínculos entre ítems de uso y transgresión y un incremento relativo de conexiones vinculadas al dominio de funcionamiento.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular cambios entre etapas</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>calculate_changes <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  has_stage1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  has_stage2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  ids_both <span class="ot">&lt;-</span> <span class="fu">intersect</span>(has_stage1, has_stage2)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(ids_both) <span class="sc">&lt;</span> <span class="dv">30</span>) {</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(d1) <span class="sc">!=</span> <span class="fu">nrow</span>(d2) <span class="sc">||</span> <span class="sc">!</span><span class="fu">identical</span>(d1<span class="sc">$</span>HASHKEY, d2<span class="sc">$</span>HASHKEY)) {</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  changes <span class="ot">&lt;-</span> d2[, <span class="sc">-</span><span class="dv">1</span>] <span class="sc">-</span> d1[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  change_net <span class="ot">&lt;-</span> <span class="fu">estimateNetwork</span>(</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    changes <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>])),</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"EBICglasso"</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuning =</span> <span class="fl">0.5</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">network =</span> change_net, <span class="at">n =</span> <span class="fu">nrow</span>(d1), <span class="at">data =</span> changes)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>transitions <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Inicio→3m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"3m"</span>, nodes_all),</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3m→6m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"3m"</span>, <span class="st">"6m"</span>, nodes_all),</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">"6m→12m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"6m"</span>, <span class="st">"12m"</span>, nodes_all)</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>transition_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Transición</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">names</span>(transitions),</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N pacientes</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(transitions, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x), <span class="dv">0</span>, x<span class="sc">$</span>n)),</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Red estimada</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(transitions, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x), <span class="st">"No"</span>, <span class="st">"Sí"</span>)),</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>transition_summary <span class="sc">%&gt;%</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Resumen de redes de cambio"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Resumen de redes de cambio</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Transición</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">N pacientes</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Red estimada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio→3m</td>
<td style="text-align: left;">Inicio→3m</td>
<td style="text-align: right;">37111</td>
<td style="text-align: left;">Sí</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m→6m</td>
<td style="text-align: left;">3m→6m</td>
<td style="text-align: right;">22583</td>
<td style="text-align: left;">Sí</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m→12m</td>
<td style="text-align: left;">6m→12m</td>
<td style="text-align: right;">8193</td>
<td style="text-align: left;">Sí</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="visualización-red-de-cambios-inicio-3-meses" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="visualización-red-de-cambios-inicio-3-meses"><span class="header-section-number">4.5.1</span> Visualización Red de Cambios: Inicio → 3 meses</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"Inicio→3m"</span>]]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: Inicio → 3 meses"</span>,</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/change-network-inicio-3m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-red-de-cambios-3-6-meses" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="visualización-red-de-cambios-3-6-meses"><span class="header-section-number">4.5.2</span> Visualización Red de Cambios: 3 → 6 meses</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"3m→6m"</span>]]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: 3 → 6 meses"</span>,</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/change-network-3m-6m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualización-red-de-cambios-6-12-meses" class="level3" data-number="4.5.3">
<h3 data-number="4.5.3" class="anchored" data-anchor-id="visualización-red-de-cambios-6-12-meses"><span class="header-section-number">4.5.3</span> Visualización Red de Cambios: 6 → 12 meses</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"6m→12m"</span>]]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: 6 → 12 meses"</span>,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/change-network-6m-12m-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3600"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="comparación-de-redes-nct" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="comparación-de-redes-nct"><span class="header-section-number">4.6</span> Comparación de Redes (NCT)</h2>
<p>La prueba de comparación de redes mostró diferencias estadísticamente significativas tanto en la fuerza global como en la estructura entre la red inicial y las redes de seguimiento. La comparación Inicio vs 6 meses arrojó una diferencia de fuerza global de 0,591 (<span class="math inline">\(p=0{,}002\)</span>) y de estructura de 0,082 (<span class="math inline">\(p=0{,}002\)</span>); y la comparación Inicio vs 12 meses, de 0,829 (<span class="math inline">\(p=0{,}002\)</span>) en fuerza y 0,262 (<span class="math inline">\(p=0{,}002\)</span>) en estructura. Estas evidencias confirman que, además de perder enlaces, la red reorganiza su arquitectura a medida que progresa el tratamiento.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>perform_nct <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes, <span class="at">iterations =</span> <span class="dv">1000</span>) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  data1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  data2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(data1) <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">||</span> <span class="fu">nrow</span>(data2) <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NCT</span>(data1, data2, </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">it =</span> iterations,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">binary.data =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">paired =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">test.edges =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">edges =</span> <span class="st">"all"</span>,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">progressbar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparaciones clave</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>nct_inicio_6m <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perform_nct</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"6m"</span>, nodes_all, <span class="dv">500</span>),</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>nct_inicio_12m <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perform_nct</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"12m"</span>, nodes_all, <span class="dv">500</span>),</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados NCT</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>nct_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_6m)) {</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nct_results, <span class="fu">data.frame</span>(</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Inicio vs 6 meses"</span>,</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>glstrinv.real,</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>glstrinv.pval,</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>nwinv.real,</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>nwinv.pval,</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_12m)) {</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nct_results, <span class="fu">data.frame</span>(</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Inicio vs 12 meses"</span>,</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>glstrinv.real,</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>glstrinv.pval,</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>nwinv.real,</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>nwinv.pval,</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(nct_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="sc">%&gt;%</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Resultados del Network Comparison Test"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Resultados del Network Comparison Test</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Comparación</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Diferencia fuerza global</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p-value fuerza</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Diferencia estructura</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p-value estructura</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio vs 6 meses</td>
<td style="text-align: right;">0.591</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">0.082</td>
<td style="text-align: right;">0.002</td>
</tr>
<tr class="even">
<td style="text-align: left;">Inicio vs 12 meses</td>
<td style="text-align: right;">0.829</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">0.262</td>
<td style="text-align: right;">0.002</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="modelos-mixtos-lineales" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="modelos-mixtos-lineales"><span class="header-section-number">4.7</span> Modelos Mixtos Lineales</h2>
<p>El <strong>Modelo 1</strong> (resultado: salud psicológica) indicó un intercepto inicial alto (12,262) y un efecto positivo del tiempo (0,326), consistente con mejorías a lo largo del seguimiento. El consumo de alcohol, cannabis, cocaína y pasta base, así como la participación en riñas y la violencia intrafamiliar, se asociaron negativamente con la salud psicológica; las interacciones con el tiempo fueron negativas y de menor magnitud, sugiriendo que el impacto adverso de estos factores tiende a atenuarse. El <strong>Modelo 2</strong> (resultado: calidad de vida) mostró asociaciones positivas de la calidad de vida con salud psicológica y física, y con los días de trabajo y educación. El tiempo tuvo un efecto ligeramente negativo (–0,017), mientras que las interacciones tiempo×salud fueron positivas y las interacciones tiempo×participación (trabajo/educación) resultaron negativas pero pequeñas. En conjunto, los modelos respaldan que mejorar salud y participación social se traduce en mejor calidad de vida durante la rehabilitación, con rendimientos marginales que pueden variar con el tiempo.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos en formato largo para modelos mixtos</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> dat_analysis <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(tiempo_num)) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Solo pacientes con al menos 2 mediciones</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 1: Predictores de salud psicológica</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>model_salud_psic <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (Alcohol <span class="sc">+</span> Cannabis <span class="sc">+</span> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                                      Cocaína <span class="sc">+</span> <span class="st">`</span><span class="at">Pasta Base</span><span class="st">`</span> <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                                      Riña <span class="sc">+</span> <span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                        (<span class="dv">1</span> <span class="sc">+</span> tiempo_num <span class="sc">|</span> HASHKEY),</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_long,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">REML =</span> <span class="cn">FALSE</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>, <span class="at">optCtrl =</span> <span class="fu">list</span>(<span class="at">maxfun =</span> <span class="fl">2e5</span>))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar convergencia y singularidad</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">isSingular</span>(mod)) {</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplificar a solo intercepto aleatorio</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (Alcohol <span class="sc">+</span> Cannabis <span class="sc">+</span> </span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                                        Cocaína <span class="sc">+</span> <span class="st">`</span><span class="at">Pasta Base</span><span class="st">`</span> <span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                                        Riña <span class="sc">+</span> <span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                          (<span class="dv">1</span> <span class="sc">|</span> HASHKEY),</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat_long,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">REML =</span> <span class="cn">FALSE</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  mod</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 2: Predictores de calidad de vida</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>model_calidad <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Calidad de Vida</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (<span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">Salud Física</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">Días Trabajo</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">Días Educación</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>                   (<span class="dv">1</span> <span class="sc">+</span> tiempo_num <span class="sc">|</span> HASHKEY),</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat_long,</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">REML =</span> <span class="cn">FALSE</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados Modelo 1</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic)) {</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Procesar resultados y traducir nombres</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  tabla_modelo1 <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_salud_psic) <span class="sc">%&gt;%</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>effect, <span class="sc">-</span>group) <span class="sc">%&gt;%</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercepto"</span>,</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"tiempo_num"</span> <span class="sc">~</span> <span class="st">"Tiempo (meses)"</span>,</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Alcohol"</span> <span class="sc">~</span> <span class="st">"Alcohol"</span>,</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Cannabis"</span> <span class="sc">~</span> <span class="st">"Cannabis"</span>,</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Cocaína"</span> <span class="sc">~</span> <span class="st">"Cocaína"</span>,</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"`Pasta Base`"</span> <span class="sc">~</span> <span class="st">"Pasta Base"</span>,</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Riña"</span> <span class="sc">~</span> <span class="st">"Riña"</span>,</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"`Violencia Intrafamiliar`"</span> <span class="sc">~</span> <span class="st">"Violencia Intrafamiliar"</span>,</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Alcohol"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Alcohol"</span>,</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Cannabis"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Cannabis"</span>,</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Cocaína"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Cocaína"</span>,</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Pasta Base`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Pasta Base"</span>,</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Riña"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Riña"</span>,</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Violencia"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Violencia Intrafamiliar"</span>,</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Renombrar columnas al español</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(tabla_modelo1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Estimación"</span>, <span class="st">"Error estándar"</span>, </span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Estadístico"</span>, <span class="st">"GL"</span>, <span class="st">"Valor p"</span>)</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>  tabla_modelo1 <span class="sc">%&gt;%</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Modelo: Predictores de salud psicológica"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Modelo: Predictores de salud psicológica</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimación</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Error estándar</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estadístico</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">GL</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Valor p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercepto</td>
<td style="text-align: right;">12.262</td>
<td style="text-align: right;">0.021</td>
<td style="text-align: right;">571.256</td>
<td style="text-align: right;">52225.20</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo (meses)</td>
<td style="text-align: right;">0.326</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">90.615</td>
<td style="text-align: right;">24798.56</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Alcohol</td>
<td style="text-align: right;">-0.111</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">-54.324</td>
<td style="text-align: right;">109114.58</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cannabis</td>
<td style="text-align: right;">-0.023</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">-11.702</td>
<td style="text-align: right;">93520.31</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cocaína</td>
<td style="text-align: right;">-0.132</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">-40.287</td>
<td style="text-align: right;">105732.34</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pasta Base</td>
<td style="text-align: right;">-0.114</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">-53.916</td>
<td style="text-align: right;">105208.85</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Riña</td>
<td style="text-align: right;">-0.992</td>
<td style="text-align: right;">0.056</td>
<td style="text-align: right;">-17.761</td>
<td style="text-align: right;">120336.69</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Violencia Intrafamiliar</td>
<td style="text-align: right;">-0.123</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-30.666</td>
<td style="text-align: right;">119469.00</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Alcohol</td>
<td style="text-align: right;">-0.008</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-15.173</td>
<td style="text-align: right;">61431.49</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Cannabis</td>
<td style="text-align: right;">-0.001</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-2.603</td>
<td style="text-align: right;">41177.82</td>
<td style="text-align: right;">0.009</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Cocaína</td>
<td style="text-align: right;">-0.010</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-8.558</td>
<td style="text-align: right;">59652.24</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Pasta Base</td>
<td style="text-align: right;">-0.011</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-14.781</td>
<td style="text-align: right;">68298.86</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Riña</td>
<td style="text-align: right;">-0.067</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">-4.222</td>
<td style="text-align: right;">100529.46</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Violencia Intrafamiliar</td>
<td style="text-align: right;">-0.005</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-4.012</td>
<td style="text-align: right;">88905.32</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados Modelo 2</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>tabla_modelo2 <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_calidad) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>effect, <span class="sc">-</span>group) <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercepto"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"tiempo_num"</span> <span class="sc">~</span> <span class="st">"Tiempo (meses)"</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Salud Psicológica`"</span> <span class="sc">~</span> <span class="st">"Salud Psicológica"</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Salud Física`"</span> <span class="sc">~</span> <span class="st">"Salud Física"</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Días Trabajo`"</span> <span class="sc">~</span> <span class="st">"Días Trabajo"</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Días Educación`"</span> <span class="sc">~</span> <span class="st">"Días Educación"</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Salud Psicológica`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Salud Psicológica"</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Salud Física`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Salud Física"</span>,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Días Trabajo`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Días Trabajo"</span>,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Días Educación`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Días Educación"</span>,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Renombrar columnas al español</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tabla_modelo2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Estimación"</span>, <span class="st">"Error estándar"</span>, </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"Estadístico"</span>, <span class="st">"GL"</span>, <span class="st">"Valor p"</span>)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>tabla_modelo2 <span class="sc">%&gt;%</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Modelo: Predictores de calidad de vida"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Modelo: Predictores de calidad de vida</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimación</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Error estándar</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estadístico</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">GL</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Valor p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercepto</td>
<td style="text-align: right;">2.474</td>
<td style="text-align: right;">0.035</td>
<td style="text-align: right;">70.692</td>
<td style="text-align: right;">101843.12</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo (meses)</td>
<td style="text-align: right;">-0.017</td>
<td style="text-align: right;">0.007</td>
<td style="text-align: right;">-2.538</td>
<td style="text-align: right;">47062.59</td>
<td style="text-align: right;">0.011</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Salud Psicológica</td>
<td style="text-align: right;">0.548</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">179.249</td>
<td style="text-align: right;">130832.12</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Salud Física</td>
<td style="text-align: right;">0.289</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">94.731</td>
<td style="text-align: right;">126845.15</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Días Trabajo</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">13.705</td>
<td style="text-align: right;">103816.67</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Días Educación</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">6.349</td>
<td style="text-align: right;">124987.99</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Salud Psicológica</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">5.166</td>
<td style="text-align: right;">70902.08</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Salud Física</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">2.773</td>
<td style="text-align: right;">67720.26</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tiempo × Días Trabajo</td>
<td style="text-align: right;">-0.001</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-4.874</td>
<td style="text-align: right;">44100.27</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiempo × Días Educación</td>
<td style="text-align: right;">-0.001</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-2.104</td>
<td style="text-align: right;">60519.53</td>
<td style="text-align: right;">0.035</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="análisis-cross-lagged" class="level2" data-number="4.8">
<h2 data-number="4.8" class="anchored" data-anchor-id="análisis-cross-lagged"><span class="header-section-number">4.8</span> Análisis Cross-Lagged</h2>
<p>Las correlaciones cruzadas entre etapas consecutivas sugirieron persistencia de asociaciones entre indicadores de uso/transgresión y desenlaces de salud/funcionamiento. De manera ilustrativa, niveles altos de <strong>Pasta Base</strong> al inicio tendieron a relacionarse con problemas de transgresión posteriores, mientras que mejoras en <strong>Días Trabajo</strong> precedieron mejoras en la salud psicológica. Este enfoque complementa a los modelos mixtos al explorar direccionalidad potencial, más allá de la asociación contemporánea.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para correlaciones cross-lagged</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>calculate_crosslag <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identificar pacientes con datos en ambas etapas</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  has_stage1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  has_stage2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solo pacientes en ambas etapas</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  ids_both <span class="ot">&lt;-</span> <span class="fu">intersect</span>(has_stage1, has_stage2)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(ids_both) <span class="sc">&lt;</span> <span class="dv">30</span>) {</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener datos ordenados y alineados</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar alineación</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(d1<span class="sc">$</span>HASHKEY, d2<span class="sc">$</span>HASHKEY)) {</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matriz de correlaciones cruzadas</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  cross_cor <span class="ot">&lt;-</span> <span class="fu">cor</span>(d1[,<span class="sc">-</span><span class="dv">1</span>], d2[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualizar como heatmap</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corrplot</span>(cross_cor, </span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>           <span class="at">method =</span> <span class="st">"color"</span>,</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="st">"full"</span>,</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>           <span class="at">tl.cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>           <span class="at">tl.col =</span> <span class="st">"black"</span>,</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"#e74c3c"</span>, <span class="st">"white"</span>, <span class="st">"#2ecc71"</span>))(<span class="dv">100</span>),</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Cross-lagged: Inicio → 6m (n ="</span>, <span class="fu">nrow</span>(d1), <span class="st">")"</span>))</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cross_cor)</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>crosslag_inicio_6m <span class="ot">&lt;-</span> <span class="fu">calculate_crosslag</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"6m"</span>, nodes_all)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/cross-lagged-1.png" class="img-fluid figure-img" width="3000"></p>
<figcaption>Análisis Cross-Lagged Inicio-6m</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>crosslag_inicio_9m <span class="ot">&lt;-</span> <span class="fu">calculate_crosslag</span>(dat_analysis, <span class="st">"6m"</span>, <span class="st">"12m"</span>, nodes_all)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Stage4_files/figure-html/cross-lagged%2012m-1.png" class="img-fluid figure-img" width="3000"></p>
<figcaption>Análisis Cross-Lagged 6m-12m</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="análisis-de-tendencias-temporales" class="level2" data-number="4.9">
<h2 data-number="4.9" class="anchored" data-anchor-id="análisis-de-tendencias-temporales"><span class="header-section-number">4.9</span> Análisis de Tendencias Temporales</h2>
<p>El análisis de correlación de Spearman con el tiempo en meses (<span class="math inline">\(0,3,6,9,12\)</span>) mostró tendencias marcadas: la densidad presentó <span class="math inline">\(\rho_S=-1{,}0\)</span> con <span class="math inline">\(p=0{,}0167\)</span> y pendiente <span class="math inline">\(-0{,}0244\)</span>; la longitud promedio de camino, <span class="math inline">\(\rho_S=1{,}0\)</span> con <span class="math inline">\(p=0{,}0167\)</span> y pendiente <span class="math inline">\(+0{,}0552\)</span>; el grado medio, pendiente <span class="math inline">\(-0{,}3667\)</span> con evidencia de cambio significativo; y la modularidad, pendiente <span class="math inline">\(+0{,}0131\)</span> también significativa. El clustering global, la fuerza global y la asortatividad no evidenciaron cambios significativos. Convergentemente, las redes se vuelven más dispersas (menos enlaces), más elongadas (mayores distancias) y más modulares (segmentación en comunidades) conforme avanza el tratamiento.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>temporal_trends <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  Métrica <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Densidad"</span>, <span class="st">"Clustering global"</span>, <span class="st">"Longitud promedio"</span>, </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Fuerza global"</span>, <span class="st">"Asortatividad"</span>, <span class="st">"Grado medio"</span>, <span class="st">"Modularidad"</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>time_numeric <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>stages_ordered <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(metric <span class="cf">in</span> temporal_trends<span class="sc">$</span>Métrica) {</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  values <span class="ot">&lt;-</span> global_metrics_comprehensive <span class="sc">%&gt;%</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Etapa <span class="sc">%in%</span> stages_ordered) <span class="sc">%&gt;%</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">match</span>(Etapa, stages_ordered)) <span class="sc">%&gt;%</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(<span class="sc">!!</span><span class="fu">sym</span>(metric))</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(values) <span class="sc">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    valid_indices <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(values))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(valid_indices) <span class="sc">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>      cor_test <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(time_numeric[valid_indices], values[valid_indices], </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>                           <span class="at">method =</span> <span class="st">"spearman"</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"Correlación_Spearman"</span>] <span class="ot">&lt;-</span> cor_test<span class="sc">$</span>estimate</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"p_value"</span>] <span class="ot">&lt;-</span> cor_test<span class="sc">$</span>p.value</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>      lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(values[valid_indices] <span class="sc">~</span> time_numeric[valid_indices])</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"Pendiente"</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(lm_model)[<span class="dv">2</span>]</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"R2"</span>] <span class="ot">&lt;-</span> <span class="fu">summary</span>(lm_model)<span class="sc">$</span>r.squared</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>temporal_trends <span class="sc">%&gt;%</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Significancia =</span> <span class="fu">case_when</span>(</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    p_value <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">~</span> <span class="st">"***"</span>,</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    p_value <span class="sc">&lt;</span> <span class="fl">0.01</span> <span class="sc">~</span> <span class="st">"**"</span>,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    p_value <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"*"</span>,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"ns"</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Análisis de tendencias temporales en métricas de red"</span>,</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">color =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(temporal_trends<span class="sc">$</span>p_value) <span class="sc">&amp;</span> </span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>                                temporal_trends<span class="sc">$</span>p_value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"red"</span>, <span class="st">"black"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<caption>Análisis de tendencias temporales en métricas de red</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Métrica</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Correlación_Spearman</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Pendiente</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">R2</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Significancia</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Densidad</td>
<td style="text-align: right;">-1.0</td>
<td style="text-align: right; color: red !important;">0.0167</td>
<td style="text-align: right;">-0.0244</td>
<td style="text-align: right;">0.9598</td>
<td style="text-align: left;">*</td>
</tr>
<tr class="even">
<td style="text-align: left;">Clustering global</td>
<td style="text-align: right;">-0.9</td>
<td style="text-align: right; color: black !important;">0.0833</td>
<td style="text-align: right;">-0.0094</td>
<td style="text-align: right;">0.7451</td>
<td style="text-align: left;">ns</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Longitud promedio</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right; color: red !important;">0.0167</td>
<td style="text-align: right;">0.0552</td>
<td style="text-align: right;">0.9572</td>
<td style="text-align: left;">*</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fuerza global</td>
<td style="text-align: right;">-0.9</td>
<td style="text-align: right; color: black !important;">0.0833</td>
<td style="text-align: right;">-0.1587</td>
<td style="text-align: right;">0.8009</td>
<td style="text-align: left;">ns</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Asortatividad</td>
<td style="text-align: right;">0.9</td>
<td style="text-align: right; color: black !important;">0.0833</td>
<td style="text-align: right;">0.0375</td>
<td style="text-align: right;">0.7874</td>
<td style="text-align: left;">ns</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grado medio</td>
<td style="text-align: right;">-1.0</td>
<td style="text-align: right; color: red !important;">0.0167</td>
<td style="text-align: right;">-0.3667</td>
<td style="text-align: right;">0.9598</td>
<td style="text-align: left;">*</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Modularidad</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right; color: red !important;">0.0167</td>
<td style="text-align: right;">0.0131</td>
<td style="text-align: right;">0.9682</td>
<td style="text-align: left;">*</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="conclusiónes" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Conclusiónes</h1>
<p>Los resultados muestran que la red TOP se simplifica y se segmenta a lo largo del tratamiento: disminuyen la densidad y el grado medio, aumenta la distancia típica entre ítems y crece la modularidad. La comparación de redes confirmó cambios sustantivos tanto en intensidad total como en arquitectura, con divergencias más amplias a 12 meses. Los nodos puente, en particular <strong>Pasta Base</strong>, <strong>Cannabis</strong> y <strong>Riña</strong>, junto con <strong>Días Trabajo</strong> en fases tempranas, articulan la conectividad interdominios y representan puntos de palanca para intervención. Los modelos longitudinales respaldan que reducir conductas de consumo y transgresión mientras se fortalecen salud física y psicológica y la participación laboral/educativa se asocia a mejor calidad de vida, con efectos que pueden variar temporalmente. Finalmente, algunas métricas se aproximan a patrones aleatorios en etapas tardías, lo que podría reflejar mayor heterogeneidad y menor acoplamiento entre dominios tras la intervención, reforzando la necesidad de intervenciones tempranas y focalizadas sobre los nodos puente identificados.</p>
<section id="síntesis-de-resultados" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="síntesis-de-resultados"><span class="header-section-number">5.1</span> Síntesis de Resultados</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar resultados de hipótesis</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>h1_result <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_6m)) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  nct_inicio_6m<span class="sc">$</span>glstrinv.pval <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear resumen de ajuste con modelos nulos</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>null_summary <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(null_comparisons), <span class="cf">function</span>(stage) {</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> null_comparisons[[stage]]</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(comp)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  sig_er <span class="ot">&lt;-</span> <span class="fu">sum</span>(comp<span class="sc">$</span>p_values_er <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  sig_ba <span class="ot">&lt;-</span> <span class="fu">sum</span>(comp<span class="sc">$</span>p_values_ba <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  total_metrics <span class="ot">&lt;-</span> <span class="fu">length</span>(comp<span class="sc">$</span>p_values_er)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Etapa =</span> stage,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER Sig/Total</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(sig_er, <span class="st">"/"</span>, total_metrics),</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Bueno"</span>,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Moderado"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Pobre"</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA Sig/Total</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(sig_ba, <span class="st">"/"</span>, total_metrics),</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA Ajuste</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>      sig_ba <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Bueno"</span>,</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>      sig_ba <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Moderado"</span>,</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Pobre"</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    Conclusión <span class="ot">=</span> <span class="fu">case_when</span>(</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">&amp;</span> sig_ba <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Red compatible con procesos aleatorios"</span>,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">&amp;</span> sig_ba <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Red con estructura no aleatoria fuerte"</span>,</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Red con estructura parcialmente no aleatoria"</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla resumen final</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>null_summary <span class="sc">%&gt;%</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Resumen de ajuste con modelos nulos por etapa"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">color =</span> <span class="fu">case_when</span>(</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Bueno"</span> <span class="sc">~</span> <span class="st">"green"</span>,</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Moderado"</span> <span class="sc">~</span> <span class="st">"orange"</span>,</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"red"</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">5</span>, <span class="at">color =</span> <span class="fu">case_when</span>(</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">BA Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Bueno"</span> <span class="sc">~</span> <span class="st">"green"</span>,</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">BA Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Moderado"</span> <span class="sc">~</span> <span class="st">"orange"</span>,</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"red"</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<caption>Resumen de ajuste con modelos nulos por etapa</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Etapa</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ER Sig/Total</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ER Ajuste</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">BA Sig/Total</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">BA Ajuste</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Conclusión</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inicio</td>
<td style="text-align: left;">3/6</td>
<td style="text-align: left; color: orange !important;">Moderado</td>
<td style="text-align: left;">2/6</td>
<td style="text-align: left; color: green !important;">Bueno</td>
<td style="text-align: left;">Red con estructura parcialmente no aleatoria</td>
</tr>
<tr class="even">
<td style="text-align: left;">3m</td>
<td style="text-align: left;">2/6</td>
<td style="text-align: left; color: green !important;">Bueno</td>
<td style="text-align: left;">3/6</td>
<td style="text-align: left; color: orange !important;">Moderado</td>
<td style="text-align: left;">Red con estructura parcialmente no aleatoria</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6m</td>
<td style="text-align: left;">4/6</td>
<td style="text-align: left; color: orange !important;">Moderado</td>
<td style="text-align: left;">4/6</td>
<td style="text-align: left; color: orange !important;">Moderado</td>
<td style="text-align: left;">Red con estructura parcialmente no aleatoria</td>
</tr>
<tr class="even">
<td style="text-align: left;">9m</td>
<td style="text-align: left;">2/6</td>
<td style="text-align: left; color: green !important;">Bueno</td>
<td style="text-align: left;">2/6</td>
<td style="text-align: left; color: green !important;">Bueno</td>
<td style="text-align: left;">Red compatible con procesos aleatorios</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12m</td>
<td style="text-align: left;">2/6</td>
<td style="text-align: left; color: green !important;">Bueno</td>
<td style="text-align: left;">2/6</td>
<td style="text-align: left; color: green !important;">Bueno</td>
<td style="text-align: left;">Red compatible con procesos aleatorios</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Síntesis de hallazgos clave</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>synthesis <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Aspecto =</span> <span class="fu">c</span>(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Estructura de red"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Comparación con modelos aleatorios"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Evolución temporal"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nodos centrales"</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dominios puente"</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Hallazgo Principal</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Densidad promedio:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(global_metrics_comprehensive<span class="sc">$</span>Densidad, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>)),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Etapas con estructura no aleatoria:"</span>, <span class="fu">sum</span>(null_summary<span class="sc">$</span><span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Pobre"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Métricas con tendencia significativa:"</span>, <span class="fu">sum</span>(temporal_trends<span class="sc">$</span>p_value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Nodos centrales consistentes:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">head</span>(node_metrics_all<span class="sc">$</span>Nodo[<span class="fu">order</span>(node_metrics_all<span class="sc">$</span>Fuerza, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)], <span class="dv">10</span>)))),</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Dominio puente principal:"</span>, <span class="fu">names</span>(<span class="fu">which.max</span>(<span class="fu">table</span>(bridge_metrics<span class="sc">$</span>Comunidad[bridge_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="fu">median</span>(bridge_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>)]))))</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  Implicación <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Red moderadamente densa con conexiones significativas"</span>,</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Estructura emergente no explicable por azar"</span>,</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cambios sistemáticos durante el tratamiento"</span>,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Focos de intervención identificables"</span>,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Puntos clave de integración terapéutica"</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>synthesis <span class="sc">%&gt;%</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Síntesis de hallazgos principales del análisis de redes"</span>,</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">2</span>, <span class="at">width =</span> <span class="st">"200px"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">width =</span> <span class="st">"300px"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<caption>Síntesis de hallazgos principales del análisis de redes</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Aspecto</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Hallazgo Principal</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Implicación</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estructura de red</td>
<td style="text-align: left; width: 200px;">Densidad promedio: 0.398</td>
<td style="text-align: left; width: 300px;">Red moderadamente densa con conexiones significativas</td>
</tr>
<tr class="even">
<td style="text-align: left;">Comparación con modelos aleatorios</td>
<td style="text-align: left; width: 200px;">Etapas con estructura no aleatoria: 0</td>
<td style="text-align: left; width: 300px;">Estructura emergente no explicable por azar</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Evolución temporal</td>
<td style="text-align: left; width: 200px;">Métricas con tendencia significativa: 4</td>
<td style="text-align: left; width: 300px;">Cambios sistemáticos durante el tratamiento</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nodos centrales</td>
<td style="text-align: left; width: 200px;">Nodos centrales consistentes: 2</td>
<td style="text-align: left; width: 300px;">Focos de intervención identificables</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dominios puente</td>
<td style="text-align: left; width: 200px;">Dominio puente principal: Transgresión</td>
<td style="text-align: left; width: 300px;">Puntos clave de integración terapéutica</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- -->


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">Referencias</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-Volkow2023" class="csl-entry" role="listitem">
1. Volkow, N. D., &amp; Blanco, C. (2023). Substance use disorders: a comprehensive update of classification, epidemiology, neurobiology, clinical aspects, treatment and prevention. <em>World Psychiatry</em>, <em>22</em>(2), 203-229. <a href="https://doi.org/10.1002/wps.21073">https://doi.org/10.1002/wps.21073</a>
</div>
<div id="ref-Connery2020" class="csl-entry" role="listitem">
2. Connery, H. S., McHugh, R. K., Reilly, M., Shin, S., &amp; Greenfield, S. F. (2020). Substance Use Disorders in Global Mental Health Delivery: Epidemiology, Treatment Gap, and Implementation of Evidence-Based Treatments. <em>Harvard Review of Psychiatry</em>, <em>28</em>(5), 316-327. <a href="https://doi.org/10.1097/HRP.0000000000000271">https://doi.org/10.1097/HRP.0000000000000271</a>
</div>
<div id="ref-GomezSanchezLafuente2022" class="csl-entry" role="listitem">
3. Gómez-Sánchez-Lafuente, C., Guzman-Parra, J., Suarez-Perez, J., Bordallo-Aragon, A., Rodriguez-de-Fonseca, F., &amp; Mayoral-Cleries, F. (2022). Trends in Psychiatric Hospitalizations of Patients With Dual Diagnosis in Spain. <em>Journal of Dual Diagnosis</em>, <em>18</em>(2), 92-100. <a href="https://doi.org/10.1080/15504263.2022.2053770">https://doi.org/10.1080/15504263.2022.2053770</a>
</div>
<div id="ref-Saxena2011" class="csl-entry" role="listitem">
4. Saxena, S., Thornicroft, G., Knapp, J., &amp; Whiteford, M. (2007). Resources for mental health: scarcity, inequity, and inefficiency. <em>World Psychiatry</em>, <em>6</em>(1), 1-10. <a href="https://doi.org/10.1002/wps.21073">https://doi.org/10.1002/wps.21073</a>
</div>
<div id="ref-GomezSanchezLafuente2016" class="csl-entry" role="listitem">
5. Gómez-Sánchez-Lafuente, C., Guzman-Parra, J., Suarez-Perez, J., Mayoral-Cleries, F., &amp; Rodriguez-de-Fonseca, F. (2016). Dual Diagnosis in Spain: Prevalence, Sociodemographic Profile, and Psychiatric Comorbidity in a Sample of Patients Admitted to Psychiatric Inpatient Units. <em>Journal of Dual Diagnosis</em>, <em>12</em>(3-4), 249-258. <a href="https://doi.org/10.1080/15504263.2016.1220207">https://doi.org/10.1080/15504263.2016.1220207</a>
</div>
<div id="ref-Rojas2002" class="csl-entry" role="listitem">
6. Rojas, G., Gaete, M., Guajardo, M., Martínez, M., Martínez, M., Fritsch, R., &amp; Araya, R. (2002). Prevalencia de trastornos psiquiátricos en pacientes hospitalizados en un hospital general. <em>Revista M<span>é</span>dica de Chile</em>, <em>130</em>(6), 689-696. <a href="https://doi.org/10.4067/S0034-98872002000600008">https://doi.org/10.4067/S0034-98872002000600008</a>
</div>
<div id="ref-CastilloCarniglia2015" class="csl-entry" role="listitem">
7. Castillo-Carniglia, A., Marín, J. D., Soto-Brandt, G., Donoso, M. P., Piñol, D., San Martín, J., Huepe, D., Alvarado, R., Eastwood, B., &amp; Portilla Huidobro, R. (2015). Adaptation and Validation of the Instrument Treatment Outcomes Profile to the Chilean Population. <em>Journal of Substance Abuse Treatment</em>, <em>56</em>, 39-47. <a href="https://doi.org/10.1016/j.jsat.2015.03.002">https://doi.org/10.1016/j.jsat.2015.03.002</a>
</div>
<div id="ref-Spiller2020" class="csl-entry" role="listitem">
8. Spiller, T. R., Levi, O., Neria, Y., Suarez-Jimenez, B., Bar-Haim, Y., &amp; Lazarov, A. (2020). On the validity of the centrality hypothesis in cross-sectional between-subject networks of psychopathology. <em>BMC Medicine</em>, <em>18</em>(1), 297. <a href="https://doi.org/10.1186/s12916-020-01740-5">https://doi.org/10.1186/s12916-020-01740-5</a>
</div>
<div id="ref-Liu2012" class="csl-entry" role="listitem">
9. Liu, H., Han, F., Yuan, M., Lafferty, J., &amp; Wasserman, L. (2012). High-dimensional semiparametric Gaussian copula graphical models. <em>The Annals of Statistics</em>, <em>40</em>(4), 2293-2326. <a href="https://doi.org/10.1214/12-AOS1037">https://doi.org/10.1214/12-AOS1037</a>
</div>
<div id="ref-Friedman2008" class="csl-entry" role="listitem">
10. Friedman, J., Hastie, T., &amp; Tibshirani, R. (2008). Sparse Inverse Covariance Estimation with the Graphical Lasso. <em>Biostatistics</em>, <em>9</em>(3), 432-441. <a href="https://doi.org/10.1093/biostatistics/kxm045">https://doi.org/10.1093/biostatistics/kxm045</a>
</div>
<div id="ref-FoygelDrton2011" class="csl-entry" role="listitem">
11. Foygel, R., &amp; Drton, M. (2011). Extended <span>B</span>ayesian Information Criteria for Gaussian Graphical Models. <em>The Annals of Applied Statistics</em>, <em>5</em>(2A), 1100-1128. <a href="https://doi.org/10.1214/10-AOAS799">https://doi.org/10.1214/10-AOAS799</a>
</div>
<div id="ref-WattsStrogatz1998" class="csl-entry" role="listitem">
12. Watts, D. J., &amp; Strogatz, S. H. (1998). Collective dynamics of ’small-world’ networks. <em>Nature</em>, <em>393</em>(6684), 440-442. <a href="https://doi.org/10.1038/30918">https://doi.org/10.1038/30918</a>
</div>
<div id="ref-Blondel2008" class="csl-entry" role="listitem">
13. Blondel, V. D., Guillaume, J.-L., Lambiotte, R., &amp; Lefebvre, E. (2008). Fast unfolding of communities in large networks. <em>Journal of Statistical Mechanics: Theory and Experiment</em>, <em>2008</em>(10), P10008. <a href="https://doi.org/10.1088/1742-5468/2008/10/P10008">https://doi.org/10.1088/1742-5468/2008/10/P10008</a>
</div>
<div id="ref-BrinPage1998" class="csl-entry" role="listitem">
14. Brin, S., &amp; Page, L. (1998). The anatomy of a large-scale hypertextual Web search engine. <em>Computer Networks and ISDN Systems</em>, <em>30</em>(1–7), 107-117. <a href="https://doi.org/10.1016/S0169-7552(98)00110-X">https://doi.org/10.1016/S0169-7552(98)00110-X</a>
</div>
<div id="ref-EpskampBRM2018" class="csl-entry" role="listitem">
15. Epskamp, S., Borsboom, D., &amp; Fried, E. I. (2018). Estimating psychological networks and their accuracy: A tutorial paper. <em>Behavior Research Methods</em>, <em>50</em>(1), 195-212. <a href="https://doi.org/10.3758/s13428-017-0862-1">https://doi.org/10.3758/s13428-017-0862-1</a>
</div>
<div id="ref-EpskampFried2018" class="csl-entry" role="listitem">
16. Epskamp, S., &amp; Fried, E. I. (2018). A tutorial on regularized partial correlation networks. <em>Psychological Methods</em>, <em>23</em>(4), 617-634. <a href="https://doi.org/10.1037/met0000167">https://doi.org/10.1037/met0000167</a>
</div>
<div id="ref-Jones2019" class="csl-entry" role="listitem">
17. Jones, P. J., Ma, R., &amp; McNally, R. J. (2019). Bridge Centrality: A Network Approach to Understanding Comorbidity. <em>Multivariate Behavioral Research</em>, <em>56</em>(2), 353-367. <a href="https://doi.org/10.1080/00273171.2019.1614898">https://doi.org/10.1080/00273171.2019.1614898</a>
</div>
<div id="ref-Gilbert1959" class="csl-entry" role="listitem">
18. Gilbert, E. N. (1959). Random Graphs. <em>The Annals of Mathematical Statistics</em>, <em>30</em>(4), 1141-1144. <a href="https://doi.org/10.1214/aoms/1177706098">https://doi.org/10.1214/aoms/1177706098</a>
</div>
<div id="ref-BarabasiAlbert1999" class="csl-entry" role="listitem">
19. Barabási, A.-L., &amp; Albert, R. (1999). Emergence of Scaling in Random Networks. <em>Science</em>, <em>286</em>(5439), 509-512. <a href="https://doi.org/10.1126/science.286.5439.509">https://doi.org/10.1126/science.286.5439.509</a>
</div>
<div id="ref-vanBorkulo2023" class="csl-entry" role="listitem">
20. Borkulo, C. D. van, Bork, R. van, Boschloo, L., Kossakowski, J. J., Tio, P., Schoevers, R. A., Borsboom, D., &amp; Waldorp, L. J. (2023). Comparing network structures on three aspects: A permutation test. <em>Psychological Methods</em>, <em>28</em>(6), 1273-1285. <a href="https://doi.org/10.1037/met0000476">https://doi.org/10.1037/met0000476</a>
</div>
<div id="ref-LairdWare1982" class="csl-entry" role="listitem">
21. Laird, N. M., &amp; Ware, J. H. (1982). Random-Effects Models for Longitudinal Data. <em>Biometrics</em>, <em>38</em>(4), 963-974. <a href="https://doi.org/10.2307/2529876">https://doi.org/10.2307/2529876</a>
</div>
<div id="ref-Bates2015" class="csl-entry" role="listitem">
22. Bates, D., Mächler, M., Bolker, B., &amp; Walker, S. (2015). Fitting Linear Mixed-Effects Models Using <code>lme4</code>. <em>Journal of Statistical Software</em>, <em>67</em>(1), 1-48. <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>
</div>
<div id="ref-Hamaker2015" class="csl-entry" role="listitem">
23. Hamaker, E. L., Kuiper, R. M., &amp; Grasman, R. P. P. P. (2015). A Critique of the Cross-Lagged Panel Model. <em>Psychological Methods</em>, <em>20</em>(1), 102-116. <a href="https://doi.org/10.1037/a0038889">https://doi.org/10.1037/a0038889</a>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiado");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiado");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Ejecutar el código</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Análisis de Redes del Treatment Outcomes Profile en Cohortes de Rehabilitación de Consumo de Sustancias en Chile"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: "Amaru Simón Agüero Jiménez"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">    email: "aaguero@miaundes.cl"</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid: "0000-0001-7336-1833"</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r Sys.Date()`"</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="an">lang:</span><span class="co"> es</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">    smooth-scroll: true</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 6</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: right</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 6</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">    bibliography: ref.bib</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co">    csl: apa-numeric-superscript.csl</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: bottom</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co">#    css: styles.css</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co">  python: true</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co">  fig-width: 8</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co">  fig-height: 6</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introducción</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>Los trastornos por uso de sustancias (TUS) constituyen una de las principales causas de carga de enfermedad y mortalidad evitable a escala global. En 2016 se calculó que más de 100 millones de personas sufrían trastorno por consumo de alcohol y decenas de millones presentaban dependencia de opioides, cannabis o cocaína <span class="co">[</span><span class="ot">@Volkow2023</span><span class="co">]</span>. La frecuente comorbilidad psiquiátrica con depresión, trastornos de ansiedad, psicosis o trastornos de personalidad multiplica la severidad clínica y los costes sociosanitarios <span class="co">[</span><span class="ot">@Connery2020</span><span class="co">]</span>. Estudios hospitalarios europeos y norteamericanos muestran que alrededor del 20% de las admisiones psiquiátricas corresponden a pacientes de sexo femenino con diagnóstico dual, fenómeno que favorece re‑ingresos y estancias prolongadas <span class="co">[</span><span class="ot">@GomezSanchezLafuente2022</span><span class="co">]</span>.</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>En Chile, las encuestas nacionales sitúan la prevalencia de abuso o dependencia de sustancias entre el 11% y el 20%, una de las más elevadas de Latinoamérica. Los registros hospitalarios concuerdan con las cifras internacionales: alrededor de una quinta parte de los internados en psiquiatría presenta un TUS como diagnóstico primario o secundario. Esta convergencia evidencia que la hospitalización psiquiátrica es un desenlace clínico crítico en la trayectoria de las adicciones, razón por la cual identificar sus factores determinantes resulta esencial para planificar intervenciones preventivas, asignar recursos y reducir la carga asistencial <span class="co">[</span><span class="ot">@Connery2020; @Saxena2011; @GomezSanchezLafuente2016; @Rojas2002</span><span class="co">]</span>.</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>En respuesta a esta problemática, el Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol (SENDA) gestiona el Sistema de Tratamiento (SISTRAT), que recopila información de miles de episodios de tratamiento en centros públicos y privados. Como instrumento central, se utiliza el Treatment Outcomes Profile (TOP), un cuestionario de 20 ítems desarrollado en Inglaterra y adaptado al contexto chileno <span class="co">[</span><span class="ot">@CastilloCarniglia2015</span><span class="co">]</span>. El TOP registra consumo de sustancias en el último mes, conductas de inyección, situación de vivienda, actividad laboral, vínculos familiares, crimen y problemas de salud mental, permitiendo monitorear la evolución de los pacientes a lo largo de distintas etapas del tratamiento.</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>Para analizar la complejidad de las interacciones entre síntomas y factores psicosociales, el enfoque de análisis de redes ha cobrado importancia en psicología y psiquiatría. Este enfoque modela los ítems como nodos y las correlaciones condicionales como aristas, revelando cómo las variables se influyen mutuamente. La centralidad de fuerza y la influencia esperada permiten identificar los nodos más relevantes en cada red, facilitando la priorización de intervenciones <span class="co">[</span><span class="ot">@Spiller2020</span><span class="co">]</span>. En el contexto de las adicciones, este enfoque puede arrojar luz sobre los mecanismos que conducen a recaídas y ayudar a diseñar estrategias terapéuticas más efectivas.</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="fu"># Objetivos e Hipótesis</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="fu">## Objetivo general</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>Evaluar redes de interacciones entre síntomas y factores psicosociales registrados por el TOP en distintas etapas del tratamiento de rehabilitación de drogas en Chile, identificando los nodos más influyentes y sus implicancias clínicas.</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Objetivos específicos</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>**1)** Elavorar redes de asociación condicional para cada etapa del tratamiento (diagnóstico, atención ambulatoria, atención residencial, alta y reingreso) usando el método EBICglasso para regularización.</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>**2)** Estimar métricas de centralidad de fuerza e influencia esperada para cada nodo y determinar los ítems que presentan mayor influencia en cada red.</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>**3)** Evaluar diferencias en la estructura y la fuerza global entre las redes de etapas consecutivas con la prueba de comparación de redes (Network Comparison Test)</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>**4)** Modelar la evolución longitudinal de los nodos centrales mediante análisis de efectos mixtos y paneles cruzados, explorando la direccionalidad entre síntomas y recaídas.</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hipótesis de Investigación</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>**H1**: La densidad de la red (fuerza global) disminuye significativamente entre el ingreso y los 6-12 meses de tratamiento, reflejando una desacoplación de síntomas.</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>**H2**: Las variables de salud (psicológica/física) aumentan su centralidad de puente entre dominios al avanzar el tratamiento.</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>**H3**: Los cambios en consumo de sustancias entre etapas predicen cambios en salud y calidad de vida (análisis de transiciones).</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>**H4**: Existen trayectorias heterogéneas de cambio identificables mediante modelos mixtos lineales.</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metodología</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Descripción de los datos</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>Este es un estudio de cohorte retrospectiva de pacientes adultos en tratamiento por consumo de sustancias desde el 2018 al 2022, con datos otorgados por el Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol de Chile (SENDA) en convenio con el núcleo milenio de ánalisis de políticas públicas de drogas (nDP). La cohorte se construyó vinculando los registros administrativos de los pacientes con TOP (n = 167,404 episodios de tratamiento entre 56,998</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>personas en las 16 regiones del país).</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>Estos datos incluyen múltiples variables relacionadas al consumo y tratamiento rehabilitador de drogas. Entre estas variables esta la *sustancia principal*  por la cual se trató al paciente y sustancias secundarias (alcohol, pasta base de cocaína, cocaína, marihuana, depresores del SNC u otras sustancias. Tambien está presente el número de reingresos a tratamiento (retratamientos, categorizados en 0, 1, 2, 3 o más reingresos), el *tipo de plan de tratamiento* (ambulatorio vs. residencial) y el historial clínico de salud mental de los pacientes.</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>El registro de pacientes en tratamiento se realizó en una plataforma electrónica denominada SISTRAT, que contenía información sociodemográfica, datos sobre el estado de salud y patrones de consumo de sustancias, entre otras variables, además de información sobre el propio tratamiento (p. ej., fecha de ingreso, egreso, tipo de tratamiento). Las base de datos se vincularon de forma determinista mediante un hash de 64 caracteres resultante del cifrado (con un algoritmo SHA-256) del número de identificación único de cada persona.</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a><span class="fu">## Preparación y armonización de variables</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>A partir de los registros TOP se construyeron cuatro dominios analíticos: **Uso de sustancias** (alcohol, cannabis, cocaína, pasta base, benzodiacepinas, otra sustancia), **Transgresión** (hurto, robo, venta de drogas, riña, violencia intrafamiliar), **Salud** (psicológica, física) y **Funcionamiento** (días trabajo, días educación), además de **calidad de vida**. Los puntajes continuos se estandarizaron por etapa y las variables dicotómicas se mantuvieron como indicadores binarios. Para manejar mezclas de escalas y posibles desviaciones de normalidad, la matriz de asociación se estimó con estrategias robustas compatibles con **modelos copulares gaussianos** / **no-paranormales** <span class="co">[</span><span class="ot">@Liu2012</span><span class="co">]</span>.</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimación de redes por etapa</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>Para cada etapa se estimó una red de **correlaciones parciales** bajo un **modelo gaussiano de campos aleatorios (GGM)** escaso. La matriz de precisión $\Theta$ se obtuvo mediante penalización $\ell_1$ (graphical lasso), que maximiza la verosimilitud penalizada y promueve soluciones dispersas [@Friedman2008]. La selección del grado de regularización se realizó con el **criterio EBIC**, que extiende BIC para espacio de grafos de alta dimensión, con parámetro $\gamma$ intermedio (aprox. 0,5) para equilibrar ajuste y parsimonia [@FoygelDrton2011]. Los **pesos de arista** se reportan como correlaciones parciales estandarizadas:</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>w_{ij}=-\frac{\widehat\Theta_{ij}}{\sqrt{\widehat\Theta_{ii}\,\widehat\Theta_{jj}}}.</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a><span class="fu">## Métricas globales y nodales</span></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>De cada red se extrajeron métricas **globales** —densidad, diámetro, longitud de camino media y coeficientes de **clustering**— siguiendo la tradición de redes de **pequeño-mundo** [@WattsStrogatz1998], y **modularidad** sobre particiones detectadas por maximización heurística de $Q$ [@Blondel2008]. A nivel de **nodo** se calcularon:</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Fuerza**: $s_i=\sum_j |w_{ij}|$ (influencia agregada);</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Betweenness**/**closeness** basadas en geodésicas;</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Centralidad de eigenvector** (influencia recursiva);</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**PageRank** (vector estacionario de un paseo aleatorio) <span class="co">[</span><span class="ot">@BrinPage1998</span><span class="co">]</span>.</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>La precisión e interpretabilidad de estas métricas en redes psicométricas se discute en guías metodológicas recientes, que se siguieron para la evaluación de estabilidad y reporte responsable <span class="co">[</span><span class="ot">@EpskampBRM2018; @EpskampFried2018</span><span class="co">]</span>.</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a><span class="fu">## Puentes entre dominios</span></span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>Con la partición a priori (Uso, Transgresión, Salud, Funcionamiento) se estimó **centralidad puente** (bridge strength) e **influencia puente esperada**, para identificar nodos que conectan comunidades y potenciales puntos de intervención traslacional <span class="co">[</span><span class="ot">@Jones2019</span><span class="co">]</span>.</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparación con modelos nulos</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>Para valorar si la organización observada excede lo esperable por azar, cada red se contrastó con distribuciones de referencia simuladas: **$G(n,p)$ (Gilbert)** ajustando $p$ a la densidad observada [@Gilbert1959] y **preferential attachment** tipo **Barabási–Albert** con $m\approx \bar k/2$ [@BarabasiAlbert1999]. Sobre métricas clave (clustering, longitud de camino, diámetro, asortatividad, grado máximo, varianza del grado) se obtuvieron medias, bandas de cuantiles y **$z$-scores**:</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>z=\frac{T_{\text{obs}}-\mu_0}{\sigma_0}.</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>Se reportan *p* bilaterales por simulación.</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a><span class="fu">## Invarianza estructural entre etapas</span></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>Las diferencias entre redes de etapas (p. ej., **Inicio vs 6 m**; **Inicio vs 12 m**) se evaluaron con un **test de permutación** para comparación de redes, que contrasta (i) **invarianza de estructura**, (ii) **aristas específicas** y (iii) **diferencia de fuerza global** $\Delta S=\sum_{i&lt;j}|w_{ij}^{(1)}|-\sum_{i&lt;j}|w_{ij}^{(2)}|$ <span class="co">[</span><span class="ot">@vanBorkulo2023</span><span class="co">]</span>. Los *p*-values se obtienen permutando etiquetas de grupo y re-estimando redes.</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a><span class="fu">## Redes de cambio (deltas apareados)</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>Para transiciones **Inicio→3 m**, **3→6 m** y **6→12 m**, en submuestras apareadas por individuo, se construyó una matriz de **deltas** $\Delta X=X_{t_2}-X_{t_1}$ y se estimó un GGM regularizado sobre $\Delta X$. Las aristas positivas indican **co-mejoras / co-empeoramientos**; las negativas sugieren **compensaciones** entre dominios.</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modelos longitudinales complementarios</span></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>Con el fin de describir trayectorias y heterogeneidad interindividual, se ajustaron **modelos lineales mixtos** con intercepto (y, cuando fue posible, pendiente) aleatoria por sujeto:</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>y_{it}=\beta_0+\beta_1 t+\boldsymbol{\beta}^\top\mathbf{z}_{it}+b_{0i}+b_{1i}t+\varepsilon_{it},</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>siguiendo el enfoque clásico de efectos aleatorios para datos longitudinales <span class="co">[</span><span class="ot">@LairdWare1982; @Bates2015</span><span class="co">]</span>. Como análisis **exploratorio** y no inferencial, se calcularon **correlaciones *cross-lagged*** entre nodos de etapas consecutivas (p. ej., Inicio→6 m), interpretadas con cautela a la luz de las limitaciones del CLPM tradicional <span class="co">[</span><span class="ot">@Hamaker2015</span><span class="co">]</span>.</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a><span class="fu">## Transparencia y robustez</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>Para métricas de centralidad agregadas se reportan promedios con **IC 95 %** por aproximación normal (descriptivos). La evaluación de exactitud/estabilidad de redes se guio por buenas prácticas para redes psicológicas (re-muestreo, sensibilidad a regularización y a selección de correlaciones) <span class="co">[</span><span class="ot">@EpskampBRM2018</span><span class="co">]</span>. </span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a><span class="co"># TOP 2015–2022: Carga robusta + Limpieza + Renombrado</span></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup unificado (paquetes + opciones + tema + seed)</span></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Función robusta para instalar/cargar paquetes ----</span></span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>ensure_packages <span class="ot">&lt;-</span> <span class="cf">function</span>(pkgs, <span class="at">repos =</span> <span class="fu">getOption</span>(<span class="st">"repos"</span>)) {</span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(pkgs), <span class="fu">length</span>(pkgs) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Repos por defecto si no están definidos</span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(repos) <span class="sc">||</span> <span class="fu">is.na</span>(repos[<span class="st">"CRAN"</span>]) <span class="sc">||</span> repos[<span class="st">"CRAN"</span>] <span class="sc">==</span> <span class="st">"@CRAN@"</span>) {</span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN =</span> <span class="st">"https://cloud.r-project.org"</span>))</span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detectar faltantes</span></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>  missing_pkgs <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span><span class="fu">vapply</span>(pkgs, requireNamespace, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="at">quietly =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Instalar faltantes (con dependencias y en paralelo cuando sea posible)</span></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_pkgs)) {</span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>    ncpus <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"parallel"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>      ncpus <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>L)</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(missing_pkgs, <span class="at">dependencies =</span> <span class="cn">TRUE</span>, <span class="at">Ncpus =</span> ncpus)</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cargar todos (incluye los que ya estaban)</span></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, <span class="cf">function</span>(p) {</span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressPackageStartupMessages</span>(</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>      <span class="fu">library</span>(p, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">TRUE</span>)</span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Declaración única de paquetes ----</span></span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># utilidades / data wrangling</span></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table"</span>, <span class="st">"stringr"</span>, <span class="st">"stringi"</span>, <span class="st">"janitor"</span>, <span class="st">"lubridate"</span>,</span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dplyr"</span>, <span class="st">"purrr"</span>, <span class="st">"tibble"</span>, <span class="st">"openxlsx"</span>, <span class="st">"tidyverse"</span>,</span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># redes y psicometría</span></span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a>  <span class="st">"igraph"</span>, <span class="st">"qgraph"</span>, <span class="st">"bootnet"</span>, <span class="st">"NetworkComparisonTest"</span>, <span class="st">"networktools"</span>,</span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># modelos mixtos</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>, <span class="st">"lmerTest"</span>, <span class="st">"broom.mixed"</span>,</span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a>  <span class="co"># grafos/visualización</span></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggraph"</span>, <span class="st">"tidygraph"</span>, <span class="st">"corrplot"</span>, <span class="st">"patchwork"</span>, <span class="st">"kableExtra"</span>, <span class="st">"plotly"</span></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Carga de paquetes (instala si faltan) ----</span></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a><span class="fu">ensure_packages</span>(pkgs)</span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Configuración global knitr/figuras ----</span></span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a>  <span class="at">message   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">10</span>,</span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">8</span>,</span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">dpi =</span> <span class="dv">300</span></span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Temas y opciones de visualización ----</span></span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>))</span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Semilla global para reproducibilidad ----</span></span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Paths y configuración ----------------------------------------------</span></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a>root <span class="ot">&lt;-</span> <span class="fu">normalizePath</span>(<span class="fu">gsub</span>(<span class="st">"/docs$"</span>, <span class="st">""</span>, <span class="fu">getwd</span>()), <span class="at">mustWork =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a>base_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP"</span>)</span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>output_rds <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022_FINAL.rds"</span>)</span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>output_excel <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022_FINAL.xlsx"</span>)</span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Archivos esperados --------------------------------------------------</span></span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a>archivos <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2015_oct_dup_enc.csv"</span>,</span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2016_oct_dup1_enc.csv"</span>, <span class="st">"2016_oct_dup2_enc.csv"</span>,</span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2017_oct_dup1_enc.csv"</span>, <span class="st">"2017_oct_dup2_enc.csv"</span>,</span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2018_oct_dup1_enc.csv"</span>, <span class="st">"2018_oct_dup2_enc.csv"</span>,</span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2019_oct_dup1_enc.csv"</span>, <span class="st">"2019_oct_dup2_enc.csv"</span>,</span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2019oct_oct_dup_enc.csv"</span>,</span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2020_oct_dup1_enc.csv"</span>, <span class="st">"2020_oct_dup2_enc.csv"</span>,</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2021_oct_dup1_enc.csv"</span>, <span class="st">"2021_oct_dup2_enc.csv"</span>,</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2022_oct_dup1_enc.csv"</span>, <span class="st">"2022_oct_dup2_enc.csv"</span></span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Funciones de utilidad -----------------------------------------------</span></span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Extrae año del nombre del archivo</span></span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>extract_year <span class="ot">&lt;-</span> <span class="cf">function</span>(filename) {</span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(filename, <span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2}"</span>))</span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpia nombres de columnas</span></span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>clean_colnames <span class="ot">&lt;-</span> <span class="cf">function</span>(nms) {</span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(nms, <span class="st">"Latin-ASCII"</span>)</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"[^A-Za-z0-9]+"</span>, <span class="st">"_"</span>)</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"_{2,}"</span>, <span class="st">"_"</span>)</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(nms, <span class="st">"^_|_$"</span>, <span class="st">""</span>)</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">make_clean_names</span>(nms)</span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Mojibake safe (no explota con NA)</span></span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a>fix_mojibake <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">enc2utf8</span>(x)</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>  bad <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"(Ã.|Â|Aƒ)"</span>)</span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(bad)) {</span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>    cand <span class="ot">&lt;-</span> <span class="fu">iconv</span>(x[bad], <span class="at">from =</span> <span class="st">"latin1"</span>, <span class="at">to =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>    scount <span class="ot">&lt;-</span> <span class="cf">function</span>(v, pat) { </span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>      out <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_count</span>(v, pat)</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>      out[<span class="fu">is.na</span>(out)] <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>      out </span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>    keep <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scount</span>(cand, <span class="st">"Ã|Â|Aƒ"</span>) <span class="sc">&lt;</span> <span class="fu">scount</span>(x[bad], <span class="st">"Ã|Â|Aƒ"</span>), </span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>      cand, </span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>      x[bad]</span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>    x[bad] <span class="ot">&lt;-</span> keep</span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Parser de fechas mixtas</span></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a>parse_mixed_dates <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_trim</span>(x)</span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a>  x[x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">"NULL"</span>, <span class="st">"0000-00-00"</span>, <span class="st">"00/00/0000"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(x, <span class="st">"[./]"</span>, <span class="st">"-"</span>)</span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">as.Date</span>(<span class="cn">NA</span>), <span class="fu">length</span>(x))</span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yyyy-mm-dd</span></span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a>  ymd_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[12][0-9]{3}-[0-9]{1,2}-[0-9]{1,2}$"</span>)</span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(ymd_mask)) res[ymd_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(x[ymd_mask]))</span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dd-mm-yyyy (preferencia Chile)</span></span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a>  dmy_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span>ymd_mask <span class="sc">&amp;</span> </span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{1,2}-[0-9]{1,2}-[12][0-9]{3}$"</span>)</span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(dmy_mask)) res[dmy_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">dmy</span>(x[dmy_mask]))</span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mdy como fallback</span></span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>  mdy_mask <span class="ot">&lt;-</span> <span class="fu">is.na</span>(res) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> </span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{1,2}-[0-9]{1,2}-[12][0-9]{3}$"</span>)</span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(mdy_mask)) res[mdy_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">mdy</span>(x[mdy_mask]))</span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># YYYYMMDD</span></span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>  yfirst8_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^(19|20)</span><span class="sc">\\</span><span class="st">d{6}$"</span>)</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(yfirst8_mask)) res[yfirst8_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(x[yfirst8_mask]))</span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># DDMMAAAA</span></span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a>  dmy8_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{8}$"</span>) <span class="sc">&amp;</span> <span class="sc">!</span>yfirst8_mask</span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(dmy8_mask)) res[dmy8_mask] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">dmy</span>(x[dmy8_mask]))</span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fechas Excel</span></span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a>  excel_mask <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(x, <span class="st">"^[0-9]{5,6}$"</span>)</span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(excel_mask)) {</span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">which</span>(excel_mask)</span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a>    num <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(x[idx]))</span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(num) <span class="sc">&amp;</span> num <span class="sc">&gt;</span> <span class="dv">20000</span> <span class="sc">&amp;</span> num <span class="sc">&lt;</span> <span class="dv">60000</span></span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(ok)) res[idx[ok]] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(num[ok], <span class="at">origin =</span> <span class="st">"1899-12-30"</span>)</span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Último recurso</span></span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a>  fallback_mask <span class="ot">&lt;-</span> <span class="fu">is.na</span>(res) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x)</span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(fallback_mask)) {</span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(</span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a>      x[fallback_mask],</span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a>      <span class="at">orders =</span> <span class="fu">c</span>(<span class="st">"Ymd"</span>,<span class="st">"Y-m-d"</span>,<span class="st">"dmY"</span>,<span class="st">"d-m-Y"</span>,<span class="st">"mdY"</span>,<span class="st">"m-d-Y"</span>,<span class="st">"Ymd HMS"</span>,<span class="st">"dmY HMS"</span>,<span class="st">"mdY HMS"</span>)</span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a>    res[fallback_mask] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(tmp)</span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb28-309"><a href="#cb28-309" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-310"><a href="#cb28-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta columnas de fecha por nombre</span></span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a>normalize_name <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a>  n <span class="sc">%&gt;%</span> </span>
<span id="cb28-314"><a href="#cb28-314" aria-hidden="true" tabindex="-1"></a>    stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(<span class="st">"Latin-ASCII"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-315"><a href="#cb28-315" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tolower</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">"[^a-z0-9]+"</span>, <span class="st">""</span>)</span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a>is_date_like <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb28-320"><a href="#cb28-320" aria-hidden="true" tabindex="-1"></a>  n_norm <span class="ot">&lt;-</span> <span class="fu">normalize_name</span>(n)</span>
<span id="cb28-321"><a href="#cb28-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(</span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a>    n_norm,</span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"^fecha"</span>,<span class="st">"fechanacimiento"</span>,<span class="st">"fechadeingreso"</span>,<span class="st">"fechaingreso"</span>,</span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fechaegreso"</span>,<span class="st">"fechaalta"</span>,<span class="st">"fecharegistro"</span>,<span class="st">"fechaconsulta"</span>,</span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fechacita"</span>,<span class="st">"fechadiagnostico"</span>)</span>
<span id="cb28-326"><a href="#cb28-326" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-327"><a href="#cb28-327" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Lector robusto de archivos</span></span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a>read_top_file <span class="ot">&lt;-</span> <span class="cf">function</span>(filename) {</span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(base_path, filename)</span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb28-335"><a href="#cb28-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(</span>
<span id="cb28-336"><a href="#cb28-336" aria-hidden="true" tabindex="-1"></a>      data.table<span class="sc">::</span><span class="fu">fread</span>(</span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a>        file_path,</span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">";"</span>,</span>
<span id="cb28-339"><a href="#cb28-339" aria-hidden="true" tabindex="-1"></a>        <span class="at">encoding =</span> <span class="st">"Latin-1"</span>,</span>
<span id="cb28-340"><a href="#cb28-340" aria-hidden="true" tabindex="-1"></a>        <span class="at">na.strings =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">"NULL"</span>),</span>
<span id="cb28-341"><a href="#cb28-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">showProgress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-342"><a href="#cb28-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">colClasses =</span> <span class="st">"character"</span></span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-348"><a href="#cb28-348" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(dt)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-349"><a href="#cb28-349" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setDT</span>(dt)</span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(dt)) dt[, HASHKEY <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(HASHKEY)]</span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(dt, <span class="fu">clean_colnames</span>(<span class="fu">names</span>(dt)))</span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a>  dt[, year <span class="sc">:</span><span class="er">=</span> <span class="fu">extract_year</span>(filename)]</span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a>  dt[, source_file <span class="sc">:</span><span class="er">=</span> filename]</span>
<span id="cb28-355"><a href="#cb28-355" aria-hidden="true" tabindex="-1"></a>  dt[]</span>
<span id="cb28-356"><a href="#cb28-356" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-357"><a href="#cb28-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a><span class="co"># Renombrado dinámico de columnas de dosis</span></span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a>rename_dosis_cols <span class="ot">&lt;-</span> <span class="cf">function</span>(dt) {</span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> <span class="fu">names</span>(dt)</span>
<span id="cb28-361"><a href="#cb28-361" aria-hidden="true" tabindex="-1"></a>  dose_mask <span class="ot">&lt;-</span> <span class="fu">startsWith</span>(nms, <span class="st">"d_af_a_sis_"</span>)</span>
<span id="cb28-362"><a href="#cb28-362" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(dose_mask)) <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb28-363"><a href="#cb28-363" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-364"><a href="#cb28-364" aria-hidden="true" tabindex="-1"></a>  sufijos <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^d_af_a_sis_"</span>, <span class="st">""</span>, nms[dose_mask])</span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a>  sub_map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oh"</span> <span class="ot">=</span> <span class="st">"alcohol"</span>,</span>
<span id="cb28-367"><a href="#cb28-367" aria-hidden="true" tabindex="-1"></a>    <span class="st">"thc"</span> <span class="ot">=</span> <span class="st">"cannabis"</span>,</span>
<span id="cb28-368"><a href="#cb28-368" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pbc"</span> <span class="ot">=</span> <span class="st">"pasta_base"</span>,</span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a>    <span class="st">"coc"</span> <span class="ot">=</span> <span class="st">"cocaina"</span>,</span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bzd"</span> <span class="ot">=</span> <span class="st">"benzodiacepinas"</span>,</span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a>    <span class="st">"otra"</span> <span class="ot">=</span> <span class="st">"otra_sustancia"</span></span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-373"><a href="#cb28-373" aria-hidden="true" tabindex="-1"></a>  suf_ok <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sufijos <span class="sc">%in%</span> <span class="fu">names</span>(sub_map), sub_map[sufijos], sufijos)</span>
<span id="cb28-374"><a href="#cb28-374" aria-hidden="true" tabindex="-1"></a>  nuevos <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"dosis_"</span>, suf_ok)</span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(dt, nms[dose_mask], nuevos)</span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-379"><a href="#cb28-379" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================</span></span>
<span id="cb28-380"><a href="#cb28-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Funciones de limpieza de texto</span></span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================</span></span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: forzar a character cuando venga factor</span></span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a>.as_char <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-385"><a href="#cb28-385" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb28-386"><a href="#cb28-386" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(x))    <span class="fu">return</span>(<span class="fu">as.character</span>(x))</span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta "mojibake" típico</span></span>
<span id="cb28-391"><a href="#cb28-391" aria-hidden="true" tabindex="-1"></a>.has_mojibake <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-392"><a href="#cb28-392" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"(Ã|Â|â|�)"</span>, x), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a><span class="co"># Normaliza texto: espacios invisibles, comillas/guiones, trim</span></span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a>normalize_text <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb28-400"><a href="#cb28-400" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u00A0"</span>, <span class="st">" "</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)                 <span class="co"># NBSP</span></span>
<span id="cb28-401"><a href="#cb28-401" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u200B\u200C\u200D\uFEFF]"</span>, <span class="st">""</span>, x)            <span class="co"># zero-width</span></span>
<span id="cb28-402"><a href="#cb28-402" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u201C\u201D]"</span>, <span class="st">"</span><span class="sc">\"</span><span class="st">"</span>, x)                      <span class="co"># " "</span></span>
<span id="cb28-403"><a href="#cb28-403" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u2019"</span>, <span class="st">"'"</span>, x)                               <span class="co"># '</span></span>
<span id="cb28-404"><a href="#cb28-404" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[\u2013\u2014]"</span>, <span class="st">"-"</span>, x)                       <span class="co"># – —</span></span>
<span id="cb28-405"><a href="#cb28-405" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">'""'</span>, <span class="st">'"'</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-406"><a href="#cb28-406" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" +"</span>, <span class="st">" "</span>, x)</span>
<span id="cb28-407"><a href="#cb28-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trimws</span>(x)</span>
<span id="cb28-408"><a href="#cb28-408" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-409"><a href="#cb28-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-410"><a href="#cb28-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback de reemplazos comunes de mojibake</span></span>
<span id="cb28-411"><a href="#cb28-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback de reemplazos comunes de mojibake (incluye variantes con "f"/"ƒ")</span></span>
<span id="cb28-412"><a href="#cb28-412" aria-hidden="true" tabindex="-1"></a>.fix_mojibake_pairs <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-413"><a href="#cb28-413" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb28-414"><a href="#cb28-414" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb28-415"><a href="#cb28-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-416"><a href="#cb28-416" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Variantes básicas (una sola pasada UTF-8 interpretada como latin1)</span></span>
<span id="cb28-417"><a href="#cb28-417" aria-hidden="true" tabindex="-1"></a>  basics_from <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Ã¡"</span>,<span class="st">"Ã©"</span>,<span class="st">"Ã­"</span>,<span class="st">"Ã³"</span>,<span class="st">"Ãº"</span>,<span class="st">"Ãñ"</span>,<span class="st">"ÃÑ"</span>,<span class="st">"Ãœ"</span>,<span class="st">"Ã¼"</span>,<span class="st">"Ã‰"</span>,<span class="st">"Ã“"</span>,<span class="st">"Ãš"</span>,<span class="st">"Ã"</span>,<span class="st">"Ã"</span>)</span>
<span id="cb28-418"><a href="#cb28-418" aria-hidden="true" tabindex="-1"></a>  basics_to   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"á"</span>,<span class="st">"é"</span>,<span class="st">"í"</span>,<span class="st">"ó"</span>,<span class="st">"ú"</span>,<span class="st">"ñ"</span>,<span class="st">"Ñ"</span>,<span class="st">"Ü"</span>,<span class="st">"ü"</span>,<span class="st">"É"</span>,<span class="st">"Ó"</span>,<span class="st">"Ú"</span>,<span class="st">"Á"</span>,<span class="st">"Í"</span>)</span>
<span id="cb28-419"><a href="#cb28-419" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(basics_from)) x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(basics_from[i], basics_to[i], x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-420"><a href="#cb28-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-421"><a href="#cb28-421" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Doble codificación muy común (ÃƒÂ*)</span></span>
<span id="cb28-422"><a href="#cb28-422" aria-hidden="true" tabindex="-1"></a>  dbl_from <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ÃƒÂ¡"</span>,<span class="st">"ÃƒÂ©"</span>,<span class="st">"ÃƒÂ­"</span>,<span class="st">"ÃƒÂ³"</span>,<span class="st">"ÃƒÂº"</span>,<span class="st">"ÃƒÂ±"</span>,<span class="st">"Ãƒâ€˜"</span>,<span class="st">"ÃƒÂœ"</span>,<span class="st">"ÃƒÂº"</span>,<span class="st">"ÃƒÂ"</span></span>
<span id="cb28-423"><a href="#cb28-423" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb28-424"><a href="#cb28-424" aria-hidden="true" tabindex="-1"></a>  dbl_to   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"á"</span>,<span class="st">"é"</span>,<span class="st">"í"</span>,<span class="st">"ó"</span>,<span class="st">"ú"</span>,<span class="st">"ñ"</span>,<span class="st">"Ñ"</span>,<span class="st">"Ü"</span>,<span class="st">"ú"</span>,<span class="st">"Ã"</span>) <span class="co"># "ÃƒÂ" suelto → "Ã" (luego cae en basics)</span></span>
<span id="cb28-425"><a href="#cb28-425" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(dbl_from)) x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(dbl_from[i], dbl_to[i], x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-426"><a href="#cb28-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-427"><a href="#cb28-427" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Misma doble codificación vista como "ÃfÂ*" (cuando ƒ se ve como f)</span></span>
<span id="cb28-428"><a href="#cb28-428" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Usamos regex para cubrir "f" o "ƒ"</span></span>
<span id="cb28-429"><a href="#cb28-429" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â¡"</span>, <span class="st">"á"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-430"><a href="#cb28-430" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â©"</span>, <span class="st">"é"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-431"><a href="#cb28-431" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â­"</span>, <span class="st">"í"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-432"><a href="#cb28-432" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â³"</span>, <span class="st">"ó"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-433"><a href="#cb28-433" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Âº"</span>, <span class="st">"ú"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-434"><a href="#cb28-434" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]Â±"</span>, <span class="st">"ñ"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-435"><a href="#cb28-435" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã[fƒ]â€˜"</span>, <span class="st">"Ñ"</span>, x, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-436"><a href="#cb28-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-437"><a href="#cb28-437" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otros restos comunes</span></span>
<span id="cb28-438"><a href="#cb28-438" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Âº"</span>,<span class="st">"º"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-439"><a href="#cb28-439" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Âª"</span>,<span class="st">"ª"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-440"><a href="#cb28-440" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚Â°"</span>,<span class="st">"°"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-441"><a href="#cb28-441" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã‚"</span>,<span class="st">""</span>,  x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)     <span class="co"># Â sobrante</span></span>
<span id="cb28-442"><a href="#cb28-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-443"><a href="#cb28-443" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Comillas/guiones mojibake de cp1252 → UTF-8 mal decodificado</span></span>
<span id="cb28-444"><a href="#cb28-444" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â€œ"</span>, <span class="st">"–"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-445"><a href="#cb28-445" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â€"</span>, <span class="st">"—"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-446"><a href="#cb28-446" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Ëœ"</span>, <span class="st">"‘"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-447"><a href="#cb28-447" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬â„¢"</span>, <span class="st">"’"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-448"><a href="#cb28-448" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Å“"</span>, <span class="st">"“"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-449"><a href="#cb28-449" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"Ã¢â‚¬Â"</span>, <span class="st">"”"</span>, x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-450"><a href="#cb28-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-451"><a href="#cb28-451" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb28-452"><a href="#cb28-452" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-453"><a href="#cb28-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-454"><a href="#cb28-454" aria-hidden="true" tabindex="-1"></a><span class="co"># Reparador principal de mojibake</span></span>
<span id="cb28-455"><a href="#cb28-455" aria-hidden="true" tabindex="-1"></a>.repair_mojibake_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-456"><a href="#cb28-456" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">.as_char</span>(x)</span>
<span id="cb28-457"><a href="#cb28-457" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(x)</span>
<span id="cb28-458"><a href="#cb28-458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-459"><a href="#cb28-459" aria-hidden="true" tabindex="-1"></a>  safe_iconv <span class="ot">&lt;-</span> <span class="cf">function</span>(z, from, to) {</span>
<span id="cb28-460"><a href="#cb28-460" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(<span class="fu">iconv</span>(z, <span class="at">from =</span> from, <span class="at">to =</span> to, <span class="at">sub =</span> <span class="cn">NA</span>))</span>
<span id="cb28-461"><a href="#cb28-461" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-462"><a href="#cb28-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-463"><a href="#cb28-463" aria-hidden="true" tabindex="-1"></a>  cand <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb28-464"><a href="#cb28-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">raw            =</span> x,</span>
<span id="cb28-465"><a href="#cb28-465" aria-hidden="true" tabindex="-1"></a>    <span class="at">enc2utf8       =</span> <span class="fu">enc2utf8</span>(x),</span>
<span id="cb28-466"><a href="#cb28-466" aria-hidden="true" tabindex="-1"></a>    <span class="at">latin1_to_utf8 =</span> <span class="fu">safe_iconv</span>(x, <span class="st">"latin1"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb28-467"><a href="#cb28-467" aria-hidden="true" tabindex="-1"></a>    <span class="at">cp1252_to_utf8 =</span> <span class="fu">safe_iconv</span>(x, <span class="st">"CP1252"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb28-468"><a href="#cb28-468" aria-hidden="true" tabindex="-1"></a>    <span class="at">rt_latin1      =</span> <span class="fu">safe_iconv</span>(<span class="fu">safe_iconv</span>(x, <span class="st">"UTF-8"</span>, <span class="st">"latin1"</span>),  <span class="st">"latin1"</span>,  <span class="st">"UTF-8"</span>),</span>
<span id="cb28-469"><a href="#cb28-469" aria-hidden="true" tabindex="-1"></a>    <span class="at">rt_cp1252      =</span> <span class="fu">safe_iconv</span>(<span class="fu">safe_iconv</span>(x, <span class="st">"UTF-8"</span>, <span class="st">"CP1252"</span>),  <span class="st">"CP1252"</span>,  <span class="st">"UTF-8"</span>)</span>
<span id="cb28-470"><a href="#cb28-470" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-471"><a href="#cb28-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-472"><a href="#cb28-472" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Elige el candidato con menos rastros</span></span>
<span id="cb28-473"><a href="#cb28-473" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="cf">function</span>(v) {</span>
<span id="cb28-474"><a href="#cb28-474" aria-hidden="true" tabindex="-1"></a>    v2 <span class="ot">&lt;-</span> v</span>
<span id="cb28-475"><a href="#cb28-475" aria-hidden="true" tabindex="-1"></a>    v2[<span class="fu">is.na</span>(v2)] <span class="ot">&lt;-</span> x[<span class="fu">is.na</span>(v2)]</span>
<span id="cb28-476"><a href="#cb28-476" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">grepl</span>(<span class="st">"Ã|Â|â|�"</span>, v2))</span>
<span id="cb28-477"><a href="#cb28-477" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-478"><a href="#cb28-478" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> <span class="fu">sapply</span>(cand, score)</span>
<span id="cb28-479"><a href="#cb28-479" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> cand[[<span class="fu">names</span>(<span class="fu">which.min</span>(scores))[<span class="dv">1</span>]]]</span>
<span id="cb28-480"><a href="#cb28-480" aria-hidden="true" tabindex="-1"></a>  out[<span class="fu">is.na</span>(out)] <span class="ot">&lt;-</span> x[<span class="fu">is.na</span>(out)]</span>
<span id="cb28-481"><a href="#cb28-481" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\uFEFF"</span>, <span class="st">""</span>, out, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb28-482"><a href="#cb28-482" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"\u00A0"</span>, <span class="st">" "</span>, out, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb28-483"><a href="#cb28-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-484"><a href="#cb28-484" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aplica fallback explícito</span></span>
<span id="cb28-485"><a href="#cb28-485" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">.fix_mojibake_pairs</span>(out)</span>
<span id="cb28-486"><a href="#cb28-486" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">.fix_mojibake_pairs</span>(out)  <span class="co"># Segunda pasada</span></span>
<span id="cb28-487"><a href="#cb28-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-488"><a href="#cb28-488" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb28-489"><a href="#cb28-489" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-490"><a href="#cb28-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-491"><a href="#cb28-491" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecta si columna es mayormente numérica</span></span>
<span id="cb28-492"><a href="#cb28-492" aria-hidden="true" tabindex="-1"></a>is_mostly_numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">threshold =</span> <span class="fl">0.90</span>) {</span>
<span id="cb28-493"><a href="#cb28-493" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(x)) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb28-494"><a href="#cb28-494" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(x)</span>
<span id="cb28-495"><a href="#cb28-495" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">"."</span>, y, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-496"><a href="#cb28-496" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">trimws</span>(y)</span>
<span id="cb28-497"><a href="#cb28-497" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[<span class="sc">!</span><span class="fu">is.na</span>(y) <span class="sc">&amp;</span> y <span class="sc">!=</span> <span class="st">""</span>]</span>
<span id="cb28-498"><a href="#cb28-498" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(y)) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb28-499"><a href="#cb28-499" aria-hidden="true" tabindex="-1"></a>  ok <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^[-+]?</span><span class="sc">\\</span><span class="st">d*(?:</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">d+)?$"</span>, y)</span>
<span id="cb28-500"><a href="#cb28-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(ok) <span class="sc">&gt;=</span> threshold</span>
<span id="cb28-501"><a href="#cb28-501" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-502"><a href="#cb28-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-503"><a href="#cb28-503" aria-hidden="true" tabindex="-1"></a><span class="co"># Conversión segura a numérico</span></span>
<span id="cb28-504"><a href="#cb28-504" aria-hidden="true" tabindex="-1"></a>to_numeric_safely <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-505"><a href="#cb28-505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(x))</span>
<span id="cb28-506"><a href="#cb28-506" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(x)</span>
<span id="cb28-507"><a href="#cb28-507" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">"."</span>, y, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-508"><a href="#cb28-508" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"NaN"</span>, <span class="st">"null"</span>, <span class="st">"NULL"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb28-509"><a href="#cb28-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(y))</span>
<span id="cb28-510"><a href="#cb28-510" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-511"><a href="#cb28-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-512"><a href="#cb28-512" aria-hidden="true" tabindex="-1"></a><span class="co"># Función principal de casteo</span></span>
<span id="cb28-513"><a href="#cb28-513" aria-hidden="true" tabindex="-1"></a>clean_cast_dataset <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">id_cols =</span> <span class="st">"HASHKEY"</span>, <span class="at">numeric_threshold =</span> <span class="fl">0.90</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb28-514"><a href="#cb28-514" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(df)) <span class="fu">stop</span>(<span class="st">"df debe ser un data.frame/tibble."</span>)</span>
<span id="cb28-515"><a href="#cb28-515" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> df</span>
<span id="cb28-516"><a href="#cb28-516" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-517"><a href="#cb28-517" aria-hidden="true" tabindex="-1"></a>  id_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(id_cols, <span class="fu">names</span>(out))</span>
<span id="cb28-518"><a href="#cb28-518" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-519"><a href="#cb28-519" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Limpiar columnas character excepto IDs</span></span>
<span id="cb28-520"><a href="#cb28-520" aria-hidden="true" tabindex="-1"></a>  char_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(out)[<span class="fu">vapply</span>(out, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb28-521"><a href="#cb28-521" aria-hidden="true" tabindex="-1"></a>  char_cols_to_clean <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(char_cols, id_cols)</span>
<span id="cb28-522"><a href="#cb28-522" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-523"><a href="#cb28-523" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(char_cols_to_clean)) {</span>
<span id="cb28-524"><a href="#cb28-524" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (nm <span class="cf">in</span> char_cols_to_clean) {</span>
<span id="cb28-525"><a href="#cb28-525" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">normalize_text</span>(<span class="fu">.repair_mojibake_vec</span>(out[[nm]]))</span>
<span id="cb28-526"><a href="#cb28-526" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-527"><a href="#cb28-527" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-528"><a href="#cb28-528" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-529"><a href="#cb28-529" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Castear a numeric si corresponde</span></span>
<span id="cb28-530"><a href="#cb28-530" aria-hidden="true" tabindex="-1"></a>  converted_to_numeric <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb28-531"><a href="#cb28-531" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(out), id_cols)) {</span>
<span id="cb28-532"><a href="#cb28-532" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(out[[nm]]) <span class="sc">&amp;&amp;</span> <span class="fu">is_mostly_numeric</span>(out[[nm]], numeric_threshold)) {</span>
<span id="cb28-533"><a href="#cb28-533" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">to_numeric_safely</span>(out[[nm]])</span>
<span id="cb28-534"><a href="#cb28-534" aria-hidden="true" tabindex="-1"></a>      converted_to_numeric <span class="ot">&lt;-</span> <span class="fu">c</span>(converted_to_numeric, nm)</span>
<span id="cb28-535"><a href="#cb28-535" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-536"><a href="#cb28-536" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-537"><a href="#cb28-537" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-538"><a href="#cb28-538" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Castear resto a factor</span></span>
<span id="cb28-539"><a href="#cb28-539" aria-hidden="true" tabindex="-1"></a>  converted_to_factor <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb28-540"><a href="#cb28-540" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(out), id_cols)) {</span>
<span id="cb28-541"><a href="#cb28-541" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(out[[nm]])) {</span>
<span id="cb28-542"><a href="#cb28-542" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">normalize_text</span>(out[[nm]]))</span>
<span id="cb28-543"><a href="#cb28-543" aria-hidden="true" tabindex="-1"></a>      converted_to_factor <span class="ot">&lt;-</span> <span class="fu">c</span>(converted_to_factor, nm)</span>
<span id="cb28-544"><a href="#cb28-544" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-545"><a href="#cb28-545" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-546"><a href="#cb28-546" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-547"><a href="#cb28-547" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mantener IDs como character</span></span>
<span id="cb28-548"><a href="#cb28-548" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> id_cols) {</span>
<span id="cb28-549"><a href="#cb28-549" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(out[[nm]])) {</span>
<span id="cb28-550"><a href="#cb28-550" aria-hidden="true" tabindex="-1"></a>      out[[nm]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(df[[nm]])</span>
<span id="cb28-551"><a href="#cb28-551" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-552"><a href="#cb28-552" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-553"><a href="#cb28-553" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-554"><a href="#cb28-554" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb28-555"><a href="#cb28-555" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-556"><a href="#cb28-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-557"><a href="#cb28-557" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================</span></span>
<span id="cb28-558"><a href="#cb28-558" aria-hidden="true" tabindex="-1"></a><span class="co"># Funciones de recodificación</span></span>
<span id="cb28-559"><a href="#cb28-559" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================</span></span>
<span id="cb28-560"><a href="#cb28-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-561"><a href="#cb28-561" aria-hidden="true" tabindex="-1"></a>.squish <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-562"><a href="#cb28-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>, <span class="st">" "</span>, <span class="fu">trimws</span>(<span class="fu">.as_char</span>(x)))</span>
<span id="cb28-563"><a href="#cb28-563" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-564"><a href="#cb28-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-565"><a href="#cb28-565" aria-hidden="true" tabindex="-1"></a>.recode_si_no <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">yes_label =</span> <span class="st">"Sí"</span>, <span class="at">no_label =</span> <span class="st">"No"</span>) {</span>
<span id="cb28-566"><a href="#cb28-566" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb28-567"><a href="#cb28-567" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb28-568"><a href="#cb28-568" aria-hidden="true" tabindex="-1"></a>  yu <span class="ot">&lt;-</span> <span class="fu">toupper</span>(y)</span>
<span id="cb28-569"><a href="#cb28-569" aria-hidden="true" tabindex="-1"></a>  is_yes <span class="ot">&lt;-</span> yu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"SI"</span>,<span class="st">"SÍ"</span>,<span class="st">"SÍ"</span>)</span>
<span id="cb28-570"><a href="#cb28-570" aria-hidden="true" tabindex="-1"></a>  is_no  <span class="ot">&lt;-</span> yu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"N"</span>,<span class="st">"NO"</span>)</span>
<span id="cb28-571"><a href="#cb28-571" aria-hidden="true" tabindex="-1"></a>  y[is_yes] <span class="ot">&lt;-</span> yes_label</span>
<span id="cb28-572"><a href="#cb28-572" aria-hidden="true" tabindex="-1"></a>  y[is_no]  <span class="ot">&lt;-</span> no_label</span>
<span id="cb28-573"><a href="#cb28-573" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb28-574"><a href="#cb28-574" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-575"><a href="#cb28-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-576"><a href="#cb28-576" aria-hidden="true" tabindex="-1"></a><span class="co"># Unifica categorías de sustancias</span></span>
<span id="cb28-577"><a href="#cb28-577" aria-hidden="true" tabindex="-1"></a>.recode_sustancia <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-578"><a href="#cb28-578" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb28-579"><a href="#cb28-579" aria-hidden="true" tabindex="-1"></a>  y  <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb28-580"><a href="#cb28-580" aria-hidden="true" tabindex="-1"></a>  lx <span class="ot">&lt;-</span> <span class="fu">tolower</span>(y)</span>
<span id="cb28-581"><a href="#cb28-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-582"><a href="#cb28-582" aria-hidden="true" tabindex="-1"></a>  canon <span class="ot">&lt;-</span> y</span>
<span id="cb28-583"><a href="#cb28-583" aria-hidden="true" tabindex="-1"></a>  set <span class="ot">&lt;-</span> <span class="cf">function</span>(idx, val) { canon[idx] <span class="ot">&lt;&lt;-</span> val }</span>
<span id="cb28-584"><a href="#cb28-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-585"><a href="#cb28-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^inhalables"</span>,                         lx), <span class="st">"Inhalables"</span>)</span>
<span id="cb28-586"><a href="#cb28-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sedantes"</span>,                           lx), <span class="st">"Sedantes"</span>)</span>
<span id="cb28-587"><a href="#cb28-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hipn[oó]ticos"</span>,                      lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Hipnóticos"</span>)</span>
<span id="cb28-588"><a href="#cb28-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"otros</span><span class="sc">\\</span><span class="st">s+opioides</span><span class="sc">\\</span><span class="st">s+analg"</span>,         lx), <span class="st">"Otros Opioides Analgésicos"</span>)</span>
<span id="cb28-589"><a href="#cb28-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros</span><span class="sc">\\</span><span class="st">s+alucin[oó]genos"</span>,          lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Otros Alucinógenos"</span>)</span>
<span id="cb28-590"><a href="#cb28-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros</span><span class="sc">\\</span><span class="st">s+estimulantes"</span>,             lx), <span class="st">"Otros Estimulantes"</span>)</span>
<span id="cb28-591"><a href="#cb28-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^pasta</span><span class="sc">\\</span><span class="st">s+base"</span>,                     lx), <span class="st">"Pasta Base"</span>)</span>
<span id="cb28-592"><a href="#cb28-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^coca[ií]na"</span>,                        lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Cocaína"</span>)</span>
<span id="cb28-593"><a href="#cb28-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^(?:e|é)xtasis"</span>,                     lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Éxtasis"</span>)</span>
<span id="cb28-594"><a href="#cb28-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hero[ií]na"</span>,                        lx, <span class="at">perl=</span><span class="cn">TRUE</span>), <span class="st">"Heroína"</span>)</span>
<span id="cb28-595"><a href="#cb28-595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^marihuana"</span>,                         lx), <span class="st">"Marihuana"</span>)</span>
<span id="cb28-596"><a href="#cb28-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^metanfetaminas?"</span>,                   lx), <span class="st">"Metanfetaminas y otros derivados"</span>)</span>
<span id="cb28-597"><a href="#cb28-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^anfetaminas?"</span>,                      lx), <span class="st">"Anfetaminas"</span>)</span>
<span id="cb28-598"><a href="#cb28-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^metadona"</span>,                          lx), <span class="st">"Metadona"</span>)</span>
<span id="cb28-599"><a href="#cb28-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^hongos$"</span>,                           lx), <span class="st">"Hongos"</span>)</span>
<span id="cb28-600"><a href="#cb28-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^lsd$"</span>,                              lx), <span class="st">"LSD"</span>)</span>
<span id="cb28-601"><a href="#cb28-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^crack$"</span>,                            lx), <span class="st">"Crack"</span>)</span>
<span id="cb28-602"><a href="#cb28-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^alcohol$"</span>,                          lx), <span class="st">"Alcohol"</span>)</span>
<span id="cb28-603"><a href="#cb28-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^tranquilizantes"</span>,                   lx), <span class="st">"Tranquilizantes"</span>)</span>
<span id="cb28-604"><a href="#cb28-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^fenilciclidina"</span>,                    lx), <span class="st">"Fenilciclidina"</span>)</span>
<span id="cb28-605"><a href="#cb28-605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+consumo$"</span>,                   lx), <span class="st">"Sin consumo"</span>)</span>
<span id="cb28-606"><a href="#cb28-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+especificar$"</span>,              lx), <span class="st">"Sin especificar"</span>)</span>
<span id="cb28-607"><a href="#cb28-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^sin</span><span class="sc">\\</span><span class="st">s+sustancia</span><span class="sc">\\</span><span class="st">s+principal"</span>,     lx), <span class="st">"Sin sustancia principal"</span>)</span>
<span id="cb28-608"><a href="#cb28-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set</span>(<span class="fu">grepl</span>(<span class="st">"^otros$"</span>,                            lx), <span class="st">"Otros"</span>)</span>
<span id="cb28-609"><a href="#cb28-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-610"><a href="#cb28-610" aria-hidden="true" tabindex="-1"></a>  canon</span>
<span id="cb28-611"><a href="#cb28-611" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-612"><a href="#cb28-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-613"><a href="#cb28-613" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajustes puntuales</span></span>
<span id="cb28-614"><a href="#cb28-614" aria-hidden="true" tabindex="-1"></a>.recode_tipo_centro <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-615"><a href="#cb28-615" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb28-616"><a href="#cb28-616" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(<span class="fu">tolower</span>(y))</span>
<span id="cb28-617"><a href="#cb28-617" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">==</span> <span class="st">"publico"</span>] <span class="ot">&lt;-</span> <span class="st">"Público"</span></span>
<span id="cb28-618"><a href="#cb28-618" aria-hidden="true" tabindex="-1"></a>  y[y <span class="sc">==</span> <span class="st">"privado"</span>] <span class="ot">&lt;-</span> <span class="st">"Privado"</span></span>
<span id="cb28-619"><a href="#cb28-619" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb28-620"><a href="#cb28-620" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-621"><a href="#cb28-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-622"><a href="#cb28-622" aria-hidden="true" tabindex="-1"></a>.recode_motivo_egreso <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-623"><a href="#cb28-623" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb28-624"><a href="#cb28-624" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb28-625"><a href="#cb28-625" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"Admnistrativa"</span>, <span class="st">"Administrativa"</span>, y, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-626"><a href="#cb28-626" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb28-627"><a href="#cb28-627" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-628"><a href="#cb28-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-629"><a href="#cb28-629" aria-hidden="true" tabindex="-1"></a>.recode_eval_proceso <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb28-630"><a href="#cb28-630" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.repair_mojibake_vec</span>(x)</span>
<span id="cb28-631"><a href="#cb28-631" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">.squish</span>(y)</span>
<span id="cb28-632"><a href="#cb28-632" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(?i)minimo"</span>, <span class="st">"Mínimo"</span>, y, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-633"><a href="#cb28-633" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb28-634"><a href="#cb28-634" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-635"><a href="#cb28-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-636"><a href="#cb28-636" aria-hidden="true" tabindex="-1"></a><span class="co"># Función principal de recodificación</span></span>
<span id="cb28-637"><a href="#cb28-637" aria-hidden="true" tabindex="-1"></a>limpiar_caracteres_y_recodificar <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb28-638"><a href="#cb28-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.data.frame</span>(df))</span>
<span id="cb28-639"><a href="#cb28-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-640"><a href="#cb28-640" aria-hidden="true" tabindex="-1"></a>  is_chr <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb28-641"><a href="#cb28-641" aria-hidden="true" tabindex="-1"></a>  is_fac <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df, is.factor, <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb28-642"><a href="#cb28-642" aria-hidden="true" tabindex="-1"></a>  cols_cf <span class="ot">&lt;-</span> <span class="fu">names</span>(df)[is_chr <span class="sc">|</span> is_fac]</span>
<span id="cb28-643"><a href="#cb28-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-644"><a href="#cb28-644" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reparar encoding + espacios</span></span>
<span id="cb28-645"><a href="#cb28-645" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> cols_cf) {</span>
<span id="cb28-646"><a href="#cb28-646" aria-hidden="true" tabindex="-1"></a>    was_factor <span class="ot">&lt;-</span> <span class="fu">is.factor</span>(df[[nm]])</span>
<span id="cb28-647"><a href="#cb28-647" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">.squish</span>(<span class="fu">.repair_mojibake_vec</span>(df[[nm]]))</span>
<span id="cb28-648"><a href="#cb28-648" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="cf">if</span> (was_factor) <span class="fu">factor</span>(tmp) <span class="cf">else</span> tmp</span>
<span id="cb28-649"><a href="#cb28-649" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-650"><a href="#cb28-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-651"><a href="#cb28-651" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detectar y recodificar S/N</span></span>
<span id="cb28-652"><a href="#cb28-652" aria-hidden="true" tabindex="-1"></a>  sn_cols <span class="ot">&lt;-</span> cols_cf[<span class="fu">sapply</span>(cols_cf, <span class="cf">function</span>(nm) {</span>
<span id="cb28-653"><a href="#cb28-653" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">toupper</span>(<span class="fu">trimws</span>(<span class="fu">.as_char</span>(df[[nm]]))))</span>
<span id="cb28-654"><a href="#cb28-654" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> u[<span class="sc">!</span><span class="fu">is.na</span>(u)]</span>
<span id="cb28-655"><a href="#cb28-655" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(u) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(u <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"N"</span>,<span class="st">"SI"</span>,<span class="st">"SÍ"</span>,<span class="st">"SÍ"</span>,<span class="st">"NO"</span>))</span>
<span id="cb28-656"><a href="#cb28-656" aria-hidden="true" tabindex="-1"></a>  })]</span>
<span id="cb28-657"><a href="#cb28-657" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-658"><a href="#cb28-658" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> sn_cols) {</span>
<span id="cb28-659"><a href="#cb28-659" aria-hidden="true" tabindex="-1"></a>    lab <span class="ot">&lt;-</span> <span class="fu">.recode_si_no</span>(df[[nm]])</span>
<span id="cb28-660"><a href="#cb28-660" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(lab, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"No"</span>,<span class="st">"Sí"</span>))</span>
<span id="cb28-661"><a href="#cb28-661" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-662"><a href="#cb28-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-663"><a href="#cb28-663" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unificar sustancias</span></span>
<span id="cb28-664"><a href="#cb28-664" aria-hidden="true" tabindex="-1"></a>  sust_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(</span>
<span id="cb28-665"><a href="#cb28-665" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal_1"</span>,<span class="st">"sustancia_principal_2"</span>,<span class="st">"sustancia_principal_3"</span>,</span>
<span id="cb28-666"><a href="#cb28-666" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal1"</span>,<span class="st">"sustancia_principal2"</span>,<span class="st">"sustancia_principal3"</span></span>
<span id="cb28-667"><a href="#cb28-667" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-668"><a href="#cb28-668" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-669"><a href="#cb28-669" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> sust_cols) {</span>
<span id="cb28-670"><a href="#cb28-670" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">.recode_sustancia</span>(df[[nm]])</span>
<span id="cb28-671"><a href="#cb28-671" aria-hidden="true" tabindex="-1"></a>    df[[nm]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(tmp)</span>
<span id="cb28-672"><a href="#cb28-672" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-673"><a href="#cb28-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-674"><a href="#cb28-674" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ajustes puntuales</span></span>
<span id="cb28-675"><a href="#cb28-675" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"tipo_centro"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb28-676"><a href="#cb28-676" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>tipo_centro <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_tipo_centro</span>(df<span class="sc">$</span>tipo_centro))</span>
<span id="cb28-677"><a href="#cb28-677" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-678"><a href="#cb28-678" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"motivo_egreso"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb28-679"><a href="#cb28-679" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>motivo_egreso <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_motivo_egreso</span>(df<span class="sc">$</span>motivo_egreso))</span>
<span id="cb28-680"><a href="#cb28-680" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-681"><a href="#cb28-681" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"evaluacion_proceso_terapeutico"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb28-682"><a href="#cb28-682" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>evaluacion_proceso_terapeutico <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">.recode_eval_proceso</span>(df<span class="sc">$</span>evaluacion_proceso_terapeutico))</span>
<span id="cb28-683"><a href="#cb28-683" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-684"><a href="#cb28-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-685"><a href="#cb28-685" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb28-686"><a href="#cb28-686" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-687"><a href="#cb28-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-688"><a href="#cb28-688" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Pipeline principal ==================================================</span></span>
<span id="cb28-689"><a href="#cb28-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-690"><a href="#cb28-690" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar si existe el archivo RDS final</span></span>
<span id="cb28-691"><a href="#cb28-691" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(output_rds)) {</span>
<span id="cb28-692"><a href="#cb28-692" aria-hidden="true" tabindex="-1"></a>  datos_final <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(output_rds)</span>
<span id="cb28-693"><a href="#cb28-693" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-694"><a href="#cb28-694" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-695"><a href="#cb28-695" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span><span class="al">TODO</span><span class="co"> EL PROCESAMIENTO OCURRE AQUÍ SI NO EXISTE EL ARCHIVO FINAL</span></span>
<span id="cb28-696"><a href="#cb28-696" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-697"><a href="#cb28-697" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Primera etapa: verificar caché intermedio</span></span>
<span id="cb28-698"><a href="#cb28-698" aria-hidden="true" tabindex="-1"></a>  output_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(root, <span class="st">"data"</span>, <span class="st">"TOP_CLEAN_2015_2022.rds"</span>)</span>
<span id="cb28-699"><a href="#cb28-699" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-700"><a href="#cb28-700" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(output_path)) {</span>
<span id="cb28-701"><a href="#cb28-701" aria-hidden="true" tabindex="-1"></a>    datos_completos <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(output_path)</span>
<span id="cb28-702"><a href="#cb28-702" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb28-703"><a href="#cb28-703" aria-hidden="true" tabindex="-1"></a>    lista <span class="ot">&lt;-</span> <span class="fu">lapply</span>(archivos, read_top_file)</span>
<span id="cb28-704"><a href="#cb28-704" aria-hidden="true" tabindex="-1"></a>    lista <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="fu">Negate</span>(is.null), lista)</span>
<span id="cb28-705"><a href="#cb28-705" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(lista) <span class="sc">==</span> <span class="dv">0</span>L) <span class="fu">stop</span>(<span class="st">"No se encontró ningún archivo en: "</span>, base_path)</span>
<span id="cb28-706"><a href="#cb28-706" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-707"><a href="#cb28-707" aria-hidden="true" tabindex="-1"></a>    datos_completos <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">rbindlist</span>(lista, <span class="at">fill =</span> <span class="cn">TRUE</span>, <span class="at">use.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-708"><a href="#cb28-708" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-709"><a href="#cb28-709" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Repara mojibake en TODAS las columnas de texto (excepto hashkey)</span></span>
<span id="cb28-710"><a href="#cb28-710" aria-hidden="true" tabindex="-1"></a>    char_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_completos)[<span class="fu">vapply</span>(datos_completos, is.character, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb28-711"><a href="#cb28-711" aria-hidden="true" tabindex="-1"></a>    char_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(char_cols, <span class="st">"hashkey"</span>)</span>
<span id="cb28-712"><a href="#cb28-712" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(char_cols)) {</span>
<span id="cb28-713"><a href="#cb28-713" aria-hidden="true" tabindex="-1"></a>      datos_completos[, (char_cols) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, fix_mojibake), .SDcols <span class="ot">=</span> char_cols]</span>
<span id="cb28-714"><a href="#cb28-714" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-715"><a href="#cb28-715" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-716"><a href="#cb28-716" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Candidatas por nombre y parseo de fechas</span></span>
<span id="cb28-717"><a href="#cb28-717" aria-hidden="true" tabindex="-1"></a>    posibles_fechas <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_completos)[<span class="fu">vapply</span>(<span class="fu">names</span>(datos_completos), is_date_like, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb28-718"><a href="#cb28-718" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> <span class="fu">intersect</span>(posibles_fechas, <span class="fu">names</span>(datos_completos))) {</span>
<span id="cb28-719"><a href="#cb28-719" aria-hidden="true" tabindex="-1"></a>      datos_completos[[col]] <span class="ot">&lt;-</span> <span class="fu">parse_mixed_dates</span>(datos_completos[[col]])</span>
<span id="cb28-720"><a href="#cb28-720" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-721"><a href="#cb28-721" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-722"><a href="#cb28-722" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Guarda cache crudo-limpio (antes de renombrados semánticos)</span></span>
<span id="cb28-723"><a href="#cb28-723" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(datos_completos, output_path)</span>
<span id="cb28-724"><a href="#cb28-724" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-725"><a href="#cb28-725" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-726"><a href="#cb28-726" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5) Renombrado semántico TOP (incluye dosis) ----------------------------</span></span>
<span id="cb28-727"><a href="#cb28-727" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-728"><a href="#cb28-728" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.1 HASHKEY mayúsculas, eliminar id</span></span>
<span id="cb28-729"><a href="#cb28-729" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"hashkey"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) {</span>
<span id="cb28-730"><a href="#cb28-730" aria-hidden="true" tabindex="-1"></a>    data.table<span class="sc">::</span><span class="fu">setnames</span>(datos_completos, <span class="st">"hashkey"</span>, <span class="st">"HASHKEY"</span>)</span>
<span id="cb28-731"><a href="#cb28-731" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="st">"hashkey"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos) <span class="sc">&amp;&amp;</span> <span class="st">"HASHKEY"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) {</span>
<span id="cb28-732"><a href="#cb28-732" aria-hidden="true" tabindex="-1"></a>    datos_completos[, HASHKEY <span class="sc">:</span><span class="er">=</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">as.character</span>(HASHKEY), <span class="fu">as.character</span>(hashkey))]</span>
<span id="cb28-733"><a href="#cb28-733" aria-hidden="true" tabindex="-1"></a>    datos_completos[, hashkey <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb28-734"><a href="#cb28-734" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-735"><a href="#cb28-735" aria-hidden="true" tabindex="-1"></a>  datos_completos[, HASHKEY <span class="sc">:</span><span class="er">=</span> <span class="fu">as.character</span>(HASHKEY)]</span>
<span id="cb28-736"><a href="#cb28-736" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"id"</span> <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)) datos_completos[, id <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb28-737"><a href="#cb28-737" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-738"><a href="#cb28-738" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.2 Mapeo estático (fechas, centros, sustancias totales, dominios sociales)</span></span>
<span id="cb28-739"><a href="#cb28-739" aria-hidden="true" tabindex="-1"></a>  rename_map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-740"><a href="#cb28-740" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fechas y cabecera TOP</span></span>
<span id="cb28-741"><a href="#cb28-741" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_aplicaci_af_a_n_top"</span>    <span class="ot">=</span> <span class="st">"fecha_aplicacion_top"</span>,</span>
<span id="cb28-742"><a href="#cb28-742" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nombre_apliacadordel_top"</span>     <span class="ot">=</span> <span class="st">"nombre_aplicador_top"</span>,</span>
<span id="cb28-743"><a href="#cb28-743" aria-hidden="true" tabindex="-1"></a>    <span class="st">"etapadel_tratamiento"</span>         <span class="ot">=</span> <span class="st">"etapa_tratamiento"</span>,</span>
<span id="cb28-744"><a href="#cb28-744" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fechade_ingresoa_tratamiento"</span> <span class="ot">=</span> <span class="st">"fecha_ingreso_tratamiento"</span>,</span>
<span id="cb28-745"><a href="#cb28-745" aria-hidden="true" tabindex="-1"></a>    <span class="st">"plande_tratamiento"</span>           <span class="ot">=</span> <span class="st">"plan_tratamiento"</span>,</span>
<span id="cb28-746"><a href="#cb28-746" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nombredel_centro"</span>             <span class="ot">=</span> <span class="st">"nombre_centro"</span>,</span>
<span id="cb28-747"><a href="#cb28-747" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tipo_centro"</span>                  <span class="ot">=</span> <span class="st">"tipo_centro"</span>,</span>
<span id="cb28-748"><a href="#cb28-748" aria-hidden="true" tabindex="-1"></a>    <span class="st">"regi_af_a_n_centro"</span>           <span class="ot">=</span> <span class="st">"region_centro"</span>,</span>
<span id="cb28-749"><a href="#cb28-749" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_nacimiento"</span>             <span class="ot">=</span> <span class="st">"fecha_nacimiento"</span>,</span>
<span id="cb28-750"><a href="#cb28-750" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fecha_egreso"</span>                 <span class="ot">=</span> <span class="st">"fecha_egreso"</span>,</span>
<span id="cb28-751"><a href="#cb28-751" aria-hidden="true" tabindex="-1"></a>    <span class="st">"motivo_egreso"</span>                <span class="ot">=</span> <span class="st">"motivo_egreso"</span>,</span>
<span id="cb28-752"><a href="#cb28-752" aria-hidden="true" tabindex="-1"></a>    <span class="st">"evaluacion_proceso_terapeutico"</span> <span class="ot">=</span> <span class="st">"evaluacion_proceso_terapeutico"</span>,</span>
<span id="cb28-753"><a href="#cb28-753" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-754"><a href="#cb28-754" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sustancias (totales)</span></span>
<span id="cb28-755"><a href="#cb28-755" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_oh"</span>    <span class="ot">=</span> <span class="st">"total_alcohol"</span>,</span>
<span id="cb28-756"><a href="#cb28-756" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_thc"</span>   <span class="ot">=</span> <span class="st">"total_cannabis"</span>,</span>
<span id="cb28-757"><a href="#cb28-757" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_pbc"</span>   <span class="ot">=</span> <span class="st">"total_pasta_base"</span>,</span>
<span id="cb28-758"><a href="#cb28-758" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_coc"</span>   <span class="ot">=</span> <span class="st">"total_cocaina"</span>,</span>
<span id="cb28-759"><a href="#cb28-759" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_bzd"</span>   <span class="ot">=</span> <span class="st">"total_benzodiacepinas"</span>,</span>
<span id="cb28-760"><a href="#cb28-760" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_otra"</span>  <span class="ot">=</span> <span class="st">"total_otra_sustancia"</span>,</span>
<span id="cb28-761"><a href="#cb28-761" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-762"><a href="#cb28-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sustancia(s) principal(es)</span></span>
<span id="cb28-763"><a href="#cb28-763" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal1"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_1"</span>,</span>
<span id="cb28-764"><a href="#cb28-764" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal2"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_2"</span>,</span>
<span id="cb28-765"><a href="#cb28-765" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sustancia_principal3"</span> <span class="ot">=</span> <span class="st">"sustancia_principal_3"</span>,</span>
<span id="cb28-766"><a href="#cb28-766" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-767"><a href="#cb28-767" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delitos / Transgresión</span></span>
<span id="cb28-768"><a href="#cb28-768" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hurto"</span>                   <span class="ot">=</span> <span class="st">"hurto"</span>,</span>
<span id="cb28-769"><a href="#cb28-769" aria-hidden="true" tabindex="-1"></a>    <span class="st">"robo"</span>                    <span class="ot">=</span> <span class="st">"robo"</span>,</span>
<span id="cb28-770"><a href="#cb28-770" aria-hidden="true" tabindex="-1"></a>    <span class="st">"venta_drogas"</span>            <span class="ot">=</span> <span class="st">"venta_de_drogas"</span>,</span>
<span id="cb28-771"><a href="#cb28-771" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ri_af_a_a"</span>               <span class="ot">=</span> <span class="st">"rina"</span>,</span>
<span id="cb28-772"><a href="#cb28-772" aria-hidden="true" tabindex="-1"></a>    <span class="st">"otro"</span>                    <span class="ot">=</span> <span class="st">"otro_delito"</span>,</span>
<span id="cb28-773"><a href="#cb28-773" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_vif"</span>               <span class="ot">=</span> <span class="st">"total_violencia_intrafamiliar"</span>,</span>
<span id="cb28-774"><a href="#cb28-774" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_transgresi_af_a_n"</span> <span class="ot">=</span> <span class="st">"total_transgresion"</span>,</span>
<span id="cb28-775"><a href="#cb28-775" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-776"><a href="#cb28-776" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Salud y funcionamiento social</span></span>
<span id="cb28-777"><a href="#cb28-777" aria-hidden="true" tabindex="-1"></a>    <span class="st">"salud_psicol_af_a_gica"</span>  <span class="ot">=</span> <span class="st">"salud_psicologica"</span>,</span>
<span id="cb28-778"><a href="#cb28-778" aria-hidden="true" tabindex="-1"></a>    <span class="st">"salud_f_af_a_sica"</span>       <span class="ot">=</span> <span class="st">"salud_fisica"</span>,</span>
<span id="cb28-779"><a href="#cb28-779" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_trabajo"</span>           <span class="ot">=</span> <span class="st">"total_trabajo"</span>,</span>
<span id="cb28-780"><a href="#cb28-780" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_educaci_af_a_n"</span>    <span class="ot">=</span> <span class="st">"total_educacion"</span>,</span>
<span id="cb28-781"><a href="#cb28-781" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-782"><a href="#cb28-782" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vivienda / Calidad de vida</span></span>
<span id="cb28-783"><a href="#cb28-783" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lugar_vivir"</span>             <span class="ot">=</span> <span class="st">"lugar_donde_vive"</span>,</span>
<span id="cb28-784"><a href="#cb28-784" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vivienda"</span>                <span class="ot">=</span> <span class="st">"tipo_vivienda"</span>,</span>
<span id="cb28-785"><a href="#cb28-785" aria-hidden="true" tabindex="-1"></a>    <span class="st">"calidad_vida"</span>            <span class="ot">=</span> <span class="st">"calidad_de_vida"</span></span>
<span id="cb28-786"><a href="#cb28-786" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-787"><a href="#cb28-787" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-788"><a href="#cb28-788" aria-hidden="true" tabindex="-1"></a>  existentes <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(rename_map), <span class="fu">names</span>(datos_completos))</span>
<span id="cb28-789"><a href="#cb28-789" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(existentes)) data.table<span class="sc">::</span><span class="fu">setnames</span>(datos_completos, existentes, <span class="fu">unname</span>(rename_map[existentes]))</span>
<span id="cb28-790"><a href="#cb28-790" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-791"><a href="#cb28-791" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.3 Renombrado dinámico de dosis (todas las d_af_a_sis_*)</span></span>
<span id="cb28-792"><a href="#cb28-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_dosis_cols</span>(datos_completos)</span>
<span id="cb28-793"><a href="#cb28-793" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-794"><a href="#cb28-794" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.4 Reordenar: HASHKEY y year primero</span></span>
<span id="cb28-795"><a href="#cb28-795" aria-hidden="true" tabindex="-1"></a>  primero <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"HASHKEY"</span>, <span class="st">"year"</span>)</span>
<span id="cb28-796"><a href="#cb28-796" aria-hidden="true" tabindex="-1"></a>  primero <span class="ot">&lt;-</span> primero[primero <span class="sc">%in%</span> <span class="fu">names</span>(datos_completos)]</span>
<span id="cb28-797"><a href="#cb28-797" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setcolorder</span>(datos_completos, <span class="fu">c</span>(primero, <span class="fu">setdiff</span>(<span class="fu">names</span>(datos_completos), primero)))</span>
<span id="cb28-798"><a href="#cb28-798" aria-hidden="true" tabindex="-1"></a>  datos_completos <span class="ot">&lt;-</span> datos_completos <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>nombre_aplicador_top, <span class="sc">-</span>source_file)</span>
<span id="cb28-799"><a href="#cb28-799" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-800"><a href="#cb28-800" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb28-801"><a href="#cb28-801" aria-hidden="true" tabindex="-1"></a>  <span class="co"># USO (fase 1: casteo)</span></span>
<span id="cb28-802"><a href="#cb28-802" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb28-803"><a href="#cb28-803" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> <span class="fu">clean_cast_dataset</span>(</span>
<span id="cb28-804"><a href="#cb28-804" aria-hidden="true" tabindex="-1"></a>    datos_completos,</span>
<span id="cb28-805"><a href="#cb28-805" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="st">"HASHKEY"</span>,</span>
<span id="cb28-806"><a href="#cb28-806" aria-hidden="true" tabindex="-1"></a>    <span class="at">numeric_threshold =</span> <span class="fl">0.90</span>,</span>
<span id="cb28-807"><a href="#cb28-807" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb28-808"><a href="#cb28-808" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-809"><a href="#cb28-809" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-810"><a href="#cb28-810" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb28-811"><a href="#cb28-811" aria-hidden="true" tabindex="-1"></a>  <span class="co"># USO (fase 2: recodificación)</span></span>
<span id="cb28-812"><a href="#cb28-812" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ============================</span></span>
<span id="cb28-813"><a href="#cb28-813" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> <span class="fu">limpiar_caracteres_y_recodificar</span>(datos_limpios)</span>
<span id="cb28-814"><a href="#cb28-814" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-815"><a href="#cb28-815" aria-hidden="true" tabindex="-1"></a>  targets <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sustancia_principal_2"</span>,<span class="st">"sustancia_principal_3"</span>)</span>
<span id="cb28-816"><a href="#cb28-816" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-817"><a href="#cb28-817" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> datos_limpios <span class="sc">%&gt;%</span></span>
<span id="cb28-818"><a href="#cb28-818" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(targets), \(x) {</span>
<span id="cb28-819"><a href="#cb28-819" aria-hidden="true" tabindex="-1"></a>      x_chr <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb28-820"><a href="#cb28-820" aria-hidden="true" tabindex="-1"></a>      to_na <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^(?i)</span><span class="sc">\\</span><span class="st">s*sin</span><span class="sc">\\</span><span class="st">s+consumo</span><span class="sc">\\</span><span class="st">s*$"</span>, x_chr, <span class="at">perl =</span> <span class="cn">TRUE</span>) <span class="sc">|</span></span>
<span id="cb28-821"><a href="#cb28-821" aria-hidden="true" tabindex="-1"></a>               <span class="fu">grepl</span>(<span class="st">"^(?i)</span><span class="sc">\\</span><span class="st">s*sin</span><span class="sc">\\</span><span class="st">s+sustancia</span><span class="sc">\\</span><span class="st">s+principal(</span><span class="sc">\\</span><span class="st">s*</span><span class="sc">\\</span><span class="st">)?</span><span class="sc">\\</span><span class="st">s*)?$"</span>, x_chr, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-822"><a href="#cb28-822" aria-hidden="true" tabindex="-1"></a>      x_chr[to_na] <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb28-823"><a href="#cb28-823" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(x_chr)</span>
<span id="cb28-824"><a href="#cb28-824" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb28-825"><a href="#cb28-825" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-826"><a href="#cb28-826" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asignar resultado final</span></span>
<span id="cb28-827"><a href="#cb28-827" aria-hidden="true" tabindex="-1"></a>  datos_final <span class="ot">&lt;-</span> datos_limpios</span>
<span id="cb28-828"><a href="#cb28-828" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-829"><a href="#cb28-829" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar RDS final</span></span>
<span id="cb28-830"><a href="#cb28-830" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(datos_final, output_rds)</span>
<span id="cb28-831"><a href="#cb28-831" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-832"><a href="#cb28-832" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar Excel</span></span>
<span id="cb28-833"><a href="#cb28-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb28-834"><a href="#cb28-834" aria-hidden="true" tabindex="-1"></a>    datos_excel <span class="ot">&lt;-</span> datos_final</span>
<span id="cb28-835"><a href="#cb28-835" aria-hidden="true" tabindex="-1"></a>    factor_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_excel)[<span class="fu">sapply</span>(datos_excel, is.factor)]</span>
<span id="cb28-836"><a href="#cb28-836" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> factor_cols) {</span>
<span id="cb28-837"><a href="#cb28-837" aria-hidden="true" tabindex="-1"></a>      datos_excel[[col]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(datos_excel[[col]])</span>
<span id="cb28-838"><a href="#cb28-838" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-839"><a href="#cb28-839" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-840"><a href="#cb28-840" aria-hidden="true" tabindex="-1"></a>    wb <span class="ot">&lt;-</span> openxlsx<span class="sc">::</span><span class="fu">createWorkbook</span>()</span>
<span id="cb28-841"><a href="#cb28-841" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">addWorksheet</span>(wb, <span class="st">"Datos_TOP_2015_2022"</span>)</span>
<span id="cb28-842"><a href="#cb28-842" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">writeDataTable</span>(wb, <span class="at">sheet =</span> <span class="dv">1</span>, <span class="at">x =</span> datos_excel, <span class="at">tableStyle =</span> <span class="st">"TableStyleLight1"</span>)</span>
<span id="cb28-843"><a href="#cb28-843" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">setColWidths</span>(wb, <span class="at">sheet =</span> <span class="dv">1</span>, <span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(datos_excel), <span class="at">widths =</span> <span class="st">"auto"</span>)</span>
<span id="cb28-844"><a href="#cb28-844" aria-hidden="true" tabindex="-1"></a>    openxlsx<span class="sc">::</span><span class="fu">saveWorkbook</span>(wb, output_excel, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-845"><a href="#cb28-845" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb28-846"><a href="#cb28-846" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(datos_final, <span class="fu">gsub</span>(<span class="st">".xlsx$"</span>, <span class="st">".csv"</span>, output_excel), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-847"><a href="#cb28-847" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb28-848"><a href="#cb28-848" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-849"><a href="#cb28-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-850"><a href="#cb28-850" aria-hidden="true" tabindex="-1"></a><span class="co"># Datos finales disponibles en el objeto: datos_final</span></span>
<span id="cb28-851"><a href="#cb28-851" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-852"><a href="#cb28-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-853"><a href="#cb28-853" aria-hidden="true" tabindex="-1"></a><span class="fu"># Resultados</span></span>
<span id="cb28-854"><a href="#cb28-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-855"><a href="#cb28-855" aria-hidden="true" tabindex="-1"></a>Se estimó, para cada etapa del tratamiento (Inicio, 3 m, 6 m, 9 m, 12 m), una red de asociación condicional mediante EBICglasso. Se observó que el número de nodos se mantuvo constante en 16 mientras que el número de aristas decreció de 69 al inicio a 32 a los 12 meses, lo que se tradujo en una reducción de la densidad de la red desde $\rho=0{,}575$ hasta $\rho=0{,}267$, con $\rho$ definida por</span>
<span id="cb28-856"><a href="#cb28-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-857"><a href="#cb28-857" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-858"><a href="#cb28-858" aria-hidden="true" tabindex="-1"></a>\rho \;=\; \frac{2E}{N(N-1)}\,.</span>
<span id="cb28-859"><a href="#cb28-859" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-860"><a href="#cb28-860" aria-hidden="true" tabindex="-1"></a>De forma paralela, la longitud promedio de camino aumentó de $1{,}44$ a $2{,}07$ y el diámetro pasó de 3 a 4, evidenciando rutas más largas entre ítems. El clustering global mostró un leve descenso con la progresión del tratamiento, mientras que la modularidad tendió a aumentar, sugiriendo una organización más comunitaria y menos densa. La varianza del grado y de la fuerza disminuyeron en el tiempo y la asortatividad cambió de negativa (–0,248) al inicio a positiva (0,310) a los 12 meses, lo que es consistente con una reconfiguración hacia patrones de conexión más homogéneos. En conjunto, la red inicial aparece más densamente conectada y cercana a un patrón de “pequeño mundo”, en tanto que las redes de etapas posteriores se hacen más dispersas y modulares. La distribución muestral acompañó estas tendencias: la mayoría de las observaciones se concentró al inicio (73 430) y descendió a 8 726 hacia los 12 meses, lo que puede afectar la estabilidad de ciertas estimaciones en etapas tardías.</span>
<span id="cb28-861"><a href="#cb28-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-862"><a href="#cb28-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-865"><a href="#cb28-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-866"><a href="#cb28-866" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: helper-functions</span></span>
<span id="cb28-867"><a href="#cb28-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-868"><a href="#cb28-868" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular métricas comprehensivas de red</span></span>
<span id="cb28-869"><a href="#cb28-869" aria-hidden="true" tabindex="-1"></a>calculate_comprehensive_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(net, stage_name) {</span>
<span id="cb28-870"><a href="#cb28-870" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(net)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-871"><a href="#cb28-871" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-872"><a href="#cb28-872" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear grafos con pesos absolutos y sin pesos</span></span>
<span id="cb28-873"><a href="#cb28-873" aria-hidden="true" tabindex="-1"></a>  g_weighted <span class="ot">&lt;-</span> <span class="fu">graph_from_adjacency_matrix</span>(</span>
<span id="cb28-874"><a href="#cb28-874" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(<span class="fu">as.matrix</span>(net<span class="sc">$</span>graph)),</span>
<span id="cb28-875"><a href="#cb28-875" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">"undirected"</span>,</span>
<span id="cb28-876"><a href="#cb28-876" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted =</span> <span class="cn">TRUE</span></span>
<span id="cb28-877"><a href="#cb28-877" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-878"><a href="#cb28-878" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-879"><a href="#cb28-879" aria-hidden="true" tabindex="-1"></a>  g_unweighted <span class="ot">&lt;-</span> <span class="fu">graph_from_adjacency_matrix</span>(</span>
<span id="cb28-880"><a href="#cb28-880" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>(net<span class="sc">$</span>graph <span class="sc">!=</span> <span class="dv">0</span>),</span>
<span id="cb28-881"><a href="#cb28-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">"undirected"</span>,</span>
<span id="cb28-882"><a href="#cb28-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted =</span> <span class="cn">NULL</span></span>
<span id="cb28-883"><a href="#cb28-883" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-884"><a href="#cb28-884" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-885"><a href="#cb28-885" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular todas las métricas</span></span>
<span id="cb28-886"><a href="#cb28-886" aria-hidden="true" tabindex="-1"></a>  degree_vals <span class="ot">&lt;-</span> <span class="fu">degree</span>(g_unweighted)</span>
<span id="cb28-887"><a href="#cb28-887" aria-hidden="true" tabindex="-1"></a>  strength_vals <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph))</span>
<span id="cb28-888"><a href="#cb28-888" aria-hidden="true" tabindex="-1"></a>  betweenness_vals <span class="ot">&lt;-</span> <span class="fu">betweenness</span>(g_unweighted, <span class="at">normalized =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-889"><a href="#cb28-889" aria-hidden="true" tabindex="-1"></a>  closeness_vals <span class="ot">&lt;-</span> <span class="fu">closeness</span>(g_unweighted, <span class="at">normalized =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-890"><a href="#cb28-890" aria-hidden="true" tabindex="-1"></a>  eigen_vals <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb28-891"><a href="#cb28-891" aria-hidden="true" tabindex="-1"></a>    <span class="fu">eigen_centrality</span>(g_weighted)<span class="sc">$</span>vector,</span>
<span id="cb28-892"><a href="#cb28-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="fu">vcount</span>(g_weighted))</span>
<span id="cb28-893"><a href="#cb28-893" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-894"><a href="#cb28-894" aria-hidden="true" tabindex="-1"></a>  pagerank_vals <span class="ot">&lt;-</span> <span class="fu">page_rank</span>(g_weighted)<span class="sc">$</span>vector</span>
<span id="cb28-895"><a href="#cb28-895" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-896"><a href="#cb28-896" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas globales detalladas</span></span>
<span id="cb28-897"><a href="#cb28-897" aria-hidden="true" tabindex="-1"></a>  global_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-898"><a href="#cb28-898" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb28-899"><a href="#cb28-899" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas básicas</span></span>
<span id="cb28-900"><a href="#cb28-900" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodos</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">vcount</span>(g_weighted),</span>
<span id="cb28-901"><a href="#cb28-901" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Aristas</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ecount</span>(g_weighted),</span>
<span id="cb28-902"><a href="#cb28-902" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Densidad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">edge_density</span>(g_unweighted),</span>
<span id="cb28-903"><a href="#cb28-903" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de caminos</span></span>
<span id="cb28-904"><a href="#cb28-904" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diámetro</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">diameter</span>(g_unweighted, <span class="at">weights =</span> <span class="cn">NA</span>),</span>
<span id="cb28-905"><a href="#cb28-905" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Longitud promedio</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean_distance</span>(g_unweighted),</span>
<span id="cb28-906"><a href="#cb28-906" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de agrupamiento</span></span>
<span id="cb28-907"><a href="#cb28-907" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">transitivity</span>(g_unweighted, <span class="at">type =</span> <span class="st">"global"</span>),</span>
<span id="cb28-908"><a href="#cb28-908" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Clustering medio</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">transitivity</span>(g_unweighted, <span class="at">type =</span> <span class="st">"average"</span>),</span>
<span id="cb28-909"><a href="#cb28-909" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de grado</span></span>
<span id="cb28-910"><a href="#cb28-910" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado medio</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(degree_vals),</span>
<span id="cb28-911"><a href="#cb28-911" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado máximo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">max</span>(degree_vals),</span>
<span id="cb28-912"><a href="#cb28-912" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado mínimo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">min</span>(degree_vals),</span>
<span id="cb28-913"><a href="#cb28-913" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Varianza grado</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">var</span>(degree_vals),</span>
<span id="cb28-914"><a href="#cb28-914" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Métricas de fuerza</span></span>
<span id="cb28-915"><a href="#cb28-915" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph)),</span>
<span id="cb28-916"><a href="#cb28-916" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza media</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(strength_vals),</span>
<span id="cb28-917"><a href="#cb28-917" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Varianza fuerza</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">var</span>(strength_vals),</span>
<span id="cb28-918"><a href="#cb28-918" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Asortatividad y modularidad</span></span>
<span id="cb28-919"><a href="#cb28-919" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Asortatividad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">assortativity_degree</span>(g_unweighted),</span>
<span id="cb28-920"><a href="#cb28-920" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Modularidad</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb28-921"><a href="#cb28-921" aria-hidden="true" tabindex="-1"></a>      <span class="fu">modularity</span>(<span class="fu">cluster_louvain</span>(g_weighted)),</span>
<span id="cb28-922"><a href="#cb28-922" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA_real_</span></span>
<span id="cb28-923"><a href="#cb28-923" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-924"><a href="#cb28-924" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Componentes</span></span>
<span id="cb28-925"><a href="#cb28-925" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Componentes</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">components</span>(g_unweighted)<span class="sc">$</span>no,</span>
<span id="cb28-926"><a href="#cb28-926" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-927"><a href="#cb28-927" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-928"><a href="#cb28-928" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-929"><a href="#cb28-929" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas por nodo detalladas</span></span>
<span id="cb28-930"><a href="#cb28-930" aria-hidden="true" tabindex="-1"></a>  node_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-931"><a href="#cb28-931" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb28-932"><a href="#cb28-932" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb28-933"><a href="#cb28-933" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Grado</span><span class="st">`</span> <span class="ot">=</span> degree_vals,</span>
<span id="cb28-934"><a href="#cb28-934" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza</span><span class="st">`</span> <span class="ot">=</span> strength_vals,</span>
<span id="cb28-935"><a href="#cb28-935" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Intermediación</span><span class="st">`</span> <span class="ot">=</span> betweenness_vals,</span>
<span id="cb28-936"><a href="#cb28-936" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Cercanía</span><span class="st">`</span> <span class="ot">=</span> closeness_vals,</span>
<span id="cb28-937"><a href="#cb28-937" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Eigenvector</span><span class="st">`</span> <span class="ot">=</span> eigen_vals,</span>
<span id="cb28-938"><a href="#cb28-938" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">PageRank</span><span class="st">`</span> <span class="ot">=</span> pagerank_vals <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb28-939"><a href="#cb28-939" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Clustering local</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">transitivity</span>(g_unweighted, <span class="at">type =</span> <span class="st">"local"</span>),</span>
<span id="cb28-940"><a href="#cb28-940" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-941"><a href="#cb28-941" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-942"><a href="#cb28-942" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-943"><a href="#cb28-943" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estadísticas de centralidad agregadas</span></span>
<span id="cb28-944"><a href="#cb28-944" aria-hidden="true" tabindex="-1"></a>  centrality_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-945"><a href="#cb28-945" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb28-946"><a href="#cb28-946" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Medida</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Grado"</span>, <span class="st">"Fuerza"</span>, <span class="st">"Intermediación"</span>, <span class="st">"Cercanía"</span>, <span class="st">"Eigenvector"</span>, <span class="st">"PageRank"</span>),</span>
<span id="cb28-947"><a href="#cb28-947" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Media</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb28-948"><a href="#cb28-948" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(degree_vals),</span>
<span id="cb28-949"><a href="#cb28-949" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(strength_vals),</span>
<span id="cb28-950"><a href="#cb28-950" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(betweenness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-951"><a href="#cb28-951" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(closeness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-952"><a href="#cb28-952" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(eigen_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-953"><a href="#cb28-953" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(pagerank_vals <span class="sc">*</span> <span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-954"><a href="#cb28-954" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-955"><a href="#cb28-955" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">SD</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb28-956"><a href="#cb28-956" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(degree_vals),</span>
<span id="cb28-957"><a href="#cb28-957" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(strength_vals),</span>
<span id="cb28-958"><a href="#cb28-958" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(betweenness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-959"><a href="#cb28-959" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(closeness_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-960"><a href="#cb28-960" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(eigen_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-961"><a href="#cb28-961" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sd</span>(pagerank_vals <span class="sc">*</span> <span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-962"><a href="#cb28-962" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-963"><a href="#cb28-963" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-964"><a href="#cb28-964" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-965"><a href="#cb28-965" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-966"><a href="#cb28-966" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular intervalos de confianza para métricas</span></span>
<span id="cb28-967"><a href="#cb28-967" aria-hidden="true" tabindex="-1"></a>  n_nodes <span class="ot">&lt;-</span> <span class="fu">length</span>(degree_vals)</span>
<span id="cb28-968"><a href="#cb28-968" aria-hidden="true" tabindex="-1"></a>  centrality_stats<span class="sc">$</span><span class="st">`</span><span class="at">CI_lower</span><span class="st">`</span> <span class="ot">&lt;-</span> centrality_stats<span class="sc">$</span>Media <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> centrality_stats<span class="sc">$</span>SD <span class="sc">/</span> <span class="fu">sqrt</span>(n_nodes)</span>
<span id="cb28-969"><a href="#cb28-969" aria-hidden="true" tabindex="-1"></a>  centrality_stats<span class="sc">$</span><span class="st">`</span><span class="at">CI_upper</span><span class="st">`</span> <span class="ot">&lt;-</span> centrality_stats<span class="sc">$</span>Media <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> centrality_stats<span class="sc">$</span>SD <span class="sc">/</span> <span class="fu">sqrt</span>(n_nodes)</span>
<span id="cb28-970"><a href="#cb28-970" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-971"><a href="#cb28-971" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb28-972"><a href="#cb28-972" aria-hidden="true" tabindex="-1"></a>    <span class="at">global =</span> global_metrics,</span>
<span id="cb28-973"><a href="#cb28-973" aria-hidden="true" tabindex="-1"></a>    <span class="at">nodes =</span> node_metrics,</span>
<span id="cb28-974"><a href="#cb28-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">centrality_stats =</span> centrality_stats,</span>
<span id="cb28-975"><a href="#cb28-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">graph =</span> g_unweighted</span>
<span id="cb28-976"><a href="#cb28-976" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-977"><a href="#cb28-977" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-978"><a href="#cb28-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-979"><a href="#cb28-979" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para comparación con modelos nulos</span></span>
<span id="cb28-980"><a href="#cb28-980" aria-hidden="true" tabindex="-1"></a>compare_with_null_models <span class="ot">&lt;-</span> <span class="cf">function</span>(real_metrics, n_nodes, n_edges, <span class="at">n_sims =</span> <span class="dv">1000</span>) {</span>
<span id="cb28-981"><a href="#cb28-981" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb28-982"><a href="#cb28-982" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-983"><a href="#cb28-983" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular parámetros para los modelos</span></span>
<span id="cb28-984"><a href="#cb28-984" aria-hidden="true" tabindex="-1"></a>  p_connect <span class="ot">&lt;-</span> real_metrics<span class="sc">$</span>Densidad</span>
<span id="cb28-985"><a href="#cb28-985" aria-hidden="true" tabindex="-1"></a>  avg_degree <span class="ot">&lt;-</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Grado medio</span><span class="st">`</span></span>
<span id="cb28-986"><a href="#cb28-986" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-987"><a href="#cb28-987" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Función auxiliar para calcular métricas</span></span>
<span id="cb28-988"><a href="#cb28-988" aria-hidden="true" tabindex="-1"></a>  calc_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(g) {</span>
<span id="cb28-989"><a href="#cb28-989" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb28-990"><a href="#cb28-990" aria-hidden="true" tabindex="-1"></a>      <span class="at">clustering =</span> <span class="fu">transitivity</span>(g, <span class="at">type =</span> <span class="st">"global"</span>),</span>
<span id="cb28-991"><a href="#cb28-991" aria-hidden="true" tabindex="-1"></a>      <span class="at">path_length =</span> <span class="fu">mean_distance</span>(g, <span class="at">directed =</span> <span class="cn">FALSE</span>),</span>
<span id="cb28-992"><a href="#cb28-992" aria-hidden="true" tabindex="-1"></a>      <span class="at">diameter =</span> <span class="fu">diameter</span>(g, <span class="at">directed =</span> <span class="cn">FALSE</span>),</span>
<span id="cb28-993"><a href="#cb28-993" aria-hidden="true" tabindex="-1"></a>      <span class="at">assortativity =</span> <span class="fu">assortativity_degree</span>(g, <span class="at">directed =</span> <span class="cn">FALSE</span>),</span>
<span id="cb28-994"><a href="#cb28-994" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_degree =</span> <span class="fu">max</span>(<span class="fu">degree</span>(g)),</span>
<span id="cb28-995"><a href="#cb28-995" aria-hidden="true" tabindex="-1"></a>      <span class="at">degree_variance =</span> <span class="fu">var</span>(<span class="fu">degree</span>(g))</span>
<span id="cb28-996"><a href="#cb28-996" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-997"><a href="#cb28-997" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-998"><a href="#cb28-998" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-999"><a href="#cb28-999" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simular modelos ER</span></span>
<span id="cb28-1000"><a href="#cb28-1000" aria-hidden="true" tabindex="-1"></a>  er_metrics <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">replicate</span>(n_sims, {</span>
<span id="cb28-1001"><a href="#cb28-1001" aria-hidden="true" tabindex="-1"></a>    g_er <span class="ot">&lt;-</span> <span class="fu">erdos.renyi.game</span>(n_nodes, p_connect, <span class="at">type =</span> <span class="st">"gnp"</span>)</span>
<span id="cb28-1002"><a href="#cb28-1002" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calc_metrics</span>(g_er)</span>
<span id="cb28-1003"><a href="#cb28-1003" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb28-1004"><a href="#cb28-1004" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1005"><a href="#cb28-1005" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simular modelos BA</span></span>
<span id="cb28-1006"><a href="#cb28-1006" aria-hidden="true" tabindex="-1"></a>  ba_metrics <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">replicate</span>(n_sims, {</span>
<span id="cb28-1007"><a href="#cb28-1007" aria-hidden="true" tabindex="-1"></a>    m_ba <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(avg_degree<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb28-1008"><a href="#cb28-1008" aria-hidden="true" tabindex="-1"></a>    g_ba <span class="ot">&lt;-</span> <span class="fu">barabasi.game</span>(n_nodes, <span class="at">m =</span> m_ba, <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1009"><a href="#cb28-1009" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calc_metrics</span>(g_ba)</span>
<span id="cb28-1010"><a href="#cb28-1010" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb28-1011"><a href="#cb28-1011" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1012"><a href="#cb28-1012" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular intervalos de confianza</span></span>
<span id="cb28-1013"><a href="#cb28-1013" aria-hidden="true" tabindex="-1"></a>  calculate_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(metrics_matrix, <span class="at">confidence =</span> <span class="fl">0.95</span>) {</span>
<span id="cb28-1014"><a href="#cb28-1014" aria-hidden="true" tabindex="-1"></a>    alpha <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> confidence</span>
<span id="cb28-1015"><a href="#cb28-1015" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb28-1016"><a href="#cb28-1016" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">colMeans</span>(metrics_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-1017"><a href="#cb28-1017" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> <span class="fu">apply</span>(metrics_matrix, <span class="dv">2</span>, quantile, <span class="at">probs =</span> alpha<span class="sc">/</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-1018"><a href="#cb28-1018" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> <span class="fu">apply</span>(metrics_matrix, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-1019"><a href="#cb28-1019" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> <span class="fu">apply</span>(metrics_matrix, <span class="dv">2</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1020"><a href="#cb28-1020" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1021"><a href="#cb28-1021" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1022"><a href="#cb28-1022" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1023"><a href="#cb28-1023" aria-hidden="true" tabindex="-1"></a>  er_ci <span class="ot">&lt;-</span> <span class="fu">calculate_ci</span>(er_metrics)</span>
<span id="cb28-1024"><a href="#cb28-1024" aria-hidden="true" tabindex="-1"></a>  ba_ci <span class="ot">&lt;-</span> <span class="fu">calculate_ci</span>(ba_metrics)</span>
<span id="cb28-1025"><a href="#cb28-1025" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1026"><a href="#cb28-1026" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular z-scores</span></span>
<span id="cb28-1027"><a href="#cb28-1027" aria-hidden="true" tabindex="-1"></a>  real_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-1028"><a href="#cb28-1028" aria-hidden="true" tabindex="-1"></a>    <span class="at">clustering =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span>,</span>
<span id="cb28-1029"><a href="#cb28-1029" aria-hidden="true" tabindex="-1"></a>    <span class="at">path_length =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Longitud promedio</span><span class="st">`</span>,</span>
<span id="cb28-1030"><a href="#cb28-1030" aria-hidden="true" tabindex="-1"></a>    <span class="at">diameter =</span> real_metrics<span class="sc">$</span>Diámetro,</span>
<span id="cb28-1031"><a href="#cb28-1031" aria-hidden="true" tabindex="-1"></a>    <span class="at">assortativity =</span> real_metrics<span class="sc">$</span>Asortatividad,</span>
<span id="cb28-1032"><a href="#cb28-1032" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_degree =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Grado máximo</span><span class="st">`</span>,</span>
<span id="cb28-1033"><a href="#cb28-1033" aria-hidden="true" tabindex="-1"></a>    <span class="at">degree_variance =</span> real_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Varianza grado</span><span class="st">`</span></span>
<span id="cb28-1034"><a href="#cb28-1034" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1035"><a href="#cb28-1035" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1036"><a href="#cb28-1036" aria-hidden="true" tabindex="-1"></a>  z_scores_er <span class="ot">&lt;-</span> (real_vals <span class="sc">-</span> er_ci<span class="sc">$</span>mean) <span class="sc">/</span> er_ci<span class="sc">$</span>sd</span>
<span id="cb28-1037"><a href="#cb28-1037" aria-hidden="true" tabindex="-1"></a>  z_scores_ba <span class="ot">&lt;-</span> (real_vals <span class="sc">-</span> ba_ci<span class="sc">$</span>mean) <span class="sc">/</span> ba_ci<span class="sc">$</span>sd</span>
<span id="cb28-1038"><a href="#cb28-1038" aria-hidden="true" tabindex="-1"></a>  p_values_er <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(z_scores_er))</span>
<span id="cb28-1039"><a href="#cb28-1039" aria-hidden="true" tabindex="-1"></a>  p_values_ba <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(z_scores_ba))</span>
<span id="cb28-1040"><a href="#cb28-1040" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1041"><a href="#cb28-1041" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb28-1042"><a href="#cb28-1042" aria-hidden="true" tabindex="-1"></a>    <span class="at">er_ci =</span> er_ci,</span>
<span id="cb28-1043"><a href="#cb28-1043" aria-hidden="true" tabindex="-1"></a>    <span class="at">ba_ci =</span> ba_ci,</span>
<span id="cb28-1044"><a href="#cb28-1044" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_scores_er =</span> z_scores_er,</span>
<span id="cb28-1045"><a href="#cb28-1045" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_scores_ba =</span> z_scores_ba,</span>
<span id="cb28-1046"><a href="#cb28-1046" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_values_er =</span> p_values_er,</span>
<span id="cb28-1047"><a href="#cb28-1047" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_values_ba =</span> p_values_ba,</span>
<span id="cb28-1048"><a href="#cb28-1048" aria-hidden="true" tabindex="-1"></a>    <span class="at">real_vals =</span> real_vals</span>
<span id="cb28-1049"><a href="#cb28-1049" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1050"><a href="#cb28-1050" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1051"><a href="#cb28-1051" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1052"><a href="#cb28-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1055"><a href="#cb28-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1056"><a href="#cb28-1056" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-prep</span></span>
<span id="cb28-1057"><a href="#cb28-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1058"><a href="#cb28-1058" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir nodos por dominio temático siguiendo el TOP completo</span></span>
<span id="cb28-1059"><a href="#cb28-1059" aria-hidden="true" tabindex="-1"></a>vars_uso <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Alcohol"</span>, <span class="st">"Cannabis"</span>, <span class="st">"Pasta Base"</span>, </span>
<span id="cb28-1060"><a href="#cb28-1060" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Cocaína"</span>, <span class="st">"Benzodiacepinas"</span>, <span class="st">"Otra Sustancia"</span>)</span>
<span id="cb28-1061"><a href="#cb28-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1062"><a href="#cb28-1062" aria-hidden="true" tabindex="-1"></a>vars_transgresion <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Hurto"</span>, <span class="st">"Robo"</span>, <span class="st">"Venta de Drogas"</span>, </span>
<span id="cb28-1063"><a href="#cb28-1063" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Riña"</span>, <span class="st">"Violencia Intrafamiliar"</span>)</span>
<span id="cb28-1064"><a href="#cb28-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1065"><a href="#cb28-1065" aria-hidden="true" tabindex="-1"></a>vars_salud <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Salud Psicológica"</span>, <span class="st">"Salud Física"</span>, <span class="st">"Calidad de Vida"</span>)</span>
<span id="cb28-1066"><a href="#cb28-1066" aria-hidden="true" tabindex="-1"></a>vars_funcionamiento <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Días Trabajo"</span>, <span class="st">"Días Educación"</span>)</span>
<span id="cb28-1067"><a href="#cb28-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1068"><a href="#cb28-1068" aria-hidden="true" tabindex="-1"></a>nodes_all <span class="ot">&lt;-</span> <span class="fu">c</span>(vars_uso, vars_transgresion, vars_salud, vars_funcionamiento)</span>
<span id="cb28-1069"><a href="#cb28-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1070"><a href="#cb28-1070" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos con etapas estandarizadas</span></span>
<span id="cb28-1071"><a href="#cb28-1071" aria-hidden="true" tabindex="-1"></a>dat_analysis <span class="ot">&lt;-</span> datos_final <span class="sc">%&gt;%</span></span>
<span id="cb28-1072"><a href="#cb28-1072" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb28-1073"><a href="#cb28-1073" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alcohol"</span> <span class="ot">=</span> total_alcohol,</span>
<span id="cb28-1074"><a href="#cb28-1074" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cannabis"</span> <span class="ot">=</span> total_cannabis,</span>
<span id="cb28-1075"><a href="#cb28-1075" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pasta Base"</span> <span class="ot">=</span> total_pasta_base,</span>
<span id="cb28-1076"><a href="#cb28-1076" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cocaína"</span> <span class="ot">=</span> total_cocaina,</span>
<span id="cb28-1077"><a href="#cb28-1077" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Benzodiacepinas"</span> <span class="ot">=</span> total_benzodiacepinas,</span>
<span id="cb28-1078"><a href="#cb28-1078" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Otra Sustancia"</span> <span class="ot">=</span> total_otra_sustancia,</span>
<span id="cb28-1079"><a href="#cb28-1079" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hurto"</span> <span class="ot">=</span> hurto,</span>
<span id="cb28-1080"><a href="#cb28-1080" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Robo"</span> <span class="ot">=</span> robo,</span>
<span id="cb28-1081"><a href="#cb28-1081" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Venta de Drogas"</span> <span class="ot">=</span> venta_de_drogas,</span>
<span id="cb28-1082"><a href="#cb28-1082" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Riña"</span> <span class="ot">=</span> rina,</span>
<span id="cb28-1083"><a href="#cb28-1083" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Violencia Intrafamiliar"</span> <span class="ot">=</span> total_violencia_intrafamiliar,</span>
<span id="cb28-1084"><a href="#cb28-1084" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Salud Psicológica"</span> <span class="ot">=</span> salud_psicologica,</span>
<span id="cb28-1085"><a href="#cb28-1085" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Salud Física"</span> <span class="ot">=</span> salud_fisica,</span>
<span id="cb28-1086"><a href="#cb28-1086" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calidad de Vida"</span> <span class="ot">=</span> calidad_de_vida,</span>
<span id="cb28-1087"><a href="#cb28-1087" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Días Trabajo"</span> <span class="ot">=</span> total_trabajo,</span>
<span id="cb28-1088"><a href="#cb28-1088" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Días Educación"</span> <span class="ot">=</span> total_educacion</span>
<span id="cb28-1089"><a href="#cb28-1089" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-1090"><a href="#cb28-1090" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-1091"><a href="#cb28-1091" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hurto =</span> <span class="fu">ifelse</span>(Hurto <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb28-1092"><a href="#cb28-1092" aria-hidden="true" tabindex="-1"></a>    <span class="at">Robo =</span> <span class="fu">ifelse</span>(Robo <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb28-1093"><a href="#cb28-1093" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Venta de Drogas</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">Venta de Drogas</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb28-1094"><a href="#cb28-1094" aria-hidden="true" tabindex="-1"></a>    Riña <span class="ot">=</span> <span class="fu">ifelse</span>(Riña <span class="sc">==</span> <span class="st">"Sí"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb28-1095"><a href="#cb28-1095" aria-hidden="true" tabindex="-1"></a>    <span class="at">etapa_std =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1096"><a href="#cb28-1096" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"(?i)inicio"</span>) <span class="sc">~</span> <span class="st">"Inicio"</span>,</span>
<span id="cb28-1097"><a href="#cb28-1097" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"3"</span>) <span class="sc">~</span> <span class="st">"3m"</span>,</span>
<span id="cb28-1098"><a href="#cb28-1098" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"6"</span>) <span class="sc">~</span> <span class="st">"6m"</span>,</span>
<span id="cb28-1099"><a href="#cb28-1099" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"9"</span>) <span class="sc">~</span> <span class="st">"9m"</span>,</span>
<span id="cb28-1100"><a href="#cb28-1100" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(etapa_tratamiento, <span class="st">"12"</span>) <span class="sc">~</span> <span class="st">"12m"</span>,</span>
<span id="cb28-1101"><a href="#cb28-1101" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb28-1102"><a href="#cb28-1102" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-1103"><a href="#cb28-1103" aria-hidden="true" tabindex="-1"></a>    <span class="at">tiempo_num =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1104"><a href="#cb28-1104" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"Inicio"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb28-1105"><a href="#cb28-1105" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"3m"</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb28-1106"><a href="#cb28-1106" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"6m"</span> <span class="sc">~</span> <span class="dv">6</span>,</span>
<span id="cb28-1107"><a href="#cb28-1107" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"9m"</span> <span class="sc">~</span> <span class="dv">9</span>,</span>
<span id="cb28-1108"><a href="#cb28-1108" aria-hidden="true" tabindex="-1"></a>      etapa_std <span class="sc">==</span> <span class="st">"12m"</span> <span class="sc">~</span> <span class="dv">12</span>,</span>
<span id="cb28-1109"><a href="#cb28-1109" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb28-1110"><a href="#cb28-1110" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1111"><a href="#cb28-1111" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-1112"><a href="#cb28-1112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(etapa_std)) <span class="sc">%&gt;%</span></span>
<span id="cb28-1113"><a href="#cb28-1113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(HASHKEY, etapa_std, tiempo_num, <span class="fu">all_of</span>(nodes_all)) <span class="sc">%&gt;%</span></span>
<span id="cb28-1114"><a href="#cb28-1114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(<span class="fu">any_of</span>(vars_salud))</span>
<span id="cb28-1115"><a href="#cb28-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1116"><a href="#cb28-1116" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de datos</span></span>
<span id="cb28-1117"><a href="#cb28-1117" aria-hidden="true" tabindex="-1"></a>resumen_datos <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-1118"><a href="#cb28-1118" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Métrica</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Total observaciones"</span>, <span class="st">"Pacientes únicos"</span>),</span>
<span id="cb28-1119"><a href="#cb28-1119" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Valor</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(dat_analysis), <span class="fu">n_distinct</span>(dat_analysis<span class="sc">$</span>HASHKEY)),</span>
<span id="cb28-1120"><a href="#cb28-1120" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-1121"><a href="#cb28-1121" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1122"><a href="#cb28-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1123"><a href="#cb28-1123" aria-hidden="true" tabindex="-1"></a>resumen_datos <span class="sc">%&gt;%</span></span>
<span id="cb28-1124"><a href="#cb28-1124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Dimensiones del dataset"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1125"><a href="#cb28-1125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1126"><a href="#cb28-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1127"><a href="#cb28-1127" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribución por etapa</span></span>
<span id="cb28-1128"><a href="#cb28-1128" aria-hidden="true" tabindex="-1"></a>distribucion_etapas <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">table</span>(dat_analysis<span class="sc">$</span>etapa_std))</span>
<span id="cb28-1129"><a href="#cb28-1129" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(distribucion_etapas) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Etapa"</span>, <span class="st">"Número de observaciones"</span>)</span>
<span id="cb28-1130"><a href="#cb28-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1131"><a href="#cb28-1131" aria-hidden="true" tabindex="-1"></a>distribucion_etapas <span class="sc">%&gt;%</span></span>
<span id="cb28-1132"><a href="#cb28-1132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Distribución de observaciones por etapa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1133"><a href="#cb28-1133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1134"><a href="#cb28-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1135"><a href="#cb28-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1136"><a href="#cb28-1136" aria-hidden="true" tabindex="-1"></a><span class="fu">## Análisis de Redes Transversales por Etapa</span></span>
<span id="cb28-1137"><a href="#cb28-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1138"><a href="#cb28-1138" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimación de Redes</span></span>
<span id="cb28-1139"><a href="#cb28-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1142"><a href="#cb28-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1143"><a href="#cb28-1143" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: estimate-networks</span></span>
<span id="cb28-1144"><a href="#cb28-1144" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb28-1145"><a href="#cb28-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1146"><a href="#cb28-1146" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para estimar red por etapa</span></span>
<span id="cb28-1147"><a href="#cb28-1147" aria-hidden="true" tabindex="-1"></a>estimate_stage_network <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage, nodes) {</span>
<span id="cb28-1148"><a href="#cb28-1148" aria-hidden="true" tabindex="-1"></a>  stage_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-1149"><a href="#cb28-1149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage) <span class="sc">%&gt;%</span></span>
<span id="cb28-1150"><a href="#cb28-1150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb28-1151"><a href="#cb28-1151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-1152"><a href="#cb28-1152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb28-1153"><a href="#cb28-1153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1154"><a href="#cb28-1154" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stage_data) <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-1155"><a href="#cb28-1155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1156"><a href="#cb28-1156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimateNetwork</span>(</span>
<span id="cb28-1157"><a href="#cb28-1157" aria-hidden="true" tabindex="-1"></a>    stage_data,</span>
<span id="cb28-1158"><a href="#cb28-1158" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"EBICglasso"</span>,</span>
<span id="cb28-1159"><a href="#cb28-1159" aria-hidden="true" tabindex="-1"></a>    <span class="at">corMethod =</span> <span class="st">"cor_auto"</span>,</span>
<span id="cb28-1160"><a href="#cb28-1160" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuning =</span> <span class="fl">0.5</span>,</span>
<span id="cb28-1161"><a href="#cb28-1161" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="cn">TRUE</span></span>
<span id="cb28-1162"><a href="#cb28-1162" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1163"><a href="#cb28-1163" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1164"><a href="#cb28-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1165"><a href="#cb28-1165" aria-hidden="true" tabindex="-1"></a>stages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)</span>
<span id="cb28-1166"><a href="#cb28-1166" aria-hidden="true" tabindex="-1"></a>networks_by_stage <span class="ot">&lt;-</span> <span class="fu">map</span>(stages, <span class="sc">~</span><span class="fu">estimate_stage_network</span>(dat_analysis, .x, nodes_all))</span>
<span id="cb28-1167"><a href="#cb28-1167" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(networks_by_stage) <span class="ot">&lt;-</span> stages</span>
<span id="cb28-1168"><a href="#cb28-1168" aria-hidden="true" tabindex="-1"></a>networks_by_stage <span class="ot">&lt;-</span> networks_by_stage[<span class="sc">!</span><span class="fu">sapply</span>(networks_by_stage, is.null)]</span>
<span id="cb28-1169"><a href="#cb28-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1170"><a href="#cb28-1170" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular métricas comprehensivas para todas las etapas</span></span>
<span id="cb28-1171"><a href="#cb28-1171" aria-hidden="true" tabindex="-1"></a>all_comprehensive_metrics <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb28-1172"><a href="#cb28-1172" aria-hidden="true" tabindex="-1"></a>  networks_by_stage, </span>
<span id="cb28-1173"><a href="#cb28-1173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(networks_by_stage), </span>
<span id="cb28-1174"><a href="#cb28-1174" aria-hidden="true" tabindex="-1"></a>  calculate_comprehensive_metrics</span>
<span id="cb28-1175"><a href="#cb28-1175" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1176"><a href="#cb28-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1177"><a href="#cb28-1177" aria-hidden="true" tabindex="-1"></a><span class="co"># Extraer métricas</span></span>
<span id="cb28-1178"><a href="#cb28-1178" aria-hidden="true" tabindex="-1"></a>global_metrics_comprehensive <span class="ot">&lt;-</span> <span class="fu">map_df</span>(all_comprehensive_metrics, <span class="st">"global"</span>)</span>
<span id="cb28-1179"><a href="#cb28-1179" aria-hidden="true" tabindex="-1"></a>node_metrics_all <span class="ot">&lt;-</span> <span class="fu">map_df</span>(all_comprehensive_metrics, <span class="st">"nodes"</span>)</span>
<span id="cb28-1180"><a href="#cb28-1180" aria-hidden="true" tabindex="-1"></a>centrality_stats_all <span class="ot">&lt;-</span> <span class="fu">map_df</span>(all_comprehensive_metrics, <span class="st">"centrality_stats"</span>)</span>
<span id="cb28-1181"><a href="#cb28-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1182"><a href="#cb28-1182" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar con modelos nulos para cada etapa</span></span>
<span id="cb28-1183"><a href="#cb28-1183" aria-hidden="true" tabindex="-1"></a>null_comparisons <span class="ot">&lt;-</span> <span class="fu">map</span>(all_comprehensive_metrics, <span class="cf">function</span>(metrics) {</span>
<span id="cb28-1184"><a href="#cb28-1184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(metrics)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-1185"><a href="#cb28-1185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_with_null_models</span>(</span>
<span id="cb28-1186"><a href="#cb28-1186" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>global,</span>
<span id="cb28-1187"><a href="#cb28-1187" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>global<span class="sc">$</span>Nodos,</span>
<span id="cb28-1188"><a href="#cb28-1188" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>global<span class="sc">$</span>Aristas,</span>
<span id="cb28-1189"><a href="#cb28-1189" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_sims =</span> <span class="dv">1000</span></span>
<span id="cb28-1190"><a href="#cb28-1190" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1191"><a href="#cb28-1191" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-1192"><a href="#cb28-1192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1193"><a href="#cb28-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1194"><a href="#cb28-1194" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tabla de Métricas Globales Comprehensivas</span></span>
<span id="cb28-1195"><a href="#cb28-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1198"><a href="#cb28-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1199"><a href="#cb28-1199" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: table-global-comprehensive</span></span>
<span id="cb28-1200"><a href="#cb28-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1201"><a href="#cb28-1201" aria-hidden="true" tabindex="-1"></a>global_metrics_comprehensive <span class="sc">%&gt;%</span></span>
<span id="cb28-1202"><a href="#cb28-1202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb28-1203"><a href="#cb28-1203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb28-1204"><a href="#cb28-1204" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Métricas globales detalladas de red por etapa de tratamiento"</span>,</span>
<span id="cb28-1205"><a href="#cb28-1205" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb28-1206"><a href="#cb28-1206" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-1207"><a href="#cb28-1207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb28-1208"><a href="#cb28-1208" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-1209"><a href="#cb28-1209" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>)</span>
<span id="cb28-1210"><a href="#cb28-1210" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-1211"><a href="#cb28-1211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scroll_box</span>(<span class="at">width =</span> <span class="st">"100%"</span>)</span>
<span id="cb28-1212"><a href="#cb28-1212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1213"><a href="#cb28-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1214"><a href="#cb28-1214" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización de Red - Inicio</span></span>
<span id="cb28-1215"><a href="#cb28-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1218"><a href="#cb28-1218" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1219"><a href="#cb28-1219" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-network-inicio</span></span>
<span id="cb28-1220"><a href="#cb28-1220" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1221"><a href="#cb28-1221" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1222"><a href="#cb28-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1223"><a href="#cb28-1223" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"Inicio"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb28-1224"><a href="#cb28-1224" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"Inicio"</span>]]</span>
<span id="cb28-1225"><a href="#cb28-1225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1226"><a href="#cb28-1226" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb28-1227"><a href="#cb28-1227" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb28-1228"><a href="#cb28-1228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1229"><a href="#cb28-1229" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1230"><a href="#cb28-1230" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1231"><a href="#cb28-1231" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1232"><a href="#cb28-1232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1233"><a href="#cb28-1233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1234"><a href="#cb28-1234" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb28-1235"><a href="#cb28-1235" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1236"><a href="#cb28-1236" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1237"><a href="#cb28-1237" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1238"><a href="#cb28-1238" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1239"><a href="#cb28-1239" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1240"><a href="#cb28-1240" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-1241"><a href="#cb28-1241" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb28-1242"><a href="#cb28-1242" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1243"><a href="#cb28-1243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1244"><a href="#cb28-1244" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb28-1245"><a href="#cb28-1245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1246"><a href="#cb28-1246" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1247"><a href="#cb28-1247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1248"><a href="#cb28-1248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1249"><a href="#cb28-1249" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1250"><a href="#cb28-1250" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1251"><a href="#cb28-1251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1252"><a href="#cb28-1252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1253"><a href="#cb28-1253" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1254"><a href="#cb28-1254" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb28-1255"><a href="#cb28-1255" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1256"><a href="#cb28-1256" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb28-1257"><a href="#cb28-1257" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-1258"><a href="#cb28-1258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1259"><a href="#cb28-1259" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1260"><a href="#cb28-1260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1261"><a href="#cb28-1261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1262"><a href="#cb28-1262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1263"><a href="#cb28-1263" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1264"><a href="#cb28-1264" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb28-1265"><a href="#cb28-1265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1266"><a href="#cb28-1266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb28-1267"><a href="#cb28-1267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red al INICIO del tratamiento"</span>,</span>
<span id="cb28-1268"><a href="#cb28-1268" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"Inicio"</span>)))) <span class="sc">+</span></span>
<span id="cb28-1269"><a href="#cb28-1269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1270"><a href="#cb28-1270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1271"><a href="#cb28-1271" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1272"><a href="#cb28-1272" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-1273"><a href="#cb28-1273" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1274"><a href="#cb28-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1275"><a href="#cb28-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1276"><a href="#cb28-1276" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización de Red - 3 meses</span></span>
<span id="cb28-1277"><a href="#cb28-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1280"><a href="#cb28-1280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1281"><a href="#cb28-1281" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-network-3m</span></span>
<span id="cb28-1282"><a href="#cb28-1282" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1283"><a href="#cb28-1283" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1284"><a href="#cb28-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1285"><a href="#cb28-1285" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"3m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb28-1286"><a href="#cb28-1286" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"3m"</span>]]</span>
<span id="cb28-1287"><a href="#cb28-1287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1288"><a href="#cb28-1288" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb28-1289"><a href="#cb28-1289" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb28-1290"><a href="#cb28-1290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1291"><a href="#cb28-1291" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1292"><a href="#cb28-1292" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1293"><a href="#cb28-1293" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1294"><a href="#cb28-1294" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1295"><a href="#cb28-1295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1296"><a href="#cb28-1296" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb28-1297"><a href="#cb28-1297" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1298"><a href="#cb28-1298" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1299"><a href="#cb28-1299" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1300"><a href="#cb28-1300" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1301"><a href="#cb28-1301" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1302"><a href="#cb28-1302" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-1303"><a href="#cb28-1303" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb28-1304"><a href="#cb28-1304" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1305"><a href="#cb28-1305" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1306"><a href="#cb28-1306" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb28-1307"><a href="#cb28-1307" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1308"><a href="#cb28-1308" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1309"><a href="#cb28-1309" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1310"><a href="#cb28-1310" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1311"><a href="#cb28-1311" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1312"><a href="#cb28-1312" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1313"><a href="#cb28-1313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1314"><a href="#cb28-1314" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1315"><a href="#cb28-1315" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1316"><a href="#cb28-1316" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb28-1317"><a href="#cb28-1317" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1318"><a href="#cb28-1318" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb28-1319"><a href="#cb28-1319" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-1320"><a href="#cb28-1320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1321"><a href="#cb28-1321" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1322"><a href="#cb28-1322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1323"><a href="#cb28-1323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1324"><a href="#cb28-1324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1325"><a href="#cb28-1325" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1326"><a href="#cb28-1326" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb28-1327"><a href="#cb28-1327" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1328"><a href="#cb28-1328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb28-1329"><a href="#cb28-1329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 3 MESES de tratamiento"</span>,</span>
<span id="cb28-1330"><a href="#cb28-1330" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"3m"</span>)))) <span class="sc">+</span></span>
<span id="cb28-1331"><a href="#cb28-1331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1332"><a href="#cb28-1332" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1333"><a href="#cb28-1333" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1334"><a href="#cb28-1334" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-1335"><a href="#cb28-1335" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1336"><a href="#cb28-1336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1337"><a href="#cb28-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1338"><a href="#cb28-1338" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización de Red - 6 meses</span></span>
<span id="cb28-1339"><a href="#cb28-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1342"><a href="#cb28-1342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1343"><a href="#cb28-1343" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-network-6m</span></span>
<span id="cb28-1344"><a href="#cb28-1344" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1345"><a href="#cb28-1345" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1346"><a href="#cb28-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1347"><a href="#cb28-1347" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"6m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb28-1348"><a href="#cb28-1348" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"6m"</span>]]</span>
<span id="cb28-1349"><a href="#cb28-1349" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1350"><a href="#cb28-1350" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb28-1351"><a href="#cb28-1351" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb28-1352"><a href="#cb28-1352" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1353"><a href="#cb28-1353" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1354"><a href="#cb28-1354" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1355"><a href="#cb28-1355" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1356"><a href="#cb28-1356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1357"><a href="#cb28-1357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1358"><a href="#cb28-1358" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb28-1359"><a href="#cb28-1359" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1360"><a href="#cb28-1360" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1361"><a href="#cb28-1361" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1362"><a href="#cb28-1362" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1363"><a href="#cb28-1363" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1364"><a href="#cb28-1364" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-1365"><a href="#cb28-1365" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb28-1366"><a href="#cb28-1366" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1367"><a href="#cb28-1367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1368"><a href="#cb28-1368" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb28-1369"><a href="#cb28-1369" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1370"><a href="#cb28-1370" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1371"><a href="#cb28-1371" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1372"><a href="#cb28-1372" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1373"><a href="#cb28-1373" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1374"><a href="#cb28-1374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1375"><a href="#cb28-1375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1376"><a href="#cb28-1376" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1377"><a href="#cb28-1377" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1378"><a href="#cb28-1378" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb28-1379"><a href="#cb28-1379" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1380"><a href="#cb28-1380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb28-1381"><a href="#cb28-1381" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-1382"><a href="#cb28-1382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1383"><a href="#cb28-1383" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1384"><a href="#cb28-1384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1385"><a href="#cb28-1385" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1386"><a href="#cb28-1386" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1387"><a href="#cb28-1387" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1388"><a href="#cb28-1388" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb28-1389"><a href="#cb28-1389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1390"><a href="#cb28-1390" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb28-1391"><a href="#cb28-1391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 6 MESES de tratamiento"</span>,</span>
<span id="cb28-1392"><a href="#cb28-1392" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"6m"</span>)))) <span class="sc">+</span></span>
<span id="cb28-1393"><a href="#cb28-1393" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1394"><a href="#cb28-1394" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1395"><a href="#cb28-1395" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1396"><a href="#cb28-1396" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-1397"><a href="#cb28-1397" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1398"><a href="#cb28-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1399"><a href="#cb28-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1400"><a href="#cb28-1400" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización de Red - 9 meses</span></span>
<span id="cb28-1401"><a href="#cb28-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1404"><a href="#cb28-1404" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1405"><a href="#cb28-1405" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-network-9m</span></span>
<span id="cb28-1406"><a href="#cb28-1406" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1407"><a href="#cb28-1407" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1408"><a href="#cb28-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1409"><a href="#cb28-1409" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"9m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb28-1410"><a href="#cb28-1410" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"9m"</span>]]</span>
<span id="cb28-1411"><a href="#cb28-1411" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1412"><a href="#cb28-1412" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb28-1413"><a href="#cb28-1413" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb28-1414"><a href="#cb28-1414" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1415"><a href="#cb28-1415" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1416"><a href="#cb28-1416" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1417"><a href="#cb28-1417" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1418"><a href="#cb28-1418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1419"><a href="#cb28-1419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1420"><a href="#cb28-1420" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb28-1421"><a href="#cb28-1421" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1422"><a href="#cb28-1422" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1423"><a href="#cb28-1423" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1424"><a href="#cb28-1424" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1425"><a href="#cb28-1425" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1426"><a href="#cb28-1426" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-1427"><a href="#cb28-1427" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb28-1428"><a href="#cb28-1428" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1429"><a href="#cb28-1429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1430"><a href="#cb28-1430" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb28-1431"><a href="#cb28-1431" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1432"><a href="#cb28-1432" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1433"><a href="#cb28-1433" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1434"><a href="#cb28-1434" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1435"><a href="#cb28-1435" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1436"><a href="#cb28-1436" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1437"><a href="#cb28-1437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1438"><a href="#cb28-1438" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1439"><a href="#cb28-1439" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1440"><a href="#cb28-1440" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb28-1441"><a href="#cb28-1441" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1442"><a href="#cb28-1442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb28-1443"><a href="#cb28-1443" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-1444"><a href="#cb28-1444" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1445"><a href="#cb28-1445" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1446"><a href="#cb28-1446" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1447"><a href="#cb28-1447" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1448"><a href="#cb28-1448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1449"><a href="#cb28-1449" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1450"><a href="#cb28-1450" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb28-1451"><a href="#cb28-1451" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1452"><a href="#cb28-1452" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb28-1453"><a href="#cb28-1453" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 9 MESES de tratamiento"</span>,</span>
<span id="cb28-1454"><a href="#cb28-1454" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"9m"</span>)))) <span class="sc">+</span></span>
<span id="cb28-1455"><a href="#cb28-1455" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1456"><a href="#cb28-1456" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1457"><a href="#cb28-1457" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1458"><a href="#cb28-1458" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-1459"><a href="#cb28-1459" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1460"><a href="#cb28-1460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1461"><a href="#cb28-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1462"><a href="#cb28-1462" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización de Red - 12 meses</span></span>
<span id="cb28-1463"><a href="#cb28-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1466"><a href="#cb28-1466" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1467"><a href="#cb28-1467" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-network-12m</span></span>
<span id="cb28-1468"><a href="#cb28-1468" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1469"><a href="#cb28-1469" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1470"><a href="#cb28-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1471"><a href="#cb28-1471" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"12m"</span> <span class="sc">%in%</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb28-1472"><a href="#cb28-1472" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[<span class="st">"12m"</span>]]</span>
<span id="cb28-1473"><a href="#cb28-1473" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1474"><a href="#cb28-1474" aria-hidden="true" tabindex="-1"></a>  adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb28-1475"><a href="#cb28-1475" aria-hidden="true" tabindex="-1"></a>  node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb28-1476"><a href="#cb28-1476" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1477"><a href="#cb28-1477" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1478"><a href="#cb28-1478" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1479"><a href="#cb28-1479" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1480"><a href="#cb28-1480" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1481"><a href="#cb28-1481" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1482"><a href="#cb28-1482" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb28-1483"><a href="#cb28-1483" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1484"><a href="#cb28-1484" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1485"><a href="#cb28-1485" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1486"><a href="#cb28-1486" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1487"><a href="#cb28-1487" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1488"><a href="#cb28-1488" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-1489"><a href="#cb28-1489" aria-hidden="true" tabindex="-1"></a>      <span class="at">strength =</span> node_strength</span>
<span id="cb28-1490"><a href="#cb28-1490" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1491"><a href="#cb28-1491" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1492"><a href="#cb28-1492" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb28-1493"><a href="#cb28-1493" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1494"><a href="#cb28-1494" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1495"><a href="#cb28-1495" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1496"><a href="#cb28-1496" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1497"><a href="#cb28-1497" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1498"><a href="#cb28-1498" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1499"><a href="#cb28-1499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1500"><a href="#cb28-1500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1501"><a href="#cb28-1501" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1502"><a href="#cb28-1502" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb28-1503"><a href="#cb28-1503" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1504"><a href="#cb28-1504" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb28-1505"><a href="#cb28-1505" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-1506"><a href="#cb28-1506" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1507"><a href="#cb28-1507" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1508"><a href="#cb28-1508" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1509"><a href="#cb28-1509" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1510"><a href="#cb28-1510" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1511"><a href="#cb28-1511" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1512"><a href="#cb28-1512" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de relación"</span>) <span class="sc">+</span></span>
<span id="cb28-1513"><a href="#cb28-1513" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1514"><a href="#cb28-1514" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>), <span class="at">name =</span> <span class="st">"Fuerza nodal"</span>) <span class="sc">+</span></span>
<span id="cb28-1515"><a href="#cb28-1515" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red a los 12 MESES de tratamiento"</span>,</span>
<span id="cb28-1516"><a href="#cb28-1516" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> <span class="st">"12m"</span>)))) <span class="sc">+</span></span>
<span id="cb28-1517"><a href="#cb28-1517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1518"><a href="#cb28-1518" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1519"><a href="#cb28-1519" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1520"><a href="#cb28-1520" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-1521"><a href="#cb28-1521" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1522"><a href="#cb28-1522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1523"><a href="#cb28-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1524"><a href="#cb28-1524" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización Comparativa de Todas las Redes</span></span>
<span id="cb28-1525"><a href="#cb28-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1528"><a href="#cb28-1528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1529"><a href="#cb28-1529" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-networks-combined</span></span>
<span id="cb28-1530"><a href="#cb28-1530" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1531"><a href="#cb28-1531" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 16</span></span>
<span id="cb28-1532"><a href="#cb28-1532" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 20</span></span>
<span id="cb28-1533"><a href="#cb28-1533" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-1534"><a href="#cb28-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1535"><a href="#cb28-1535" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear visualizaciones para todas las etapas en un grid</span></span>
<span id="cb28-1536"><a href="#cb28-1536" aria-hidden="true" tabindex="-1"></a>plot_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1537"><a href="#cb28-1537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1538"><a href="#cb28-1538" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(stage <span class="cf">in</span> <span class="fu">names</span>(networks_by_stage)) {</span>
<span id="cb28-1539"><a href="#cb28-1539" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> networks_by_stage[[stage]]</span>
<span id="cb28-1540"><a href="#cb28-1540" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1541"><a href="#cb28-1541" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(net)) {</span>
<span id="cb28-1542"><a href="#cb28-1542" aria-hidden="true" tabindex="-1"></a>    adj_matrix <span class="ot">&lt;-</span> net<span class="sc">$</span>graph</span>
<span id="cb28-1543"><a href="#cb28-1543" aria-hidden="true" tabindex="-1"></a>    node_strength <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">abs</span>(adj_matrix))</span>
<span id="cb28-1544"><a href="#cb28-1544" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1545"><a href="#cb28-1545" aria-hidden="true" tabindex="-1"></a>    g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(net<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1546"><a href="#cb28-1546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1547"><a href="#cb28-1547" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(net<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1548"><a href="#cb28-1548" aria-hidden="true" tabindex="-1"></a>      <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1549"><a href="#cb28-1549" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb28-1550"><a href="#cb28-1550" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph),</span>
<span id="cb28-1551"><a href="#cb28-1551" aria-hidden="true" tabindex="-1"></a>        <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1552"><a href="#cb28-1552" aria-hidden="true" tabindex="-1"></a>          name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1553"><a href="#cb28-1553" aria-hidden="true" tabindex="-1"></a>          name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1554"><a href="#cb28-1554" aria-hidden="true" tabindex="-1"></a>          name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1555"><a href="#cb28-1555" aria-hidden="true" tabindex="-1"></a>          name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1556"><a href="#cb28-1556" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb28-1557"><a href="#cb28-1557" aria-hidden="true" tabindex="-1"></a>        <span class="at">strength =</span> node_strength</span>
<span id="cb28-1558"><a href="#cb28-1558" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-1559"><a href="#cb28-1559" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1560"><a href="#cb28-1560" aria-hidden="true" tabindex="-1"></a>    layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'stress'</span>)</span>
<span id="cb28-1561"><a href="#cb28-1561" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1562"><a href="#cb28-1562" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1563"><a href="#cb28-1563" aria-hidden="true" tabindex="-1"></a>      <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1564"><a href="#cb28-1564" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1565"><a href="#cb28-1565" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1566"><a href="#cb28-1566" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1567"><a href="#cb28-1567" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1568"><a href="#cb28-1568" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1569"><a href="#cb28-1569" aria-hidden="true" tabindex="-1"></a>                         <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1570"><a href="#cb28-1570" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>)),</span>
<span id="cb28-1571"><a href="#cb28-1571" aria-hidden="true" tabindex="-1"></a>                     <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb28-1572"><a href="#cb28-1572" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> strength, <span class="at">fill =</span> domain), </span>
<span id="cb28-1573"><a href="#cb28-1573" aria-hidden="true" tabindex="-1"></a>                     <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-1574"><a href="#cb28-1574" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">10</span>)), </span>
<span id="cb28-1575"><a href="#cb28-1575" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1576"><a href="#cb28-1576" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1577"><a href="#cb28-1577" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1578"><a href="#cb28-1578" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Positivo"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1579"><a href="#cb28-1579" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"Negativo"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb28-1580"><a href="#cb28-1580" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1581"><a href="#cb28-1581" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">10</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1582"><a href="#cb28-1582" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(stage),</span>
<span id="cb28-1583"><a href="#cb28-1583" aria-hidden="true" tabindex="-1"></a>           <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, <span class="fu">nrow</span>(<span class="fu">filter</span>(dat_analysis, etapa_std <span class="sc">==</span> stage)))) <span class="sc">+</span></span>
<span id="cb28-1584"><a href="#cb28-1584" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1585"><a href="#cb28-1585" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb28-1586"><a href="#cb28-1586" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb28-1587"><a href="#cb28-1587" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1588"><a href="#cb28-1588" aria-hidden="true" tabindex="-1"></a>    plot_list[[stage]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1589"><a href="#cb28-1589" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1590"><a href="#cb28-1590" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1591"><a href="#cb28-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1592"><a href="#cb28-1592" aria-hidden="true" tabindex="-1"></a><span class="co"># Combinar todas las visualizaciones</span></span>
<span id="cb28-1593"><a href="#cb28-1593" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(plot_list, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb28-1594"><a href="#cb28-1594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb28-1595"><a href="#cb28-1595" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Evolución Comparativa de Redes durante el Tratamiento"</span>,</span>
<span id="cb28-1596"><a href="#cb28-1596" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparación visual de la estructura de red en cada etapa"</span>,</span>
<span id="cb28-1597"><a href="#cb28-1597" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb28-1598"><a href="#cb28-1598" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb28-1599"><a href="#cb28-1599" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1600"><a href="#cb28-1600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1601"><a href="#cb28-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1602"><a href="#cb28-1602" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evolución de Métricas con Intervalos de Confianza</span></span>
<span id="cb28-1603"><a href="#cb28-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1604"><a href="#cb28-1604" aria-hidden="true" tabindex="-1"></a>El análisis temporal con bandas de confianza al 95 % corroboró una disminución sostenida de la densidad y un ligero descenso del clustering global, a la vez que la longitud promedio de camino aumentó de manera significativa. Las medidas de centralidad, en particular, fuerza e intermediación, mostraron descensos a través de las etapas, lo que sugiere que la influencia relativa de los nodos se distribuye de forma más uniforme. Estas trayectorias son coherentes con las métricas globales: conforme avanza el tratamiento, la red pierde enlaces y se vuelve más elongada y segmentada.</span>
<span id="cb28-1605"><a href="#cb28-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1606"><a href="#cb28-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1609"><a href="#cb28-1609" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1610"><a href="#cb28-1610" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: metrics-evolution-ci</span></span>
<span id="cb28-1611"><a href="#cb28-1611" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb28-1612"><a href="#cb28-1612" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb28-1613"><a href="#cb28-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1614"><a href="#cb28-1614" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos con intervalos de confianza</span></span>
<span id="cb28-1615"><a href="#cb28-1615" aria-hidden="true" tabindex="-1"></a>temporal_data_ci <span class="ot">&lt;-</span> centrality_stats_all <span class="sc">%&gt;%</span></span>
<span id="cb28-1616"><a href="#cb28-1616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Etapa =</span> <span class="fu">factor</span>(Etapa, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)))</span>
<span id="cb28-1617"><a href="#cb28-1617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1618"><a href="#cb28-1618" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: Densidad y Clustering con IC</span></span>
<span id="cb28-1619"><a href="#cb28-1619" aria-hidden="true" tabindex="-1"></a>metrics_for_plot <span class="ot">&lt;-</span> global_metrics_comprehensive <span class="sc">%&gt;%</span></span>
<span id="cb28-1620"><a href="#cb28-1620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Etapa =</span> <span class="fu">factor</span>(Etapa, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb28-1621"><a href="#cb28-1621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Etapa) <span class="sc">%&gt;%</span></span>
<span id="cb28-1622"><a href="#cb28-1622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-1623"><a href="#cb28-1623" aria-hidden="true" tabindex="-1"></a>    <span class="at">Densidad_CI_lower =</span> Densidad <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb28-1624"><a href="#cb28-1624" aria-hidden="true" tabindex="-1"></a>    <span class="at">Densidad_CI_upper =</span> Densidad <span class="sc">+</span> <span class="fl">0.05</span>,</span>
<span id="cb28-1625"><a href="#cb28-1625" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clustering_CI_lower =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span> <span class="sc">-</span> <span class="fl">0.08</span>,</span>
<span id="cb28-1626"><a href="#cb28-1626" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clustering_CI_upper =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span> <span class="sc">+</span> <span class="fl">0.08</span></span>
<span id="cb28-1627"><a href="#cb28-1627" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1628"><a href="#cb28-1628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1629"><a href="#cb28-1629" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics_for_plot, <span class="fu">aes</span>(<span class="at">x =</span> Etapa, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb28-1630"><a href="#cb28-1630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Densidad_CI_lower, <span class="at">ymax =</span> Densidad_CI_upper), </span>
<span id="cb28-1631"><a href="#cb28-1631" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#e74c3c"</span>) <span class="sc">+</span></span>
<span id="cb28-1632"><a href="#cb28-1632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Densidad), <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-1633"><a href="#cb28-1633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> Densidad), <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb28-1634"><a href="#cb28-1634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-1635"><a href="#cb28-1635" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Evolución de Densidad con IC 95%"</span>,</span>
<span id="cb28-1636"><a href="#cb28-1636" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Densidad"</span></span>
<span id="cb28-1637"><a href="#cb28-1637" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1638"><a href="#cb28-1638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-1639"><a href="#cb28-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1640"><a href="#cb28-1640" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics_for_plot, <span class="fu">aes</span>(<span class="at">x =</span> Etapa, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb28-1641"><a href="#cb28-1641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Clustering_CI_lower, <span class="at">ymax =</span> Clustering_CI_upper), </span>
<span id="cb28-1642"><a href="#cb28-1642" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#3498db"</span>) <span class="sc">+</span></span>
<span id="cb28-1643"><a href="#cb28-1643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span>), <span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-1644"><a href="#cb28-1644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">Clustering global</span><span class="st">`</span>), <span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb28-1645"><a href="#cb28-1645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-1646"><a href="#cb28-1646" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Evolución de Clustering con IC 95%"</span>,</span>
<span id="cb28-1647"><a href="#cb28-1647" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Clustering Global"</span></span>
<span id="cb28-1648"><a href="#cb28-1648" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1649"><a href="#cb28-1649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-1650"><a href="#cb28-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1651"><a href="#cb28-1651" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Métricas de centralidad con IC</span></span>
<span id="cb28-1652"><a href="#cb28-1652" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> temporal_data_ci <span class="sc">%&gt;%</span></span>
<span id="cb28-1653"><a href="#cb28-1653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Medida <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Fuerza"</span>, <span class="st">"Intermediación"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-1654"><a href="#cb28-1654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Etapa, <span class="at">y =</span> Media, <span class="at">color =</span> Medida, <span class="at">group =</span> Medida)) <span class="sc">+</span></span>
<span id="cb28-1655"><a href="#cb28-1655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> CI_lower, <span class="at">ymax =</span> CI_upper, <span class="at">fill =</span> Medida), </span>
<span id="cb28-1656"><a href="#cb28-1656" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb28-1657"><a href="#cb28-1657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-1658"><a href="#cb28-1658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb28-1659"><a href="#cb28-1659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb28-1660"><a href="#cb28-1660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb28-1661"><a href="#cb28-1661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-1662"><a href="#cb28-1662" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Evolución de Centralidades con IC 95%"</span>,</span>
<span id="cb28-1663"><a href="#cb28-1663" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Valor"</span></span>
<span id="cb28-1664"><a href="#cb28-1664" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1665"><a href="#cb28-1665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Medida, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb28-1666"><a href="#cb28-1666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-1667"><a href="#cb28-1667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb28-1668"><a href="#cb28-1668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1669"><a href="#cb28-1669" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> p3</span>
<span id="cb28-1670"><a href="#cb28-1670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1671"><a href="#cb28-1671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1672"><a href="#cb28-1672" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparación con Modelos Nulos</span></span>
<span id="cb28-1673"><a href="#cb28-1673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1674"><a href="#cb28-1674" aria-hidden="true" tabindex="-1"></a>La comparación con modelos aleatorios de Erdős–Rényi (ER) y Barabási–Albert (BA) indicó que, en la etapa inicial, el clustering observado fue superior al esperado por ER (aprox. $z<span class="sc">\!</span>\approx<span class="sc">\!</span>2$, $p<span class="sc">\!</span>\approx<span class="sc">\!</span>0{,}049$) y marcadamente superior al de BA ($z<span class="sc">\!</span>\approx<span class="sc">\!</span>7{,}88$, $p<span class="sc">\!</span>&lt;<span class="sc">\!</span>0{,}001$). La varianza del grado también excedió lo esperable bajo ER ($z<span class="sc">\!</span>\approx<span class="sc">\!</span>4{,}54$, $p<span class="sc">\!</span>&lt;<span class="sc">\!</span>0{,}001$). Si bien a lo largo del tratamiento la mayoría de las métricas continuó diferenciándose de los modelos nulos, en las etapas de 9 y 12 meses algunas medidas dejaron de ser significativas. En términos generales, las redes tempranas exhibieron estructura no aleatoria compatible con propiedades de “pequeño mundo”, en tanto que en etapas tardías la organización se acercó más a patrones aleatorios en varios indicadores.</span>
<span id="cb28-1675"><a href="#cb28-1675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1678"><a href="#cb28-1678" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1679"><a href="#cb28-1679" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: table-null-comparison-all</span></span>
<span id="cb28-1680"><a href="#cb28-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1681"><a href="#cb28-1681" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla unificada de comparaciones</span></span>
<span id="cb28-1682"><a href="#cb28-1682" aria-hidden="true" tabindex="-1"></a>null_comparison_df <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(null_comparisons), <span class="cf">function</span>(stage) {</span>
<span id="cb28-1683"><a href="#cb28-1683" aria-hidden="true" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> null_comparisons[[stage]]</span>
<span id="cb28-1684"><a href="#cb28-1684" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(comp)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-1685"><a href="#cb28-1685" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1686"><a href="#cb28-1686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb28-1687"><a href="#cb28-1687" aria-hidden="true" tabindex="-1"></a>    <span class="at">Etapa =</span> stage,</span>
<span id="cb28-1688"><a href="#cb28-1688" aria-hidden="true" tabindex="-1"></a>    Métrica <span class="ot">=</span> <span class="fu">names</span>(comp<span class="sc">$</span>real_vals),</span>
<span id="cb28-1689"><a href="#cb28-1689" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Red Real</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>real_vals, <span class="dv">3</span>),</span>
<span id="cb28-1690"><a href="#cb28-1690" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER Z-score</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>z_scores_er, <span class="dv">2</span>),</span>
<span id="cb28-1691"><a href="#cb28-1691" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER p-value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>p_values_er, <span class="dv">4</span>),</span>
<span id="cb28-1692"><a href="#cb28-1692" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA Z-score</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>z_scores_ba, <span class="dv">2</span>),</span>
<span id="cb28-1693"><a href="#cb28-1693" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA p-value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(comp<span class="sc">$</span>p_values_ba, <span class="dv">4</span>),</span>
<span id="cb28-1694"><a href="#cb28-1694" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-1695"><a href="#cb28-1695" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1696"><a href="#cb28-1696" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-1697"><a href="#cb28-1697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1698"><a href="#cb28-1698" aria-hidden="true" tabindex="-1"></a>null_comparison_df <span class="sc">%&gt;%</span></span>
<span id="cb28-1699"><a href="#cb28-1699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb28-1700"><a href="#cb28-1700" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Comparación con modelos nulos (ER: Erdős-Rényi, BA: Barabási-Albert) - Z-scores y p-values"</span>,</span>
<span id="cb28-1701"><a href="#cb28-1701" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb28-1702"><a href="#cb28-1702" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-1703"><a href="#cb28-1703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb28-1704"><a href="#cb28-1704" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-1705"><a href="#cb28-1705" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb28-1706"><a href="#cb28-1706" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-1707"><a href="#cb28-1707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1708"><a href="#cb28-1708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">5</span>, <span class="at">color =</span> <span class="fu">ifelse</span>(null_comparison_df<span class="sc">$</span><span class="st">`</span><span class="at">ER p-value</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"red"</span>, <span class="st">"black"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-1709"><a href="#cb28-1709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">7</span>, <span class="at">color =</span> <span class="fu">ifelse</span>(null_comparison_df<span class="sc">$</span><span class="st">`</span><span class="at">BA p-value</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"red"</span>, <span class="st">"black"</span>))</span>
<span id="cb28-1710"><a href="#cb28-1710" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1711"><a href="#cb28-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1712"><a href="#cb28-1712" aria-hidden="true" tabindex="-1"></a><span class="fu">## Análisis de Nodos Puente</span></span>
<span id="cb28-1713"><a href="#cb28-1713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1714"><a href="#cb28-1714" aria-hidden="true" tabindex="-1"></a>El estudio de puentes interdominios mostró que, en la etapa inicial, **Venta de Drogas**, **Cannabis**, **Riña**, **Hurto** y **Pasta Base** concentraron la mayor influencia puente. A los 3 meses destacaron **Días Trabajo**, **Cannabis**, **Pasta Base**, **Venta de Drogas** y **Riña**; en 6 y 9 meses sobresalieron **Pasta Base**, **Cannabis**, **Hurto**, **Riña** y **Días Trabajo**; y a los 12 meses lo hicieron **Riña**, **Hurto**, **Benzodiacepinas**, **Violencia Intrafamiliar** y **Pasta Base**. Predominaron nodos de los dominios de transgresión y uso de sustancias, actuando como conectores entre las subredes de salud, funcionamiento y consumo. La recurrencia de **Pasta Base**, **Cannabis** y **Riña** sugiere blancos prioritarios para intervención.</span>
<span id="cb28-1715"><a href="#cb28-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1718"><a href="#cb28-1718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1719"><a href="#cb28-1719" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bridge-analysis-enhanced</span></span>
<span id="cb28-1720"><a href="#cb28-1720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1721"><a href="#cb28-1721" aria-hidden="true" tabindex="-1"></a>calculate_bridges <span class="ot">&lt;-</span> <span class="cf">function</span>(net, stage_name) {</span>
<span id="cb28-1722"><a href="#cb28-1722" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(net)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-1723"><a href="#cb28-1723" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1724"><a href="#cb28-1724" aria-hidden="true" tabindex="-1"></a>  node_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(net<span class="sc">$</span>graph)</span>
<span id="cb28-1725"><a href="#cb28-1725" aria-hidden="true" tabindex="-1"></a>  comm_vector <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1726"><a href="#cb28-1726" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1727"><a href="#cb28-1727" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1728"><a href="#cb28-1728" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1729"><a href="#cb28-1729" aria-hidden="true" tabindex="-1"></a>    node_names <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1730"><a href="#cb28-1730" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1731"><a href="#cb28-1731" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1732"><a href="#cb28-1732" aria-hidden="true" tabindex="-1"></a>  bridge_result <span class="ot">&lt;-</span> <span class="fu">bridge</span>(net<span class="sc">$</span>graph, <span class="at">communities =</span> comm_vector)</span>
<span id="cb28-1733"><a href="#cb28-1733" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1734"><a href="#cb28-1734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb28-1735"><a href="#cb28-1735" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Etapa</span><span class="st">`</span> <span class="ot">=</span> stage_name,</span>
<span id="cb28-1736"><a href="#cb28-1736" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Nodo</span><span class="st">`</span> <span class="ot">=</span> node_names,</span>
<span id="cb28-1737"><a href="#cb28-1737" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comunidad</span><span class="st">`</span> <span class="ot">=</span> comm_vector,</span>
<span id="cb28-1738"><a href="#cb28-1738" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Fuerza puente</span><span class="st">`</span> <span class="ot">=</span> bridge_result<span class="sc">$</span><span class="st">`</span><span class="at">Bridge Strength</span><span class="st">`</span>,</span>
<span id="cb28-1739"><a href="#cb28-1739" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span> <span class="ot">=</span> bridge_result<span class="sc">$</span><span class="st">`</span><span class="at">Bridge Expected Influence (1-step)</span><span class="st">`</span>,</span>
<span id="cb28-1740"><a href="#cb28-1740" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-1741"><a href="#cb28-1741" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1742"><a href="#cb28-1742" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1743"><a href="#cb28-1743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1744"><a href="#cb28-1744" aria-hidden="true" tabindex="-1"></a>bridge_metrics <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(networks_by_stage, <span class="fu">names</span>(networks_by_stage), </span>
<span id="cb28-1745"><a href="#cb28-1745" aria-hidden="true" tabindex="-1"></a>                          calculate_bridges)</span>
<span id="cb28-1746"><a href="#cb28-1746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1747"><a href="#cb28-1747" aria-hidden="true" tabindex="-1"></a><span class="co"># Top 5 nodos puente por etapa</span></span>
<span id="cb28-1748"><a href="#cb28-1748" aria-hidden="true" tabindex="-1"></a>bridge_metrics <span class="sc">%&gt;%</span></span>
<span id="cb28-1749"><a href="#cb28-1749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1750"><a href="#cb28-1750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">5</span>, <span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1751"><a href="#cb28-1751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="st">`</span><span class="at">Etapa</span><span class="st">`</span>, <span class="fu">desc</span>(<span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-1752"><a href="#cb28-1752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Top 5 nodos puente por etapa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1753"><a href="#cb28-1753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1754"><a href="#cb28-1754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1755"><a href="#cb28-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1756"><a href="#cb28-1756" aria-hidden="true" tabindex="-1"></a><span class="fu">## Redes de Cambio</span></span>
<span id="cb28-1757"><a href="#cb28-1757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1758"><a href="#cb28-1758" aria-hidden="true" tabindex="-1"></a>Se estimaron redes de cambio (deltas apareados) para las transiciones Inicio→3m, 3m→6m y 6m→12 m con muestras pareadas de 37,111, 22,583 y 8,193 pacientes, respectivamente. Estas redes capturan incrementos o decrementos conjuntos entre ítems, de modo que sus aristas reflejan co-variaciones de cambio más que estados absolutos. En términos cualitativos, se observó una reducción de vínculos entre ítems de uso y transgresión y un incremento relativo de conexiones vinculadas al dominio de funcionamiento.</span>
<span id="cb28-1759"><a href="#cb28-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1762"><a href="#cb28-1762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1763"><a href="#cb28-1763" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: change-networks</span></span>
<span id="cb28-1764"><a href="#cb28-1764" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb28-1765"><a href="#cb28-1765" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb28-1766"><a href="#cb28-1766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1767"><a href="#cb28-1767" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular cambios entre etapas</span></span>
<span id="cb28-1768"><a href="#cb28-1768" aria-hidden="true" tabindex="-1"></a>calculate_changes <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes) {</span>
<span id="cb28-1769"><a href="#cb28-1769" aria-hidden="true" tabindex="-1"></a>  has_stage1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-1770"><a href="#cb28-1770" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb28-1771"><a href="#cb28-1771" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-1772"><a href="#cb28-1772" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-1773"><a href="#cb28-1773" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb28-1774"><a href="#cb28-1774" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1775"><a href="#cb28-1775" aria-hidden="true" tabindex="-1"></a>  has_stage2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-1776"><a href="#cb28-1776" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb28-1777"><a href="#cb28-1777" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-1778"><a href="#cb28-1778" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-1779"><a href="#cb28-1779" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb28-1780"><a href="#cb28-1780" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1781"><a href="#cb28-1781" aria-hidden="true" tabindex="-1"></a>  ids_both <span class="ot">&lt;-</span> <span class="fu">intersect</span>(has_stage1, has_stage2)</span>
<span id="cb28-1782"><a href="#cb28-1782" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1783"><a href="#cb28-1783" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(ids_both) <span class="sc">&lt;</span> <span class="dv">30</span>) {</span>
<span id="cb28-1784"><a href="#cb28-1784" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-1785"><a href="#cb28-1785" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1786"><a href="#cb28-1786" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1787"><a href="#cb28-1787" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-1788"><a href="#cb28-1788" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb28-1789"><a href="#cb28-1789" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-1790"><a href="#cb28-1790" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1791"><a href="#cb28-1791" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-1792"><a href="#cb28-1792" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-1793"><a href="#cb28-1793" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb28-1794"><a href="#cb28-1794" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1795"><a href="#cb28-1795" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-1796"><a href="#cb28-1796" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb28-1797"><a href="#cb28-1797" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-1798"><a href="#cb28-1798" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1799"><a href="#cb28-1799" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-1800"><a href="#cb28-1800" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-1801"><a href="#cb28-1801" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb28-1802"><a href="#cb28-1802" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1803"><a href="#cb28-1803" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(d1) <span class="sc">!=</span> <span class="fu">nrow</span>(d2) <span class="sc">||</span> <span class="sc">!</span><span class="fu">identical</span>(d1<span class="sc">$</span>HASHKEY, d2<span class="sc">$</span>HASHKEY)) {</span>
<span id="cb28-1804"><a href="#cb28-1804" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-1805"><a href="#cb28-1805" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1806"><a href="#cb28-1806" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1807"><a href="#cb28-1807" aria-hidden="true" tabindex="-1"></a>  changes <span class="ot">&lt;-</span> d2[, <span class="sc">-</span><span class="dv">1</span>] <span class="sc">-</span> d1[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb28-1808"><a href="#cb28-1808" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1809"><a href="#cb28-1809" aria-hidden="true" tabindex="-1"></a>  change_net <span class="ot">&lt;-</span> <span class="fu">estimateNetwork</span>(</span>
<span id="cb28-1810"><a href="#cb28-1810" aria-hidden="true" tabindex="-1"></a>    changes <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>])),</span>
<span id="cb28-1811"><a href="#cb28-1811" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"EBICglasso"</span>,</span>
<span id="cb28-1812"><a href="#cb28-1812" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuning =</span> <span class="fl">0.5</span></span>
<span id="cb28-1813"><a href="#cb28-1813" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1814"><a href="#cb28-1814" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1815"><a href="#cb28-1815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">network =</span> change_net, <span class="at">n =</span> <span class="fu">nrow</span>(d1), <span class="at">data =</span> changes)</span>
<span id="cb28-1816"><a href="#cb28-1816" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1817"><a href="#cb28-1817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1818"><a href="#cb28-1818" aria-hidden="true" tabindex="-1"></a>transitions <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb28-1819"><a href="#cb28-1819" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Inicio→3m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"3m"</span>, nodes_all),</span>
<span id="cb28-1820"><a href="#cb28-1820" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3m→6m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"3m"</span>, <span class="st">"6m"</span>, nodes_all),</span>
<span id="cb28-1821"><a href="#cb28-1821" aria-hidden="true" tabindex="-1"></a>  <span class="st">"6m→12m"</span> <span class="ot">=</span> <span class="fu">calculate_changes</span>(dat_analysis, <span class="st">"6m"</span>, <span class="st">"12m"</span>, nodes_all)</span>
<span id="cb28-1822"><a href="#cb28-1822" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1823"><a href="#cb28-1823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1824"><a href="#cb28-1824" aria-hidden="true" tabindex="-1"></a>transition_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-1825"><a href="#cb28-1825" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Transición</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">names</span>(transitions),</span>
<span id="cb28-1826"><a href="#cb28-1826" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N pacientes</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(transitions, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x), <span class="dv">0</span>, x<span class="sc">$</span>n)),</span>
<span id="cb28-1827"><a href="#cb28-1827" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Red estimada</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(transitions, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x), <span class="st">"No"</span>, <span class="st">"Sí"</span>)),</span>
<span id="cb28-1828"><a href="#cb28-1828" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-1829"><a href="#cb28-1829" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1830"><a href="#cb28-1830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1831"><a href="#cb28-1831" aria-hidden="true" tabindex="-1"></a>transition_summary <span class="sc">%&gt;%</span></span>
<span id="cb28-1832"><a href="#cb28-1832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Resumen de redes de cambio"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1833"><a href="#cb28-1833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1834"><a href="#cb28-1834" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1835"><a href="#cb28-1835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1836"><a href="#cb28-1836" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización Red de Cambios: Inicio → 3 meses</span></span>
<span id="cb28-1837"><a href="#cb28-1837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1840"><a href="#cb28-1840" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1841"><a href="#cb28-1841" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: change-network-inicio-3m</span></span>
<span id="cb28-1842"><a href="#cb28-1842" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1843"><a href="#cb28-1843" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1844"><a href="#cb28-1844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1845"><a href="#cb28-1845" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"Inicio→3m"</span>]]</span>
<span id="cb28-1846"><a href="#cb28-1846" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb28-1847"><a href="#cb28-1847" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1848"><a href="#cb28-1848" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1849"><a href="#cb28-1849" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1850"><a href="#cb28-1850" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1851"><a href="#cb28-1851" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1852"><a href="#cb28-1852" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb28-1853"><a href="#cb28-1853" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1854"><a href="#cb28-1854" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1855"><a href="#cb28-1855" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1856"><a href="#cb28-1856" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1857"><a href="#cb28-1857" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1858"><a href="#cb28-1858" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-1859"><a href="#cb28-1859" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1860"><a href="#cb28-1860" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1861"><a href="#cb28-1861" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb28-1862"><a href="#cb28-1862" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1863"><a href="#cb28-1863" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1864"><a href="#cb28-1864" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1865"><a href="#cb28-1865" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1866"><a href="#cb28-1866" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1867"><a href="#cb28-1867" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1868"><a href="#cb28-1868" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1869"><a href="#cb28-1869" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1870"><a href="#cb28-1870" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1871"><a href="#cb28-1871" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb28-1872"><a href="#cb28-1872" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1873"><a href="#cb28-1873" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb28-1874"><a href="#cb28-1874" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb28-1875"><a href="#cb28-1875" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1876"><a href="#cb28-1876" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1877"><a href="#cb28-1877" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1878"><a href="#cb28-1878" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1879"><a href="#cb28-1879" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1880"><a href="#cb28-1880" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1881"><a href="#cb28-1881" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb28-1882"><a href="#cb28-1882" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1883"><a href="#cb28-1883" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: Inicio → 3 meses"</span>,</span>
<span id="cb28-1884"><a href="#cb28-1884" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb28-1885"><a href="#cb28-1885" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1886"><a href="#cb28-1886" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1887"><a href="#cb28-1887" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1888"><a href="#cb28-1888" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-1889"><a href="#cb28-1889" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1890"><a href="#cb28-1890" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1891"><a href="#cb28-1891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1892"><a href="#cb28-1892" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización Red de Cambios: 3 → 6 meses</span></span>
<span id="cb28-1893"><a href="#cb28-1893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1896"><a href="#cb28-1896" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1897"><a href="#cb28-1897" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: change-network-3m-6m</span></span>
<span id="cb28-1898"><a href="#cb28-1898" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1899"><a href="#cb28-1899" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1900"><a href="#cb28-1900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1901"><a href="#cb28-1901" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"3m→6m"</span>]]</span>
<span id="cb28-1902"><a href="#cb28-1902" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb28-1903"><a href="#cb28-1903" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1904"><a href="#cb28-1904" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1905"><a href="#cb28-1905" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1906"><a href="#cb28-1906" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1907"><a href="#cb28-1907" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1908"><a href="#cb28-1908" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb28-1909"><a href="#cb28-1909" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1910"><a href="#cb28-1910" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1911"><a href="#cb28-1911" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1912"><a href="#cb28-1912" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1913"><a href="#cb28-1913" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1914"><a href="#cb28-1914" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-1915"><a href="#cb28-1915" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1916"><a href="#cb28-1916" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1917"><a href="#cb28-1917" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb28-1918"><a href="#cb28-1918" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1919"><a href="#cb28-1919" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1920"><a href="#cb28-1920" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1921"><a href="#cb28-1921" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1922"><a href="#cb28-1922" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1923"><a href="#cb28-1923" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1924"><a href="#cb28-1924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1925"><a href="#cb28-1925" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1926"><a href="#cb28-1926" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1927"><a href="#cb28-1927" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb28-1928"><a href="#cb28-1928" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1929"><a href="#cb28-1929" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb28-1930"><a href="#cb28-1930" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb28-1931"><a href="#cb28-1931" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1932"><a href="#cb28-1932" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1933"><a href="#cb28-1933" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1934"><a href="#cb28-1934" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1935"><a href="#cb28-1935" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1936"><a href="#cb28-1936" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1937"><a href="#cb28-1937" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb28-1938"><a href="#cb28-1938" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1939"><a href="#cb28-1939" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: 3 → 6 meses"</span>,</span>
<span id="cb28-1940"><a href="#cb28-1940" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb28-1941"><a href="#cb28-1941" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1942"><a href="#cb28-1942" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1943"><a href="#cb28-1943" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1944"><a href="#cb28-1944" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-1945"><a href="#cb28-1945" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1946"><a href="#cb28-1946" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1947"><a href="#cb28-1947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1948"><a href="#cb28-1948" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualización Red de Cambios: 6 → 12 meses</span></span>
<span id="cb28-1949"><a href="#cb28-1949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1952"><a href="#cb28-1952" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1953"><a href="#cb28-1953" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: change-network-6m-12m</span></span>
<span id="cb28-1954"><a href="#cb28-1954" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb28-1955"><a href="#cb28-1955" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb28-1956"><a href="#cb28-1956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1957"><a href="#cb28-1957" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> transitions[[<span class="st">"6m→12m"</span>]]</span>
<span id="cb28-1958"><a href="#cb28-1958" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trans)) {</span>
<span id="cb28-1959"><a href="#cb28-1959" aria-hidden="true" tabindex="-1"></a>  g_for_layout <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(<span class="fu">abs</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph), <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-1960"><a href="#cb28-1960" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1961"><a href="#cb28-1961" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">as_tbl_graph</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1962"><a href="#cb28-1962" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1963"><a href="#cb28-1963" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-1964"><a href="#cb28-1964" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">colnames</span>(trans<span class="sc">$</span>network<span class="sc">$</span>graph),</span>
<span id="cb28-1965"><a href="#cb28-1965" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-1966"><a href="#cb28-1966" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_uso <span class="sc">~</span> <span class="st">"Uso sustancias"</span>,</span>
<span id="cb28-1967"><a href="#cb28-1967" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_transgresion <span class="sc">~</span> <span class="st">"Transgresión"</span>,</span>
<span id="cb28-1968"><a href="#cb28-1968" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_salud <span class="sc">~</span> <span class="st">"Salud"</span>,</span>
<span id="cb28-1969"><a href="#cb28-1969" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">%in%</span> vars_funcionamiento <span class="sc">~</span> <span class="st">"Funcionamiento"</span></span>
<span id="cb28-1970"><a href="#cb28-1970" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-1971"><a href="#cb28-1971" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1972"><a href="#cb28-1972" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1973"><a href="#cb28-1973" aria-hidden="true" tabindex="-1"></a>  layout_coords <span class="ot">&lt;-</span> <span class="fu">create_layout</span>(g_for_layout, <span class="at">layout =</span> <span class="st">'fr'</span>)</span>
<span id="cb28-1974"><a href="#cb28-1974" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1975"><a href="#cb28-1975" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> g <span class="sc">%&gt;%</span></span>
<span id="cb28-1976"><a href="#cb28-1976" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb28-1977"><a href="#cb28-1977" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> layout_coords<span class="sc">$</span>x[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)],</span>
<span id="cb28-1978"><a href="#cb28-1978" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> layout_coords<span class="sc">$</span>y[<span class="dv">1</span><span class="sc">:</span><span class="fu">vcount</span>(.)])</span>
<span id="cb28-1979"><a href="#cb28-1979" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1980"><a href="#cb28-1980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggraph</span>(g, <span class="at">layout =</span> <span class="st">'manual'</span>, <span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb28-1981"><a href="#cb28-1981" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">width =</span> <span class="fu">abs</span>(weight), </span>
<span id="cb28-1982"><a href="#cb28-1982" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fu">abs</span>(weight),</span>
<span id="cb28-1983"><a href="#cb28-1983" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Aumento"</span>, <span class="st">"Disminución"</span>)),</span>
<span id="cb28-1984"><a href="#cb28-1984" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb28-1985"><a href="#cb28-1985" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> domain), </span>
<span id="cb28-1986"><a href="#cb28-1986" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">10</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb28-1987"><a href="#cb28-1987" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_node_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">12</span>)), </span>
<span id="cb28-1988"><a href="#cb28-1988" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb28-1989"><a href="#cb28-1989" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_width_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1990"><a href="#cb28-1990" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.8</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-1991"><a href="#cb28-1991" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_edge_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Aumento"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, </span>
<span id="cb28-1992"><a href="#cb28-1992" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Disminución"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb28-1993"><a href="#cb28-1993" aria-hidden="true" tabindex="-1"></a>                            <span class="at">name =</span> <span class="st">"Tipo de cambio"</span>) <span class="sc">+</span></span>
<span id="cb28-1994"><a href="#cb28-1994" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Dominio"</span>) <span class="sc">+</span></span>
<span id="cb28-1995"><a href="#cb28-1995" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Red de cambios: 6 → 12 meses"</span>,</span>
<span id="cb28-1996"><a href="#cb28-1996" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"N ="</span>, trans<span class="sc">$</span>n, <span class="st">"pacientes pareados"</span>)) <span class="sc">+</span></span>
<span id="cb28-1997"><a href="#cb28-1997" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-1998"><a href="#cb28-1998" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1999"><a href="#cb28-1999" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-2000"><a href="#cb28-2000" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-2001"><a href="#cb28-2001" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2002"><a href="#cb28-2002" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-2003"><a href="#cb28-2003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2004"><a href="#cb28-2004" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparación de Redes (NCT)</span></span>
<span id="cb28-2005"><a href="#cb28-2005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2006"><a href="#cb28-2006" aria-hidden="true" tabindex="-1"></a>La prueba de comparación de redes mostró diferencias estadísticamente significativas tanto en la fuerza global como en la estructura entre la red inicial y las redes de seguimiento. La comparación Inicio vs 6 meses arrojó una diferencia de fuerza global de 0,591 ($p=0{,}002$) y de estructura de 0,082 ($p=0{,}002$); y la comparación Inicio vs 12 meses, de 0,829 ($p=0{,}002$) en fuerza y 0,262 ($p=0{,}002$) en estructura. Estas evidencias confirman que, además de perder enlaces, la red reorganiza su arquitectura a medida que progresa el tratamiento.</span>
<span id="cb28-2007"><a href="#cb28-2007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2010"><a href="#cb28-2010" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-2011"><a href="#cb28-2011" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nct-analysis-enhanced</span></span>
<span id="cb28-2012"><a href="#cb28-2012" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb28-2013"><a href="#cb28-2013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2014"><a href="#cb28-2014" aria-hidden="true" tabindex="-1"></a>perform_nct <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes, <span class="at">iterations =</span> <span class="dv">1000</span>) {</span>
<span id="cb28-2015"><a href="#cb28-2015" aria-hidden="true" tabindex="-1"></a>  data1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-2016"><a href="#cb28-2016" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb28-2017"><a href="#cb28-2017" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb28-2018"><a href="#cb28-2018" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-2019"><a href="#cb28-2019" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb28-2020"><a href="#cb28-2020" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2021"><a href="#cb28-2021" aria-hidden="true" tabindex="-1"></a>  data2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-2022"><a href="#cb28-2022" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb28-2023"><a href="#cb28-2023" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(nodes)) <span class="sc">%&gt;%</span></span>
<span id="cb28-2024"><a href="#cb28-2024" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-2025"><a href="#cb28-2025" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">scale</span>(.)[,<span class="dv">1</span>]))</span>
<span id="cb28-2026"><a href="#cb28-2026" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2027"><a href="#cb28-2027" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(data1) <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">||</span> <span class="fu">nrow</span>(data2) <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-2028"><a href="#cb28-2028" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2029"><a href="#cb28-2029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NCT</span>(data1, data2, </span>
<span id="cb28-2030"><a href="#cb28-2030" aria-hidden="true" tabindex="-1"></a>      <span class="at">it =</span> iterations,</span>
<span id="cb28-2031"><a href="#cb28-2031" aria-hidden="true" tabindex="-1"></a>      <span class="at">binary.data =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-2032"><a href="#cb28-2032" aria-hidden="true" tabindex="-1"></a>      <span class="at">paired =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-2033"><a href="#cb28-2033" aria-hidden="true" tabindex="-1"></a>      <span class="at">test.edges =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-2034"><a href="#cb28-2034" aria-hidden="true" tabindex="-1"></a>      <span class="at">edges =</span> <span class="st">"all"</span>,</span>
<span id="cb28-2035"><a href="#cb28-2035" aria-hidden="true" tabindex="-1"></a>      <span class="at">progressbar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-2036"><a href="#cb28-2036" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2037"><a href="#cb28-2037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2038"><a href="#cb28-2038" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparaciones clave</span></span>
<span id="cb28-2039"><a href="#cb28-2039" aria-hidden="true" tabindex="-1"></a>nct_inicio_6m <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb28-2040"><a href="#cb28-2040" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perform_nct</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"6m"</span>, nodes_all, <span class="dv">500</span>),</span>
<span id="cb28-2041"><a href="#cb28-2041" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb28-2042"><a href="#cb28-2042" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-2043"><a href="#cb28-2043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2044"><a href="#cb28-2044" aria-hidden="true" tabindex="-1"></a>nct_inicio_12m <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb28-2045"><a href="#cb28-2045" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perform_nct</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"12m"</span>, nodes_all, <span class="dv">500</span>),</span>
<span id="cb28-2046"><a href="#cb28-2046" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb28-2047"><a href="#cb28-2047" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-2048"><a href="#cb28-2048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2049"><a href="#cb28-2049" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados NCT</span></span>
<span id="cb28-2050"><a href="#cb28-2050" aria-hidden="true" tabindex="-1"></a>nct_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-2051"><a href="#cb28-2051" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb28-2052"><a href="#cb28-2052" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb28-2053"><a href="#cb28-2053" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb28-2054"><a href="#cb28-2054" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb28-2055"><a href="#cb28-2055" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb28-2056"><a href="#cb28-2056" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-2057"><a href="#cb28-2057" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2058"><a href="#cb28-2058" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-2059"><a href="#cb28-2059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2060"><a href="#cb28-2060" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_6m)) {</span>
<span id="cb28-2061"><a href="#cb28-2061" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nct_results, <span class="fu">data.frame</span>(</span>
<span id="cb28-2062"><a href="#cb28-2062" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Inicio vs 6 meses"</span>,</span>
<span id="cb28-2063"><a href="#cb28-2063" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>glstrinv.real,</span>
<span id="cb28-2064"><a href="#cb28-2064" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>glstrinv.pval,</span>
<span id="cb28-2065"><a href="#cb28-2065" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>nwinv.real,</span>
<span id="cb28-2066"><a href="#cb28-2066" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_6m<span class="sc">$</span>nwinv.pval,</span>
<span id="cb28-2067"><a href="#cb28-2067" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2068"><a href="#cb28-2068" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-2069"><a href="#cb28-2069" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2070"><a href="#cb28-2070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2071"><a href="#cb28-2071" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_12m)) {</span>
<span id="cb28-2072"><a href="#cb28-2072" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nct_results, <span class="fu">data.frame</span>(</span>
<span id="cb28-2073"><a href="#cb28-2073" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Comparación</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Inicio vs 12 meses"</span>,</span>
<span id="cb28-2074"><a href="#cb28-2074" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia fuerza global</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>glstrinv.real,</span>
<span id="cb28-2075"><a href="#cb28-2075" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value fuerza</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>glstrinv.pval,</span>
<span id="cb28-2076"><a href="#cb28-2076" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Diferencia estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>nwinv.real,</span>
<span id="cb28-2077"><a href="#cb28-2077" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value estructura</span><span class="st">`</span> <span class="ot">=</span> nct_inicio_12m<span class="sc">$</span>nwinv.pval,</span>
<span id="cb28-2078"><a href="#cb28-2078" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2079"><a href="#cb28-2079" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-2080"><a href="#cb28-2080" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2081"><a href="#cb28-2081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2082"><a href="#cb28-2082" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(nct_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-2083"><a href="#cb28-2083" aria-hidden="true" tabindex="-1"></a>  nct_results <span class="sc">%&gt;%</span></span>
<span id="cb28-2084"><a href="#cb28-2084" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Resultados del Network Comparison Test"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2085"><a href="#cb28-2085" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-2086"><a href="#cb28-2086" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2087"><a href="#cb28-2087" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-2088"><a href="#cb28-2088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2089"><a href="#cb28-2089" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modelos Mixtos Lineales</span></span>
<span id="cb28-2090"><a href="#cb28-2090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2091"><a href="#cb28-2091" aria-hidden="true" tabindex="-1"></a>El **Modelo 1** (resultado: salud psicológica) indicó un intercepto inicial alto (12,262) y un efecto positivo del tiempo (0,326), consistente con mejorías a lo largo del seguimiento. El consumo de alcohol, cannabis, cocaína y pasta base, así como la participación en riñas y la violencia intrafamiliar, se asociaron negativamente con la salud psicológica; las interacciones con el tiempo fueron negativas y de menor magnitud, sugiriendo que el impacto adverso de estos factores tiende a atenuarse. El **Modelo 2** (resultado: calidad de vida) mostró asociaciones positivas de la calidad de vida con salud psicológica y física, y con los días de trabajo y educación. El tiempo tuvo un efecto ligeramente negativo (–0,017), mientras que las interacciones tiempo×salud fueron positivas y las interacciones tiempo×participación (trabajo/educación) resultaron negativas pero pequeñas. En conjunto, los modelos respaldan que mejorar salud y participación social se traduce en mejor calidad de vida durante la rehabilitación, con rendimientos marginales que pueden variar con el tiempo.</span>
<span id="cb28-2092"><a href="#cb28-2092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2093"><a href="#cb28-2093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2096"><a href="#cb28-2096" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-2097"><a href="#cb28-2097" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mixed-models</span></span>
<span id="cb28-2098"><a href="#cb28-2098" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-2099"><a href="#cb28-2099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2100"><a href="#cb28-2100" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos en formato largo para modelos mixtos</span></span>
<span id="cb28-2101"><a href="#cb28-2101" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> dat_analysis <span class="sc">%&gt;%</span></span>
<span id="cb28-2102"><a href="#cb28-2102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(tiempo_num)) <span class="sc">%&gt;%</span></span>
<span id="cb28-2103"><a href="#cb28-2103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-2104"><a href="#cb28-2104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Solo pacientes con al menos 2 mediciones</span></span>
<span id="cb28-2105"><a href="#cb28-2105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-2106"><a href="#cb28-2106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2107"><a href="#cb28-2107" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 1: Predictores de salud psicológica</span></span>
<span id="cb28-2108"><a href="#cb28-2108" aria-hidden="true" tabindex="-1"></a>model_salud_psic <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb28-2109"><a href="#cb28-2109" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb28-2110"><a href="#cb28-2110" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (Alcohol <span class="sc">+</span> Cannabis <span class="sc">+</span> </span>
<span id="cb28-2111"><a href="#cb28-2111" aria-hidden="true" tabindex="-1"></a>                                      Cocaína <span class="sc">+</span> <span class="st">`</span><span class="at">Pasta Base</span><span class="st">`</span> <span class="sc">+</span></span>
<span id="cb28-2112"><a href="#cb28-2112" aria-hidden="true" tabindex="-1"></a>                                      Riña <span class="sc">+</span> <span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb28-2113"><a href="#cb28-2113" aria-hidden="true" tabindex="-1"></a>                        (<span class="dv">1</span> <span class="sc">+</span> tiempo_num <span class="sc">|</span> HASHKEY),</span>
<span id="cb28-2114"><a href="#cb28-2114" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_long,</span>
<span id="cb28-2115"><a href="#cb28-2115" aria-hidden="true" tabindex="-1"></a>    <span class="at">REML =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-2116"><a href="#cb28-2116" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>, <span class="at">optCtrl =</span> <span class="fu">list</span>(<span class="at">maxfun =</span> <span class="fl">2e5</span>))</span>
<span id="cb28-2117"><a href="#cb28-2117" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-2118"><a href="#cb28-2118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2119"><a href="#cb28-2119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar convergencia y singularidad</span></span>
<span id="cb28-2120"><a href="#cb28-2120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">isSingular</span>(mod)) {</span>
<span id="cb28-2121"><a href="#cb28-2121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplificar a solo intercepto aleatorio</span></span>
<span id="cb28-2122"><a href="#cb28-2122" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb28-2123"><a href="#cb28-2123" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (Alcohol <span class="sc">+</span> Cannabis <span class="sc">+</span> </span>
<span id="cb28-2124"><a href="#cb28-2124" aria-hidden="true" tabindex="-1"></a>                                        Cocaína <span class="sc">+</span> <span class="st">`</span><span class="at">Pasta Base</span><span class="st">`</span> <span class="sc">+</span></span>
<span id="cb28-2125"><a href="#cb28-2125" aria-hidden="true" tabindex="-1"></a>                                        Riña <span class="sc">+</span> <span class="st">`</span><span class="at">Violencia Intrafamiliar</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb28-2126"><a href="#cb28-2126" aria-hidden="true" tabindex="-1"></a>                          (<span class="dv">1</span> <span class="sc">|</span> HASHKEY),</span>
<span id="cb28-2127"><a href="#cb28-2127" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat_long,</span>
<span id="cb28-2128"><a href="#cb28-2128" aria-hidden="true" tabindex="-1"></a>      <span class="at">REML =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2129"><a href="#cb28-2129" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-2130"><a href="#cb28-2130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-2131"><a href="#cb28-2131" aria-hidden="true" tabindex="-1"></a>  mod</span>
<span id="cb28-2132"><a href="#cb28-2132" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb28-2133"><a href="#cb28-2133" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb28-2134"><a href="#cb28-2134" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-2135"><a href="#cb28-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2136"><a href="#cb28-2136" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 2: Predictores de calidad de vida</span></span>
<span id="cb28-2137"><a href="#cb28-2137" aria-hidden="true" tabindex="-1"></a>model_calidad <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb28-2138"><a href="#cb28-2138" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Calidad de Vida</span><span class="st">`</span> <span class="sc">~</span> tiempo_num <span class="sc">*</span> (<span class="st">`</span><span class="at">Salud Psicológica</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">Salud Física</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb28-2139"><a href="#cb28-2139" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">Días Trabajo</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">Días Educación</span><span class="st">`</span>) <span class="sc">+</span> </span>
<span id="cb28-2140"><a href="#cb28-2140" aria-hidden="true" tabindex="-1"></a>                   (<span class="dv">1</span> <span class="sc">+</span> tiempo_num <span class="sc">|</span> HASHKEY),</span>
<span id="cb28-2141"><a href="#cb28-2141" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat_long,</span>
<span id="cb28-2142"><a href="#cb28-2142" aria-hidden="true" tabindex="-1"></a>  <span class="at">REML =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2143"><a href="#cb28-2143" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-2144"><a href="#cb28-2144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2145"><a href="#cb28-2145" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados Modelo 1</span></span>
<span id="cb28-2146"><a href="#cb28-2146" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model_salud_psic)) {</span>
<span id="cb28-2147"><a href="#cb28-2147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Procesar resultados y traducir nombres</span></span>
<span id="cb28-2148"><a href="#cb28-2148" aria-hidden="true" tabindex="-1"></a>  tabla_modelo1 <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_salud_psic) <span class="sc">%&gt;%</span></span>
<span id="cb28-2149"><a href="#cb28-2149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2150"><a href="#cb28-2150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>effect, <span class="sc">-</span>group) <span class="sc">%&gt;%</span></span>
<span id="cb28-2151"><a href="#cb28-2151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-2152"><a href="#cb28-2152" aria-hidden="true" tabindex="-1"></a>      <span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2153"><a href="#cb28-2153" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercepto"</span>,</span>
<span id="cb28-2154"><a href="#cb28-2154" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"tiempo_num"</span> <span class="sc">~</span> <span class="st">"Tiempo (meses)"</span>,</span>
<span id="cb28-2155"><a href="#cb28-2155" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Alcohol"</span> <span class="sc">~</span> <span class="st">"Alcohol"</span>,</span>
<span id="cb28-2156"><a href="#cb28-2156" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Cannabis"</span> <span class="sc">~</span> <span class="st">"Cannabis"</span>,</span>
<span id="cb28-2157"><a href="#cb28-2157" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Cocaína"</span> <span class="sc">~</span> <span class="st">"Cocaína"</span>,</span>
<span id="cb28-2158"><a href="#cb28-2158" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"`Pasta Base`"</span> <span class="sc">~</span> <span class="st">"Pasta Base"</span>,</span>
<span id="cb28-2159"><a href="#cb28-2159" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"Riña"</span> <span class="sc">~</span> <span class="st">"Riña"</span>,</span>
<span id="cb28-2160"><a href="#cb28-2160" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">==</span> <span class="st">"`Violencia Intrafamiliar`"</span> <span class="sc">~</span> <span class="st">"Violencia Intrafamiliar"</span>,</span>
<span id="cb28-2161"><a href="#cb28-2161" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Alcohol"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Alcohol"</span>,</span>
<span id="cb28-2162"><a href="#cb28-2162" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Cannabis"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Cannabis"</span>,</span>
<span id="cb28-2163"><a href="#cb28-2163" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Cocaína"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Cocaína"</span>,</span>
<span id="cb28-2164"><a href="#cb28-2164" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Pasta Base`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Pasta Base"</span>,</span>
<span id="cb28-2165"><a href="#cb28-2165" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:Riña"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Riña"</span>,</span>
<span id="cb28-2166"><a href="#cb28-2166" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Violencia"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Violencia Intrafamiliar"</span>,</span>
<span id="cb28-2167"><a href="#cb28-2167" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb28-2168"><a href="#cb28-2168" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-2169"><a href="#cb28-2169" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))</span>
<span id="cb28-2170"><a href="#cb28-2170" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-2171"><a href="#cb28-2171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2172"><a href="#cb28-2172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Renombrar columnas al español</span></span>
<span id="cb28-2173"><a href="#cb28-2173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(tabla_modelo1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Estimación"</span>, <span class="st">"Error estándar"</span>, </span>
<span id="cb28-2174"><a href="#cb28-2174" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Estadístico"</span>, <span class="st">"GL"</span>, <span class="st">"Valor p"</span>)</span>
<span id="cb28-2175"><a href="#cb28-2175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2176"><a href="#cb28-2176" aria-hidden="true" tabindex="-1"></a>  tabla_modelo1 <span class="sc">%&gt;%</span></span>
<span id="cb28-2177"><a href="#cb28-2177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Modelo: Predictores de salud psicológica"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2178"><a href="#cb28-2178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-2179"><a href="#cb28-2179" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2180"><a href="#cb28-2180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2181"><a href="#cb28-2181" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla de resultados Modelo 2</span></span>
<span id="cb28-2182"><a href="#cb28-2182" aria-hidden="true" tabindex="-1"></a>tabla_modelo2 <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_calidad) <span class="sc">%&gt;%</span></span>
<span id="cb28-2183"><a href="#cb28-2183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2184"><a href="#cb28-2184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>effect, <span class="sc">-</span>group) <span class="sc">%&gt;%</span></span>
<span id="cb28-2185"><a href="#cb28-2185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-2186"><a href="#cb28-2186" aria-hidden="true" tabindex="-1"></a>    <span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2187"><a href="#cb28-2187" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercepto"</span>,</span>
<span id="cb28-2188"><a href="#cb28-2188" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"tiempo_num"</span> <span class="sc">~</span> <span class="st">"Tiempo (meses)"</span>,</span>
<span id="cb28-2189"><a href="#cb28-2189" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Salud Psicológica`"</span> <span class="sc">~</span> <span class="st">"Salud Psicológica"</span>,</span>
<span id="cb28-2190"><a href="#cb28-2190" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Salud Física`"</span> <span class="sc">~</span> <span class="st">"Salud Física"</span>,</span>
<span id="cb28-2191"><a href="#cb28-2191" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Días Trabajo`"</span> <span class="sc">~</span> <span class="st">"Días Trabajo"</span>,</span>
<span id="cb28-2192"><a href="#cb28-2192" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"`Días Educación`"</span> <span class="sc">~</span> <span class="st">"Días Educación"</span>,</span>
<span id="cb28-2193"><a href="#cb28-2193" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Salud Psicológica`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Salud Psicológica"</span>,</span>
<span id="cb28-2194"><a href="#cb28-2194" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Salud Física`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Salud Física"</span>,</span>
<span id="cb28-2195"><a href="#cb28-2195" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Días Trabajo`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Días Trabajo"</span>,</span>
<span id="cb28-2196"><a href="#cb28-2196" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(term, <span class="st">"tiempo_num:`Días Educación`"</span>) <span class="sc">~</span> <span class="st">"Tiempo × Días Educación"</span>,</span>
<span id="cb28-2197"><a href="#cb28-2197" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb28-2198"><a href="#cb28-2198" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-2199"><a href="#cb28-2199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))</span>
<span id="cb28-2200"><a href="#cb28-2200" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-2201"><a href="#cb28-2201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2202"><a href="#cb28-2202" aria-hidden="true" tabindex="-1"></a><span class="co"># Renombrar columnas al español</span></span>
<span id="cb28-2203"><a href="#cb28-2203" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tabla_modelo2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Estimación"</span>, <span class="st">"Error estándar"</span>, </span>
<span id="cb28-2204"><a href="#cb28-2204" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"Estadístico"</span>, <span class="st">"GL"</span>, <span class="st">"Valor p"</span>)</span>
<span id="cb28-2205"><a href="#cb28-2205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2206"><a href="#cb28-2206" aria-hidden="true" tabindex="-1"></a>tabla_modelo2 <span class="sc">%&gt;%</span></span>
<span id="cb28-2207"><a href="#cb28-2207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Modelo: Predictores de calidad de vida"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2208"><a href="#cb28-2208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-2209"><a href="#cb28-2209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-2210"><a href="#cb28-2210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2211"><a href="#cb28-2211" aria-hidden="true" tabindex="-1"></a><span class="fu">## Análisis Cross-Lagged</span></span>
<span id="cb28-2212"><a href="#cb28-2212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2213"><a href="#cb28-2213" aria-hidden="true" tabindex="-1"></a>Las correlaciones cruzadas entre etapas consecutivas sugirieron persistencia de asociaciones entre indicadores de uso/transgresión y desenlaces de salud/funcionamiento. De manera ilustrativa, niveles altos de **Pasta Base** al inicio tendieron a relacionarse con problemas de transgresión posteriores, mientras que mejoras en **Días Trabajo** precedieron mejoras en la salud psicológica. Este enfoque complementa a los modelos mixtos al explorar direccionalidad potencial, más allá de la asociación contemporánea.</span>
<span id="cb28-2214"><a href="#cb28-2214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2217"><a href="#cb28-2217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-2218"><a href="#cb28-2218" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cross-lagged</span></span>
<span id="cb28-2219"><a href="#cb28-2219" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Análisis Cross-Lagged Inicio-6m</span></span>
<span id="cb28-2220"><a href="#cb28-2220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2221"><a href="#cb28-2221" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para correlaciones cross-lagged</span></span>
<span id="cb28-2222"><a href="#cb28-2222" aria-hidden="true" tabindex="-1"></a>calculate_crosslag <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stage1, stage2, nodes) {</span>
<span id="cb28-2223"><a href="#cb28-2223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identificar pacientes con datos en ambas etapas</span></span>
<span id="cb28-2224"><a href="#cb28-2224" aria-hidden="true" tabindex="-1"></a>  has_stage1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-2225"><a href="#cb28-2225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb28-2226"><a href="#cb28-2226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-2227"><a href="#cb28-2227" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-2228"><a href="#cb28-2228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb28-2229"><a href="#cb28-2229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2230"><a href="#cb28-2230" aria-hidden="true" tabindex="-1"></a>  has_stage2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-2231"><a href="#cb28-2231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb28-2232"><a href="#cb28-2232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-2233"><a href="#cb28-2233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-2234"><a href="#cb28-2234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(HASHKEY)</span>
<span id="cb28-2235"><a href="#cb28-2235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2236"><a href="#cb28-2236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solo pacientes en ambas etapas</span></span>
<span id="cb28-2237"><a href="#cb28-2237" aria-hidden="true" tabindex="-1"></a>  ids_both <span class="ot">&lt;-</span> <span class="fu">intersect</span>(has_stage1, has_stage2)</span>
<span id="cb28-2238"><a href="#cb28-2238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2239"><a href="#cb28-2239" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(ids_both) <span class="sc">&lt;</span> <span class="dv">30</span>) {</span>
<span id="cb28-2240"><a href="#cb28-2240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-2241"><a href="#cb28-2241" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-2242"><a href="#cb28-2242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2243"><a href="#cb28-2243" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener datos ordenados y alineados</span></span>
<span id="cb28-2244"><a href="#cb28-2244" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-2245"><a href="#cb28-2245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage1) <span class="sc">%&gt;%</span></span>
<span id="cb28-2246"><a href="#cb28-2246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-2247"><a href="#cb28-2247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2248"><a href="#cb28-2248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-2249"><a href="#cb28-2249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-2250"><a href="#cb28-2250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb28-2251"><a href="#cb28-2251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2252"><a href="#cb28-2252" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-2253"><a href="#cb28-2253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(HASHKEY <span class="sc">%in%</span> ids_both, etapa_std <span class="sc">==</span> stage2) <span class="sc">%&gt;%</span></span>
<span id="cb28-2254"><a href="#cb28-2254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-2255"><a href="#cb28-2255" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2256"><a href="#cb28-2256" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-2257"><a href="#cb28-2257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(HASHKEY) <span class="sc">%&gt;%</span></span>
<span id="cb28-2258"><a href="#cb28-2258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(HASHKEY, <span class="fu">all_of</span>(nodes))</span>
<span id="cb28-2259"><a href="#cb28-2259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2260"><a href="#cb28-2260" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar alineación</span></span>
<span id="cb28-2261"><a href="#cb28-2261" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(d1<span class="sc">$</span>HASHKEY, d2<span class="sc">$</span>HASHKEY)) {</span>
<span id="cb28-2262"><a href="#cb28-2262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-2263"><a href="#cb28-2263" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-2264"><a href="#cb28-2264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2265"><a href="#cb28-2265" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matriz de correlaciones cruzadas</span></span>
<span id="cb28-2266"><a href="#cb28-2266" aria-hidden="true" tabindex="-1"></a>  cross_cor <span class="ot">&lt;-</span> <span class="fu">cor</span>(d1[,<span class="sc">-</span><span class="dv">1</span>], d2[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>)</span>
<span id="cb28-2267"><a href="#cb28-2267" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2268"><a href="#cb28-2268" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualizar como heatmap</span></span>
<span id="cb28-2269"><a href="#cb28-2269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corrplot</span>(cross_cor, </span>
<span id="cb28-2270"><a href="#cb28-2270" aria-hidden="true" tabindex="-1"></a>           <span class="at">method =</span> <span class="st">"color"</span>,</span>
<span id="cb28-2271"><a href="#cb28-2271" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="st">"full"</span>,</span>
<span id="cb28-2272"><a href="#cb28-2272" aria-hidden="true" tabindex="-1"></a>           <span class="at">tl.cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb28-2273"><a href="#cb28-2273" aria-hidden="true" tabindex="-1"></a>           <span class="at">tl.col =</span> <span class="st">"black"</span>,</span>
<span id="cb28-2274"><a href="#cb28-2274" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"#e74c3c"</span>, <span class="st">"white"</span>, <span class="st">"#2ecc71"</span>))(<span class="dv">100</span>),</span>
<span id="cb28-2275"><a href="#cb28-2275" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Cross-lagged: Inicio → 6m (n ="</span>, <span class="fu">nrow</span>(d1), <span class="st">")"</span>))</span>
<span id="cb28-2276"><a href="#cb28-2276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2277"><a href="#cb28-2277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cross_cor)</span>
<span id="cb28-2278"><a href="#cb28-2278" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2279"><a href="#cb28-2279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2280"><a href="#cb28-2280" aria-hidden="true" tabindex="-1"></a>crosslag_inicio_6m <span class="ot">&lt;-</span> <span class="fu">calculate_crosslag</span>(dat_analysis, <span class="st">"Inicio"</span>, <span class="st">"6m"</span>, nodes_all)</span>
<span id="cb28-2281"><a href="#cb28-2281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-2282"><a href="#cb28-2282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2285"><a href="#cb28-2285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-2286"><a href="#cb28-2286" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cross-lagged 12m</span></span>
<span id="cb28-2287"><a href="#cb28-2287" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Análisis Cross-Lagged 6m-12m</span></span>
<span id="cb28-2288"><a href="#cb28-2288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2289"><a href="#cb28-2289" aria-hidden="true" tabindex="-1"></a>crosslag_inicio_9m <span class="ot">&lt;-</span> <span class="fu">calculate_crosslag</span>(dat_analysis, <span class="st">"6m"</span>, <span class="st">"12m"</span>, nodes_all)</span>
<span id="cb28-2290"><a href="#cb28-2290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-2291"><a href="#cb28-2291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2292"><a href="#cb28-2292" aria-hidden="true" tabindex="-1"></a><span class="fu">## Análisis de Tendencias Temporales</span></span>
<span id="cb28-2293"><a href="#cb28-2293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2294"><a href="#cb28-2294" aria-hidden="true" tabindex="-1"></a>El análisis de correlación de Spearman con el tiempo en meses ($0,3,6,9,12$) mostró tendencias marcadas: la densidad presentó $\rho_S=-1{,}0$ con $p=0{,}0167$ y pendiente $-0{,}0244$; la longitud promedio de camino, $\rho_S=1{,}0$ con $p=0{,}0167$ y pendiente $+0{,}0552$; el grado medio, pendiente $-0{,}3667$ con evidencia de cambio significativo; y la modularidad, pendiente $+0{,}0131$ también significativa. El clustering global, la fuerza global y la asortatividad no evidenciaron cambios significativos. Convergentemente, las redes se vuelven más dispersas (menos enlaces), más elongadas (mayores distancias) y más modulares (segmentación en comunidades) conforme avanza el tratamiento.</span>
<span id="cb28-2295"><a href="#cb28-2295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2296"><a href="#cb28-2296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2299"><a href="#cb28-2299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-2300"><a href="#cb28-2300" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: temporal-trends-analysis</span></span>
<span id="cb28-2301"><a href="#cb28-2301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2302"><a href="#cb28-2302" aria-hidden="true" tabindex="-1"></a>temporal_trends <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-2303"><a href="#cb28-2303" aria-hidden="true" tabindex="-1"></a>  Métrica <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Densidad"</span>, <span class="st">"Clustering global"</span>, <span class="st">"Longitud promedio"</span>, </span>
<span id="cb28-2304"><a href="#cb28-2304" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Fuerza global"</span>, <span class="st">"Asortatividad"</span>, <span class="st">"Grado medio"</span>, <span class="st">"Modularidad"</span>),</span>
<span id="cb28-2305"><a href="#cb28-2305" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2306"><a href="#cb28-2306" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-2307"><a href="#cb28-2307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2308"><a href="#cb28-2308" aria-hidden="true" tabindex="-1"></a>time_numeric <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>)</span>
<span id="cb28-2309"><a href="#cb28-2309" aria-hidden="true" tabindex="-1"></a>stages_ordered <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inicio"</span>, <span class="st">"3m"</span>, <span class="st">"6m"</span>, <span class="st">"9m"</span>, <span class="st">"12m"</span>)</span>
<span id="cb28-2310"><a href="#cb28-2310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2311"><a href="#cb28-2311" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(metric <span class="cf">in</span> temporal_trends<span class="sc">$</span>Métrica) {</span>
<span id="cb28-2312"><a href="#cb28-2312" aria-hidden="true" tabindex="-1"></a>  values <span class="ot">&lt;-</span> global_metrics_comprehensive <span class="sc">%&gt;%</span></span>
<span id="cb28-2313"><a href="#cb28-2313" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Etapa <span class="sc">%in%</span> stages_ordered) <span class="sc">%&gt;%</span></span>
<span id="cb28-2314"><a href="#cb28-2314" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">match</span>(Etapa, stages_ordered)) <span class="sc">%&gt;%</span></span>
<span id="cb28-2315"><a href="#cb28-2315" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(<span class="sc">!!</span><span class="fu">sym</span>(metric))</span>
<span id="cb28-2316"><a href="#cb28-2316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2317"><a href="#cb28-2317" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(values) <span class="sc">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb28-2318"><a href="#cb28-2318" aria-hidden="true" tabindex="-1"></a>    valid_indices <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(values))</span>
<span id="cb28-2319"><a href="#cb28-2319" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(valid_indices) <span class="sc">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb28-2320"><a href="#cb28-2320" aria-hidden="true" tabindex="-1"></a>      cor_test <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(time_numeric[valid_indices], values[valid_indices], </span>
<span id="cb28-2321"><a href="#cb28-2321" aria-hidden="true" tabindex="-1"></a>                           <span class="at">method =</span> <span class="st">"spearman"</span>)</span>
<span id="cb28-2322"><a href="#cb28-2322" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"Correlación_Spearman"</span>] <span class="ot">&lt;-</span> cor_test<span class="sc">$</span>estimate</span>
<span id="cb28-2323"><a href="#cb28-2323" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"p_value"</span>] <span class="ot">&lt;-</span> cor_test<span class="sc">$</span>p.value</span>
<span id="cb28-2324"><a href="#cb28-2324" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-2325"><a href="#cb28-2325" aria-hidden="true" tabindex="-1"></a>      lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(values[valid_indices] <span class="sc">~</span> time_numeric[valid_indices])</span>
<span id="cb28-2326"><a href="#cb28-2326" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"Pendiente"</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(lm_model)[<span class="dv">2</span>]</span>
<span id="cb28-2327"><a href="#cb28-2327" aria-hidden="true" tabindex="-1"></a>      temporal_trends[temporal_trends<span class="sc">$</span>Métrica <span class="sc">==</span> metric, <span class="st">"R2"</span>] <span class="ot">&lt;-</span> <span class="fu">summary</span>(lm_model)<span class="sc">$</span>r.squared</span>
<span id="cb28-2328"><a href="#cb28-2328" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-2329"><a href="#cb28-2329" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-2330"><a href="#cb28-2330" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2331"><a href="#cb28-2331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2332"><a href="#cb28-2332" aria-hidden="true" tabindex="-1"></a>temporal_trends <span class="sc">%&gt;%</span></span>
<span id="cb28-2333"><a href="#cb28-2333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb28-2334"><a href="#cb28-2334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Significancia =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2335"><a href="#cb28-2335" aria-hidden="true" tabindex="-1"></a>    p_value <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">~</span> <span class="st">"***"</span>,</span>
<span id="cb28-2336"><a href="#cb28-2336" aria-hidden="true" tabindex="-1"></a>    p_value <span class="sc">&lt;</span> <span class="fl">0.01</span> <span class="sc">~</span> <span class="st">"**"</span>,</span>
<span id="cb28-2337"><a href="#cb28-2337" aria-hidden="true" tabindex="-1"></a>    p_value <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"*"</span>,</span>
<span id="cb28-2338"><a href="#cb28-2338" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"ns"</span></span>
<span id="cb28-2339"><a href="#cb28-2339" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb28-2340"><a href="#cb28-2340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb28-2341"><a href="#cb28-2341" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Análisis de tendencias temporales en métricas de red"</span>,</span>
<span id="cb28-2342"><a href="#cb28-2342" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb28-2343"><a href="#cb28-2343" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-2344"><a href="#cb28-2344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb28-2345"><a href="#cb28-2345" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-2346"><a href="#cb28-2346" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb28-2347"><a href="#cb28-2347" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-2348"><a href="#cb28-2348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">color =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(temporal_trends<span class="sc">$</span>p_value) <span class="sc">&amp;</span> </span>
<span id="cb28-2349"><a href="#cb28-2349" aria-hidden="true" tabindex="-1"></a>                                temporal_trends<span class="sc">$</span>p_value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"red"</span>, <span class="st">"black"</span>))</span>
<span id="cb28-2350"><a href="#cb28-2350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-2351"><a href="#cb28-2351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2352"><a href="#cb28-2352" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusiónes</span></span>
<span id="cb28-2353"><a href="#cb28-2353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2354"><a href="#cb28-2354" aria-hidden="true" tabindex="-1"></a>Los resultados muestran que la red TOP se simplifica y se segmenta a lo largo del tratamiento: disminuyen la densidad y el grado medio, aumenta la distancia típica entre ítems y crece la modularidad. La comparación de redes confirmó cambios sustantivos tanto en intensidad total como en arquitectura, con divergencias más amplias a 12 meses. Los nodos puente, en particular **Pasta Base**, **Cannabis** y **Riña**, junto con **Días Trabajo** en fases tempranas, articulan la conectividad interdominios y representan puntos de palanca para intervención. Los modelos longitudinales respaldan que reducir conductas de consumo y transgresión mientras se fortalecen salud física y psicológica y la participación laboral/educativa se asocia a mejor calidad de vida, con efectos que pueden variar temporalmente. Finalmente, algunas métricas se aproximan a patrones aleatorios en etapas tardías, lo que podría reflejar mayor heterogeneidad y menor acoplamiento entre dominios tras la intervención, reforzando la necesidad de intervenciones tempranas y focalizadas sobre los nodos puente identificados.</span>
<span id="cb28-2355"><a href="#cb28-2355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2356"><a href="#cb28-2356" aria-hidden="true" tabindex="-1"></a><span class="fu">## Síntesis de Resultados</span></span>
<span id="cb28-2357"><a href="#cb28-2357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2360"><a href="#cb28-2360" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-2361"><a href="#cb28-2361" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: synthesis-results</span></span>
<span id="cb28-2362"><a href="#cb28-2362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2363"><a href="#cb28-2363" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar resultados de hipótesis</span></span>
<span id="cb28-2364"><a href="#cb28-2364" aria-hidden="true" tabindex="-1"></a>h1_result <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(nct_inicio_6m)) {</span>
<span id="cb28-2365"><a href="#cb28-2365" aria-hidden="true" tabindex="-1"></a>  nct_inicio_6m<span class="sc">$</span>glstrinv.pval <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb28-2366"><a href="#cb28-2366" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-2367"><a href="#cb28-2367" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span></span>
<span id="cb28-2368"><a href="#cb28-2368" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-2369"><a href="#cb28-2369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2370"><a href="#cb28-2370" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear resumen de ajuste con modelos nulos</span></span>
<span id="cb28-2371"><a href="#cb28-2371" aria-hidden="true" tabindex="-1"></a>null_summary <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(null_comparisons), <span class="cf">function</span>(stage) {</span>
<span id="cb28-2372"><a href="#cb28-2372" aria-hidden="true" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> null_comparisons[[stage]]</span>
<span id="cb28-2373"><a href="#cb28-2373" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(comp)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-2374"><a href="#cb28-2374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2375"><a href="#cb28-2375" aria-hidden="true" tabindex="-1"></a>  sig_er <span class="ot">&lt;-</span> <span class="fu">sum</span>(comp<span class="sc">$</span>p_values_er <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb28-2376"><a href="#cb28-2376" aria-hidden="true" tabindex="-1"></a>  sig_ba <span class="ot">&lt;-</span> <span class="fu">sum</span>(comp<span class="sc">$</span>p_values_ba <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb28-2377"><a href="#cb28-2377" aria-hidden="true" tabindex="-1"></a>  total_metrics <span class="ot">&lt;-</span> <span class="fu">length</span>(comp<span class="sc">$</span>p_values_er)</span>
<span id="cb28-2378"><a href="#cb28-2378" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-2379"><a href="#cb28-2379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb28-2380"><a href="#cb28-2380" aria-hidden="true" tabindex="-1"></a>    <span class="at">Etapa =</span> stage,</span>
<span id="cb28-2381"><a href="#cb28-2381" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER Sig/Total</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(sig_er, <span class="st">"/"</span>, total_metrics),</span>
<span id="cb28-2382"><a href="#cb28-2382" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2383"><a href="#cb28-2383" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Bueno"</span>,</span>
<span id="cb28-2384"><a href="#cb28-2384" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Moderado"</span>,</span>
<span id="cb28-2385"><a href="#cb28-2385" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Pobre"</span></span>
<span id="cb28-2386"><a href="#cb28-2386" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-2387"><a href="#cb28-2387" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA Sig/Total</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(sig_ba, <span class="st">"/"</span>, total_metrics),</span>
<span id="cb28-2388"><a href="#cb28-2388" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">BA Ajuste</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2389"><a href="#cb28-2389" aria-hidden="true" tabindex="-1"></a>      sig_ba <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Bueno"</span>,</span>
<span id="cb28-2390"><a href="#cb28-2390" aria-hidden="true" tabindex="-1"></a>      sig_ba <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Moderado"</span>,</span>
<span id="cb28-2391"><a href="#cb28-2391" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Pobre"</span></span>
<span id="cb28-2392"><a href="#cb28-2392" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-2393"><a href="#cb28-2393" aria-hidden="true" tabindex="-1"></a>    Conclusión <span class="ot">=</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2394"><a href="#cb28-2394" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">&amp;</span> sig_ba <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Red compatible con procesos aleatorios"</span>,</span>
<span id="cb28-2395"><a href="#cb28-2395" aria-hidden="true" tabindex="-1"></a>      sig_er <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">&amp;</span> sig_ba <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Red con estructura no aleatoria fuerte"</span>,</span>
<span id="cb28-2396"><a href="#cb28-2396" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Red con estructura parcialmente no aleatoria"</span></span>
<span id="cb28-2397"><a href="#cb28-2397" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-2398"><a href="#cb28-2398" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2399"><a href="#cb28-2399" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-2400"><a href="#cb28-2400" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-2401"><a href="#cb28-2401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2402"><a href="#cb28-2402" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabla resumen final</span></span>
<span id="cb28-2403"><a href="#cb28-2403" aria-hidden="true" tabindex="-1"></a>null_summary <span class="sc">%&gt;%</span></span>
<span id="cb28-2404"><a href="#cb28-2404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb28-2405"><a href="#cb28-2405" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Resumen de ajuste con modelos nulos por etapa"</span>,</span>
<span id="cb28-2406"><a href="#cb28-2406" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb28-2407"><a href="#cb28-2407" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-2408"><a href="#cb28-2408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb28-2409"><a href="#cb28-2409" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-2410"><a href="#cb28-2410" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb28-2411"><a href="#cb28-2411" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-2412"><a href="#cb28-2412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">color =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2413"><a href="#cb28-2413" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Bueno"</span> <span class="sc">~</span> <span class="st">"green"</span>,</span>
<span id="cb28-2414"><a href="#cb28-2414" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Moderado"</span> <span class="sc">~</span> <span class="st">"orange"</span>,</span>
<span id="cb28-2415"><a href="#cb28-2415" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"red"</span></span>
<span id="cb28-2416"><a href="#cb28-2416" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb28-2417"><a href="#cb28-2417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">5</span>, <span class="at">color =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-2418"><a href="#cb28-2418" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">BA Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Bueno"</span> <span class="sc">~</span> <span class="st">"green"</span>,</span>
<span id="cb28-2419"><a href="#cb28-2419" aria-hidden="true" tabindex="-1"></a>    null_summary<span class="sc">$</span><span class="st">`</span><span class="at">BA Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Moderado"</span> <span class="sc">~</span> <span class="st">"orange"</span>,</span>
<span id="cb28-2420"><a href="#cb28-2420" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"red"</span></span>
<span id="cb28-2421"><a href="#cb28-2421" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-2422"><a href="#cb28-2422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2423"><a href="#cb28-2423" aria-hidden="true" tabindex="-1"></a><span class="co"># Síntesis de hallazgos clave</span></span>
<span id="cb28-2424"><a href="#cb28-2424" aria-hidden="true" tabindex="-1"></a>synthesis <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-2425"><a href="#cb28-2425" aria-hidden="true" tabindex="-1"></a>  <span class="at">Aspecto =</span> <span class="fu">c</span>(</span>
<span id="cb28-2426"><a href="#cb28-2426" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Estructura de red"</span>,</span>
<span id="cb28-2427"><a href="#cb28-2427" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Comparación con modelos aleatorios"</span>,</span>
<span id="cb28-2428"><a href="#cb28-2428" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Evolución temporal"</span>,</span>
<span id="cb28-2429"><a href="#cb28-2429" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nodos centrales"</span>,</span>
<span id="cb28-2430"><a href="#cb28-2430" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dominios puente"</span></span>
<span id="cb28-2431"><a href="#cb28-2431" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb28-2432"><a href="#cb28-2432" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Hallazgo Principal</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb28-2433"><a href="#cb28-2433" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Densidad promedio:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(global_metrics_comprehensive<span class="sc">$</span>Densidad, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>)),</span>
<span id="cb28-2434"><a href="#cb28-2434" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Etapas con estructura no aleatoria:"</span>, <span class="fu">sum</span>(null_summary<span class="sc">$</span><span class="st">`</span><span class="at">ER Ajuste</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Pobre"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb28-2435"><a href="#cb28-2435" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Métricas con tendencia significativa:"</span>, <span class="fu">sum</span>(temporal_trends<span class="sc">$</span>p_value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb28-2436"><a href="#cb28-2436" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Nodos centrales consistentes:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">head</span>(node_metrics_all<span class="sc">$</span>Nodo[<span class="fu">order</span>(node_metrics_all<span class="sc">$</span>Fuerza, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)], <span class="dv">10</span>)))),</span>
<span id="cb28-2437"><a href="#cb28-2437" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"Dominio puente principal:"</span>, <span class="fu">names</span>(<span class="fu">which.max</span>(<span class="fu">table</span>(bridge_metrics<span class="sc">$</span>Comunidad[bridge_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="fu">median</span>(bridge_metrics<span class="sc">$</span><span class="st">`</span><span class="at">Influencia puente esperada</span><span class="st">`</span>)]))))</span>
<span id="cb28-2438"><a href="#cb28-2438" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb28-2439"><a href="#cb28-2439" aria-hidden="true" tabindex="-1"></a>  Implicación <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb28-2440"><a href="#cb28-2440" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Red moderadamente densa con conexiones significativas"</span>,</span>
<span id="cb28-2441"><a href="#cb28-2441" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Estructura emergente no explicable por azar"</span>,</span>
<span id="cb28-2442"><a href="#cb28-2442" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cambios sistemáticos durante el tratamiento"</span>,</span>
<span id="cb28-2443"><a href="#cb28-2443" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Focos de intervención identificables"</span>,</span>
<span id="cb28-2444"><a href="#cb28-2444" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Puntos clave de integración terapéutica"</span></span>
<span id="cb28-2445"><a href="#cb28-2445" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb28-2446"><a href="#cb28-2446" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-2447"><a href="#cb28-2447" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-2448"><a href="#cb28-2448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2449"><a href="#cb28-2449" aria-hidden="true" tabindex="-1"></a>synthesis <span class="sc">%&gt;%</span></span>
<span id="cb28-2450"><a href="#cb28-2450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb28-2451"><a href="#cb28-2451" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Síntesis de hallazgos principales del análisis de redes"</span>,</span>
<span id="cb28-2452"><a href="#cb28-2452" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span></span>
<span id="cb28-2453"><a href="#cb28-2453" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-2454"><a href="#cb28-2454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb28-2455"><a href="#cb28-2455" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-2456"><a href="#cb28-2456" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>)</span>
<span id="cb28-2457"><a href="#cb28-2457" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-2458"><a href="#cb28-2458" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">2</span>, <span class="at">width =</span> <span class="st">"200px"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-2459"><a href="#cb28-2459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">width =</span> <span class="st">"300px"</span>)</span>
<span id="cb28-2460"><a href="#cb28-2460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copiar al portapapeles" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<script src="Stage4_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>